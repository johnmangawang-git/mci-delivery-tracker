<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase-Only Customers</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üóÑÔ∏è Supabase-Only Customer Test</h1>
    
    <div class="test-section info">
        <h3>Test Purpose</h3>
        <p>This page tests that customer data comes ONLY from Supabase, with no localStorage fallback or mock data.</p>
        <div id="browserInfo"></div>
        <div id="fixStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üß™ Test Controls</h3>
        <button onclick="testSupabaseOnlyLoad()">Test Supabase-Only Load</button>
        <button onclick="checkForMockData()">Check for Mock Data</button>
        <button onclick="clearLocalStorage()">Clear localStorage</button>
        <button onclick="showCurrentData()">Show Current Data</button>
        <button onclick="clearAllData()">Clear ALL Customer Data</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h3>üìä Data Sources Comparison</h3>
        <div id="dataComparison"></div>
    </div>
    
    <div class="test-section">
        <h3>üìù Test Log</h3>
        <div id="testLog" class="log"></div>
    </div>

    <!-- Load required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/customer-field-mapping-fix.js"></script>
    <script src="public/assets/js/supabase-only-customer-fix.js"></script>
    
    <script>
        // Test logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<span style="color: ${colorMap[type] || '#333'}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        // Initialize test environment
        function initTestEnvironment() {
            log('üîß Initializing Supabase-only customer test environment...', 'info');
            
            // Display browser information
            const browserInfo = document.getElementById('browserInfo');
            const browserName = navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                               navigator.userAgent.includes('Firefox') ? 'Firefox' : 
                               navigator.userAgent.includes('Safari') ? 'Safari' : 'Unknown';
            
            browserInfo.innerHTML = `
                <strong>Browser:</strong> ${browserName}<br>
                <strong>Current Time:</strong> ${new Date().toLocaleString()}
            `;
            
            // Check if Supabase-only fix is loaded
            const fixStatus = document.getElementById('fixStatus');
            if (typeof window.supabaseOnlyCustomerFix !== 'undefined') {
                fixStatus.innerHTML = `
                    <div class="success" style="margin-top: 10px; padding: 10px; border-radius: 5px;">
                        <strong>‚úÖ Supabase-Only Customer Fix Loaded</strong><br>
                        Version: ${window.supabaseOnlyCustomerFix.version}<br>
                        Loaded at: ${window.supabaseOnlyCustomerFix.timestamp}
                    </div>
                `;
                log('‚úÖ Supabase-only customer fix loaded', 'success');
            } else {
                fixStatus.innerHTML = `
                    <div class="error" style="margin-top: 10px; padding: 10px; border-radius: 5px;">
                        <strong>‚ùå Supabase-Only Customer Fix NOT Loaded</strong><br>
                        Mock data may still appear.
                    </div>
                `;
                log('‚ùå Supabase-only customer fix NOT loaded', 'error');
            }
            
            // Check function availability
            const functions = [
                'supabaseOnlyLoadCustomers',
                'clearAllCustomerData',
                'dataService'
            ];
            
            functions.forEach(funcName => {
                const available = typeof window[funcName] !== 'undefined';
                log(`Function ${funcName}: ${available ? 'Available' : 'Not Available'}`, available ? 'success' : 'error');
            });
        }
        
        // Test Supabase-only loading
        async function testSupabaseOnlyLoad() {
            log('üß™ Testing Supabase-only customer loading...', 'info');
            
            try {
                if (typeof window.supabaseOnlyLoadCustomers === 'function') {
                    log('üîÑ Calling supabaseOnlyLoadCustomers...', 'info');
                    const customers = await window.supabaseOnlyLoadCustomers();
                    
                    log(`‚úÖ Supabase-only load completed: ${customers.length} customers`, 'success');
                    
                    if (customers.length === 0) {
                        log('üìä No customers found in Supabase (expected if database is empty)', 'info');
                    } else {
                        customers.forEach(customer => {
                            log(`üìù Customer: ${customer.contactPerson || customer.name} (${customer.id})`, 'info');
                        });
                    }
                    
                } else {
                    log('‚ùå supabaseOnlyLoadCustomers function not available', 'error');
                }
            } catch (error) {
                log(`‚ùå Error in Supabase-only load test: ${error.message}`, 'error');
            }
        }
        
        // Check for mock data
        function checkForMockData() {
            log('üîç Checking for mock data...', 'info');
            
            const mockDataIndicators = [
                'John Doe',
                'Jane Smith',
                '+63 917 123 4567',
                '+63 918 765 4321',
                'CUST-001',
                'CUST-002'
            ];
            
            let mockDataFound = false;
            
            // Check window.customers
            if (window.customers && window.customers.length > 0) {
                window.customers.forEach(customer => {
                    mockDataIndicators.forEach(indicator => {
                        if (JSON.stringify(customer).includes(indicator)) {
                            log(`‚ö†Ô∏è MOCK DATA FOUND in window.customers: ${indicator}`, 'warning');
                            mockDataFound = true;
                        }
                    });
                });
            }
            
            // Check localStorage
            try {
                const localCustomers = localStorage.getItem('mci-customers');
                if (localCustomers) {
                    mockDataIndicators.forEach(indicator => {
                        if (localCustomers.includes(indicator)) {
                            log(`‚ö†Ô∏è MOCK DATA FOUND in localStorage: ${indicator}`, 'warning');
                            mockDataFound = true;
                        }
                    });
                }
            } catch (error) {
                log('‚ùå Error checking localStorage for mock data', 'error');
            }
            
            if (!mockDataFound) {
                log('‚úÖ No mock data found - good!', 'success');
            } else {
                log('‚ùå Mock data detected - this should not happen with Supabase-only fix', 'error');
            }
        }
        
        // Clear localStorage
        function clearLocalStorage() {
            log('üóëÔ∏è Clearing localStorage customer data...', 'info');
            
            try {
                localStorage.removeItem('mci-customers');
                log('‚úÖ localStorage customer data cleared', 'success');
                
                // Also clear window.customers
                window.customers = [];
                log('‚úÖ window.customers cleared', 'success');
                
            } catch (error) {
                log(`‚ùå Error clearing localStorage: ${error.message}`, 'error');
            }
        }
        
        // Show current data from all sources
        async function showCurrentData() {
            log('üìä Showing current data from all sources...', 'info');
            
            const dataComparison = document.getElementById('dataComparison');
            let comparisonHtml = '<h4>Data Sources Comparison:</h4>';
            
            // Window customers
            comparisonHtml += '<h5>window.customers:</h5>';
            if (window.customers && window.customers.length > 0) {
                comparisonHtml += '<ul>';
                window.customers.forEach(customer => {
                    comparisonHtml += `<li>${customer.contactPerson || customer.name} (${customer.phone}) - ID: ${customer.id}</li>`;
                });
                comparisonHtml += '</ul>';
                log(`üìä window.customers: ${window.customers.length} items`, 'info');
            } else {
                comparisonHtml += '<p>Empty</p>';
                log('üìä window.customers: Empty', 'info');
            }
            
            // localStorage
            comparisonHtml += '<h5>localStorage:</h5>';
            try {
                const localCustomers = localStorage.getItem('mci-customers');
                if (localCustomers) {
                    const customers = JSON.parse(localCustomers);
                    if (customers.length > 0) {
                        comparisonHtml += '<ul>';
                        customers.forEach(customer => {
                            comparisonHtml += `<li>${customer.contactPerson || customer.name} (${customer.phone}) - ID: ${customer.id}</li>`;
                        });
                        comparisonHtml += '</ul>';
                        log(`üìä localStorage: ${customers.length} items`, 'info');
                    } else {
                        comparisonHtml += '<p>Empty array</p>';
                        log('üìä localStorage: Empty array', 'info');
                    }
                } else {
                    comparisonHtml += '<p>No data</p>';
                    log('üìä localStorage: No data', 'info');
                }
            } catch (error) {
                comparisonHtml += `<p>Error: ${error.message}</p>`;
                log('‚ùå Error reading localStorage', 'error');
            }
            
            // Supabase (if available)
            comparisonHtml += '<h5>Supabase (direct):</h5>';
            if (window.dataService && typeof window.dataService.getCustomers === 'function') {
                try {
                    const supabaseCustomers = await window.dataService.getCustomers();
                    if (supabaseCustomers && supabaseCustomers.length > 0) {
                        comparisonHtml += '<ul>';
                        supabaseCustomers.forEach(customer => {
                            comparisonHtml += `<li>${customer.name || customer.contactPerson} (${customer.phone}) - ID: ${customer.id}</li>`;
                        });
                        comparisonHtml += '</ul>';
                        log(`üìä Supabase: ${supabaseCustomers.length} items`, 'info');
                    } else {
                        comparisonHtml += '<p>Empty</p>';
                        log('üìä Supabase: Empty', 'info');
                    }
                } catch (error) {
                    comparisonHtml += `<p>Error: ${error.message}</p>`;
                    log(`‚ùå Error reading Supabase: ${error.message}`, 'error');
                }
            } else {
                comparisonHtml += '<p>DataService not available</p>';
                log('‚ùå DataService not available', 'error');
            }
            
            dataComparison.innerHTML = comparisonHtml;
        }
        
        // Clear all customer data
        async function clearAllData() {
            log('üóëÔ∏è Clearing ALL customer data...', 'info');
            
            if (!confirm('Are you sure you want to clear ALL customer data from Supabase and localStorage?')) {
                return;
            }
            
            try {
                if (typeof window.clearAllCustomerData === 'function') {
                    await window.clearAllCustomerData();
                    log('‚úÖ All customer data cleared using clearAllCustomerData function', 'success');
                } else {
                    // Manual cleanup
                    window.customers = [];
                    localStorage.removeItem('mci-customers');
                    log('‚úÖ Local data cleared manually', 'success');
                }
                
                // Refresh data display
                setTimeout(showCurrentData, 1000);
                
            } catch (error) {
                log(`‚ùå Error clearing all data: ${error.message}`, 'error');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initTestEnvironment();
                // Auto-show current data
                setTimeout(showCurrentData, 2000);
            }, 1000);
        });
    </script>
</body>
</html>