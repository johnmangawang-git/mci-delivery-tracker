<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cross-Browser Cost Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 Cross-Browser Cost Sync Test</h1>
        
        <div class="alert alert-info">
            <h5>Test Purpose</h5>
            <p>This page tests that cost items uploaded in one browser appear in another browser via Supabase sync.</p>
            <p><strong>Expected:</strong> Edge uploads Gas + Helper → Chrome shows Gas + Helper in analytics</p>
        </div>

        <div class="test-section">
            <h3>🧪 Test Supabase Cost Items Sync</h3>
            <p>This tests if cost items are properly saved to and loaded from the additional_cost_items table.</p>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <button onclick="testSaveCostItems()" class="btn btn-primary">1. Test Save Cost Items</button>
                    <small class="d-block text-muted">Simulates DR upload with cost items</small>
                </div>
                <div class="col-md-6">
                    <button onclick="testLoadCostItems()" class="btn btn-success">2. Test Load Cost Items</button>
                    <small class="d-block text-muted">Simulates analytics loading from Supabase</small>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <button onclick="testCrossSync()" class="btn btn-warning">3. Test Cross-Browser Sync</button>
                    <small class="d-block text-muted">Simulates opening in different browser</small>
                </div>
                <div class="col-md-6">
                    <button onclick="clearLog()" class="btn btn-secondary">Clear Log</button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>📊 Current Browser Data</h3>
            <div id="browserData" class="log">Click "Test Load Cost Items" to see current data...</div>
        </div>

        <div class="test-section">
            <h3>📋 Test Log</h3>
            <div id="testLog" class="log">Ready to test cross-browser cost sync...\n</div>
        </div>
    </div>

    <!-- Include required scripts -->
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/analytics.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            
            const logEntry = document.createElement('div');
            logEntry.className = className;
            logEntry.textContent = `${timestamp} ${icon} ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = 'Log cleared...\n';
        }
        
        async function testSaveCostItems() {
            log('🧪 Testing save cost items to Supabase...', 'info');
            
            try {
                if (!window.dataService) {
                    log('❌ DataService not available', 'error');
                    return;
                }
                
                // Create a test delivery with cost items
                const testDelivery = {
                    dr_number: `DR-TEST-${Date.now()}`,
                    customer_name: 'Test Customer for Cross-Browser Sync',
                    vendor_number: '+63 917 999 0001',
                    origin: 'Test Origin',
                    destination: 'Test Destination',
                    status: 'Active',
                    created_date: new Date().toISOString().split('T')[0],
                    created_by: 'Cross-Browser Test',
                    created_at: new Date().toISOString(),
                    additional_costs: 225.50,
                    additional_cost_items: [
                        {
                            description: 'Gas for truck',
                            amount: 150.00,
                            category: 'Fuel Surcharge'
                        },
                        {
                            description: 'Helper fee',
                            amount: 75.50,
                            category: 'Helper'
                        }
                    ]
                };
                
                log(`Creating test delivery: ${testDelivery.dr_number}`, 'info');
                log(`Cost items: ${testDelivery.additional_cost_items.length}`, 'info');
                
                const result = await window.dataService.saveDelivery(testDelivery);
                
                if (result) {
                    log(`✅ Successfully saved delivery: ${result.dr_number || result.id}`, 'success');
                    log('✅ Cost items should now be in additional_cost_items table', 'success');
                    
                    // Store for later tests
                    window.testDeliveryId = result.id;
                    window.testDrNumber = result.dr_number || testDelivery.dr_number;
                } else {
                    log('❌ No result returned from saveDelivery', 'error');
                }
                
            } catch (error) {
                log(`❌ Error saving cost items: ${error.message}`, 'error');
                console.error('Save error details:', error);
            }
        }
        
        async function testLoadCostItems() {
            log('🧪 Testing load cost items from Supabase...', 'info');
            
            try {
                if (!window.dataService || typeof window.dataService.getAdditionalCostItems !== 'function') {
                    log('❌ getAdditionalCostItems function not available', 'error');
                    return;
                }
                
                const costItems = await window.dataService.getAdditionalCostItems();
                
                log(`📊 Loaded ${costItems.length} cost items from Supabase`, 'success');
                
                const browserDataDiv = document.getElementById('browserData');
                if (costItems.length > 0) {
                    let dataHtml = `<strong>Cost Items Found (${costItems.length}):</strong>\n`;
                    costItems.forEach((item, index) => {
                        dataHtml += `${index + 1}. ${item.description} - ₱${item.amount} (${item.category})\n`;
                    });
                    browserDataDiv.innerHTML = dataHtml;
                    
                    log('✅ Cost items loaded successfully - check "Current Browser Data" section', 'success');
                } else {
                    browserDataDiv.innerHTML = 'No cost items found in Supabase additional_cost_items table.\nThis might mean:\n1. No DR uploads with costs yet\n2. Cost items not being saved to dedicated table\n3. Different user account';
                    log('⚠️ No cost items found in additional_cost_items table', 'warning');
                }
                
            } catch (error) {
                log(`❌ Error loading cost items: ${error.message}`, 'error');
                console.error('Load error details:', error);
            }
        }
        
        async function testCrossSync() {
            log('🧪 Testing cross-browser sync scenario...', 'info');
            
            try {
                // First, test if we can load deliveries
                if (!window.dataService || typeof window.dataService.getDeliveries !== 'function') {
                    log('❌ getDeliveries function not available', 'error');
                    return;
                }
                
                const deliveries = await window.dataService.getDeliveries();
                log(`📦 Found ${deliveries.length} deliveries in Supabase`, 'info');
                
                // Check for deliveries with cost items
                const deliveriesWithCosts = deliveries.filter(d => 
                    (d.additional_cost_items && Array.isArray(d.additional_cost_items) && d.additional_cost_items.length > 0) ||
                    (d.additional_costs && d.additional_costs > 0)
                );
                
                log(`💰 Found ${deliveriesWithCosts.length} deliveries with costs`, 'info');
                
                if (deliveriesWithCosts.length > 0) {
                    log('✅ Cross-browser sync should work - deliveries with costs found', 'success');
                    
                    // Show sample
                    const sample = deliveriesWithCosts[0];
                    log(`Sample: ${sample.dr_number} - ₱${sample.additional_costs}`, 'info');
                    
                    if (sample.additional_cost_items && sample.additional_cost_items.length > 0) {
                        log(`Cost breakdown: ${sample.additional_cost_items.map(item => `${item.description}:₱${item.amount}`).join(', ')}`, 'info');
                    }
                } else {
                    log('⚠️ No deliveries with costs found - upload a DR with costs first', 'warning');
                }
                
                // Test analytics function
                if (typeof window.getCostBreakdownData === 'function') {
                    log('🔍 Testing analytics cost breakdown function...', 'info');
                    
                    const analyticsData = await window.getCostBreakdownData('month');
                    if (analyticsData && analyticsData.labels && analyticsData.labels.length > 0) {
                        log(`📊 Analytics found ${analyticsData.labels.length} cost categories: ${analyticsData.labels.join(', ')}`, 'success');
                    } else {
                        log('⚠️ Analytics returned no cost breakdown data', 'warning');
                    }
                }
                
            } catch (error) {
                log(`❌ Error in cross-sync test: ${error.message}`, 'error');
                console.error('Cross-sync error details:', error);
            }
        }
        
        // Initialize test
        window.addEventListener('load', () => {
            log('🔧 Cross-Browser Cost Sync Test initialized', 'info');
            log('Browser: ' + navigator.userAgent.split(' ').pop(), 'info');
            
            // Check if required functions are available
            setTimeout(() => {
                log(`DataService available: ${!!window.dataService}`, 'info');
                log(`getAdditionalCostItems available: ${!!(window.dataService && window.dataService.getAdditionalCostItems)}`, 'info');
                log(`getCostBreakdownData available: ${typeof window.getCostBreakdownData === 'function'}`, 'info');
                log('Ready to test! Start with "Test Save Cost Items"', 'info');
            }, 1000);
        });
    </script>
</body>
</html>