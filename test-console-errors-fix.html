<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console Errors Fix Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Console Errors Fix Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test switchToActiveDeliveriesView Function</h5>
                    </div>
                    <div class="card-body">
                        <button id="testSwitchView" class="btn btn-primary">Test Switch to Active Deliveries</button>
                        <div id="switchResult" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test DataService Error Handling</h5>
                    </div>
                    <div class="card-body">
                        <button id="testErrorHandling" class="btn btn-warning">Test Error Handling</button>
                        <div id="errorResult" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Console Output</h5>
                    </div>
                    <div class="card-body">
                        <div id="consoleOutput" style="background: #f8f9fa; padding: 10px; font-family: monospace; height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mock navigation for testing -->
    <div style="display: none;">
        <a data-view="active-deliveries" id="mockActiveDeliveriesLink">Active Deliveries</a>
        <div id="activeDeliveriesView" class="view">Active Deliveries View</div>
    </div>

    <!-- Load the fixed scripts -->
    <script src="public/assets/js/main-fixed.js"></script>
    <script src="public/assets/js/dataService.js"></script>

    <script>
        // Capture console output
        const consoleOutput = document.getElementById('consoleOutput');
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            consoleOutput.innerHTML += `<div class="text-${type === 'error' ? 'danger' : type === 'warn' ? 'warning' : 'info'}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog.apply(console, args);
            addToConsole('log', ...args);
        };
        
        console.warn = (...args) => {
            originalWarn.apply(console, args);
            addToConsole('warn', ...args);
        };
        
        console.error = (...args) => {
            originalError.apply(console, args);
            addToConsole('error', ...args);
        };

        // Test switchToActiveDeliveriesView function
        document.getElementById('testSwitchView').addEventListener('click', function() {
            const result = document.getElementById('switchResult');
            
            console.log('Testing switchToActiveDeliveriesView function...');
            
            if (typeof window.switchToActiveDeliveriesView === 'function') {
                try {
                    window.switchToActiveDeliveriesView();
                    result.innerHTML = '<div class="alert alert-success">✅ Function exists and executed without errors</div>';
                    console.log('✅ switchToActiveDeliveriesView test passed');
                } catch (error) {
                    result.innerHTML = '<div class="alert alert-danger">❌ Function exists but threw error: ' + error.message + '</div>';
                    console.error('❌ switchToActiveDeliveriesView test failed:', error);
                }
            } else {
                result.innerHTML = '<div class="alert alert-danger">❌ Function not found</div>';
                console.error('❌ switchToActiveDeliveriesView function not available');
            }
        });

        // Test error handling
        document.getElementById('testErrorHandling').addEventListener('click', function() {
            const result = document.getElementById('errorResult');
            
            console.log('Testing dataService error handling...');
            
            // Mock error with undefined details
            const mockError1 = {
                code: '23505',
                message: 'duplicate key value violates unique constraint "deliveries_dr_number_key"',
                details: undefined
            };
            
            // Mock error with malformed details
            const mockError2 = {
                code: '23505', 
                message: 'duplicate key value violates unique constraint "deliveries_dr_number_key"',
                details: 'Key (dr_number)=(undefined) already exists.'
            };
            
            // Mock error with proper details
            const mockError3 = {
                code: '23505',
                message: 'duplicate key value violates unique constraint "deliveries_dr_number_key"', 
                details: 'Key (dr_number)=(DR123456) already exists.'
            };
            
            console.log('Mock error 1 (undefined details):', mockError1);
            console.log('Mock error 2 (undefined dr_number):', mockError2);
            console.log('Mock error 3 (valid dr_number):', mockError3);
            
            result.innerHTML = '<div class="alert alert-info">Check console for error handling test results</div>';
        });

        console.log('Test page loaded successfully');
        console.log('Available functions:', {
            switchToActiveDeliveriesView: typeof window.switchToActiveDeliveriesView,
            dataService: typeof window.dataService
        });
    </script>
</body>
</html>