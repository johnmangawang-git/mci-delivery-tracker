<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Delivery History Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üß™ Test: Delivery History Fix</h2>
        
        <div class="alert alert-success">
            <strong>‚úÖ Fix Applied:</strong> Removed database loading race condition that was overwriting delivery history after signature completion.
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Active Deliveries</h5>
                        <span id="activeCount" class="badge bg-light text-dark">0</span>
                    </div>
                    <div class="card-body" style="height: 200px; overflow-y: auto;">
                        <div id="activeList">No active deliveries</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>Delivery History</h5>
                        <span id="historyCount" class="badge bg-light text-dark">0</span>
                    </div>
                    <div class="card-body" style="height: 200px; overflow-y: auto;">
                        <div id="historyList">No delivery history</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary btn-sm mb-2 w-100" onclick="addTestDelivery()">Add Test Delivery</button>
                        <button class="btn btn-success btn-sm mb-2 w-100" onclick="completeSignature()">Complete Signature</button>
                        <button class="btn btn-info btn-sm mb-2 w-100" onclick="testLoadDeliveryHistory()">Test Load History</button>
                        <button class="btn btn-secondary btn-sm w-100" onclick="clearData()">Clear Data</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Test Results</h5>
                </div>
                <div class="card-body">
                    <div id="testResults" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; background-color: #f8f9fa; padding: 10px;">
                        Test results will appear here...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/signature-completion-fix.js"></script>
    <script>
        // Initialize arrays
        if (typeof window.activeDeliveries === 'undefined') {
            window.activeDeliveries = [];
        }
        if (typeof window.deliveryHistory === 'undefined') {
            window.deliveryHistory = [];
        }

        // Load existing data
        try {
            const savedActive = localStorage.getItem('mci-active-deliveries');
            const savedHistory = localStorage.getItem('mci-delivery-history');
            
            if (savedActive) {
                window.activeDeliveries = JSON.parse(savedActive);
            }
            if (savedHistory) {
                window.deliveryHistory = JSON.parse(savedHistory);
            }
        } catch (error) {
            console.error('Error loading data:', error);
        }

        // Mock loadDeliveryHistory function to test the fix
        window.loadDeliveryHistory = function() {
            log('üîÑ loadDeliveryHistory called', 'info');
            log(`üìä Current delivery history length: ${window.deliveryHistory ? window.deliveryHistory.length : 0}`, 'info');
            
            // Simulate the fixed version without database loading
            const currentDeliveryHistory = window.deliveryHistory || [];
            log(`üìä Using delivery history with ${currentDeliveryHistory.length} items`, 'info');
            
            const filteredHistory = [...currentDeliveryHistory];
            log(`üìä Filtered history: ${filteredHistory.length} items`, 'info');
            
            // Update the display
            updateDisplay();
            
            if (filteredHistory.length > 0) {
                log('‚úÖ Delivery history loaded successfully', 'success');
                filteredHistory.forEach((delivery, index) => {
                    log(`  ${index + 1}. ${delivery.drNumber} - ${delivery.status} (${delivery.completedDate})`, 'info');
                });
            } else {
                log('üìù No delivery history to display', 'info');
            }
        };

        // Logging
        const testResults = document.getElementById('testResults');
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            testResults.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            testResults.scrollTop = testResults.scrollHeight;
            console.log(message);
        }

        function addTestDelivery() {
            const testDelivery = {
                id: 'test-' + Date.now(),
                drNumber: 'DR-FIX-' + Date.now(),
                customerName: 'Fix Test Customer',
                vendorNumber: 'VN-FIX-001',
                truckPlateNumber: 'FIX-123',
                origin: 'Manila',
                destination: 'Quezon City',
                status: 'Active',
                createdDate: new Date().toLocaleDateString()
            };
            
            window.activeDeliveries.push(testDelivery);
            localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
            
            log(`‚úÖ Added test delivery: ${testDelivery.drNumber}`, 'success');
            updateDisplay();
        }

        function completeSignature() {
            if (window.activeDeliveries.length === 0) {
                log('‚ö†Ô∏è No active deliveries to complete', 'warning');
                return;
            }
            
            const delivery = window.activeDeliveries[0];
            log(`üñäÔ∏è Starting signature completion for: ${delivery.drNumber}`, 'info');
            
            // Step 1: Create E-POD record
            const ePodRecord = {
                drNumber: delivery.drNumber,
                customerName: delivery.customerName,
                customerContact: delivery.vendorNumber,
                truckPlate: delivery.truckPlateNumber,
                origin: delivery.origin,
                destination: delivery.destination,
                signature: 'data:image/png;base64,test',
                status: 'Completed',
                signedAt: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            
            try {
                let ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                ePodRecords.push(ePodRecord);
                localStorage.setItem('ePodRecords', JSON.stringify(ePodRecords));
                log(`üìù E-POD record saved. Total: ${ePodRecords.length}`, 'success');
            } catch (error) {
                log(`‚ùå Error saving E-POD: ${error.message}`, 'error');
                return;
            }
            
            // Step 2: Use enhanced signature save
            log('üöÄ Calling enhanced signature save...', 'info');
            
            if (typeof window.enhancedSaveSignature === 'function') {
                const signatureInfo = {
                    drNumber: delivery.drNumber,
                    customerName: delivery.customerName,
                    customerContact: delivery.vendorNumber,
                    truckPlate: delivery.truckPlateNumber,
                    origin: delivery.origin,
                    destination: delivery.destination,
                    signatureData: ePodRecord.signature
                };
                
                const success = window.enhancedSaveSignature(signatureInfo);
                
                if (success) {
                    log('‚úÖ Enhanced signature save successful!', 'success');
                    
                    // Step 3: Test the fixed loadDeliveryHistory
                    setTimeout(() => {
                        log('üîÑ Testing loadDeliveryHistory after signature...', 'info');
                        window.loadDeliveryHistory();
                        
                        // Verify the result
                        const stillInActive = window.activeDeliveries.find(d => d.drNumber === delivery.drNumber);
                        const nowInHistory = window.deliveryHistory.find(d => d.drNumber === delivery.drNumber);
                        
                        if (!stillInActive && nowInHistory) {
                            log('üéâ SUCCESS: Delivery properly moved to history and displayed!', 'success');
                        } else if (stillInActive && !nowInHistory) {
                            log('‚ùå FAILED: Delivery still in active deliveries', 'error');
                        } else if (!stillInActive && !nowInHistory) {
                            log('‚ùå CRITICAL: Delivery disappeared completely', 'error');
                        } else {
                            log('‚ö†Ô∏è WARNING: Delivery in both active and history', 'warning');
                        }
                    }, 500);
                } else {
                    log('‚ùå Enhanced signature save failed', 'error');
                }
            } else {
                log('‚ùå Enhanced signature save function not available', 'error');
            }
        }

        function testLoadDeliveryHistory() {
            log('üß™ Testing loadDeliveryHistory function...', 'info');
            log(`üìä Before: Active=${window.activeDeliveries.length}, History=${window.deliveryHistory.length}`, 'info');
            
            if (typeof window.loadDeliveryHistory === 'function') {
                window.loadDeliveryHistory();
            } else {
                log('‚ùå loadDeliveryHistory function not available', 'error');
            }
        }

        function clearData() {
            window.activeDeliveries = [];
            window.deliveryHistory = [];
            localStorage.removeItem('mci-active-deliveries');
            localStorage.removeItem('mci-delivery-history');
            localStorage.removeItem('ePodRecords');
            
            log('üóëÔ∏è All data cleared', 'info');
            updateDisplay();
        }

        function updateDisplay() {
            // Update active deliveries
            document.getElementById('activeCount').textContent = window.activeDeliveries.length;
            const activeList = document.getElementById('activeList');
            if (window.activeDeliveries.length === 0) {
                activeList.innerHTML = '<div class="text-muted">No active deliveries</div>';
            } else {
                activeList.innerHTML = window.activeDeliveries.map(d => 
                    `<div class="mb-1 p-2 border rounded">
                        <strong>${d.drNumber}</strong><br>
                        <small>${d.customerName} - ${d.status}</small>
                    </div>`
                ).join('');
            }
            
            // Update delivery history
            document.getElementById('historyCount').textContent = window.deliveryHistory.length;
            const historyList = document.getElementById('historyList');
            if (window.deliveryHistory.length === 0) {
                historyList.innerHTML = '<div class="text-muted">No delivery history</div>';
            } else {
                historyList.innerHTML = window.deliveryHistory.map(d => 
                    `<div class="mb-1 p-2 border rounded bg-light">
                        <strong>${d.drNumber}</strong><br>
                        <small>${d.customerName} - ${d.status}</small><br>
                        <small class="text-success">Completed: ${d.completedDate}</small>
                    </div>`
                ).join('');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Delivery History Fix Test loaded', 'success');
            log('üìã Test Steps:', 'info');
            log('1. Add a test delivery', 'info');
            log('2. Complete signature (should move to history)', 'info');
            log('3. Verify delivery appears in history', 'info');
            updateDisplay();
        });
    </script>
</body>
</html>