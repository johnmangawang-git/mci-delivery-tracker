<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Date Field Mapping Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .highlight { background-color: #fff3cd; }
    </style>
</head>
<body>
    <h1>üìÖ Date Field Mapping Fix Test</h1>
    
    <div class="test-section info">
        <h3>Test Purpose</h3>
        <p>This page tests the date field mapping fix to ensure completed delivery dates display correctly across different browsers.</p>
        <div id="browserInfo"></div>
    </div>
    
    <div class="test-section">
        <h3>üß™ Test Controls</h3>
        <button onclick="testDateNormalization()">Test Date Normalization</button>
        <button onclick="testCrossBrowserData()">Test Cross-Browser Data</button>
        <button onclick="simulateSignatureCompletion()">Simulate Signature Completion</button>
        <button onclick="testDeliveryHistoryDisplay()">Test Delivery History Display</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h3>üìä Test Results</h3>
        <div id="testResults"></div>
    </div>
    
    <div class="test-section">
        <h3>üìù Test Log</h3>
        <div id="testLog" class="log"></div>
    </div>

    <!-- Load required scripts -->
    <script src="public/assets/js/date-field-mapping-fix.js"></script>
    
    <script>
        // Test logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<span style="color: ${colorMap[type] || '#333'}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        // Initialize test environment
        function initTestEnvironment() {
            log('üîß Initializing date field mapping test environment...', 'info');
            
            // Display browser information
            const browserInfo = document.getElementById('browserInfo');
            browserInfo.innerHTML = `
                <strong>Browser:</strong> ${navigator.userAgent}<br>
                <strong>Local Storage Available:</strong> ${typeof(Storage) !== "undefined" ? '‚úÖ Yes' : '‚ùå No'}<br>
                <strong>Current Time:</strong> ${new Date().toLocaleString()}
            `;
            
            // Initialize global arrays
            if (typeof window.activeDeliveries === 'undefined') {
                window.activeDeliveries = [];
                log('‚úÖ Initialized window.activeDeliveries array', 'success');
            }
            
            if (typeof window.deliveryHistory === 'undefined') {
                window.deliveryHistory = [];
                log('‚úÖ Initialized window.deliveryHistory array', 'success');
            }
            
            // Check if date field mapping fix is loaded
            if (typeof window.dateFieldMappingFix !== 'undefined') {
                log('‚úÖ Date field mapping fix loaded', 'success');
                log(`   Version: ${window.dateFieldMappingFix.version}`, 'info');
                log(`   Loaded at: ${window.dateFieldMappingFix.timestamp}`, 'info');
            } else {
                log('‚ùå Date field mapping fix NOT loaded', 'error');
            }
            
            // Check if functions are available
            const requiredFunctions = [
                'enhancedNormalizeDateFields',
                'enhancedLoadDeliveryHistory',
                'enhancedUpdateDeliveryStatusWithDates'
            ];
            
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    log(`‚úÖ Function ${funcName} available`, 'success');
                } else {
                    log(`‚ùå Function ${funcName} NOT available`, 'error');
                }
            });
        }
        
        // Test date normalization
        function testDateNormalization() {
            log('üß™ Testing date field normalization...', 'info');
            
            if (typeof window.enhancedNormalizeDateFields !== 'function') {
                log('‚ùå enhancedNormalizeDateFields function not available', 'error');
                return;
            }
            
            // Test delivery with various date field formats
            const testDeliveries = [
                {
                    id: 'test-1',
                    drNumber: 'DR001',
                    status: 'Completed',
                    completedDate: 'Dec 15, 2024'
                },
                {
                    id: 'test-2',
                    dr_number: 'DR002',
                    status: 'Completed',
                    completed_date: 'Dec 16, 2024'
                },
                {
                    id: 'test-3',
                    drNumber: 'DR003',
                    status: 'Completed',
                    signedAt: '2024-12-17T10:30:00Z'
                },
                {
                    id: 'test-4',
                    dr_number: 'DR004',
                    status: 'Completed',
                    createdDate: 'Dec 18, 2024'
                },
                {
                    id: 'test-5',
                    drNumber: 'DR005',
                    status: 'Completed'
                    // No date fields - should get current date
                }
            ];
            
            const results = [];
            
            testDeliveries.forEach((delivery, index) => {
                log(`üìù Testing delivery ${index + 1}: ${JSON.stringify(delivery)}`, 'info');
                
                const normalized = window.enhancedNormalizeDateFields(delivery);
                
                const result = {
                    drNumber: normalized.drNumber || normalized.dr_number,
                    originalDate: delivery.completedDate || delivery.completed_date || delivery.signedAt || delivery.createdDate || 'None',
                    normalizedCompletedDate: normalized.completedDate,
                    normalizedSignedAt: normalized.signedAt,
                    hasValidDate: !!(normalized.completedDate && normalized.completedDate !== '')
                };
                
                results.push(result);
                
                log(`üìù Result: ${JSON.stringify(result)}`, result.hasValidDate ? 'success' : 'warning');
            });
            
            // Display results in table
            displayTestResults(results);
            
            const passedTests = results.filter(r => r.hasValidDate).length;
            log(`‚úÖ Date normalization test completed: ${passedTests}/${results.length} passed`, 
                passedTests === results.length ? 'success' : 'warning');
        }
        
        // Test cross-browser data compatibility
        function testCrossBrowserData() {
            log('üß™ Testing cross-browser data compatibility...', 'info');
            
            // Create test data with various date formats
            const testData = [
                {
                    id: 'cross-1',
                    drNumber: 'DR-CROSS-001',
                    status: 'Completed',
                    completedDate: new Date().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    }),
                    customerName: 'Cross Browser Test 1'
                },
                {
                    id: 'cross-2',
                    dr_number: 'DR-CROSS-002',
                    status: 'Completed',
                    completed_date: new Date().toLocaleDateString(),
                    customer_name: 'Cross Browser Test 2'
                }
            ];
            
            // Save to localStorage
            try {
                localStorage.setItem('mci-delivery-history', JSON.stringify(testData));
                log('üíæ Saved test data to localStorage', 'success');
                
                // Immediately read back
                const readData = JSON.parse(localStorage.getItem('mci-delivery-history'));
                log(`üìñ Read back ${readData.length} items from localStorage`, 'success');
                
                // Test normalization on read data
                readData.forEach(delivery => {
                    const normalized = window.enhancedNormalizeDateFields(delivery);
                    log(`üìÖ ${normalized.drNumber || normalized.dr_number}: ${normalized.completedDate}`, 
                        normalized.completedDate && normalized.completedDate !== 'N/A' ? 'success' : 'error');
                });
                
            } catch (error) {
                log(`‚ùå Error with localStorage: ${error.message}`, 'error');
            }
        }
        
        // Simulate signature completion
        function simulateSignatureCompletion() {
            log('üß™ Simulating signature completion...', 'info');
            
            // Create active delivery
            const activeDelivery = {
                id: 'sim-1',
                drNumber: 'DR-SIM-001',
                customerName: 'Simulation Customer',
                status: 'Active',
                createdDate: new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                })
            };
            
            window.activeDeliveries = [activeDelivery];
            window.deliveryHistory = [];
            
            log(`üìù Created active delivery: ${activeDelivery.drNumber}`, 'info');
            
            // Simulate completion
            if (typeof window.enhancedUpdateDeliveryStatusWithDates === 'function') {
                const success = window.enhancedUpdateDeliveryStatusWithDates('DR-SIM-001', 'Completed');
                
                if (success) {
                    log('‚úÖ Signature completion simulation successful', 'success');
                    log(`üìä Active deliveries: ${window.activeDeliveries.length}`, 'info');
                    log(`üìä Delivery history: ${window.deliveryHistory.length}`, 'info');
                    
                    if (window.deliveryHistory.length > 0) {
                        const completedDelivery = window.deliveryHistory[0];
                        log(`üìÖ Completed delivery date: ${completedDelivery.completedDate}`, 
                            completedDelivery.completedDate && completedDelivery.completedDate !== 'N/A' ? 'success' : 'error');
                    }
                } else {
                    log('‚ùå Signature completion simulation failed', 'error');
                }
            } else {
                log('‚ùå enhancedUpdateDeliveryStatusWithDates function not available', 'error');
            }
        }
        
        // Test delivery history display
        function testDeliveryHistoryDisplay() {
            log('üß™ Testing delivery history display...', 'info');
            
            // Create mock delivery history table
            const testContainer = document.getElementById('testResults');
            testContainer.innerHTML = `
                <h4>Mock Delivery History Table</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>DR Number</th>
                            <th>Customer</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="mockDeliveryHistoryTableBody">
                    </tbody>
                </table>
            `;
            
            // Use current delivery history or create test data
            let historyData = window.deliveryHistory || [];
            
            if (historyData.length === 0) {
                historyData = [
                    {
                        drNumber: 'DR-TEST-001',
                        customerName: 'Test Customer 1',
                        status: 'Completed',
                        completedDate: 'Dec 15, 2024'
                    },
                    {
                        dr_number: 'DR-TEST-002',
                        customer_name: 'Test Customer 2',
                        status: 'Completed',
                        completed_date: 'Dec 16, 2024'
                    },
                    {
                        drNumber: 'DR-TEST-003',
                        customerName: 'Test Customer 3',
                        status: 'Completed',
                        signedAt: '2024-12-17T10:30:00Z'
                    }
                ];
            }
            
            const mockTableBody = document.getElementById('mockDeliveryHistoryTableBody');
            
            historyData.forEach(delivery => {
                const normalized = window.enhancedNormalizeDateFields(delivery);
                
                let displayDate = normalized.completedDate || 
                                 normalized.completed_date ||
                                 normalized.deliveryDate ||
                                 normalized.createdDate ||
                                 'N/A';
                
                // If still no date, try to parse from signedAt
                if (displayDate === 'N/A' && normalized.signedAt) {
                    try {
                        const signedDate = new Date(normalized.signedAt);
                        displayDate = signedDate.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    } catch (error) {
                        console.warn('Error parsing signedAt date:', error);
                    }
                }
                
                const row = document.createElement('tr');
                if (displayDate === 'N/A') {
                    row.classList.add('highlight');
                }
                
                row.innerHTML = `
                    <td><strong>${displayDate}</strong></td>
                    <td>${normalized.drNumber || normalized.dr_number}</td>
                    <td>${normalized.customerName || normalized.customer_name}</td>
                    <td>${normalized.status}</td>
                `;
                
                mockTableBody.appendChild(row);
                
                log(`üìÖ Display test - ${normalized.drNumber || normalized.dr_number}: ${displayDate}`, 
                    displayDate !== 'N/A' ? 'success' : 'error');
            });
            
            const validDates = historyData.filter(d => {
                const normalized = window.enhancedNormalizeDateFields(d);
                return normalized.completedDate && normalized.completedDate !== 'N/A';
            }).length;
            
            log(`‚úÖ Delivery history display test: ${validDates}/${historyData.length} have valid dates`, 
                validDates === historyData.length ? 'success' : 'warning');
        }
        
        // Display test results in table format
        function displayTestResults(results) {
            const testResults = document.getElementById('testResults');
            
            let tableHTML = `
                <h4>Date Normalization Test Results</h4>
                <table>
                    <thead>
                        <tr>
                            <th>DR Number</th>
                            <th>Original Date</th>
                            <th>Normalized Date</th>
                            <th>Signed At</th>
                            <th>Valid Date</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(result => {
                const rowClass = result.hasValidDate ? '' : 'highlight';
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${result.drNumber}</td>
                        <td>${result.originalDate}</td>
                        <td>${result.normalizedCompletedDate}</td>
                        <td>${result.normalizedSignedAt}</td>
                        <td>${result.hasValidDate ? '‚úÖ Yes' : '‚ùå No'}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            testResults.innerHTML = tableHTML;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initTestEnvironment, 500); // Give scripts time to load
        });
    </script>
</body>
</html>