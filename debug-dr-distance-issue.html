<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug DR Distance Issue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h2><i class="bi bi-bug"></i> Debug DR Distance Issue</h2>
        <p>This tool helps debug why all DR entries are getting the same distance (18.5 km).</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Sample Addresses</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testSampleAddresses()">
                            <i class="bi bi-search"></i> Test Common DR Addresses
                        </button>
                        <div id="sampleResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Your Excel Addresses</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Paste addresses from your Excel (one per line):</label>
                            <textarea class="form-control" id="excelAddresses" rows="5" 
                                placeholder="Paste your Excel destination addresses here..."></textarea>
                        </div>
                        <button class="btn btn-success" onclick="testExcelAddresses()">
                            <i class="bi bi-file-earmark-excel"></i> Test Excel Addresses
                        </button>
                        <div id="excelResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Geocoding Debug Results</h5>
            </div>
            <div class="card-body">
                <div id="debugResults"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Distance Calculation Check</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-warning" onclick="checkDistanceCalculation()">
                    <i class="bi bi-calculator"></i> Check Distance Calculation
                </button>
                <div id="distanceCheck" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Console Output</h5>
            </div>
            <div class="card-body">
                <div id="consoleOutput" class="bg-dark text-light p-3" style="font-family: monospace; height: 400px; overflow-y: auto;">
                    <!-- Console output will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const consoleOutput = document.getElementById('consoleOutput');
        
        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            let color = 'text-light';
            if (type === 'error') color = 'text-danger';
            else if (type === 'warn') color = 'text-warning';
            else if (type === 'success') color = 'text-success';
            
            consoleOutput.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };
        
        // Initialize global arrays
        window.activeDeliveries = [];
        
        async function testSampleAddresses() {
            const resultDiv = document.getElementById('sampleResults');
            resultDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Testing sample addresses...</div>';
            
            const sampleAddresses = [
                'Makati City, Metro Manila, Philippines',
                'Quezon City, Metro Manila, Philippines',
                'Las Pinas City, Metro Manila, Philippines',
                'Pasig City, Metro Manila, Philippines',
                'BGC, Taguig City, Metro Manila',
                'Ortigas Center, Pasig City, Metro Manila'
            ];
            
            try {
                console.log('=== TESTING SAMPLE ADDRESSES ===');
                
                let html = '<div class="table-responsive"><table class="table table-striped table-sm">';
                html += '<thead><tr><th>Address</th><th>Parsed</th><th>Coordinates</th><th>Distance</th><th>Issue?</th></tr></thead><tbody>';
                
                const results = [];
                
                for (const address of sampleAddresses) {
                    try {
                        console.log(`\n--- Testing: ${address} ---`);
                        
                        // Test parsing
                        const parsed = parseAddressForGeocoding ? parseAddressForGeocoding(address) : 'Function not available';
                        console.log(`Parsed: ${parsed}`);
                        
                        // Test geocoding
                        const coords = geocodeAddressWithParsing ? await geocodeAddressWithParsing(address) : { lat: 0, lng: 0 };
                        console.log(`Coordinates: ${coords.lat}, ${coords.lng}`);
                        
                        // Test distance calculation
                        const booking = {
                            drNumber: `TEST-${sampleAddresses.indexOf(address) + 1}`,
                            originWarehouse: 'SMEG Alabang warehouse',
                            destinationArea: address
                        };
                        
                        const distance = calculateDistanceForBooking ? await calculateDistanceForBooking(booking) : 0;
                        console.log(`Distance: ${distance} km`);
                        
                        results.push({ address, parsed, coords, distance });
                        
                        // Check for issues
                        const isDefaultCoords = (coords.lat === 14.5995 && coords.lng === 120.9842);
                        const isDuplicateDistance = results.filter(r => Math.abs(r.distance - distance) < 0.1).length > 1;
                        
                        let issue = '';
                        if (isDefaultCoords) issue += '‚ö†Ô∏è Default coords ';
                        if (isDuplicateDistance) issue += '‚ö†Ô∏è Duplicate distance ';
                        if (!issue) issue = '‚úÖ OK';
                        
                        html += `
                            <tr>
                                <td><small>${address}</small></td>
                                <td><code>${parsed}</code></td>
                                <td><code>${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}</code></td>
                                <td><span class="badge bg-primary">${distance.toFixed(2)} km</span></td>
                                <td>${issue}</td>
                            </tr>
                        `;
                        
                    } catch (error) {
                        console.error(`Error testing ${address}:`, error);
                        html += `
                            <tr>
                                <td><small>${address}</small></td>
                                <td colspan="4"><span class="text-danger">Error: ${error.message}</span></td>
                            </tr>
                        `;
                    }
                }
                
                html += '</tbody></table></div>';
                
                // Summary
                const uniqueDistances = [...new Set(results.map(r => Math.round(r.distance * 10) / 10))];
                if (uniqueDistances.length === 1) {
                    html += '<div class="alert alert-danger">üö® All distances are the same! This is the problem.</div>';
                } else {
                    html += `<div class="alert alert-success">‚úÖ Found ${uniqueDistances.length} unique distances</div>`;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Sample address test failed:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå Test failed: ${error.message}</div>`;
            }
        }
        
        async function testExcelAddresses() {
            const addresses = document.getElementById('excelAddresses').value.split('\n').filter(addr => addr.trim());
            const resultDiv = document.getElementById('excelResults');
            
            if (addresses.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please paste some addresses</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Testing your Excel addresses...</div>';
            
            try {
                console.log('=== TESTING EXCEL ADDRESSES ===');
                
                let html = '<div class="table-responsive"><table class="table table-striped table-sm">';
                html += '<thead><tr><th>#</th><th>Original Address</th><th>Parsed</th><th>Distance</th><th>Same as Others?</th></tr></thead><tbody>';
                
                const results = [];
                
                for (let i = 0; i < addresses.length; i++) {
                    const address = addresses[i].trim();
                    if (!address) continue;
                    
                    try {
                        console.log(`\n--- Testing Excel Address ${i + 1}: ${address} ---`);
                        
                        const parsed = parseAddressForGeocoding ? parseAddressForGeocoding(address) : 'Function not available';
                        console.log(`Parsed: ${parsed}`);
                        
                        const booking = {
                            drNumber: `EXCEL-${i + 1}`,
                            originWarehouse: 'SMEG Alabang warehouse',
                            destinationArea: address
                        };
                        
                        const distance = calculateDistanceForBooking ? await calculateDistanceForBooking(booking) : 0;
                        console.log(`Distance: ${distance} km`);
                        
                        results.push({ address, parsed, distance });
                        
                        // Check if this distance matches others
                        const sameDistanceCount = results.filter(r => Math.abs(r.distance - distance) < 0.1).length;
                        const isDuplicate = sameDistanceCount > 1;
                        
                        html += `
                            <tr>
                                <td>${i + 1}</td>
                                <td><small>${address}</small></td>
                                <td><code>${parsed}</code></td>
                                <td><span class="badge bg-primary">${distance.toFixed(2)} km</span></td>
                                <td>${isDuplicate ? `<span class="text-danger">‚ö†Ô∏è Same as ${sameDistanceCount - 1} others</span>` : '<span class="text-success">‚úÖ Unique</span>'}</td>
                            </tr>
                        `;
                        
                    } catch (error) {
                        console.error(`Error testing Excel address ${i + 1}:`, error);
                        html += `
                            <tr>
                                <td>${i + 1}</td>
                                <td><small>${address}</small></td>
                                <td colspan="3"><span class="text-danger">Error: ${error.message}</span></td>
                            </tr>
                        `;
                    }
                }
                
                html += '</tbody></table></div>';
                
                // Analysis
                const distances = results.map(r => r.distance);
                const uniqueDistances = [...new Set(distances.map(d => Math.round(d * 10) / 10))];
                
                if (uniqueDistances.length === 1) {
                    html += `<div class="alert alert-danger">üö® ALL ${results.length} addresses have the same distance: ${uniqueDistances[0]} km<br>This means geocoding is failing and using fallback coordinates!</div>`;
                } else {
                    html += `<div class="alert alert-success">‚úÖ Found ${uniqueDistances.length} unique distances out of ${results.length} addresses</div>`;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Excel address test failed:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå Test failed: ${error.message}</div>`;
            }
        }
        
        function checkDistanceCalculation() {
            const resultDiv = document.getElementById('distanceCheck');
            
            try {
                console.log('=== CHECKING DISTANCE CALCULATION ===');
                
                // Test the fallback coordinates (Manila)
                const manilaCoords = { lat: 14.5995, lng: 120.9842 };
                const alabangCoords = { lat: 14.444208, lng: 121.046787 };
                
                if (typeof calculateHaversineDistance === 'function') {
                    const fallbackDistance = calculateHaversineDistance(alabangCoords, manilaCoords);
                    console.log(`Distance from Alabang to Manila (fallback): ${fallbackDistance.toFixed(2)} km`);
                    
                    let html = `
                        <div class="alert alert-info">
                            <h6>Distance Calculation Check:</h6>
                            <strong>SMEG Alabang warehouse:</strong> ${alabangCoords.lat}, ${alabangCoords.lng}<br>
                            <strong>Manila (fallback coords):</strong> ${manilaCoords.lat}, ${manilaCoords.lng}<br>
                            <strong>Calculated distance:</strong> ${fallbackDistance.toFixed(2)} km
                        </div>
                    `;
                    
                    if (Math.abs(fallbackDistance - 18.5) < 1.0) {
                        html += '<div class="alert alert-danger">üéØ FOUND THE ISSUE! All addresses are falling back to Manila coordinates, giving ~18.5 km distance!</div>';
                    } else {
                        html += '<div class="alert alert-warning">The fallback distance doesn\'t match 18.5 km. The issue might be elsewhere.</div>';
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå calculateHaversineDistance function not available</div>';
                }
                
            } catch (error) {
                console.error('Distance calculation check failed:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå Check failed: ${error.message}</div>`;
            }
        }
        
        // Load the booking.js file
        const script = document.createElement('script');
        script.src = 'public/assets/js/booking.js';
        script.onload = function() {
            console.log('‚úÖ booking.js loaded');
            addToConsole('‚úÖ Debug tools ready - click buttons to test', 'success');
        };
        script.onerror = function() {
            console.error('‚ùå Failed to load booking.js');
            addToConsole('‚ùå Failed to load booking.js', 'error');
        };
        document.head.appendChild(script);
    </script>
</body>
</html>