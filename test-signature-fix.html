<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Pad Fix Test - MCI Delivery System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .signature-canvas { border: 2px solid #ddd; border-radius: 8px; }
        .status-log { background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-section">
            <h2><i class="bi bi-bug-fill text-danger"></i> Signature Pad Fix Test</h2>
            <p class="text-muted">Diagnosing and fixing the signature pad error that prevents deliveries from being marked as "Completed" and "Signed"</p>
            
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle"></i> Current Issue:</h5>
                <p><strong>Error:</strong> <code>signature_pad.ts:136 Uncaught (in promise) #&lt;Event&gt;n.onerror@signature_pad.ts:136</code></p>
                <p><strong>Problem:</strong> Items not being tagged as complete and signed after signature</p>
            </div>
        </div>

        <div class="test-section">
            <h4>Library Loading Test</h4>
            <div id="libraryStatus" class="row">
                <div class="col-md-6">
                    <h6>Required Libraries:</h6>
                    <ul id="libraryList" class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            SignaturePad
                            <span id="signaturePadStatus" class="badge bg-secondary">Checking...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Bootstrap
                            <span id="bootstrapStatus" class="badge bg-secondary">Checking...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            jQuery (if used)
                            <span id="jqueryStatus" class="badge bg-secondary">Checking...</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Function Availability:</h6>
                    <ul id="functionList" class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            updateDeliveryStatus
                            <span id="updateDeliveryStatusFunc" class="badge bg-secondary">Checking...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            openRobustSignaturePad
                            <span id="openRobustSignaturePadFunc" class="badge bg-secondary">Checking...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            saveRobustSignature
                            <span id="saveRobustSignatureFunc" class="badge bg-secondary">Checking...</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h4>Signature Pad Test</h4>
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label class="form-label">Test DR Number:</label>
                        <input type="text" id="testDrNumber" class="form-control" value="DR-TEST-001" placeholder="Enter DR number">
                    </div>
                    <div class="mb-3">
                        <canvas id="testSignaturePad" class="signature-canvas" width="600" height="200"></canvas>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="clearSignature" class="btn btn-outline-secondary">
                            <i class="bi bi-eraser"></i> Clear
                        </button>
                        <button id="testSaveSignature" class="btn btn-primary">
                            <i class="bi bi-save"></i> Test Save
                        </button>
                        <button id="simulateCompletion" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Simulate Completion
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>Test Results:</h6>
                    <div id="testResults" class="alert alert-info">
                        <p><strong>Status:</strong> Ready to test</p>
                        <p><strong>Instructions:</strong> Draw a signature and click "Test Save"</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h4>Status Update Test</h4>
            <div class="row">
                <div class="col-md-6">
                    <h6>Mock Active Delivery:</h6>
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">DR-TEST-001</h6>
                            <p class="card-text">
                                <strong>Customer:</strong> Test Customer<br>
                                <strong>Status:</strong> <span id="mockDeliveryStatus" class="badge bg-warning">In Transit</span>
                            </p>
                            <button id="testStatusUpdate" class="btn btn-sm btn-outline-primary">
                                Test Status Update
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Function Call Test:</h6>
                    <div class="d-flex flex-column gap-2">
                        <button id="testUpdateByDR" class="btn btn-outline-info btn-sm">
                            Test updateDeliveryStatus('DR-TEST-001', 'Completed')
                        </button>
                        <button id="testUpdateById" class="btn btn-outline-info btn-sm">
                            Test updateDeliveryStatusById('test-id', 'Completed')
                        </button>
                        <button id="testSignaturePadInit" class="btn btn-outline-info btn-sm">
                            Test Signature Pad Initialization
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h4>Debug Log</h4>
            <div id="debugLog" class="status-log">
                <div>Debug log initialized...</div>
            </div>
            <button id="clearLog" class="btn btn-sm btn-outline-secondary mt-2">Clear Log</button>
        </div>
    </div>

    <!-- Load SignaturePad library -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let testSignaturePad = null;
        let mockActiveDeliveries = [
            {
                id: 'test-id',
                drNumber: 'DR-TEST-001',
                customerName: 'Test Customer',
                status: 'In Transit'
            }
        ];

        // Debug logging function
        function debugLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
            log.innerHTML += `<div class="${typeClass}">[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Check library availability
        function checkLibraries() {
            debugLog('Checking library availability...');
            
            // SignaturePad
            const signaturePadStatus = document.getElementById('signaturePadStatus');
            if (typeof SignaturePad !== 'undefined') {
                signaturePadStatus.textContent = 'Available';
                signaturePadStatus.className = 'badge bg-success';
                debugLog('✅ SignaturePad library loaded successfully');
            } else {
                signaturePadStatus.textContent = 'Missing';
                signaturePadStatus.className = 'badge bg-danger';
                debugLog('❌ SignaturePad library not found', 'error');
            }

            // Bootstrap
            const bootstrapStatus = document.getElementById('bootstrapStatus');
            if (typeof bootstrap !== 'undefined') {
                bootstrapStatus.textContent = 'Available';
                bootstrapStatus.className = 'badge bg-success';
                debugLog('✅ Bootstrap library loaded successfully');
            } else {
                bootstrapStatus.textContent = 'Missing';
                bootstrapStatus.className = 'badge bg-danger';
                debugLog('❌ Bootstrap library not found', 'error');
            }

            // jQuery (optional)
            const jqueryStatus = document.getElementById('jqueryStatus');
            if (typeof $ !== 'undefined') {
                jqueryStatus.textContent = 'Available';
                jqueryStatus.className = 'badge bg-success';
                debugLog('✅ jQuery library loaded');
            } else {
                jqueryStatus.textContent = 'Not Used';
                jqueryStatus.className = 'badge bg-secondary';
                debugLog('ℹ️ jQuery not loaded (not required)');
            }
        }

        // Check function availability
        function checkFunctions() {
            debugLog('Checking function availability...');
            
            // updateDeliveryStatus
            const updateDeliveryStatusFunc = document.getElementById('updateDeliveryStatusFunc');
            if (typeof window.updateDeliveryStatus === 'function') {
                updateDeliveryStatusFunc.textContent = 'Available';
                updateDeliveryStatusFunc.className = 'badge bg-success';
                debugLog('✅ updateDeliveryStatus function available');
            } else {
                updateDeliveryStatusFunc.textContent = 'Missing';
                updateDeliveryStatusFunc.className = 'badge bg-danger';
                debugLog('❌ updateDeliveryStatus function not found', 'error');
            }

            // openRobustSignaturePad
            const openRobustSignaturePadFunc = document.getElementById('openRobustSignaturePadFunc');
            if (typeof window.openRobustSignaturePad === 'function') {
                openRobustSignaturePadFunc.textContent = 'Available';
                openRobustSignaturePadFunc.className = 'badge bg-success';
                debugLog('✅ openRobustSignaturePad function available');
            } else {
                openRobustSignaturePadFunc.textContent = 'Missing';
                openRobustSignaturePadFunc.className = 'badge bg-danger';
                debugLog('❌ openRobustSignaturePad function not found', 'error');
            }

            // saveRobustSignature
            const saveRobustSignatureFunc = document.getElementById('saveRobustSignatureFunc');
            if (typeof window.saveRobustSignature === 'function') {
                saveRobustSignatureFunc.textContent = 'Available';
                saveRobustSignatureFunc.className = 'badge bg-success';
                debugLog('✅ saveRobustSignature function available');
            } else {
                saveRobustSignatureFunc.textContent = 'Missing';
                saveRobustSignatureFunc.className = 'badge bg-danger';
                debugLog('❌ saveRobustSignature function not found', 'error');
            }
        }

        // Initialize test signature pad
        function initTestSignaturePad() {
            debugLog('Initializing test signature pad...');
            
            try {
                const canvas = document.getElementById('testSignaturePad');
                if (!canvas) {
                    debugLog('❌ Canvas element not found', 'error');
                    return false;
                }

                if (typeof SignaturePad === 'undefined') {
                    debugLog('❌ SignaturePad library not loaded', 'error');
                    return false;
                }

                // Clean up existing instance
                if (testSignaturePad) {
                    testSignaturePad.clear();
                    testSignaturePad = null;
                }

                // Create new instance
                testSignaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)',
                    minWidth: 1,
                    maxWidth: 3,
                    throttle: 16,
                    minDistance: 5
                });

                debugLog('✅ Test signature pad initialized successfully', 'success');
                return true;
            } catch (error) {
                debugLog(`❌ Error initializing signature pad: ${error.message}`, 'error');
                return false;
            }
        }

        // Mock updateDeliveryStatus function
        function updateDeliveryStatus(drNumber, newStatus) {
            debugLog(`📝 updateDeliveryStatus called: DR=${drNumber}, Status=${newStatus}`);
            
            // Find mock delivery
            const delivery = mockActiveDeliveries.find(d => d.drNumber === drNumber);
            if (delivery) {
                const oldStatus = delivery.status;
                delivery.status = newStatus;
                
                // Update UI
                const statusBadge = document.getElementById('mockDeliveryStatus');
                statusBadge.textContent = newStatus;
                statusBadge.className = newStatus === 'Completed' ? 'badge bg-success' : 'badge bg-warning';
                
                debugLog(`✅ Status updated: ${oldStatus} → ${newStatus}`, 'success');
                
                // Update test results
                document.getElementById('testResults').innerHTML = `
                    <p><strong>Status:</strong> ✅ Function called successfully</p>
                    <p><strong>DR Number:</strong> ${drNumber}</p>
                    <p><strong>New Status:</strong> ${newStatus}</p>
                    <p><strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
                `;
            } else {
                debugLog(`❌ Delivery ${drNumber} not found`, 'error');
            }
        }

        // Mock updateDeliveryStatusById function
        function updateDeliveryStatusById(deliveryId, newStatus) {
            debugLog(`📝 updateDeliveryStatusById called: ID=${deliveryId}, Status=${newStatus}`);
            
            // Find mock delivery
            const delivery = mockActiveDeliveries.find(d => d.id === deliveryId);
            if (delivery) {
                const oldStatus = delivery.status;
                delivery.status = newStatus;
                
                // Update UI
                const statusBadge = document.getElementById('mockDeliveryStatus');
                statusBadge.textContent = newStatus;
                statusBadge.className = newStatus === 'Completed' ? 'badge bg-success' : 'badge bg-warning';
                
                debugLog(`✅ Status updated by ID: ${oldStatus} → ${newStatus}`, 'success');
            } else {
                debugLog(`❌ Delivery with ID ${deliveryId} not found`, 'error');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM loaded, initializing tests...');
            
            // Check libraries and functions
            checkLibraries();
            checkFunctions();
            
            // Initialize signature pad
            setTimeout(() => {
                initTestSignaturePad();
            }, 500);

            // Clear signature
            document.getElementById('clearSignature').addEventListener('click', function() {
                if (testSignaturePad) {
                    testSignaturePad.clear();
                    debugLog('🧹 Signature cleared');
                }
            });

            // Test save signature
            document.getElementById('testSaveSignature').addEventListener('click', function() {
                debugLog('🧪 Testing signature save...');
                
                if (!testSignaturePad) {
                    debugLog('❌ Signature pad not initialized', 'error');
                    return;
                }

                if (testSignaturePad.isEmpty()) {
                    debugLog('❌ No signature to save', 'error');
                    document.getElementById('testResults').innerHTML = `
                        <p><strong>Status:</strong> ❌ Error</p>
                        <p><strong>Message:</strong> Please draw a signature first</p>
                    `;
                    return;
                }

                try {
                    const signatureData = testSignaturePad.toDataURL('image/png');
                    debugLog('✅ Signature data captured successfully', 'success');
                    
                    document.getElementById('testResults').innerHTML = `
                        <p><strong>Status:</strong> ✅ Success</p>
                        <p><strong>Data Length:</strong> ${signatureData.length} characters</p>
                        <p><strong>Format:</strong> PNG Base64</p>
                        <img src="${signatureData}" style="max-width: 200px; border: 1px solid #ddd; border-radius: 4px;">
                    `;
                } catch (error) {
                    debugLog(`❌ Error capturing signature: ${error.message}`, 'error');
                    document.getElementById('testResults').innerHTML = `
                        <p><strong>Status:</strong> ❌ Error</p>
                        <p><strong>Message:</strong> ${error.message}</p>
                    `;
                }
            });

            // Simulate completion
            document.getElementById('simulateCompletion').addEventListener('click', function() {
                debugLog('🎯 Simulating delivery completion...');
                
                const drNumber = document.getElementById('testDrNumber').value;
                if (!drNumber) {
                    debugLog('❌ No DR number provided', 'error');
                    return;
                }

                // Simulate the signature save and status update process
                if (testSignaturePad && !testSignaturePad.isEmpty()) {
                    const signatureData = testSignaturePad.toDataURL('image/png');
                    debugLog('📝 Signature captured for completion');
                    
                    // Call updateDeliveryStatus
                    updateDeliveryStatus(drNumber, 'Completed');
                    
                    debugLog('✅ Delivery completion simulation complete', 'success');
                } else {
                    debugLog('❌ No signature provided for completion', 'error');
                }
            });

            // Test function calls
            document.getElementById('testUpdateByDR').addEventListener('click', function() {
                updateDeliveryStatus('DR-TEST-001', 'Completed');
            });

            document.getElementById('testUpdateById').addEventListener('click', function() {
                updateDeliveryStatusById('test-id', 'Completed');
            });

            document.getElementById('testSignaturePadInit').addEventListener('click', function() {
                initTestSignaturePad();
            });

            // Clear log
            document.getElementById('clearLog').addEventListener('click', function() {
                document.getElementById('debugLog').innerHTML = '<div>Debug log cleared...</div>';
            });

            debugLog('🚀 Test environment initialized successfully', 'success');
        });

        // Make functions globally available for testing
        window.updateDeliveryStatus = updateDeliveryStatus;
        window.updateDeliveryStatusById = updateDeliveryStatusById;
    </script>
</body>
</html>