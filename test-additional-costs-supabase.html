<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Additional Costs Supabase Integration Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Additional Costs Supabase Integration Test</h1>
                
                <div class="alert alert-info">
                    <h5>Testing Additional Cost Breakdown Supabase Integration</h5>
                    <p>This page tests that additional cost breakdown data is saved to Supabase instead of localStorage.</p>
                    <p><strong>Features:</strong> Cost items table, automatic categorization, analytics integration</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Controls</h5>
                            </div>
                            <div class="card-body">
                                <button id="createTestDelivery" class="btn btn-primary mb-2">Create Test Delivery with Costs</button>
                                <button id="testCostItems" class="btn btn-success mb-2">Test Cost Items Save</button>
                                <button id="getCostAnalytics" class="btn btn-info mb-2">Get Cost Analytics</button>
                                <button id="testDataService" class="btn btn-warning mb-2">Test Enhanced DataService</button>
                                <button id="clearConsole" class="btn btn-secondary mb-2">Clear Console</button>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Test Results</h5>
                            </div>
                            <div class="card-body">
                                <div id="testResults" class="small" style="max-height: 300px; overflow-y: auto;">
                                    <p class="text-muted">Click test buttons to see results...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Cost Analytics Preview</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="testCostChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Cost Items Data</h5>
                            </div>
                            <div class="card-body">
                                <div id="costItemsDisplay" class="small">
                                    <p class="text-muted">No cost items loaded yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Configuration -->
    <script>
        // Supabase configuration
        window.SUPABASE_URL = 'https://ntyvrezyhrmflswxefbk.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50eXZyZXp5aHJtZmxzd3hlZmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA3MjU1NzQsImV4cCI6MjA0NjMwMTU3NH0.Ej5zJhOJGKJhq8Ej5zJhOJGKJhq8Ej5zJhOJGKJhq8E';
    </script>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Core Scripts -->
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    
    <!-- Fix Scripts -->
    <script src="public/assets/js/additional-costs-supabase-fix.js"></script>
    
    <script>
        let testResults = [];
        let testChart = null;
        
        function addTestResult(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push({ timestamp, message, type });
            updateTestResultsDisplay();
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateTestResultsDisplay() {
            const container = document.getElementById('testResults');
            container.innerHTML = testResults.map(result => {
                const badgeClass = {
                    'success': 'bg-success',
                    'error': 'bg-danger',
                    'warning': 'bg-warning',
                    'info': 'bg-info'
                }[result.type] || 'bg-secondary';
                
                return `
                    <div class="mb-1">
                        <span class="badge ${badgeClass}">${result.timestamp}</span>
                        <span class="ms-2">${result.message}</span>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        function displayCostItems(costItems) {
            const container = document.getElementById('costItemsDisplay');
            
            if (!costItems || costItems.length === 0) {
                container.innerHTML = '<p class="text-muted">No cost items to display</p>';
                return;
            }
            
            container.innerHTML = costItems.map(item => `
                <div class="border rounded p-2 mb-2">
                    <strong>${item.description}</strong><br>
                    <span class="text-success">‚Ç±${parseFloat(item.amount).toFixed(2)}</span>
                    <span class="badge bg-secondary ms-2">${item.category || 'Other'}</span>
                </div>
            `).join('');
        }
        
        function updateCostChart(analyticsData) {
            const ctx = document.getElementById('testCostChart');
            
            if (testChart) {
                testChart.destroy();
            }
            
            if (!analyticsData || !analyticsData.labels || analyticsData.labels.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            testChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: analyticsData.labels,
                    datasets: [{
                        data: analyticsData.values,
                        backgroundColor: analyticsData.colors || [
                            'rgba(243, 156, 18, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(155, 89, 182, 0.8)',
                            'rgba(149, 165, 166, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Create test delivery with costs
        document.getElementById('createTestDelivery').addEventListener('click', async function() {
            addTestResult('Creating test delivery with cost breakdown...', 'info');
            
            const testDelivery = {
                dr_number: 'TEST-COST-' + Date.now(),
                customer_name: 'Test Customer',
                vendor_number: '+63 999 123 4567',
                origin: 'Test Origin',
                destination: 'Test Destination',
                truck_type: 'Test Truck',
                truck_plate_number: 'TEST-123',
                status: 'Active',
                distance: '50 km',
                created_date: new Date().toISOString().split('T')[0],
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                created_by: 'Test',
                additionalCostItems: [
                    { description: 'Fuel Surcharge', amount: 500 },
                    { description: 'Toll Fees - SLEX', amount: 200 },
                    { description: 'Helper Assistance', amount: 300 },
                    { description: 'Special Handling', amount: 150 }
                ]
            };
            
            try {
                if (!window.dataService) {
                    throw new Error('DataService not available');
                }
                
                const savedDelivery = await window.dataService.saveDelivery(testDelivery);
                addTestResult(`‚úÖ Test delivery created: ${savedDelivery.dr_number}`, 'success');
                addTestResult(`üí∞ Cost items: ${testDelivery.additionalCostItems.length} items`, 'info');
                
                // Display the cost items
                displayCostItems(savedDelivery.additionalCostItems || testDelivery.additionalCostItems);
                
            } catch (error) {
                addTestResult(`‚ùå Failed to create test delivery: ${error.message}`, 'error');
                console.error('Test delivery creation error:', error);
            }
        });
        
        // Test cost items save
        document.getElementById('testCostItems').addEventListener('click', async function() {
            addTestResult('Testing direct cost items save...', 'info');
            
            const testCostItems = [
                { description: 'Gas Money', amount: 800 },
                { description: 'Skyway Toll', amount: 150 },
                { description: 'Overtime Helper', amount: 400 }
            ];
            
            try {
                // Create a dummy delivery ID for testing
                const testDeliveryId = 'test-delivery-' + Date.now();
                
                const savedCostItems = await window.saveAdditionalCostItems(testDeliveryId, testCostItems);
                addTestResult(`‚úÖ Cost items saved: ${savedCostItems.length} items`, 'success');
                
                // Display the saved cost items
                displayCostItems(savedCostItems);
                
            } catch (error) {
                addTestResult(`‚ùå Failed to save cost items: ${error.message}`, 'error');
                console.error('Cost items save error:', error);
            }
        });
        
        // Get cost analytics
        document.getElementById('getCostAnalytics').addEventListener('click', async function() {
            addTestResult('Getting cost breakdown analytics from Supabase...', 'info');
            
            try {
                const analyticsData = await window.getCostBreakdownAnalytics('month');
                addTestResult(`‚úÖ Analytics retrieved: ${analyticsData.labels.length} categories`, 'success');
                
                if (analyticsData.labels.length > 0) {
                    addTestResult(`üìä Categories: ${analyticsData.labels.join(', ')}`, 'info');
                    updateCostChart(analyticsData);
                } else {
                    addTestResult('üìä No analytics data available yet', 'warning');
                }
                
            } catch (error) {
                addTestResult(`‚ùå Failed to get analytics: ${error.message}`, 'error');
                console.error('Analytics error:', error);
            }
        });
        
        // Test enhanced dataService
        document.getElementById('testDataService').addEventListener('click', async function() {
            addTestResult('Testing enhanced dataService integration...', 'info');
            
            try {
                // Test getting deliveries with cost items
                const deliveries = await window.dataService.getDeliveries();
                addTestResult(`‚úÖ Retrieved ${deliveries.length} deliveries`, 'success');
                
                // Check if any deliveries have cost items
                const deliveriesWithCosts = deliveries.filter(d => d.additionalCostItems && d.additionalCostItems.length > 0);
                addTestResult(`üí∞ Deliveries with cost items: ${deliveriesWithCosts.length}`, 'info');
                
                if (deliveriesWithCosts.length > 0) {
                    const firstDelivery = deliveriesWithCosts[0];
                    addTestResult(`üìã Sample: ${firstDelivery.dr_number} has ${firstDelivery.additionalCostItems.length} cost items`, 'info');
                    displayCostItems(firstDelivery.additionalCostItems);
                }
                
            } catch (error) {
                addTestResult(`‚ùå DataService test failed: ${error.message}`, 'error');
                console.error('DataService test error:', error);
            }
        });
        
        // Clear console
        document.getElementById('clearConsole').addEventListener('click', function() {
            testResults = [];
            updateTestResultsDisplay();
            console.clear();
            addTestResult('Console cleared', 'info');
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('Additional Costs Supabase Integration Test initialized', 'success');
            addTestResult('Ready to test cost breakdown Supabase integration', 'info');
            
            // Check if fix is loaded
            if (window.additionalCostsSupabaseFix) {
                addTestResult('‚úÖ Additional Costs Supabase Fix loaded', 'success');
            } else {
                addTestResult('‚ö†Ô∏è Additional Costs Supabase Fix not detected', 'warning');
            }
        });
    </script>
</body>
</html>