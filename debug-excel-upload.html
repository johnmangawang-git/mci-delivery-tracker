<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Excel Upload Customer Creation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; font-size: 12px; }
        .instructions { background-color: #e7f3ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß Debug Excel Upload Customer Creation</h1>
    
    <div class="debug-section info">
        <h3>Debug Instructions</h3>
        <div class="instructions">
            <h4>How to use this debug page:</h4>
            <ol>
                <li><strong>Open this page in the same browser</strong> where you're testing Excel uploads</li>
                <li><strong>Click "Start Debug Monitoring"</strong> below</li>
                <li><strong>Go back to your main app</strong> and upload an Excel file</li>
                <li><strong>Come back to this page</strong> and check the debug log</li>
                <li><strong>The log will show</strong> exactly what happens during customer creation</li>
            </ol>
            <p><strong>Note:</strong> Keep this page open while testing Excel uploads to capture all debug information.</p>
        </div>
    </div>
    
    <div class="debug-section">
        <h3>üîç Debug Controls</h3>
        <button onclick="startDebugMonitoring()">Start Debug Monitoring</button>
        <button onclick="checkSystemStatus()">Check System Status</button>
        <button onclick="testCustomerCreation()">Test Customer Creation</button>
        <button onclick="clearDebugLog()">Clear Log</button>
        <div id="debugStatus"></div>
    </div>
    
    <div class="debug-section">
        <h3>üìä Current State</h3>
        <button onclick="showCurrentState()">Show Current State</button>
        <div id="currentState"></div>
    </div>
    
    <div class="debug-section">
        <h3>üìù Debug Log</h3>
        <div id="debugLog" class="log"></div>
    </div>

    <!-- Load all the same scripts as main app -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/customer-field-mapping-fix.js"></script>
    <script src="public/assets/js/booking-customer-integration-fix.js"></script>
    <script src="public/assets/js/supabase-only-customer-fix.js"></script>
    <script src="public/assets/js/excel-customer-creation-fix.js"></script>
    <script src="public/assets/js/excel-upload-customer-debug-fix.js"></script>
    
    <script>
        let debugMonitoring = false;
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;
        
        // Debug logging function
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<span style="color: ${colorMap[type] || '#333'}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        // Start debug monitoring
        function startDebugMonitoring() {
            if (debugMonitoring) {
                debugLog('Debug monitoring already active', 'warning');
                return;
            }
            
            debugMonitoring = true;
            debugLog('üîç DEBUG MONITORING STARTED', 'success');
            debugLog('Upload an Excel file in your main app now...', 'info');
            
            // Override console functions to capture logs
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
                if (message.includes('customer') || message.includes('Customer') || message.includes('autoCreate') || message.includes('Excel') || message.includes('DR')) {
                    debugLog(`LOG: ${message}`, 'info');
                }
            };
            
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
                debugLog(`ERROR: ${message}`, 'error');
            };
            
            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
                debugLog(`WARN: ${message}`, 'warning');
            };
            
            // Update status
            document.getElementById('debugStatus').innerHTML = `
                <div class="success" style="padding: 10px; border-radius: 5px; margin-top: 10px;">
                    <strong>‚úÖ Debug Monitoring Active</strong><br>
                    All customer-related console messages will appear in the debug log below.
                </div>
            `;
        }
        
        // Check system status
        function checkSystemStatus() {
            debugLog('üîç Checking system status...', 'info');
            
            const functions = [
                'autoCreateCustomer',
                'enhancedAutoCreateCustomer',
                'createBookingFromDR',
                'supabaseOnlyLoadCustomers',
                'debugExcelCustomerCreation'
            ];
            
            functions.forEach(funcName => {
                const available = typeof window[funcName] === 'function';
                debugLog(`${funcName}: ${available ? 'Available' : 'Not Available'}`, available ? 'success' : 'error');
            });
            
            // Check fixes
            const fixes = [
                'customerFieldMappingFix',
                'bookingCustomerIntegrationFix',
                'supabaseOnlyCustomerFix',
                'excelCustomerCreationFix',
                'excelUploadCustomerDebugFix'
            ];
            
            fixes.forEach(fixName => {
                const available = typeof window[fixName] !== 'undefined';
                debugLog(`${fixName}: ${available ? 'Loaded' : 'Not Loaded'}`, available ? 'success' : 'error');
            });
            
            // Check dataService
            if (window.dataService) {
                debugLog('dataService: Available', 'success');
                debugLog(`dataService.saveCustomer: ${typeof window.dataService.saveCustomer === 'function' ? 'Available' : 'Not Available'}`, 'info');
                debugLog(`dataService.getCustomers: ${typeof window.dataService.getCustomers === 'function' ? 'Available' : 'Not Available'}`, 'info');
            } else {
                debugLog('dataService: Not Available', 'error');
            }
            
            // Run debug function if available
            if (typeof window.debugExcelCustomerCreation === 'function') {
                debugLog('Running debugExcelCustomerCreation...', 'info');
                window.debugExcelCustomerCreation();
            }
        }
        
        // Test customer creation
        async function testCustomerCreation() {
            debugLog('üß™ Testing customer creation...', 'info');
            
            const testData = {
                customerName: 'Debug Test Customer',
                vendorNumber: '+63 917 999 0000',
                destination: 'Debug Test Destination'
            };
            
            debugLog(`Testing with: ${JSON.stringify(testData)}`, 'info');
            
            try {
                if (typeof window.autoCreateCustomer === 'function') {
                    debugLog('Calling autoCreateCustomer...', 'info');
                    const result = await window.autoCreateCustomer(testData.customerName, testData.vendorNumber, testData.destination);
                    
                    if (result) {
                        debugLog(`‚úÖ Customer creation successful: ${result.contactPerson || result.name}`, 'success');
                    } else {
                        debugLog('‚ùå Customer creation returned null', 'error');
                    }
                } else {
                    debugLog('‚ùå autoCreateCustomer function not available', 'error');
                }
            } catch (error) {
                debugLog(`‚ùå Customer creation error: ${error.message}`, 'error');
            }
        }
        
        // Show current state
        async function showCurrentState() {
            debugLog('üìä Showing current state...', 'info');
            
            const currentState = document.getElementById('currentState');
            let stateHtml = '<h4>Current System State:</h4>';
            
            // Window customers
            stateHtml += `<p><strong>window.customers:</strong> ${window.customers ? window.customers.length : 'undefined'} items</p>`;
            
            // localStorage
            try {
                const localCustomers = localStorage.getItem('mci-customers');
                const localCount = localCustomers ? JSON.parse(localCustomers).length : 0;
                stateHtml += `<p><strong>localStorage customers:</strong> ${localCount} items</p>`;
            } catch (error) {
                stateHtml += `<p><strong>localStorage customers:</strong> Error reading</p>`;
            }
            
            // Supabase
            if (window.dataService && typeof window.dataService.getCustomers === 'function') {
                try {
                    const supabaseCustomers = await window.dataService.getCustomers();
                    stateHtml += `<p><strong>Supabase customers:</strong> ${supabaseCustomers.length} items</p>`;
                    
                    if (supabaseCustomers.length > 0) {
                        stateHtml += '<h5>Supabase Customers:</h5><ul>';
                        supabaseCustomers.forEach(customer => {
                            stateHtml += `<li>${customer.name || customer.contactPerson} (${customer.phone}) - ${customer.notes || 'No notes'}</li>`;
                        });
                        stateHtml += '</ul>';
                    }
                } catch (error) {
                    stateHtml += `<p><strong>Supabase customers:</strong> Error: ${error.message}</p>`;
                }
            } else {
                stateHtml += `<p><strong>Supabase customers:</strong> DataService not available</p>`;
            }
            
            currentState.innerHTML = stateHtml;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                debugLog('üîß Debug page initialized', 'info');
                debugLog('Click "Start Debug Monitoring" then upload Excel in main app', 'info');
                checkSystemStatus();
            }, 1000);
        });
    </script>
</body>
</html>