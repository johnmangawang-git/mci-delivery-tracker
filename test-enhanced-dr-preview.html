<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced DR Preview Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Enhanced DR Preview Test</h2>
        <p>This test verifies the enhanced column mapping functionality for DR uploads.</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Data Upload</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testEnhancedMapping()">Test Enhanced Column Mapping</button>
                        <button class="btn btn-secondary ms-2" onclick="testFallbackMapping()">Test Fallback Mapping</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Database Schema</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="testSchemaUpdate()">Test Schema Update</button>
                        <div id="schemaResult" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Preview Table</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>DR Number</th>
                                        <th>Customer Name</th>
                                        <th>Vendor Number</th>
                                        <th>Origin</th>
                                        <th>Destination</th>
                                        <th>Delivery Date</th>
                                        <th>Status</th>
                                        <th>Item #</th>
                                        <th>Mobile#</th>
                                        <th>Item Description</th>
                                        <th>Serial Number</th>
                                    </tr>
                                </thead>
                                <tbody id="testPreviewTableBody">
                                    <!-- Test data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/enhanced-dr-preview.js"></script>
    
    <script>
        // Test data with various column naming conventions
        const testDataWithNames = [
            {
                'DR Number': 'DR-001',
                'Customer Name': 'SMEG Customer 1',
                'Vendor Number': 'V001',
                'Origin': 'SMEG Alabang',
                'Destination': 'Manila Office',
                'Item Number': 'ITM-001',
                'Mobile Number': '09171234567',
                'Item Description': 'Refrigerator Unit',
                'Serial Number': 'SN-001'
            },
            {
                'dr_number': 'DR-002',
                'customer_name': 'SMEG Customer 2',
                'vendor_number': 'V002',
                'origin': 'SMEG Cebu',
                'destination': 'Cebu Office',
                'item_number': 'ITM-002',
                'mobile_number': '09187654321',
                'item_description': 'Washing Machine',
                'serial_number': 'SN-002'
            }
        ];
        
        const testDataWithIndexes = [
            ['#', 'Doc', 'Status', 'DR-003', 'Date', 'Month', 'V003', 'SMEG Customer 3', 'Davao Office', 'ITM-003', '09191111111', 'Dishwasher', '', '', 'SN-003'],
            ['#', 'Doc', 'Status', 'DR-004', 'Date', 'Month', 'V004', 'SMEG Customer 4', 'Iloilo Office', 'ITM-004', '09192222222', 'Oven', '', '', 'SN-004']
        ];
        
        function testEnhancedMapping() {
            console.log('Testing enhanced column mapping...');
            
            const results = [];
            
            // Test named columns
            testDataWithNames.forEach((row, index) => {
                const itemNumber = window.getEnhancedColumnValue(row, [
                    'Item Number', 'Item number', 'item_number', 'Item #', 'Item#'
                ]);
                
                const mobileNumber = window.getEnhancedColumnValue(row, [
                    'Mobile Number', 'Mobile number', 'mobile_number', 'Mobile#'
                ]);
                
                const itemDescription = window.getEnhancedColumnValue(row, [
                    'Item Description', 'Item description', 'item_description', 'Description'
                ]);
                
                const serialNumber = window.getEnhancedColumnValue(row, [
                    'Serial Number', 'Serial number', 'serial_number', 'Serial'
                ]);
                
                results.push({
                    drNumber: row['DR Number'] || row['dr_number'],
                    customer: row['Customer Name'] || row['customer_name'],
                    vendor: row['Vendor Number'] || row['vendor_number'],
                    origin: row['Origin'] || row['origin'],
                    destination: row['Destination'] || row['destination'],
                    itemNumber,
                    mobileNumber,
                    itemDescription,
                    serialNumber
                });
            });
            
            populateTestTable(results);
            showTestResults('Enhanced mapping test completed successfully!', 'success');
        }
        
        function testFallbackMapping() {
            console.log('Testing fallback column mapping...');
            
            const results = [];
            
            // Test index-based columns
            testDataWithIndexes.forEach((row, index) => {
                const rowObj = {};
                row.forEach((value, idx) => {
                    rowObj[idx] = value;
                });
                
                const itemNumber = window.getEnhancedColumnValue(rowObj, [
                    'Item Number', 'Item number', 'item_number'
                ], 9);
                
                const mobileNumber = window.getEnhancedColumnValue(rowObj, [
                    'Mobile Number', 'Mobile number', 'mobile_number'
                ], 10);
                
                const itemDescription = window.getEnhancedColumnValue(rowObj, [
                    'Item Description', 'Item description', 'item_description'
                ], 11);
                
                const serialNumber = window.getEnhancedColumnValue(rowObj, [
                    'Serial Number', 'Serial number', 'serial_number'
                ], 14);
                
                results.push({
                    drNumber: row[3], // Column D
                    customer: row[7], // Column H
                    vendor: row[6],   // Column G
                    origin: 'SMEG Warehouse',
                    destination: row[8], // Column I
                    itemNumber,
                    mobileNumber,
                    itemDescription,
                    serialNumber
                });
            });
            
            populateTestTable(results);
            showTestResults('Fallback mapping test completed successfully!', 'success');
        }
        
        function populateTestTable(data) {
            const tableBody = document.getElementById('testPreviewTableBody');
            tableBody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.drNumber}</strong></td>
                    <td>${row.customer}</td>
                    <td>${row.vendor}</td>
                    <td>${row.origin}</td>
                    <td>${row.destination}</td>
                    <td>${new Date().toLocaleDateString()}</td>
                    <td><span class="badge bg-success">Active</span></td>
                    <td>${row.itemNumber}</td>
                    <td>${row.mobileNumber}</td>
                    <td>${row.itemDescription}</td>
                    <td>${row.serialNumber}</td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        function testSchemaUpdate() {
            const schemaResult = document.getElementById('schemaResult');
            schemaResult.innerHTML = `
                <div class="alert alert-info">
                    <h6>Schema Update Required:</h6>
                    <p>Run the following SQL in your Supabase SQL Editor:</p>
                    <code>
                        ALTER TABLE public.deliveries 
                        ADD COLUMN IF NOT EXISTS item_number TEXT,
                        ADD COLUMN IF NOT EXISTS mobile_number TEXT,
                        ADD COLUMN IF NOT EXISTS item_description TEXT,
                        ADD COLUMN IF NOT EXISTS serial_number TEXT;
                    </code>
                </div>
            `;
        }
        
        function showTestResults(message, type) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="bi bi-check-circle"></i> ${message}
                </div>
            `;
        }
        
        // Initialize test
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced DR Preview Test loaded');
            showTestResults('Test environment ready. Click buttons above to test functionality.', 'info');
        });
    </script>
</body>
</html>