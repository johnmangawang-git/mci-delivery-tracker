<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Complete Signature Flow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üß™ Test: Complete Signature Flow</h2>
        
        <div class="alert alert-info">
            <strong>Test Purpose:</strong> Verify the complete signature process from selection to delivery history movement.
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Active Deliveries</h5>
                        <span id="activeCount" class="badge bg-light text-dark">0</span>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: auto;">
                        <div id="activeList">No active deliveries</div>
                        <button class="btn btn-sm btn-success mt-2" onclick="addTestDelivery()">Add Test Delivery</button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>Delivery History</h5>
                        <span id="historyCount" class="badge bg-light text-dark">0</span>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: auto;">
                        <div id="historyList">No delivery history</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5>E-POD Records</h5>
                        <span id="epodCount" class="badge bg-dark text-light">0</span>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: auto;">
                        <div id="epodList">No E-POD records</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Signature Process Test</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Step 1: Select Delivery</h6>
                            <select id="deliverySelect" class="form-select mb-2">
                                <option value="">Select a delivery to sign</option>
                            </select>
                            <button class="btn btn-primary" onclick="simulateSignatureProcess()">
                                üñäÔ∏è Simulate Complete Signature Process
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>Process Status</h6>
                            <div id="processStatus" class="border p-2 bg-light" style="height: 100px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                                Ready to test...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Debug Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Available Functions</h6>
                            <div id="functionStatus" class="small"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Data Integrity</h6>
                            <div id="dataIntegrity" class="small"></div>
                        </div>
                    </div>
                    <button class="btn btn-info btn-sm mt-2" onclick="checkSystemStatus()">Check System Status</button>
                    <button class="btn btn-secondary btn-sm mt-2" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/signature-completion-fix.js"></script>
    <script>
        // Initialize arrays
        if (typeof window.activeDeliveries === 'undefined') {
            window.activeDeliveries = [];
        }
        if (typeof window.deliveryHistory === 'undefined') {
            window.deliveryHistory = [];
        }

        // Load existing data
        try {
            const savedActive = localStorage.getItem('mci-active-deliveries');
            const savedHistory = localStorage.getItem('mci-delivery-history');
            
            if (savedActive) {
                window.activeDeliveries = JSON.parse(savedActive);
            }
            if (savedHistory) {
                window.deliveryHistory = JSON.parse(savedHistory);
            }
        } catch (error) {
            console.error('Error loading data:', error);
        }

        // Status logging
        function logStatus(message, type = 'info') {
            const statusDiv = document.getElementById('processStatus');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            statusDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
            console.log(message);
        }

        function addTestDelivery() {
            const testDelivery = {
                id: 'test-' + Date.now(),
                drNumber: 'DR-TEST-' + Date.now(),
                customerName: 'Test Customer Inc.',
                vendorNumber: 'VN-TEST-001',
                truckPlateNumber: 'ABC-123',
                origin: 'Manila',
                destination: 'Quezon City',
                status: 'Active',
                createdDate: new Date().toLocaleDateString()
            };
            
            window.activeDeliveries.push(testDelivery);
            localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
            
            logStatus(`‚úÖ Added test delivery: ${testDelivery.drNumber}`, 'success');
            updateDisplay();
            updateDeliverySelect();
        }

        function simulateSignatureProcess() {
            const selectedDR = document.getElementById('deliverySelect').value;
            if (!selectedDR) {
                logStatus('‚ö†Ô∏è Please select a delivery first', 'warning');
                return;
            }
            
            logStatus(`üöÄ Starting signature process for: ${selectedDR}`, 'info');
            
            // Find the delivery
            const delivery = window.activeDeliveries.find(d => d.drNumber === selectedDR);
            if (!delivery) {
                logStatus(`‚ùå Delivery ${selectedDR} not found`, 'error');
                return;
            }
            
            logStatus('üìù Step 1: Creating E-POD record...', 'info');
            
            // Step 1: Create E-POD record (simulating signature capture)
            const ePodRecord = {
                drNumber: delivery.drNumber,
                customerName: delivery.customerName,
                customerContact: delivery.vendorNumber,
                truckPlate: delivery.truckPlateNumber,
                origin: delivery.origin,
                destination: delivery.destination,
                signature: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                status: 'Completed',
                signedAt: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            
            // Save E-POD record
            try {
                let ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                ePodRecords.push(ePodRecord);
                localStorage.setItem('ePodRecords', JSON.stringify(ePodRecords));
                logStatus(`‚úÖ E-POD record saved. Total: ${ePodRecords.length}`, 'success');
            } catch (error) {
                logStatus(`‚ùå Error saving E-POD: ${error.message}`, 'error');
                return;
            }
            
            logStatus('üîÑ Step 2: Processing signature completion...', 'info');
            
            // Step 2: Process signature completion
            if (typeof window.enhancedSaveSignature === 'function') {
                logStatus('üöÄ Using enhanced signature save function', 'info');
                
                const signatureInfo = {
                    drNumber: delivery.drNumber,
                    customerName: delivery.customerName,
                    customerContact: delivery.vendorNumber,
                    truckPlate: delivery.truckPlateNumber,
                    origin: delivery.origin,
                    destination: delivery.destination,
                    signatureData: ePodRecord.signature
                };
                
                const success = window.enhancedSaveSignature(signatureInfo);
                
                if (success) {
                    logStatus('‚úÖ Enhanced signature save successful!', 'success');
                    logStatus('üì¶ Delivery should now be in history', 'info');
                } else {
                    logStatus('‚ùå Enhanced signature save failed', 'error');
                }
            } else {
                logStatus('‚ö†Ô∏è Enhanced function not available, using fallback', 'warning');
                
                // Fallback to direct status update
                if (typeof window.updateDeliveryStatus === 'function') {
                    window.updateDeliveryStatus(delivery.drNumber, 'Completed');
                    logStatus('‚úÖ Fallback status update completed', 'success');
                } else {
                    logStatus('‚ùå No update function available', 'error');
                }
            }
            
            // Step 3: Verify the result
            setTimeout(() => {
                logStatus('üîç Step 3: Verifying results...', 'info');
                
                const stillInActive = window.activeDeliveries.find(d => d.drNumber === selectedDR);
                const nowInHistory = window.deliveryHistory.find(d => d.drNumber === selectedDR);
                
                if (!stillInActive && nowInHistory) {
                    logStatus('‚úÖ SUCCESS: Delivery moved to history!', 'success');
                } else if (stillInActive && !nowInHistory) {
                    logStatus('‚ùå FAILED: Delivery still in active deliveries', 'error');
                } else if (stillInActive && nowInHistory) {
                    logStatus('‚ö†Ô∏è WARNING: Delivery in both active and history', 'warning');
                } else {
                    logStatus('‚ùå ERROR: Delivery disappeared completely', 'error');
                }
                
                updateDisplay();
                updateDeliverySelect();
            }, 500);
        }

        function checkSystemStatus() {
            logStatus('üîç Checking system status...', 'info');
            
            // Check functions
            const functions = [
                'enhancedSaveSignature',
                'enhancedUpdateDeliveryStatus',
                'updateDeliveryStatus',
                'loadDeliveryHistory',
                'saveToLocalStorage'
            ];
            
            let functionStatus = '';
            functions.forEach(func => {
                const available = typeof window[func] === 'function';
                functionStatus += `<div>${func}: <span class="badge ${available ? 'bg-success' : 'bg-danger'}">${available ? 'Available' : 'Missing'}</span></div>`;
            });
            document.getElementById('functionStatus').innerHTML = functionStatus;
            
            // Check data integrity
            let dataIntegrity = '';
            try {
                const savedActive = localStorage.getItem('mci-active-deliveries');
                const savedHistory = localStorage.getItem('mci-delivery-history');
                const savedEPod = localStorage.getItem('ePodRecords');
                
                const activeCount = savedActive ? JSON.parse(savedActive).length : 0;
                const historyCount = savedHistory ? JSON.parse(savedHistory).length : 0;
                const epodCount = savedEPod ? JSON.parse(savedEPod).length : 0;
                
                dataIntegrity += `<div>Memory Active: ${window.activeDeliveries.length}</div>`;
                dataIntegrity += `<div>Storage Active: ${activeCount}</div>`;
                dataIntegrity += `<div>Memory History: ${window.deliveryHistory.length}</div>`;
                dataIntegrity += `<div>Storage History: ${historyCount}</div>`;
                dataIntegrity += `<div>E-POD Records: ${epodCount}</div>`;
                
                // Check for discrepancies
                if (window.activeDeliveries.length !== activeCount) {
                    dataIntegrity += `<div class="text-warning">‚ö†Ô∏è Active deliveries mismatch</div>`;
                }
                if (window.deliveryHistory.length !== historyCount) {
                    dataIntegrity += `<div class="text-warning">‚ö†Ô∏è History mismatch</div>`;
                }
                
            } catch (error) {
                dataIntegrity += `<div class="text-danger">‚ùå Error: ${error.message}</div>`;
            }
            
            document.getElementById('dataIntegrity').innerHTML = dataIntegrity;
        }

        function clearAllData() {
            window.activeDeliveries = [];
            window.deliveryHistory = [];
            localStorage.removeItem('mci-active-deliveries');
            localStorage.removeItem('mci-delivery-history');
            localStorage.removeItem('ePodRecords');
            
            logStatus('üóëÔ∏è All data cleared', 'info');
            updateDisplay();
            updateDeliverySelect();
        }

        function updateDisplay() {
            // Update active deliveries
            document.getElementById('activeCount').textContent = window.activeDeliveries.length;
            const activeList = document.getElementById('activeList');
            if (window.activeDeliveries.length === 0) {
                activeList.innerHTML = '<div class="text-muted">No active deliveries</div>';
            } else {
                activeList.innerHTML = window.activeDeliveries.map(d => 
                    `<div class="mb-1 p-2 border rounded">
                        <strong>${d.drNumber}</strong><br>
                        <small>${d.customerName} - ${d.status}</small>
                    </div>`
                ).join('');
            }
            
            // Update delivery history
            document.getElementById('historyCount').textContent = window.deliveryHistory.length;
            const historyList = document.getElementById('historyList');
            if (window.deliveryHistory.length === 0) {
                historyList.innerHTML = '<div class="text-muted">No delivery history</div>';
            } else {
                historyList.innerHTML = window.deliveryHistory.map(d => 
                    `<div class="mb-1 p-2 border rounded bg-light">
                        <strong>${d.drNumber}</strong><br>
                        <small>${d.customerName} - ${d.status}</small><br>
                        <small class="text-success">Completed: ${d.completedDate}</small>
                    </div>`
                ).join('');
            }
            
            // Update E-POD records
            try {
                const epodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                document.getElementById('epodCount').textContent = epodRecords.length;
                const epodList = document.getElementById('epodList');
                if (epodRecords.length === 0) {
                    epodList.innerHTML = '<div class="text-muted">No E-POD records</div>';
                } else {
                    epodList.innerHTML = epodRecords.map(r => 
                        `<div class="mb-1 p-2 border rounded bg-warning bg-opacity-25">
                            <strong>${r.drNumber}</strong><br>
                            <small>Signed: ${new Date(r.signedAt).toLocaleString()}</small>
                        </div>`
                    ).join('');
                }
            } catch (error) {
                document.getElementById('epodList').innerHTML = '<div class="text-danger">Error loading E-POD records</div>';
            }
        }

        function updateDeliverySelect() {
            const select = document.getElementById('deliverySelect');
            select.innerHTML = '<option value="">Select a delivery to sign</option>';
            
            window.activeDeliveries.forEach(delivery => {
                const option = document.createElement('option');
                option.value = delivery.drNumber;
                option.textContent = `${delivery.drNumber} - ${delivery.customerName}`;
                select.appendChild(option);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logStatus('üöÄ Test page loaded', 'info');
            updateDisplay();
            updateDeliverySelect();
            checkSystemStatus();
        });
    </script>
</body>
</html>