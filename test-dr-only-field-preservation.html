<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DR-Only Field Preservation Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="bi bi-database-check text-success"></i> DR-Only Field Preservation Test</h2>
        <p class="lead">Verify that Item #, Mobile #, Item Description, and Serial Number are preserved when moving to Delivery History</p>
        
        <div class="alert alert-info">
            <strong>Issue:</strong> Missing columns (Item #, Mobile #, Item Description, Serial Number) in Delivery History after e-signature completion.<br>
            <strong>Fix:</strong> Enhanced field preservation with dual naming convention support.
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-list-ul"></i> Test Data</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Test Scenario:</strong> DR-001 with complete field data</p>
                        <ul>
                            <li><strong>Item #:</strong> ITM-001, ITM-002</li>
                            <li><strong>Mobile #:</strong> 09171111111, 09172222222</li>
                            <li><strong>Item Description:</strong> Refrigerator, Washing Machine</li>
                            <li><strong>Serial #:</strong> SN-001, SN-002</li>
                        </ul>
                        
                        <button class="btn btn-primary" onclick="setupFieldTestData()">
                            <i class="bi bi-database-add"></i> Setup Test Data
                        </button>
                        <button class="btn btn-success" onclick="testFieldPreservation()">
                            <i class="bi bi-pen"></i> Test E-Signature
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-check-circle"></i> Expected Result</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>After e-signature:</strong></p>
                        <ul>
                            <li>✅ All fields preserved in Delivery History</li>
                            <li>✅ Item # visible in history table</li>
                            <li>✅ Mobile # visible in history table</li>
                            <li>✅ Item Description visible in history table</li>
                            <li>✅ Serial Number visible in history table</li>
                        </ul>
                        <div id="fieldTestResult"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list"></i> Active Deliveries</h5>
                        <span class="badge bg-primary" id="activeFieldCount">0</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>DR</th>
                                        <th>Item #</th>
                                        <th>Mobile #</th>
                                        <th>Item Desc</th>
                                        <th>Serial #</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="activeFieldTable">
                                    <!-- Active deliveries will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-clock-history"></i> Delivery History</h5>
                        <span class="badge bg-success" id="historyFieldCount">0</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-success">
                                <thead class="table-dark">
                                    <tr>
                                        <th>DR</th>
                                        <th>Item #</th>
                                        <th>Mobile #</th>
                                        <th>Item Desc</th>
                                        <th>Serial #</th>
                                        <th>Completed</th>
                                    </tr>
                                </thead>
                                <tbody id="historyFieldTable">
                                    <!-- Completed deliveries will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="bi bi-exclamation-triangle"></i> Field Verification</h5>
                    </div>
                    <div class="card-body">
                        <div id="fieldVerification">
                            <p class="text-muted">Run test to see field verification results</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="bi bi-terminal"></i> Field Preservation Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="fieldLog" class="bg-dark text-light p-3" style="font-family: monospace; height: 300px; overflow-y: auto;">
                            <!-- Field log will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/enhanced-group-signature-dr-only.js"></script>
    
    <script>
        // Test data with complete field information
        let fieldTestDeliveries = [
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-001',
                itemNumber: 'ITM-001',
                mobileNumber: '09171111111',
                itemDescription: 'Samsung Refrigerator 21cu ft',
                customerName: 'Customer A',
                vendorNumber: 'VND-001',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Manila Office'
            },
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-002',
                itemNumber: 'ITM-002',
                mobileNumber: '09172222222',
                itemDescription: 'LG Washing Machine 8kg',
                customerName: 'Customer B',
                vendorNumber: 'VND-002',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Cebu Office'
            }
        ];
        
        // Capture console output for field tracking
        const originalConsoleLog = console.log;
        const fieldLog = document.getElementById('fieldLog');
        
        function addToFieldLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'lightblue',
                success: 'lightgreen',
                warning: 'orange',
                error: 'lightcoral'
            };
            const color = colors[type] || 'lightblue';
            fieldLog.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            fieldLog.scrollTop = fieldLog.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToFieldLog(args.join(' '), 'info');
        };
        
        function setupFieldTestData() {
            addToFieldLog('🧪 Setting up field preservation test data...', 'info');
            
            // Reset global arrays
            window.activeDeliveries = [...fieldTestDeliveries];
            window.deliveryHistory = [];
            
            addToFieldLog(`✅ Field test data setup: ${fieldTestDeliveries.length} deliveries with complete field data`, 'success');
            
            updateFieldTables();
            showFieldResult('Field test data setup complete. All fields populated.', 'info');
        }
        
        function updateFieldTables() {
            const activeCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            const historyCount = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            // Update badges
            document.getElementById('activeFieldCount').textContent = activeCount;
            document.getElementById('historyFieldCount').textContent = historyCount;
            
            // Update active deliveries table
            const activeTable = document.getElementById('activeFieldTable');
            if (activeCount === 0) {
                activeTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No active deliveries</td></tr>';
            } else {
                activeTable.innerHTML = window.activeDeliveries.map(d => 
                    `<tr>
                        <td><strong>${d.drNumber}</strong></td>
                        <td>${d.itemNumber || d.item_number || 'N/A'}</td>
                        <td>${d.mobileNumber || d.mobile_number || 'N/A'}</td>
                        <td>${d.itemDescription || d.item_description || 'N/A'}</td>
                        <td>${d.serialNumber || d.serial_number || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="signFieldDelivery('${d.drNumber}')">
                                <i class="bi bi-pen"></i>
                            </button>
                        </td>
                    </tr>`
                ).join('');
            }
            
            // Update history table
            const historyTable = document.getElementById('historyFieldTable');
            if (historyCount === 0) {
                historyTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No completed deliveries</td></tr>';
            } else {
                historyTable.innerHTML = window.deliveryHistory.map(d => 
                    `<tr>
                        <td><strong>${d.drNumber}</strong></td>
                        <td>${d.itemNumber || d.item_number || 'N/A'}</td>
                        <td>${d.mobileNumber || d.mobile_number || 'N/A'}</td>
                        <td>${d.itemDescription || d.item_description || 'N/A'}</td>
                        <td>${d.serialNumber || d.serial_number || 'N/A'}</td>
                        <td><small>${d.completedDateTime || d.completedDate || 'N/A'}</small></td>
                    </tr>`
                ).join('');
            }
        }
        
        function signFieldDelivery(drNumber) {
            addToFieldLog(`🖊️ Signing delivery: ${drNumber} (Field Preservation Test)`, 'info');
            
            if (typeof window.enhancedUpdateDeliveryStatusDROnly === 'function') {
                window.enhancedUpdateDeliveryStatusDROnly(drNumber, 'Completed');
                
                // Check results after a short delay
                setTimeout(() => {
                    updateFieldTables();
                    verifyFieldPreservation();
                }, 500);
                
            } else {
                addToFieldLog('❌ Enhanced DR-only function not available', 'error');
                showFieldResult('Error: DR-Only function not loaded', 'danger');
            }
        }
        
        function testFieldPreservation() {
            addToFieldLog('🧪 Testing field preservation for DR-001...', 'info');
            
            if (!window.activeDeliveries || window.activeDeliveries.length === 0) {
                addToFieldLog('❌ No field test data available. Please setup test data first.', 'error');
                showFieldResult('Please setup field test data first before testing.', 'danger');
                return;
            }
            
            signFieldDelivery('DR-001');
        }
        
        function verifyFieldPreservation() {
            addToFieldLog('🔍 VERIFYING FIELD PRESERVATION:', 'info');
            
            const historyCount = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            if (historyCount === 0) {
                addToFieldLog('❌ No deliveries in history to verify', 'error');
                showFieldResult('❌ No deliveries moved to history', 'danger');
                return;
            }
            
            let allFieldsPreserved = true;
            let verificationResults = [];
            
            window.deliveryHistory.forEach((delivery, index) => {
                const drNumber = delivery.drNumber || delivery.dr_number;
                const itemNumber = delivery.itemNumber || delivery.item_number;
                const mobileNumber = delivery.mobileNumber || delivery.mobile_number;
                const itemDescription = delivery.itemDescription || delivery.item_description;
                const serialNumber = delivery.serialNumber || delivery.serial_number;
                
                const hasAllFields = itemNumber && mobileNumber && itemDescription && serialNumber;
                
                verificationResults.push({
                    drNumber,
                    itemNumber: itemNumber || 'MISSING',
                    mobileNumber: mobileNumber || 'MISSING',
                    itemDescription: itemDescription || 'MISSING',
                    serialNumber: serialNumber || 'MISSING',
                    hasAllFields
                });
                
                if (!hasAllFields) {
                    allFieldsPreserved = false;
                }
                
                addToFieldLog(`  Delivery ${index + 1} (${drNumber}): Item#=${itemNumber || 'MISSING'}, Mobile#=${mobileNumber || 'MISSING'}, Desc=${itemDescription || 'MISSING'}, Serial#=${serialNumber || 'MISSING'}`, hasAllFields ? 'success' : 'error');
            });
            
            // Display verification results
            const verificationDiv = document.getElementById('fieldVerification');
            verificationDiv.innerHTML = `
                <h6>Field Verification Results:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>DR</th>
                                <th>Item #</th>
                                <th>Mobile #</th>
                                <th>Item Desc</th>
                                <th>Serial #</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${verificationResults.map(result => `
                                <tr class="${result.hasAllFields ? 'table-success' : 'table-danger'}">
                                    <td>${result.drNumber}</td>
                                    <td>${result.itemNumber}</td>
                                    <td>${result.mobileNumber}</td>
                                    <td>${result.itemDescription}</td>
                                    <td>${result.serialNumber}</td>
                                    <td>
                                        <span class="badge ${result.hasAllFields ? 'bg-success' : 'bg-danger'}">
                                            ${result.hasAllFields ? '✅ Complete' : '❌ Missing Fields'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            if (allFieldsPreserved) {
                addToFieldLog('✅ FIELD PRESERVATION SUCCESS: All fields preserved correctly!', 'success');
                showFieldResult('✅ SUCCESS: All fields (Item #, Mobile #, Item Description, Serial Number) preserved in Delivery History!', 'success');
            } else {
                addToFieldLog('❌ FIELD PRESERVATION FAILED: Some fields are missing', 'error');
                showFieldResult('❌ FAILED: Some fields are missing in Delivery History', 'danger');
            }
        }
        
        function showFieldResult(message, type) {
            const resultDiv = document.getElementById('fieldTestResult');
            resultDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addToFieldLog('Field Preservation Test loaded', 'info');
            showFieldResult('Field test ready. Click "Setup Test Data" to begin.', 'info');
            updateFieldTables();
        });
    </script>
</body>
</html>