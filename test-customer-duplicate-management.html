<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Duplicate Management Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Customer Duplicate Management Test</h1>
                
                <div class="alert alert-info">
                    <h5>Testing Comprehensive Duplicate Management</h5>
                    <p>This page tests the advanced duplicate customer detection, merging, and prevention system.</p>
                    <p><strong>Features:</strong> Multi-criteria matching, intelligent merging, conflict resolution</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Controls</h5>
                            </div>
                            <div class="card-body">
                                <button id="createTestDuplicates" class="btn btn-warning mb-2">Create Test Duplicates</button>
                                <button id="detectDuplicates" class="btn btn-info mb-2">Detect Duplicates</button>
                                <button id="mergeDuplicates" class="btn btn-success mb-2">Merge Duplicates</button>
                                <button id="loadCustomersClean" class="btn btn-primary mb-2">Load Customers (Clean)</button>
                                <button id="clearAllCustomers" class="btn btn-danger mb-2">Clear All Customers</button>
                                <button id="clearConsole" class="btn btn-secondary mb-2">Clear Console</button>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div id="customerStats">
                                    <p class="mb-1">Total Customers: <span id="totalCustomers">0</span></p>
                                    <p class="mb-1">Unique Customers: <span id="uniqueCustomers">0</span></p>
                                    <p class="mb-1">Duplicate Groups: <span id="duplicateGroups">0</span></p>
                                    <p class="mb-0">Duplicates Merged: <span id="duplicatesMerged">0</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Results</h5>
                            </div>
                            <div class="card-body">
                                <div id="testResults" class="small" style="max-height: 300px; overflow-y: auto;">
                                    <p class="text-muted">Click test buttons to see results...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Customer List</h5>
                            </div>
                            <div class="card-body">
                                <div id="customersList" class="row">
                                    <div class="col-12 text-center py-3">
                                        <p class="text-muted">No customers loaded yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Configuration -->
    <script>
        // Supabase configuration
        window.SUPABASE_URL = 'https://ntyvrezyhrmflswxefbk.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50eXZyZXp5aHJtZmxzd3hlZmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA3MjU1NzQsImV4cCI6MjA0NjMwMTU3NH0.Ej5zJhOJGKJhq8Ej5zJhOJGKJhq8Ej5zJhOJGKJhq8E';
    </script>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Core Scripts -->
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/customers.js"></script>
    
    <!-- Fix Scripts -->
    <script src="public/assets/js/customer-field-mapping-fix.js"></script>
    <script src="public/assets/js/customer-supabase-schema-fix.js"></script>
    <script src="public/assets/js/customer-duplicate-management.js"></script>
    
    <script>
        let testResults = [];
        let testStats = {
            totalCustomers: 0,
            uniqueCustomers: 0,
            duplicateGroups: 0,
            duplicatesMerged: 0
        };
        
        function addTestResult(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push({ timestamp, message, type });
            updateTestResultsDisplay();
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateTestResultsDisplay() {
            const container = document.getElementById('testResults');
            container.innerHTML = testResults.map(result => {
                const badgeClass = {
                    'success': 'bg-success',
                    'error': 'bg-danger',
                    'warning': 'bg-warning',
                    'info': 'bg-info'
                }[result.type] || 'bg-secondary';
                
                return `
                    <div class="mb-1">
                        <span class="badge ${badgeClass}">${result.timestamp}</span>
                        <span class="ms-2">${result.message}</span>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        function updateStats() {
            document.getElementById('totalCustomers').textContent = testStats.totalCustomers;
            document.getElementById('uniqueCustomers').textContent = testStats.uniqueCustomers;
            document.getElementById('duplicateGroups').textContent = testStats.duplicateGroups;
            document.getElementById('duplicatesMerged').textContent = testStats.duplicatesMerged;
        }
        
        function displayCustomersList(customers) {
            const container = document.getElementById('customersList');
            
            if (!customers || customers.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-3"><p class="text-muted">No customers to display</p></div>';
                return;
            }
            
            container.innerHTML = customers.map(customer => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${customer.contactPerson || customer.name}</h6>
                            <p class="card-text small">
                                <i class="bi bi-telephone"></i> ${customer.phone}<br>
                                <i class="bi bi-envelope"></i> ${customer.email || 'No email'}<br>
                                <i class="bi bi-geo-alt"></i> ${customer.address || 'No address'}<br>
                                <i class="bi bi-calendar"></i> Bookings: ${customer.bookingsCount || 0}
                            </p>
                            <small class="text-muted">${customer.notes || 'No notes'}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Create test duplicates
        document.getElementById('createTestDuplicates').addEventListener('click', function() {
            addTestResult('Creating test duplicate customers...', 'info');
            
            const testCustomers = [
                // Exact duplicates
                {
                    id: 'TEST-001',
                    contactPerson: 'John Smith',
                    phone: '+63 917 123 4567',
                    email: 'john@example.com',
                    address: '123 Main St, Manila',
                    bookingsCount: 5,
                    notes: 'Regular customer'
                },
                {
                    id: 'TEST-002',
                    contactPerson: 'John Smith',
                    phone: '+63 917 123 4567',
                    email: 'john.smith@example.com',
                    address: '123 Main Street, Manila City',
                    bookingsCount: 3,
                    notes: 'VIP customer'
                },
                // Phone number variations
                {
                    id: 'TEST-003',
                    contactPerson: 'Maria Garcia',
                    phone: '09171234567',
                    email: 'maria@test.com',
                    address: '456 Oak Ave',
                    bookingsCount: 2
                },
                {
                    id: 'TEST-004',
                    contactPerson: 'Maria Garcia',
                    phone: '+639171234567',
                    email: 'maria.garcia@test.com',
                    address: '456 Oak Avenue, Quezon City',
                    bookingsCount: 4
                },
                // Similar names
                {
                    id: 'TEST-005',
                    contactPerson: 'Robert Johnson',
                    phone: '+63 918 555 1234',
                    email: 'rob@company.com',
                    address: '789 Pine St',
                    bookingsCount: 1
                },
                {
                    id: 'TEST-006',
                    contactPerson: 'Bob Johnson',
                    phone: '+63 918 555 1234',
                    email: 'robert@company.com',
                    address: '789 Pine Street, Makati',
                    bookingsCount: 6
                },
                // Unique customer (no duplicates)
                {
                    id: 'TEST-007',
                    contactPerson: 'Sarah Wilson',
                    phone: '+63 919 999 8888',
                    email: 'sarah@unique.com',
                    address: '321 Unique Ave',
                    bookingsCount: 2
                }
            ];
            
            // Add timestamps
            testCustomers.forEach(customer => {
                customer.createdAt = new Date().toISOString();
                customer.updatedAt = new Date().toISOString();
                customer.accountType = 'Individual';
                customer.status = 'active';
            });
            
            window.customers = testCustomers;
            testStats.totalCustomers = testCustomers.length;
            
            addTestResult(`✅ Created ${testCustomers.length} test customers with duplicates`, 'success');
            updateStats();
            displayCustomersList(testCustomers);
        });
        
        // Detect duplicates
        document.getElementById('detectDuplicates').addEventListener('click', function() {
            addTestResult('Detecting duplicate customers...', 'info');
            
            if (!window.customers || window.customers.length === 0) {
                addTestResult('❌ No customers to analyze', 'error');
                return;
            }
            
            try {
                const { duplicates, unique } = window.detectDuplicateCustomers(window.customers);
                
                testStats.duplicateGroups = duplicates.length;
                testStats.uniqueCustomers = unique.length;
                
                addTestResult(`🔍 Detection complete: ${duplicates.length} duplicate groups, ${unique.length} unique customers`, 'success');
                
                duplicates.forEach((group, index) => {
                    addTestResult(`  Group ${index + 1}: ${group.customers.length} duplicates`, 'info');
                });
                
                updateStats();
            } catch (error) {
                addTestResult(`❌ Detection failed: ${error.message}`, 'error');
            }
        });
        
        // Merge duplicates
        document.getElementById('mergeDuplicates').addEventListener('click', async function() {
            addTestResult('Merging duplicate customers...', 'info');
            
            if (!window.customers || window.customers.length === 0) {
                addTestResult('❌ No customers to merge', 'error');
                return;
            }
            
            try {
                const originalCount = window.customers.length;
                const cleanedCustomers = await window.manageDuplicatesForModal(window.customers);
                
                window.customers = cleanedCustomers;
                testStats.totalCustomers = cleanedCustomers.length;
                testStats.duplicatesMerged = originalCount - cleanedCustomers.length;
                
                addTestResult(`✅ Merge complete: ${originalCount} → ${cleanedCustomers.length} customers`, 'success');
                addTestResult(`🎯 Merged ${testStats.duplicatesMerged} duplicate records`, 'success');
                
                updateStats();
                displayCustomersList(cleanedCustomers);
            } catch (error) {
                addTestResult(`❌ Merge failed: ${error.message}`, 'error');
            }
        });
        
        // Load customers clean
        document.getElementById('loadCustomersClean').addEventListener('click', async function() {
            addTestResult('Loading customers with duplicate management...', 'info');
            
            try {
                const customers = await window.loadCustomersWithDuplicateManagement();
                
                testStats.totalCustomers = customers.length;
                testStats.uniqueCustomers = customers.length; // After cleaning
                testStats.duplicateGroups = 0; // After cleaning
                
                addTestResult(`✅ Loaded ${customers.length} clean customers`, 'success');
                
                updateStats();
                displayCustomersList(customers);
            } catch (error) {
                addTestResult(`❌ Load failed: ${error.message}`, 'error');
            }
        });
        
        // Clear all customers
        document.getElementById('clearAllCustomers').addEventListener('click', function() {
            window.customers = [];
            localStorage.removeItem('mci-customers');
            
            testStats = {
                totalCustomers: 0,
                uniqueCustomers: 0,
                duplicateGroups: 0,
                duplicatesMerged: 0
            };
            
            addTestResult('🗑️ All customers cleared', 'warning');
            updateStats();
            displayCustomersList([]);
        });
        
        // Clear console
        document.getElementById('clearConsole').addEventListener('click', function() {
            testResults = [];
            updateTestResultsDisplay();
            console.clear();
            addTestResult('Console cleared', 'info');
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('Customer Duplicate Management Test initialized', 'success');
            addTestResult('Ready to test duplicate detection and merging', 'info');
            updateStats();
        });
    </script>
</body>
</html>