<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Analytics Option C Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container mt-4">
        <h2>Test Analytics Dashboard - Option C Integration</h2>
        <p class="text-muted">This page tests that the Analytics Dashboard correctly shows cost data from DR uploads
            using Option C logic.</p>

        <div class="alert alert-info">
            <h5>Test Scenario:</h5>
            <p>Simulate DR upload with 3 records and ₱2,500 total costs:</p>
            <ul>
                <li><strong>DR001:</strong> Gets ₱2,500 (all costs) - Fuel: ₱1,500, Helper: ₱700, Toll: ₱300</li>
                <li><strong>DR002:</strong> Gets ₱0 (zero costs)</li>
                <li><strong>DR003:</strong> Gets ₱0 (zero costs)</li>
            </ul>
            <p><strong>Expected Analytics:</strong> Total Additional Cost = ₱2,500 (not ₱7,500)</p>
        </div>

        <!-- Mock Analytics Dashboard -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Bookings</h5>
                        <h2 class="metric-value text-primary">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Additional Cost</h5>
                        <h2 class="metric-value text-success">₱0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Avg Cost per Booking</h5>
                        <h2 class="metric-value">₱<span class="crossed-out">0.00</span></h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Additional Costs Analysis (Line Chart)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="costsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Cost Breakdown (Pie Chart)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="costBreakdownChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>Test Controls</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-primary btn-lg w-100 mb-2" onclick="simulateOptionCUpload()">
                            <i class="bi bi-upload"></i> Simulate Option C DR Upload
                        </button>
                        <button class="btn btn-success btn-lg w-100 mb-2" onclick="updateAnalyticsDashboard()">
                            <i class="bi bi-bar-chart"></i> Update Analytics Dashboard
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-warning btn-lg w-100 mb-2" onclick="showDataInspector()">
                            <i class="bi bi-search"></i> Inspect Data
                        </button>
                        <button class="btn btn-danger btn-lg w-100 mb-2" onclick="clearTestData()">
                            <i class="bi bi-trash"></i> Clear Test Data
                        </button>
                    </div>
                </div>

                <div id="dataInspector" class="mt-3" style="display: none;">
                    <h6>Data Inspector:</h6>
                    <pre id="dataInspectorContent" class="bg-light p-3"
                        style="font-size: 12px; max-height: 300px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div id="testResults" class="mt-3" style="display: none;">
            <div class="alert alert-success">
                <h6>✅ Test Results:</h6>
                <div id="testResultsContent"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Mock global variables
        window.activeDeliveries = [];
        window.deliveryHistory = [];

        let costsChart, costBreakdownChart;

        function simulateOptionCUpload() {
            console.log('🧪 Simulating Option C DR Upload...');

            // Clear existing data
            window.activeDeliveries = [];
            window.deliveryHistory = [];

            // Mock DR upload with Option C logic
            const mockDRData = [
                {
                    drNumber: 'DR001',
                    dr_number: 'DR001',
                    customerName: 'Customer A',
                    customer_name: 'Customer A',
                    vendorNumber: 'V001',
                    vendor_number: 'V001',
                    origin: 'SMEG Alabang warehouse',
                    destination: 'Manila',
                    status: 'Active',
                    deliveryDate: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    // OPTION C: First DR gets all costs
                    additionalCosts: 2500,
                    additional_costs: 2500,
                    additionalCostItems: [
                        { description: 'Fuel Surcharge', amount: 1500, category: 'Fuel Surcharge' },
                        { description: 'Helper Fee', amount: 700, category: 'Helper' },
                        { description: 'Toll Fee', amount: 300, category: 'Toll Fees' }
                    ]
                },
                {
                    drNumber: 'DR002',
                    dr_number: 'DR002',
                    customerName: 'Customer B',
                    customer_name: 'Customer B',
                    vendorNumber: 'V002',
                    vendor_number: 'V002',
                    origin: 'SMEG Alabang warehouse',
                    destination: 'Cebu',
                    status: 'Active',
                    deliveryDate: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    // OPTION C: Other DRs get zero costs
                    additionalCosts: 0,
                    additional_costs: 0,
                    additionalCostItems: []
                },
                {
                    drNumber: 'DR003',
                    dr_number: 'DR003',
                    customerName: 'Customer C',
                    customer_name: 'Customer C',
                    vendorNumber: 'V003',
                    vendor_number: 'V003',
                    origin: 'SMEG Alabang warehouse',
                    destination: 'Davao',
                    status: 'Active',
                    deliveryDate: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    // OPTION C: Other DRs get zero costs
                    additionalCosts: 0,
                    additional_costs: 0,
                    additionalCostItems: []
                }
            ];

            // Add to activeDeliveries
            window.activeDeliveries = mockDRData;

            console.log('✅ Option C DR Upload simulated:', window.activeDeliveries);

            // Show success message
            showAlert('success', 'Option C DR Upload simulated successfully! 3 DRs created with costs only on first DR.');
        }

        function updateAnalyticsDashboard() {
            console.log('📊 Updating Analytics Dashboard...');

            // Get data (same logic as analytics.js)
            const activeDeliveries = window.activeDeliveries || [];
            const deliveryHistory = window.deliveryHistory || [];
            const allDeliveries = [...activeDeliveries, ...deliveryHistory];

            // Calculate metrics
            const totalBookings = allDeliveries.length;
            let totalAdditionalCost = 0;

            allDeliveries.forEach(delivery => {
                if (typeof delivery.additionalCosts === 'number') {
                    totalAdditionalCost += delivery.additionalCosts;
                }
            });

            const avgCostPerBooking = totalBookings > 0 ? totalAdditionalCost / totalBookings : 0;

            // Update UI
            document.querySelector('.metric-card:nth-child(1) .metric-value').textContent = totalBookings;
            document.querySelector('.metric-card:nth-child(2) .metric-value').textContent = `₱${totalAdditionalCost.toLocaleString()}`;
            document.querySelector('.metric-card:nth-child(3) .metric-value .crossed-out').textContent = avgCostPerBooking.toFixed(2);

            // Update charts
            updateCharts(allDeliveries);

            // Show test results
            showTestResults(totalBookings, totalAdditionalCost, avgCostPerBooking);

            console.log('✅ Analytics Dashboard updated:', {
                totalBookings,
                totalAdditionalCost,
                avgCostPerBooking
            });
        }

        function updateCharts(deliveries) {
            // Costs Chart (Line Chart)
            const costsData = processDataForCostsChart(deliveries);

            if (costsChart) {
                costsChart.destroy();
            }

            const costsCtx = document.getElementById('costsChart');
            costsChart = new Chart(costsCtx, {
                type: 'line',
                data: {
                    labels: costsData.labels,
                    datasets: [{
                        label: 'Additional Costs (₱)',
                        data: costsData.values,
                        backgroundColor: 'rgba(243, 156, 18, 0.2)',
                        borderColor: 'rgba(243, 156, 18, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(243, 156, 18, 1)',
                        pointRadius: 4,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `₱${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return `₱${value.toLocaleString()}`;
                                }
                            }
                        }
                    }
                }
            });

            // Cost Breakdown Chart (Pie Chart)
            const breakdownData = processDataForBreakdownChart(deliveries);

            if (costBreakdownChart) {
                costBreakdownChart.destroy();
            }

            const breakdownCtx = document.getElementById('costBreakdownChart');
            costBreakdownChart = new Chart(breakdownCtx, {
                type: 'pie',
                data: {
                    labels: breakdownData.labels,
                    datasets: [{
                        data: breakdownData.values,
                        backgroundColor: [
                            'rgba(243, 156, 18, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(155, 89, 182, 0.8)',
                            'rgba(149, 165, 166, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((sum, value) => sum + value, 0);
                                    const currentValue = context.dataset.data[context.dataIndex];
                                    const percentage = total > 0 ? ((currentValue / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${percentage}% (₱${currentValue.toLocaleString()})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function processDataForCostsChart(deliveries) {
            // Simple daily data for demo
            const today = new Date();
            const labels = [];
            const values = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayKey = `${dayName} ${date.getMonth() + 1}/${date.getDate()}`;
                labels.push(dayKey);

                // Only today has costs (from our test data)
                if (i === 0) {
                    const totalCosts = deliveries.reduce((sum, d) => sum + (d.additionalCosts || 0), 0);
                    values.push(totalCosts);
                } else {
                    values.push(0);
                }
            }

            return { labels, values };
        }

        function processDataForBreakdownChart(deliveries) {
            const costBreakdown = {
                'Fuel Surcharge': 0,
                'Helper': 0,
                'Toll Fees': 0,
                'Other': 0
            };

            deliveries.forEach(delivery => {
                if (delivery.additionalCostItems && Array.isArray(delivery.additionalCostItems)) {
                    delivery.additionalCostItems.forEach(item => {
                        const category = item.category || 'Other';
                        costBreakdown[category] = (costBreakdown[category] || 0) + item.amount;
                    });
                }
            });

            const labels = Object.keys(costBreakdown).filter(key => costBreakdown[key] > 0);
            const values = labels.map(label => costBreakdown[label]);

            return { labels, values };
        }

        function showDataInspector() {
            const inspector = document.getElementById('dataInspector');
            const content = document.getElementById('dataInspectorContent');

            const data = {
                activeDeliveries: window.activeDeliveries,
                deliveryHistory: window.deliveryHistory,
                totalDeliveries: (window.activeDeliveries || []).length + (window.deliveryHistory || []).length
            };

            content.textContent = JSON.stringify(data, null, 2);
            inspector.style.display = inspector.style.display === 'none' ? 'block' : 'none';
        }

        function clearTestData() {
            window.activeDeliveries = [];
            window.deliveryHistory = [];

            // Reset UI
            document.querySelector('.metric-card:nth-child(1) .metric-value').textContent = '0';
            document.querySelector('.metric-card:nth-child(2) .metric-value').textContent = '₱0';
            document.querySelector('.metric-card:nth-child(3) .metric-value .crossed-out').textContent = '0.00';

            // Clear charts
            if (costsChart) costsChart.destroy();
            if (costBreakdownChart) costBreakdownChart.destroy();

            // Hide results
            document.getElementById('testResults').style.display = 'none';
            document.getElementById('dataInspector').style.display = 'none';

            showAlert('info', 'Test data cleared successfully!');
        }

        function showTestResults(totalBookings, totalAdditionalCost, avgCostPerBooking) {
            const resultsDiv = document.getElementById('testResults');
            const contentDiv = document.getElementById('testResultsContent');

            const isCorrect = totalBookings === 3 && totalAdditionalCost === 2500;

            contentDiv.innerHTML = `
                <p><strong>Total Bookings:</strong> ${totalBookings} ${totalBookings === 3 ? '✅' : '❌'}</p>
                <p><strong>Total Additional Cost:</strong> ₱${totalAdditionalCost.toLocaleString()} ${totalAdditionalCost === 2500 ? '✅' : '❌'}</p>
                <p><strong>Average Cost per Booking:</strong> ₱${avgCostPerBooking.toFixed(2)} ${Math.abs(avgCostPerBooking - 833.33) < 0.01 ? '✅' : '❌'}</p>
                <hr>
                <p><strong>Option C Test Result:</strong> ${isCorrect ? '✅ PASSED' : '❌ FAILED'}</p>
                ${isCorrect ?
                    '<p class="text-success">The analytics correctly shows ₱2,500 total cost (not inflated to ₱7,500)!</p>' :
                    '<p class="text-danger">The analytics is not showing the expected values.</p>'
                }
            `;

            resultsDiv.style.display = 'block';
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>

</html>