<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPOD Debug Check</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>EPOD Debug Check</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>Debug Information</h5>
            </div>
            <div class="card-body">
                <div id="debugInfo"></div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>Check Functions</h5>
            </div>
            <div class="card-body">
                <button id="checkLocalStorage" class="btn btn-primary me-2">Check LocalStorage</button>
                <button id="checkDataService" class="btn btn-secondary me-2">Check DataService</button>
                <button id="clearRecords" class="btn btn-danger">Clear EPOD Records</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>EPOD Records</h5>
            </div>
            <div class="card-body">
                <div id="epodRecords"></div>
            </div>
        </div>
    </div>

    <script>
        // Debug function to log information
        function log(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            debugInfo.appendChild(logEntry);
            console.log(`[${timestamp}] ${message}`);
            
            // Auto-scroll to bottom
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        // Check localStorage
        function checkLocalStorage() {
            log('=== Checking LocalStorage ===');
            
            try {
                const ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                log(`EPOD records in localStorage: ${ePodRecords.length}`);
                
                if (ePodRecords.length > 0) {
                    log('First record DR Number: ' + ePodRecords[0].drNumber);
                    log('First record signedAt: ' + ePodRecords[0].signedAt);
                }
                
                displayRecords(ePodRecords);
            } catch (error) {
                log(`Error accessing localStorage: ${error.message}`);
            }
        }
        
        // Check DataService
        function checkDataService() {
            log('=== Checking DataService ===');
            
            log('dataService available: ' + (typeof window.dataService !== 'undefined'));
            if (window.dataService) {
                log('dataService initialized: ' + (window.dataService.initialized || false));
                log('dataService supabase: ' + (window.dataService.supabase !== null));
                log('dataService.getEPodRecords available: ' + (typeof window.dataService.getEPodRecords === 'function'));
                log('dataService.saveEPodRecord available: ' + (typeof window.dataService.saveEPodRecord === 'function'));
            } else {
                log('dataService NOT available');
            }
        }
        
        // Clear EPOD records
        function clearRecords() {
            log('=== Clearing EPOD Records ===');
            try {
                localStorage.removeItem('ePodRecords');
                log('EPOD records cleared from localStorage');
                document.getElementById('epodRecords').innerHTML = '<div class="alert alert-success">Records cleared</div>';
            } catch (error) {
                log(`Error clearing localStorage: ${error.message}`);
            }
        }
        
        // Display records
        function displayRecords(records) {
            const container = document.getElementById('epodRecords');
            
            if (!records || records.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No EPOD records found</div>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>DR Number</th><th>Customer</th><th>Date</th><th>Method</th></tr></thead><tbody>';
            
            // Sort by date (newest first)
            const sortedRecords = [...records].sort((a, b) => 
                new Date(b.signedAt || b.timestamp) - new Date(a.signedAt || a.timestamp)
            );
            
            sortedRecords.forEach(record => {
                const date = new Date(record.signedAt || record.timestamp);
                const isTest = record.drNumber.includes('TEST');
                html += `<tr><td>${record.drNumber}</td><td>${record.customerName}</td><td>${date.toLocaleDateString()}</td><td><span class="badge ${isTest ? 'bg-warning' : 'bg-primary'}">${isTest ? 'Test' : 'Live'}</span></td></tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // Set up event listeners
        document.addEventListener('DOMContentLoaded', function() {
            log('EPOD Debug Check Loaded');
            
            document.getElementById('checkLocalStorage').addEventListener('click', checkLocalStorage);
            document.getElementById('checkDataService').addEventListener('click', checkDataService);
            document.getElementById('clearRecords').addEventListener('click', clearRecords);
            
            // Initial check
            setTimeout(checkLocalStorage, 1000);
        });
    </script>
</body>
</html>