<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DR-Only Group Signature - Complete Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="bi bi-pen-fill text-primary"></i> DR-Only Group Signature Test</h2>
        <p class="lead">Sign one DR ‚Üí Complete ALL deliveries with same DR number (different serials)</p>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-list-check"></i> Test Scenario: Identical DRs with Unique Serials</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Expected Behavior:</strong></p>
                        <ul>
                            <li>‚úÖ Sign DR-001 ‚Üí Complete ALL 4 deliveries with DR-001</li>
                            <li>‚úÖ Sign DR-002 ‚Üí Complete ALL 3 deliveries with DR-002</li>
                            <li>‚úÖ All completed deliveries move to Delivery History</li>
                        </ul>
                        
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-primary" onclick="setupTestData()">
                                <i class="bi bi-database-add"></i> Setup Test Data
                            </button>
                            <button class="btn btn-success" onclick="testDROnlySignature()">
                                <i class="bi bi-pen"></i> Test DR-001 Signature
                            </button>
                            <button class="btn btn-info" onclick="testSecondDR()">
                                <i class="bi bi-pen"></i> Test DR-002 Signature
                            </button>
                        </div>
                        
                        <div id="testResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="bi bi-graph-up"></i> Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testStats">
                            <p>Active Deliveries: <span id="activeCount" class="badge bg-warning">0</span></p>
                            <p>Completed Deliveries: <span id="completedCount" class="badge bg-success">0</span></p>
                            <p>Test Status: <span id="testStatus" class="badge bg-secondary">Ready</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-table"></i> Active Deliveries</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>DR Number</th>
                                        <th>Serial Number</th>
                                        <th>Customer</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="activeDeliveriesTable">
                                    <!-- Active deliveries will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-clock-history"></i> Delivery History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-success">
                                <thead class="table-dark">
                                    <tr>
                                        <th>DR Number</th>
                                        <th>Serial Number</th>
                                        <th>Customer</th>
                                        <th>Completed Date</th>
                                        <th>Method</th>
                                    </tr>
                                </thead>
                                <tbody id="deliveryHistoryTable">
                                    <!-- Completed deliveries will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="bi bi-terminal"></i> Test Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="testLog" class="bg-dark text-light p-3" style="font-family: monospace; height: 300px; overflow-y: auto;">
                            <!-- Test log will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/enhanced-group-signature-dr-only.js"></script>
    
    <script>
        // Test data: Multiple identical DRs with unique serial numbers
        let testDeliveries = [
            // DR-001: 4 deliveries with different serial numbers
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-001',
                customerName: 'SMEG Customer A',
                mobileNumber: '09171111111',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Manila Office'
            },
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-002',
                customerName: 'SMEG Customer B',
                mobileNumber: '09172222222',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Cebu Office'
            },
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-003',
                customerName: 'SMEG Customer C',
                mobileNumber: '09173333333',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Davao Office'
            },
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-004',
                customerName: 'SMEG Customer D',
                mobileNumber: '09174444444',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Iloilo Office'
            },
            // DR-002: 3 deliveries with different serial numbers
            {
                drNumber: 'DR-002',
                serialNumber: 'SN-005',
                customerName: 'SMEG Customer E',
                mobileNumber: '09175555555',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Baguio Office'
            },
            {
                drNumber: 'DR-002',
                serialNumber: 'SN-006',
                customerName: 'SMEG Customer F',
                mobileNumber: '09176666666',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Cagayan Office'
            },
            {
                drNumber: 'DR-002',
                serialNumber: 'SN-007',
                customerName: 'SMEG Customer G',
                mobileNumber: '09177777777',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Palawan Office'
            }
        ];
        
        // Capture console output
        const originalConsoleLog = console.log;
        const testLog = document.getElementById('testLog');
        
        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'lightblue',
                success: 'lightgreen',
                warning: 'orange',
                error: 'lightcoral'
            };
            const color = colors[type] || 'lightblue';
            testLog.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            testLog.scrollTop = testLog.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToLog(args.join(' '), 'info');
        };
        
        function setupTestData() {
            addToLog('üß™ Setting up test data for DR-Only Group Signature...', 'info');
            
            // Set up global arrays
            window.activeDeliveries = [...testDeliveries];
            window.deliveryHistory = [];
            
            // Populate tables
            populateActiveDeliveriesTable();
            populateDeliveryHistoryTable();
            updateTestStats();
            
            addToLog(`‚úÖ Test data setup complete: ${testDeliveries.length} deliveries`, 'success');
            showResult('Test data setup complete. Ready to test DR-Only group signature.', 'success');
        }
        
        function populateActiveDeliveriesTable() {
            const tableBody = document.getElementById('activeDeliveriesTable');
            tableBody.innerHTML = '';
            
            if (!window.activeDeliveries) return;
            
            window.activeDeliveries.forEach((delivery, index) => {
                const row = document.createElement('tr');
                const statusClass = delivery.status === 'Completed' ? 'table-success' : '';
                row.className = statusClass;
                
                row.innerHTML = `
                    <td><strong>${delivery.drNumber}</strong></td>
                    <td><span class="badge bg-info">${delivery.serialNumber}</span></td>
                    <td>${delivery.customerName}</td>
                    <td><span class="badge ${delivery.status === 'Completed' ? 'bg-success' : 'bg-warning'}">${delivery.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="signDelivery('${delivery.drNumber}')"
                                ${delivery.status === 'Completed' ? 'disabled' : ''}>
                            <i class="bi bi-pen"></i> Sign
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function populateDeliveryHistoryTable() {
            const tableBody = document.getElementById('deliveryHistoryTable');
            tableBody.innerHTML = '';
            
            if (!window.deliveryHistory || window.deliveryHistory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No completed deliveries</td></tr>';
                return;
            }
            
            window.deliveryHistory.forEach((delivery) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${delivery.drNumber}</strong></td>
                    <td><span class="badge bg-success">${delivery.serialNumber}</span></td>
                    <td>${delivery.customerName}</td>
                    <td>${delivery.completedDate || 'Just now'}</td>
                    <td><small>${delivery.completionMethod || 'Manual'}</small></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateTestStats() {
            const activeCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            const completedCount = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('completedCount').textContent = completedCount;
        }
        
        function signDelivery(drNumber) {
            addToLog(`üñäÔ∏è Signing delivery: ${drNumber} (DR-Only Mode)`, 'info');
            
            if (typeof window.enhancedUpdateDeliveryStatusDROnly === 'function') {
                window.enhancedUpdateDeliveryStatusDROnly(drNumber, 'Completed');
                
                // Update tables after a short delay
                setTimeout(() => {
                    populateActiveDeliveriesTable();
                    populateDeliveryHistoryTable();
                    updateTestStats();
                    analyzeResults(drNumber);
                }, 500);
                
            } else {
                addToLog('‚ùå Enhanced group signature (DR-Only) function not available', 'error');
                showResult('Error: DR-Only group signature function not loaded', 'danger');
            }
        }
        
        function testDROnlySignature() {
            addToLog('üß™ Testing DR-Only group signature for DR-001...', 'info');
            
            if (!window.activeDeliveries || window.activeDeliveries.length === 0) {
                addToLog('‚ùå No test data available. Please setup test data first.', 'error');
                showResult('Please setup test data first before testing.', 'danger');
                return;
            }
            
            // Test signing DR-001 (should complete all 4 DR-001 deliveries)
            signDelivery('DR-001');
        }
        
        function testSecondDR() {
            addToLog('üß™ Testing DR-Only group signature for DR-002...', 'info');
            signDelivery('DR-002');
        }
        
        function analyzeResults(drNumber) {
            const activeCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            const completedCount = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            addToLog('üìä ANALYSIS RESULTS:', 'info');
            addToLog(`  Active deliveries remaining: ${activeCount}`, 'info');
            addToLog(`  Completed deliveries: ${completedCount}`, 'info');
            
            // Count how many deliveries were completed for this DR
            const completedForDR = window.deliveryHistory ? 
                window.deliveryHistory.filter(d => d.drNumber === drNumber).length : 0;
            
            addToLog(`  Completed for ${drNumber}: ${completedForDR}`, 'info');
            
            if (drNumber === 'DR-001' && completedForDR === 4) {
                addToLog('‚úÖ TEST PASSED: All 4 DR-001 deliveries completed', 'success');
                showResult('‚úÖ DR-001 TEST PASSED: All 4 deliveries with DR-001 completed successfully!', 'success');
                document.getElementById('testStatus').textContent = 'DR-001 Passed';
                document.getElementById('testStatus').className = 'badge bg-success';
            } else if (drNumber === 'DR-002' && completedForDR === 3) {
                addToLog('‚úÖ TEST PASSED: All 3 DR-002 deliveries completed', 'success');
                showResult('‚úÖ DR-002 TEST PASSED: All 3 deliveries with DR-002 completed successfully!', 'success');
                document.getElementById('testStatus').textContent = 'All Tests Passed';
                document.getElementById('testStatus').className = 'badge bg-success';
            } else {
                addToLog(`‚ùå TEST FAILED: Expected completions not met for ${drNumber}`, 'error');
                showResult(`‚ùå TEST FAILED: Expected completions not met for ${drNumber}`, 'danger');
                document.getElementById('testStatus').textContent = 'Test Failed';
                document.getElementById('testStatus').className = 'badge bg-danger';
            }
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addToLog('DR-Only Group Signature Test loaded', 'info');
            showResult('Test environment ready. Click "Setup Test Data" to begin.', 'info');
            updateTestStats();
        });
    </script>
</body>
</html>