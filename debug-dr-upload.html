<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug DR Upload Issue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h2><i class="bi bi-bug"></i> DR Upload Debug Tool</h2>
        <p>This tool helps debug why DR uploads aren't showing in active deliveries.</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Debug Information</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info mb-3" onclick="checkStatus()">
                            <i class="bi bi-info-circle"></i> Check Status
                        </button>
                        <div id="debugInfo">
                            <p class="text-muted">Click "Check Status" to see debug information</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="createTestDR()">
                            <i class="bi bi-plus-circle"></i> Create Test DR Entry
                        </button>
                        <br>
                        <button class="btn btn-success mb-2" onclick="refreshViews()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Views
                        </button>
                        <br>
                        <button class="btn btn-warning mb-2" onclick="clearData()">
                            <i class="bi bi-trash"></i> Clear All Data
                        </button>
                        <br>
                        <button class="btn btn-secondary" onclick="fixKeys()">
                            <i class="bi bi-wrench"></i> Fix localStorage Keys
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Current Active Deliveries</h5>
            </div>
            <div class="card-body">
                <div id="activeDeliveriesList">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize global arrays
        if (!window.activeDeliveries) {
            window.activeDeliveries = [];
        }
        
        function checkStatus() {
            const debugInfo = document.getElementById('debugInfo');
            
            // Check global array
            const globalCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            
            // Check localStorage keys
            const mciKey = localStorage.getItem('mci-active-deliveries');
            const altKey = localStorage.getItem('activeDeliveries');
            
            const mciCount = mciKey ? JSON.parse(mciKey).length : 0;
            const altCount = altKey ? JSON.parse(altKey).length : 0;
            
            // Check for DR entries
            const drEntries = window.activeDeliveries ? 
                window.activeDeliveries.filter(d => d.source === 'DR_UPLOAD') : [];
            
            debugInfo.innerHTML = `
                <div class="alert alert-info">
                    <h6>Global Array Status:</h6>
                    <ul>
                        <li><strong>window.activeDeliveries:</strong> ${globalCount} items</li>
                        <li><strong>DR Upload entries:</strong> ${drEntries.length} items</li>
                    </ul>
                    
                    <h6>localStorage Status:</h6>
                    <ul>
                        <li><strong>mci-active-deliveries:</strong> ${mciCount} items</li>
                        <li><strong>activeDeliveries:</strong> ${altCount} items</li>
                    </ul>
                    
                    <h6>Functions Available:</h6>
                    <ul>
                        <li><strong>loadActiveDeliveries:</strong> ${typeof window.loadActiveDeliveries}</li>
                        <li><strong>debugDRUpload:</strong> ${typeof window.debugDRUpload}</li>
                    </ul>
                </div>
            `;
            
            updateActiveDeliveriesList();
        }
        
        function createTestDR() {
            const testDR = {
                id: 'TEST_DR_' + Date.now(),
                drNumber: 'TEST-DR-001',
                customerName: 'Test Customer',
                customerNumber: '09123456789',
                origin: 'SMEG Alabang warehouse',
                destination: 'Test Destination',
                deliveryDate: new Date().toISOString().split('T')[0],
                // distance field removed
                status: 'Pending',
                timestamp: new Date().toISOString(),
                source: 'DR_UPLOAD'
            };
            
            if (!window.activeDeliveries) {
                window.activeDeliveries = [];
            }
            
            window.activeDeliveries.push(testDR);
            
            // Save to both localStorage keys
            localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
            localStorage.setItem('activeDeliveries', JSON.stringify(window.activeDeliveries));
            
            alert('Test DR entry created!');
            checkStatus();
        }
        
        function refreshViews() {
            if (typeof window.loadActiveDeliveries === 'function') {
                window.loadActiveDeliveries();
                alert('Active deliveries view refreshed!');
            } else {
                alert('loadActiveDeliveries function not available');
            }
        }
        
        function clearData() {
            if (confirm('Are you sure you want to clear all data?')) {
                window.activeDeliveries = [];
                localStorage.removeItem('mci-active-deliveries');
                localStorage.removeItem('activeDeliveries');
                alert('All data cleared!');
                checkStatus();
            }
        }
        
        function fixKeys() {
            // Load from any available key and sync both
            let data = [];
            
            const mciData = localStorage.getItem('mci-active-deliveries');
            const altData = localStorage.getItem('activeDeliveries');
            
            if (mciData) {
                data = JSON.parse(mciData);
            } else if (altData) {
                data = JSON.parse(altData);
            }
            
            // Update both keys and global array
            window.activeDeliveries = data;
            localStorage.setItem('mci-active-deliveries', JSON.stringify(data));
            localStorage.setItem('activeDeliveries', JSON.stringify(data));
            
            alert('localStorage keys synchronized!');
            checkStatus();
        }
        
        function updateActiveDeliveriesList() {
            const listDiv = document.getElementById('activeDeliveriesList');
            
            if (!window.activeDeliveries || window.activeDeliveries.length === 0) {
                listDiv.innerHTML = '<p class="text-muted">No active deliveries found</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>ID</th><th>DR Number</th><th>Customer</th><th>Destination</th><th>Source</th></tr></thead><tbody>';
            
            window.activeDeliveries.forEach(delivery => {
                html += `<tr>
                    <td>${delivery.id || 'N/A'}</td>
                    <td>${delivery.drNumber || 'N/A'}</td>
                    <td>${delivery.customerName || 'N/A'}</td>
                    <td>${delivery.destination || 'N/A'}</td>
                    <td><span class="badge ${delivery.source === 'DR_UPLOAD' ? 'bg-primary' : 'bg-secondary'}">${delivery.source || 'MANUAL'}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            listDiv.innerHTML = html;
        }
        
        // Load initial status
        setTimeout(checkStatus, 1000);
    </script>
</body>
</html>