<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Data Flow Debug - MCI Delivery System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .debug-container { max-width: 1400px; margin: 0 auto; }
        .debug-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .debug-log { background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 11px; max-height: 400px; overflow-y: auto; }
        .status-good { color: #28a745; font-weight: bold; }
        .status-bad { color: #dc3545; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
        .data-display { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .step-indicator { display: inline-block; width: 20px; height: 20px; border-radius: 50%; background: #6c757d; color: white; text-align: center; line-height: 20px; font-size: 12px; margin-right: 8px; }
        .step-success { background: #28a745; }
        .step-error { background: #dc3545; }
        .step-warning { background: #ffc107; }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="debug-section">
            <h2><i class="bi bi-search text-primary"></i> Booking Data Flow Deep Investigation</h2>
            <p class="text-muted">Comprehensive analysis of why bookings aren't appearing in Active Deliveries</p>
            
            <div class="alert alert-danger">
                <h5><i class="bi bi-exclamation-triangle"></i> Current Issue:</h5>
                <p><strong>Problem:</strong> Bookings show "successful confirmation" but don't appear in Active Deliveries</p>
                <p><strong>Status:</strong> Need to trace the complete data flow from booking save to display</p>
            </div>
        </div>

        <div class="debug-section">
            <h4>Step-by-Step Data Flow Analysis</h4>
            <div id="dataFlowSteps" class="mb-3">
                <div class="mb-2">
                    <span class="step-indicator" id="step1">1</span>
                    <strong>Global Arrays Initialization</strong>
                    <span id="step1Status" class="ms-2">Checking...</span>
                </div>
                <div class="mb-2">
                    <span class="step-indicator" id="step2">2</span>
                    <strong>saveBooking Function Availability</strong>
                    <span id="step2Status" class="ms-2">Checking...</span>
                </div>
                <div class="mb-2">
                    <span class="step-indicator" id="step3">3</span>
                    <strong>Data Addition to window.activeDeliveries</strong>
                    <span id="step3Status" class="ms-2">Pending...</span>
                </div>
                <div class="mb-2">
                    <span class="step-indicator" id="step4">4</span>
                    <strong>localStorage Save Operation</strong>
                    <span id="step4Status" class="ms-2">Pending...</span>
                </div>
                <div class="mb-2">
                    <span class="step-indicator" id="step5">5</span>
                    <strong>loadActiveDeliveries Function Call</strong>
                    <span id="step5Status" class="ms-2">Pending...</span>
                </div>
                <div class="mb-2">
                    <span class="step-indicator" id="step6">6</span>
                    <strong>Data Loading in loadActiveDeliveries</strong>
                    <span id="step6Status" class="ms-2">Pending...</span>
                </div>
                <div class="mb-2">
                    <span class="step-indicator" id="step7">7</span>
                    <strong>Table Population</strong>
                    <span id="step7Status" class="ms-2">Pending...</span>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h4>Current System State</h4>
            <div class="row">
                <div class="col-md-4">
                    <h6>Global Variables:</h6>
                    <div class="data-display" id="globalVarsDisplay">Loading...</div>
                </div>
                <div class="col-md-4">
                    <h6>localStorage Data:</h6>
                    <div class="data-display" id="localStorageDisplay">Loading...</div>
                </div>
                <div class="col-md-4">
                    <h6>Function Availability:</h6>
                    <div class="data-display" id="functionsDisplay">Loading...</div>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h4>Live Booking Test</h4>
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h6>Simulate Complete Booking Flow</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">DR Number:</label>
                                        <input type="text" id="testDrNumber" class="form-control" value="DR-DEBUG-001">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Customer Name:</label>
                                        <input type="text" id="testCustomerName" class="form-control" value="Debug Customer">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Vendor Number:</label>
                                        <input type="text" id="testVendorNumber" class="form-control" value="VN-001">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Origin:</label>
                                        <input type="text" id="testOrigin" class="form-control" value="Manila">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Destination:</label>
                                        <input type="text" id="testDestination" class="form-control" value="Quezon City">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Truck Type:</label>
                                        <input type="text" id="testTruckType" class="form-control" value="10-Wheeler">
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button id="simulateFullBooking" class="btn btn-primary">
                                    <i class="bi bi-play-circle"></i> Simulate Full Booking Flow
                                </button>
                                <button id="testLoadActiveDeliveries" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> Test loadActiveDeliveries
                                </button>
                                <button id="inspectActiveDeliveriesTable" class="btn btn-outline-info">
                                    <i class="bi bi-table"></i> Inspect Table Element
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>Test Results:</h6>
                    <div id="testResults" class="alert alert-info">
                        <p><strong>Status:</strong> Ready for testing</p>
                        <p><strong>Instructions:</strong> Click "Simulate Full Booking Flow"</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h4>Active Deliveries Table Investigation</h4>
            <div class="row">
                <div class="col-md-6">
                    <h6>Table Element Status:</h6>
                    <div id="tableElementStatus" class="data-display">Checking...</div>
                </div>
                <div class="col-md-6">
                    <h6>Current Table Content:</h6>
                    <div id="currentTableContent" class="data-display">Loading...</div>
                </div>
            </div>
            <div class="mt-3">
                <h6>Live Table Preview:</h6>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>DR Number</th>
                                <th>Customer</th>
                                <th>Origin</th>
                                <th>Destination</th>
                                <th>Status</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody id="debugActiveDeliveriesTable">
                            <tr>
                                <td colspan="6" class="text-center text-muted">No data loaded yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h4>Detailed Debug Log</h4>
            <div id="debugLog" class="debug-log">
                <div>Debug log initialized...</div>
            </div>
            <div class="mt-2">
                <button id="clearLog" class="btn btn-sm btn-outline-secondary">Clear Log</button>
                <button id="exportLog" class="btn btn-sm btn-outline-primary">Export Log</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Debug logging function
        function debugLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = type === 'error' ? 'status-bad' : type === 'success' ? 'status-good' : type === 'warning' ? 'status-warning' : '';
            log.innerHTML += `<div class="${typeClass}">[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Update step status
        function updateStepStatus(stepNum, status, message) {
            const stepElement = document.getElementById(`step${stepNum}`);
            const statusElement = document.getElementById(`step${stepNum}Status`);
            
            stepElement.className = `step-indicator step-${status}`;
            statusElement.innerHTML = `<span class="status-${status}">${message}</span>`;
        }

        // Check system initialization
        function checkSystemInitialization() {
            debugLog('🔍 Starting system initialization check...');
            
            // Step 1: Global Arrays
            if (typeof window.activeDeliveries !== 'undefined') {
                updateStepStatus(1, 'success', `✅ Available (${window.activeDeliveries.length} items)`);
                debugLog(`✅ window.activeDeliveries: ${window.activeDeliveries.length} items`, 'success');
            } else {
                updateStepStatus(1, 'error', '❌ Not Available');
                debugLog('❌ window.activeDeliveries not available', 'error');
                // Initialize for testing
                window.activeDeliveries = [];
                debugLog('🔧 Initialized window.activeDeliveries for testing');
            }

            // Step 2: saveBooking Function
            if (typeof window.saveBooking === 'function') {
                updateStepStatus(2, 'success', '✅ Available');
                debugLog('✅ saveBooking function available', 'success');
            } else {
                updateStepStatus(2, 'error', '❌ Not Available');
                debugLog('❌ saveBooking function not available', 'error');
            }

            updateSystemStateDisplays();
        }

        // Update system state displays
        function updateSystemStateDisplays() {
            // Global Variables
            const globalVarsDisplay = document.getElementById('globalVarsDisplay');
            globalVarsDisplay.innerHTML = `
window.activeDeliveries: ${typeof window.activeDeliveries !== 'undefined' ? window.activeDeliveries.length + ' items' : 'undefined'}
window.deliveryHistory: ${typeof window.deliveryHistory !== 'undefined' ? window.deliveryHistory.length + ' items' : 'undefined'}
window.loadActiveDeliveries: ${typeof window.loadActiveDeliveries === 'function' ? 'function available' : 'not available'}
            `;

            // localStorage Data
            const localStorageDisplay = document.getElementById('localStorageDisplay');
            try {
                const activeData = localStorage.getItem('mci-active-deliveries');
                const historyData = localStorage.getItem('mci-delivery-history');
                localStorageDisplay.innerHTML = `
mci-active-deliveries: ${activeData ? JSON.parse(activeData).length + ' items' : 'empty'}
mci-delivery-history: ${historyData ? JSON.parse(historyData).length + ' items' : 'empty'}
Total localStorage keys: ${localStorage.length}
                `;
            } catch (error) {
                localStorageDisplay.innerHTML = `Error reading localStorage: ${error.message}`;
            }

            // Functions
            const functionsDisplay = document.getElementById('functionsDisplay');
            functionsDisplay.innerHTML = `
saveBooking: ${typeof window.saveBooking === 'function' ? '✅ Available' : '❌ Missing'}
loadActiveDeliveries: ${typeof window.loadActiveDeliveries === 'function' ? '✅ Available' : '❌ Missing'}
updateDeliveryStatus: ${typeof window.updateDeliveryStatus === 'function' ? '✅ Available' : '❌ Missing'}
            `;
        }

        // Simulate full booking flow
        function simulateFullBookingFlow() {
            debugLog('🧪 Starting full booking flow simulation...');
            
            // Reset steps
            for (let i = 3; i <= 7; i++) {
                updateStepStatus(i, '', 'Pending...');
            }

            // Step 3: Add data to window.activeDeliveries
            debugLog('📝 Step 3: Adding data to window.activeDeliveries...');
            
            if (typeof window.activeDeliveries === 'undefined') {
                window.activeDeliveries = [];
                debugLog('🔧 Initialized window.activeDeliveries');
            }

            const testBooking = {
                id: 'DEL-' + Date.now() + '-DEBUG',
                drNumber: document.getElementById('testDrNumber').value,
                customerName: document.getElementById('testCustomerName').value,
                vendorNumber: document.getElementById('testVendorNumber').value,
                origin: document.getElementById('testOrigin').value,
                destination: document.getElementById('testDestination').value,
                truckType: document.getElementById('testTruckType').value,
                truckPlateNumber: 'DEBUG-123',
                status: 'On Schedule',
                deliveryDate: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString(),
                source: 'DEBUG_TEST'
            };

            const beforeCount = window.activeDeliveries.length;
            window.activeDeliveries.push(testBooking);
            const afterCount = window.activeDeliveries.length;

            if (afterCount > beforeCount) {
                updateStepStatus(3, 'success', `✅ Added (${beforeCount} → ${afterCount})`);
                debugLog(`✅ Successfully added booking. Count: ${beforeCount} → ${afterCount}`, 'success');
            } else {
                updateStepStatus(3, 'error', '❌ Failed to add');
                debugLog('❌ Failed to add booking to array', 'error');
                return;
            }

            // Step 4: Save to localStorage
            debugLog('💾 Step 4: Saving to localStorage...');
            try {
                localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
                
                // Verify save
                const saved = localStorage.getItem('mci-active-deliveries');
                const parsed = JSON.parse(saved);
                
                if (parsed.length === afterCount) {
                    updateStepStatus(4, 'success', `✅ Saved (${parsed.length} items)`);
                    debugLog(`✅ Successfully saved to localStorage: ${parsed.length} items`, 'success');
                } else {
                    updateStepStatus(4, 'error', '❌ Save verification failed');
                    debugLog('❌ localStorage save verification failed', 'error');
                }
            } catch (error) {
                updateStepStatus(4, 'error', '❌ Save failed');
                debugLog(`❌ localStorage save failed: ${error.message}`, 'error');
            }

            // Step 5: Call loadActiveDeliveries
            debugLog('🔄 Step 5: Calling loadActiveDeliveries...');
            if (typeof window.loadActiveDeliveries === 'function') {
                try {
                    window.loadActiveDeliveries();
                    updateStepStatus(5, 'success', '✅ Function called');
                    debugLog('✅ loadActiveDeliveries function called successfully', 'success');
                    
                    // Step 6: Check if data loaded
                    setTimeout(() => {
                        debugLog('🔍 Step 6: Checking data loading...');
                        
                        // Check if the function actually used our data
                        const tableBody = document.getElementById('activeDeliveriesTableBody');
                        if (tableBody) {
                            const rows = tableBody.querySelectorAll('tr');
                            const hasData = rows.length > 0 && !rows[0].textContent.includes('No active deliveries');
                            
                            if (hasData) {
                                updateStepStatus(6, 'success', '✅ Data loaded');
                                debugLog('✅ Data successfully loaded in loadActiveDeliveries', 'success');
                            } else {
                                updateStepStatus(6, 'error', '❌ No data in function');
                                debugLog('❌ loadActiveDeliveries did not load our data', 'error');
                            }
                        } else {
                            updateStepStatus(6, 'warning', '⚠️ Table not found');
                            debugLog('⚠️ activeDeliveriesTableBody element not found', 'warning');
                        }

                        // Step 7: Check table population
                        setTimeout(() => {
                            debugLog('📊 Step 7: Checking table population...');
                            inspectActiveDeliveriesTable();
                        }, 500);
                    }, 200);
                    
                } catch (error) {
                    updateStepStatus(5, 'error', '❌ Function error');
                    debugLog(`❌ Error calling loadActiveDeliveries: ${error.message}`, 'error');
                }
            } else {
                updateStepStatus(5, 'error', '❌ Function not available');
                debugLog('❌ loadActiveDeliveries function not available', 'error');
            }

            // Update displays
            updateSystemStateDisplays();
            updateDebugTable();

            // Test results
            document.getElementById('testResults').innerHTML = `
                <p><strong>Status:</strong> 🧪 Test completed</p>
                <p><strong>DR Number:</strong> ${testBooking.drNumber}</p>
                <p><strong>Array Count:</strong> ${window.activeDeliveries.length}</p>
                <p><strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
            `;
        }

        // Inspect Active Deliveries table
        function inspectActiveDeliveriesTable() {
            debugLog('🔍 Inspecting Active Deliveries table...');
            
            const tableBody = document.getElementById('activeDeliveriesTableBody');
            const tableElementStatus = document.getElementById('tableElementStatus');
            const currentTableContent = document.getElementById('currentTableContent');
            
            if (tableBody) {
                const rows = tableBody.querySelectorAll('tr');
                tableElementStatus.innerHTML = `
✅ Table found
Element ID: activeDeliveriesTableBody
Rows count: ${rows.length}
Parent element: ${tableBody.parentElement ? tableBody.parentElement.tagName : 'none'}
                `;
                
                let contentPreview = '';
                if (rows.length === 0) {
                    contentPreview = 'No rows in table';
                } else if (rows.length === 1 && rows[0].textContent.includes('No active deliveries')) {
                    contentPreview = 'Empty state message displayed';
                } else {
                    contentPreview = `${rows.length} data rows found`;
                    Array.from(rows).slice(0, 3).forEach((row, index) => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length > 0) {
                            contentPreview += `\nRow ${index + 1}: ${cells[0].textContent.trim()}`;
                        }
                    });
                }
                
                currentTableContent.innerHTML = contentPreview;
                
                if (rows.length > 0 && !rows[0].textContent.includes('No active deliveries')) {
                    updateStepStatus(7, 'success', `✅ Table populated (${rows.length} rows)`);
                    debugLog(`✅ Table populated with ${rows.length} rows`, 'success');
                } else {
                    updateStepStatus(7, 'error', '❌ Table empty');
                    debugLog('❌ Table is empty or showing empty state', 'error');
                }
                
                debugLog(`Table inspection: ${rows.length} rows found`);
            } else {
                tableElementStatus.innerHTML = '❌ Table element not found (activeDeliveriesTableBody)';
                currentTableContent.innerHTML = 'Cannot inspect - element missing';
                updateStepStatus(7, 'error', '❌ Table element missing');
                debugLog('❌ activeDeliveriesTableBody element not found in DOM', 'error');
            }
        }

        // Update debug table
        function updateDebugTable() {
            const tbody = document.getElementById('debugActiveDeliveriesTable');
            
            if (typeof window.activeDeliveries === 'undefined' || window.activeDeliveries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No active deliveries</td></tr>';
                return;
            }

            tbody.innerHTML = window.activeDeliveries.map(delivery => `
                <tr>
                    <td><strong>${delivery.drNumber}</strong></td>
                    <td>${delivery.customerName}</td>
                    <td>${delivery.origin}</td>
                    <td>${delivery.destination}</td>
                    <td><span class="badge bg-success">${delivery.status}</span></td>
                    <td><small>${delivery.source || 'Unknown'}</small></td>
                </tr>
            `).join('');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('🚀 Booking data flow debug initialized');
            
            // Initial system check
            checkSystemInitialization();
            updateDebugTable();

            // Simulate full booking flow
            document.getElementById('simulateFullBooking').addEventListener('click', simulateFullBookingFlow);

            // Test load active deliveries
            document.getElementById('testLoadActiveDeliveries').addEventListener('click', function() {
                debugLog('🧪 Testing loadActiveDeliveries function directly...');
                
                if (typeof window.loadActiveDeliveries === 'function') {
                    try {
                        window.loadActiveDeliveries();
                        debugLog('✅ loadActiveDeliveries called successfully', 'success');
                        setTimeout(inspectActiveDeliveriesTable, 300);
                    } catch (error) {
                        debugLog(`❌ Error calling loadActiveDeliveries: ${error.message}`, 'error');
                    }
                } else {
                    debugLog('❌ loadActiveDeliveries function not available', 'error');
                }
            });

            // Inspect table
            document.getElementById('inspectActiveDeliveriesTable').addEventListener('click', inspectActiveDeliveriesTable);

            // Clear log
            document.getElementById('clearLog').addEventListener('click', function() {
                document.getElementById('debugLog').innerHTML = '<div>Debug log cleared...</div>';
            });

            // Export log
            document.getElementById('exportLog').addEventListener('click', function() {
                const logContent = document.getElementById('debugLog').textContent;
                const blob = new Blob([logContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `booking-debug-log-${new Date().toISOString().slice(0, 19)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            });

            // Auto-refresh system state every 3 seconds
            setInterval(() => {
                updateSystemStateDisplays();
                updateDebugTable();
            }, 3000);
        });

        // Initialize window.activeDeliveries if not exists (for testing)
        if (typeof window.activeDeliveries === 'undefined') {
            window.activeDeliveries = [];
        }
    </script>
</body>
</html>