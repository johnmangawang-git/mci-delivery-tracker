<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Date Mapping Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        .correct { background: #e8f5e8; padding: 10px; border-radius: 5px; }
        .incorrect { background: #ffe8e8; padding: 10px; border-radius: 5px; }
        input, button { margin: 5px; padding: 8px; }
        #results { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .date-comparison { display: flex; gap: 20px; margin: 10px 0; }
        .date-box { padding: 10px; border-radius: 5px; flex: 1; }
    </style>
</head>
<body>
    <h1>üìÖ Delivery Date Mapping Fix Test</h1>
    <p><strong>TESTING:</strong> Ensures user's delivery date input is preserved (NOT today's date)</p>
    
    <div class="test-section">
        <h3>üìÖ Current Date Information</h3>
        <div class="date-comparison">
            <div class="date-box incorrect">
                <strong>‚ùå Today's Date (WRONG):</strong><br>
                <span id="todayDate">Loading...</span>
            </div>
            <div class="date-box correct">
                <strong>‚úÖ User Input (CORRECT):</strong><br>
                <span id="userInputDate">Not set</span>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h3>üéØ Delivery Date Input Test</h3>
        <label for="drDeliveryDate">Delivery Date:</label>
        <input type="date" id="drDeliveryDate" value="2025-01-31">
        <button onclick="testDeliveryDateMapping()">Test Date Mapping</button>
        
        <div id="mappingResults" style="margin-top: 10px;">
            Click "Test Date Mapping" to verify the fix...
        </div>
    </div>
    
    <div class="test-section">
        <h3>üîç Active Deliveries Display Simulation</h3>
        <button onclick="simulateActiveDeliveriesDisplay()">Simulate Display</button>
        
        <div id="displaySimulation">
            <div class="info">This will show what would appear in the Active Deliveries table</div>
        </div>
    </div>
    
    <div class="test-section">
        <h3>üìä Test Results</h3>
        <div id="results">Run tests above to see results...</div>
    </div>
    
    <div class="test-section">
        <h3>üéØ Expected Results</h3>
        <ul>
            <li><strong>‚úÖ CORRECT:</strong> Display shows "Jan 31, 2025" (user input)</li>
            <li><strong>‚ùå WRONG:</strong> Display shows "Oct 29, 2024" (today's date)</li>
            <li><strong>üìÖ Format:</strong> "Jan 31, 2025, 2:30 PM" (user date + system time)</li>
            <li><strong>üö´ NEVER:</strong> Should never show today's date unless user selected it</li>
        </ul>
    </div>

    <!-- Load all the fix scripts in correct order -->
    <script src="public/assets/js/force-delivery-date-fix.js"></script>
    <script src="public/assets/js/dr-upload-created-date-fix.js"></script>
    <script src="public/assets/js/instant-time-display-fix.js"></script>
    <script src="public/assets/js/delivery-date-input-preservation-fix.js"></script>
    
    <script>
        // Update current date display
        function updateCurrentDates() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            const todayDisplay = today.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            document.getElementById('todayDate').textContent = `${todayDisplay} (${todayString})`;
            
            const userInput = document.getElementById('drDeliveryDate').value;
            if (userInput) {
                const userDate = new Date(userInput);
                const userDisplay = userDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                document.getElementById('userInputDate').textContent = `${userDisplay} (${userInput})`;
            }
        }
        
        function testDeliveryDateMapping() {
            const resultsDiv = document.getElementById('mappingResults');
            const userInput = document.getElementById('drDeliveryDate').value;
            const todayDate = new Date().toISOString().split('T')[0];
            
            resultsDiv.innerHTML = '';
            
            console.log('üß™ Testing delivery date mapping...');
            console.log('üìÖ User input:', userInput);
            console.log('üìÖ Today date:', todayDate);
            
            // Test 1: Check if user input is captured
            let capturedDate = null;
            if (window.getUserDeliveryDateInput) {
                capturedDate = window.getUserDeliveryDateInput();
            } else if (window.getUserSelectedDeliveryDate) {
                capturedDate = window.getUserSelectedDeliveryDate();
            }
            
            resultsDiv.innerHTML += `<div class="info"><strong>Test 1: Date Capture</strong></div>`;
            resultsDiv.innerHTML += `User Input: ${userInput}<br>`;
            resultsDiv.innerHTML += `Captured Date: ${capturedDate || 'Not captured'}<br>`;
            
            if (capturedDate === userInput) {
                resultsDiv.innerHTML += `<div class="success">‚úÖ PASS: User input correctly captured</div><br>`;
            } else {
                resultsDiv.innerHTML += `<div class="error">‚ùå FAIL: User input not captured correctly</div><br>`;
            }
            
            // Test 2: Check if it's NOT using today's date
            resultsDiv.innerHTML += `<div class="info"><strong>Test 2: Date Validation</strong></div>`;
            resultsDiv.innerHTML += `Today's Date: ${todayDate}<br>`;
            resultsDiv.innerHTML += `User's Date: ${userInput}<br>`;
            
            if (userInput !== todayDate) {
                resultsDiv.innerHTML += `<div class="success">‚úÖ PASS: User selected different date from today</div><br>`;
            } else {
                resultsDiv.innerHTML += `<div class="warning">‚ö†Ô∏è WARNING: User selected today's date (can't test override)</div><br>`;
            }
            
            // Test 3: Simulate created_date assignment
            resultsDiv.innerHTML += `<div class="info"><strong>Test 3: created_date Assignment</strong></div>`;
            
            const simulatedCreatedDate = (function() {
                const drDeliveryDateInput = document.getElementById('drDeliveryDate');
                return drDeliveryDateInput && drDeliveryDateInput.value ? drDeliveryDateInput.value : new Date().toISOString().split('T')[0];
            })();
            
            resultsDiv.innerHTML += `Simulated created_date: ${simulatedCreatedDate}<br>`;
            
            if (simulatedCreatedDate === userInput && simulatedCreatedDate !== todayDate) {
                resultsDiv.innerHTML += `<div class="success">‚úÖ PASS: created_date uses user input, not system date</div><br>`;
            } else if (simulatedCreatedDate === todayDate && userInput !== todayDate) {
                resultsDiv.innerHTML += `<div class="error">‚ùå FAIL: created_date using system date instead of user input</div><br>`;
            } else {
                resultsDiv.innerHTML += `<div class="success">‚úÖ PASS: created_date assignment correct</div><br>`;
            }
        }
        
        function simulateActiveDeliveriesDisplay() {
            const displayDiv = document.getElementById('displaySimulation');
            const userInput = document.getElementById('drDeliveryDate').value;
            
            // Create mock delivery data
            const mockDelivery = {
                drNumber: 'DR-TEST-001',
                created_date: userInput,
                deliveryDate: userInput
            };
            
            displayDiv.innerHTML = `<div class="info"><strong>Mock Delivery Data:</strong></div>`;
            displayDiv.innerHTML += `DR Number: ${mockDelivery.drNumber}<br>`;
            displayDiv.innerHTML += `created_date: ${mockDelivery.created_date}<br>`;
            displayDiv.innerHTML += `deliveryDate: ${mockDelivery.deliveryDate}<br><br>`;
            
            // Test formatActiveDeliveryDate function
            if (window.formatActiveDeliveryDate) {
                const formattedDisplay = window.formatActiveDeliveryDate(mockDelivery);
                displayDiv.innerHTML += `<div class="info"><strong>Formatted Display:</strong></div>`;
                displayDiv.innerHTML += `<div class="correct">${formattedDisplay}</div><br>`;
                
                // Check if it contains the user's date
                const userDate = new Date(userInput);
                const expectedMonth = userDate.toLocaleDateString('en-US', { month: 'short' });
                const expectedDay = userDate.getDate();
                const expectedYear = userDate.getFullYear();
                
                if (formattedDisplay.includes(expectedMonth) && 
                    formattedDisplay.includes(expectedDay.toString()) && 
                    formattedDisplay.includes(expectedYear.toString())) {
                    displayDiv.innerHTML += `<div class="success">‚úÖ CORRECT: Display shows user's delivery date</div>`;
                } else {
                    displayDiv.innerHTML += `<div class="error">‚ùå WRONG: Display not showing user's delivery date</div>`;
                }
            } else {
                displayDiv.innerHTML += `<div class="warning">‚ö†Ô∏è formatActiveDeliveryDate function not available</div>`;
            }
            
            // Update main results
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="info"><strong>üéØ Active Deliveries Display Test Complete</strong></div>
                <div class="success">Expected: User's delivery date (${userInput}) + current system time</div>
                <div class="error">NOT Expected: Today's date (${new Date().toISOString().split('T')[0]}) + current system time</div>
            `;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDates();
            
            // Update dates when user changes input
            document.getElementById('drDeliveryDate').addEventListener('change', updateCurrentDates);
            
            console.log('üìÖ Delivery Date Mapping Fix Test Page Loaded');
            console.log('üéØ Testing that user input is preserved, not overridden with today\'s date');
            
            // Auto-run test after a delay to let scripts load
            setTimeout(() => {
                testDeliveryDateMapping();
            }, 2000);
        });
    </script>
</body>
</html>