<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Booking Customer Sync</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .debug-info { background-color: #f8f9fa; padding: 10px; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß Booking Customer Sync Test</h1>
    
    <div class="test-section info">
        <h3>Test Purpose</h3>
        <p>This page helps debug why customers created from Excel booking in Chrome don't appear in Firefox.</p>
        <div id="browserInfo"></div>
    </div>
    
    <div class="test-section">
        <h3>üîç Debug Information</h3>
        <button onclick="runDebugCheck()">Run Debug Check</button>
        <button onclick="testAutoCreateCustomer()">Test Auto-Create Customer</button>
        <button onclick="forceCustomerSync()">Force Customer Sync</button>
        <button onclick="clearLog()">Clear Log</button>
        <div id="debugInfo" class="debug-info"></div>
    </div>
    
    <div class="test-section">
        <h3>üß™ Simulate Excel Booking</h3>
        <p>This simulates what happens when you upload an Excel file with customer data:</p>
        <button onclick="simulateExcelBooking()">Simulate Excel Booking</button>
        <div id="simulationResults"></div>
    </div>
    
    <div class="test-section">
        <h3>üìä Current Data Status</h3>
        <button onclick="showDataStatus()">Show Data Status</button>
        <div id="dataStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üìù Debug Log</h3>
        <div id="testLog" class="log"></div>
    </div>

    <!-- Load required scripts in the same order as main app -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/customer-field-mapping-fix.js"></script>
    <script src="public/assets/js/booking-customer-integration-fix.js"></script>
    
    <script>
        // Test logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<span style="color: ${colorMap[type] || '#333'}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        // Initialize test environment
        function initTestEnvironment() {
            log('üîß Initializing booking customer sync test environment...', 'info');
            
            // Display browser information
            const browserInfo = document.getElementById('browserInfo');
            const browserName = navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                               navigator.userAgent.includes('Firefox') ? 'Firefox' : 
                               navigator.userAgent.includes('Safari') ? 'Safari' : 'Unknown';
            
            browserInfo.innerHTML = `
                <strong>Browser:</strong> ${browserName}<br>
                <strong>User Agent:</strong> ${navigator.userAgent}<br>
                <strong>Local Storage Available:</strong> ${typeof(Storage) !== "undefined" ? '‚úÖ Yes' : '‚ùå No'}<br>
                <strong>Current Time:</strong> ${new Date().toLocaleString()}
            `;
            
            // Initialize global arrays
            if (typeof window.customers === 'undefined') {
                window.customers = [];
                log('‚úÖ Initialized window.customers array', 'success');
            }
            
            // Check if fixes are loaded
            const fixes = [
                { name: 'Customer Field Mapping Fix', check: () => typeof window.customerFieldMappingFix !== 'undefined' },
                { name: 'Booking Customer Integration Fix', check: () => typeof window.bookingCustomerIntegrationFix !== 'undefined' },
                { name: 'Enhanced Auto Create Customer', check: () => typeof window.enhancedAutoCreateCustomer === 'function' },
                { name: 'DataService', check: () => typeof window.dataService !== 'undefined' },
                { name: 'Supabase Client', check: () => typeof window.supabaseClient === 'function' }
            ];
            
            fixes.forEach(fix => {
                if (fix.check()) {
                    log(`‚úÖ ${fix.name} loaded`, 'success');
                } else {
                    log(`‚ùå ${fix.name} NOT loaded`, 'error');
                }
            });
        }
        
        // Run comprehensive debug check
        function runDebugCheck() {
            log('üîç Running comprehensive debug check...', 'info');
            
            const debugInfo = document.getElementById('debugInfo');
            let debugHtml = '<h4>Debug Information:</h4>';
            
            // Check function availability
            const functions = [
                'autoCreateCustomer',
                'enhancedAutoCreateCustomer',
                'loadCustomers',
                'enhancedLoadCustomers',
                'saveCustomer',
                'enhancedSaveCustomer'
            ];
            
            debugHtml += '<h5>Function Availability:</h5><ul>';
            functions.forEach(funcName => {
                const available = typeof window[funcName] === 'function';
                debugHtml += `<li>${funcName}: ${available ? '‚úÖ Available' : '‚ùå Not Available'}</li>`;
                log(`Function ${funcName}: ${available ? 'Available' : 'Not Available'}`, available ? 'success' : 'error');
            });
            debugHtml += '</ul>';
            
            // Check data status
            debugHtml += '<h5>Data Status:</h5><ul>';
            
            const windowCustomersCount = window.customers ? window.customers.length : 0;
            debugHtml += `<li>window.customers: ${windowCustomersCount} items</li>`;
            log(`window.customers: ${windowCustomersCount} items`, 'info');
            
            try {
                const localStorageCustomers = localStorage.getItem('mci-customers');
                const localCount = localStorageCustomers ? JSON.parse(localStorageCustomers).length : 0;
                debugHtml += `<li>localStorage customers: ${localCount} items</li>`;
                log(`localStorage customers: ${localCount} items`, 'info');
            } catch (error) {
                debugHtml += `<li>localStorage customers: Error reading</li>`;
                log('Error reading localStorage customers', 'error');
            }
            
            debugHtml += '</ul>';
            
            // Check Supabase connection
            debugHtml += '<h5>Supabase Status:</h5><ul>';
            
            if (typeof window.supabaseClient === 'function') {
                const client = window.supabaseClient();
                debugHtml += `<li>Supabase Client: ${client ? '‚úÖ Available' : '‚ùå Not Initialized'}</li>`;
                log(`Supabase Client: ${client ? 'Available' : 'Not Initialized'}`, client ? 'success' : 'error');
            } else {
                debugHtml += `<li>Supabase Client: ‚ùå Function Not Available</li>`;
                log('Supabase Client: Function Not Available', 'error');
            }
            
            if (typeof window.dataService !== 'undefined') {
                debugHtml += `<li>DataService: ‚úÖ Available</li>`;
                log('DataService: Available', 'success');
                
                if (typeof window.dataService.saveCustomer === 'function') {
                    debugHtml += `<li>DataService.saveCustomer: ‚úÖ Available</li>`;
                    log('DataService.saveCustomer: Available', 'success');
                } else {
                    debugHtml += `<li>DataService.saveCustomer: ‚ùå Not Available</li>`;
                    log('DataService.saveCustomer: Not Available', 'error');
                }
            } else {
                debugHtml += `<li>DataService: ‚ùå Not Available</li>`;
                log('DataService: Not Available', 'error');
            }
            
            debugHtml += '</ul>';
            
            debugInfo.innerHTML = debugHtml;
            
            // Also run the debug function if available
            if (typeof window.debugCustomerSync === 'function') {
                log('üîç Running debugCustomerSync function...', 'info');
                window.debugCustomerSync();
            }
        }
        
        // Test auto-create customer function
        async function testAutoCreateCustomer() {
            log('üß™ Testing auto-create customer function...', 'info');
            
            const testCustomerName = 'Test Excel Customer';
            const testVendorNumber = '+63 917 999 0001';
            const testDestination = 'Test Excel Destination';
            
            try {
                if (typeof window.autoCreateCustomer === 'function') {
                    log('üîÑ Calling autoCreateCustomer function...', 'info');
                    const result = await window.autoCreateCustomer(testCustomerName, testVendorNumber, testDestination);
                    
                    if (result) {
                        log('‚úÖ Auto-create customer test PASSED', 'success');
                        log(`üìù Created customer: ${result.contactPerson || result.name}`, 'info');
                        
                        // Check if it's in localStorage
                        setTimeout(() => {
                            try {
                                const localCustomers = localStorage.getItem('mci-customers');
                                if (localCustomers) {
                                    const customers = JSON.parse(localCustomers);
                                    const found = customers.find(c => c.phone === testVendorNumber);
                                    if (found) {
                                        log('‚úÖ Customer found in localStorage', 'success');
                                    } else {
                                        log('‚ö†Ô∏è Customer NOT found in localStorage', 'warning');
                                    }
                                }
                            } catch (error) {
                                log('‚ùå Error checking localStorage', 'error');
                            }
                        }, 1000);
                        
                    } else {
                        log('‚ùå Auto-create customer test FAILED - no result', 'error');
                    }
                } else {
                    log('‚ùå autoCreateCustomer function not available', 'error');
                }
            } catch (error) {
                log(`‚ùå Auto-create customer test ERROR: ${error.message}`, 'error');
            }
        }
        
        // Force customer sync
        async function forceCustomerSync() {
            log('üîÑ Force syncing customers...', 'info');
            
            try {
                if (typeof window.forceCustomerSync === 'function') {
                    await window.forceCustomerSync();
                    log('‚úÖ Force customer sync completed', 'success');
                } else if (typeof window.enhancedLoadCustomers === 'function') {
                    await window.enhancedLoadCustomers();
                    log('‚úÖ Enhanced load customers completed', 'success');
                } else if (typeof window.loadCustomers === 'function') {
                    await window.loadCustomers();
                    log('‚úÖ Load customers completed', 'success');
                } else {
                    log('‚ùå No customer sync function available', 'error');
                }
            } catch (error) {
                log(`‚ùå Error in force customer sync: ${error.message}`, 'error');
            }
        }
        
        // Simulate Excel booking process
        async function simulateExcelBooking() {
            log('üß™ Simulating Excel booking process...', 'info');
            
            const simulationResults = document.getElementById('simulationResults');
            simulationResults.innerHTML = '<p>Running simulation...</p>';
            
            // Simulate Excel data
            const excelData = [
                {
                    customerName: 'Excel Customer 1',
                    vendorNumber: '+63 917 111 2222',
                    destination: 'Excel Destination 1',
                    drNumber: 'DR-EXCEL-001'
                },
                {
                    customerName: 'Excel Customer 2',
                    vendorNumber: '+63 917 333 4444',
                    destination: 'Excel Destination 2',
                    drNumber: 'DR-EXCEL-002'
                }
            ];
            
            let results = [];
            
            for (const data of excelData) {
                try {
                    log(`üìù Processing: ${data.customerName}`, 'info');
                    
                    if (typeof window.autoCreateCustomer === 'function') {
                        const customer = await window.autoCreateCustomer(
                            data.customerName,
                            data.vendorNumber,
                            data.destination
                        );
                        
                        if (customer) {
                            results.push({
                                name: data.customerName,
                                status: 'Success',
                                id: customer.id,
                                phone: customer.phone
                            });
                            log(`‚úÖ Successfully processed: ${data.customerName}`, 'success');
                        } else {
                            results.push({
                                name: data.customerName,
                                status: 'Failed - No Result',
                                id: 'N/A',
                                phone: data.vendorNumber
                            });
                            log(`‚ùå Failed to process: ${data.customerName}`, 'error');
                        }
                    } else {
                        results.push({
                            name: data.customerName,
                            status: 'Failed - Function Not Available',
                            id: 'N/A',
                            phone: data.vendorNumber
                        });
                        log(`‚ùå autoCreateCustomer function not available`, 'error');
                    }
                } catch (error) {
                    results.push({
                        name: data.customerName,
                        status: `Error: ${error.message}`,
                        id: 'N/A',
                        phone: data.vendorNumber
                    });
                    log(`‚ùå Error processing ${data.customerName}: ${error.message}`, 'error');
                }
            }
            
            // Display results
            let resultsHtml = '<h4>Simulation Results:</h4><table border="1" style="width: 100%; border-collapse: collapse;"><tr><th>Customer Name</th><th>Status</th><th>ID</th><th>Phone</th></tr>';
            
            results.forEach(result => {
                const statusColor = result.status === 'Success' ? '#d4edda' : '#f8d7da';
                resultsHtml += `<tr style="background-color: ${statusColor}"><td>${result.name}</td><td>${result.status}</td><td>${result.id}</td><td>${result.phone}</td></tr>`;
            });
            
            resultsHtml += '</table>';
            simulationResults.innerHTML = resultsHtml;
            
            log('üß™ Excel booking simulation completed', 'info');
        }
        
        // Show current data status
        function showDataStatus() {
            log('üìä Showing current data status...', 'info');
            
            const dataStatus = document.getElementById('dataStatus');
            let statusHtml = '<h4>Current Data Status:</h4>';
            
            // Window customers
            statusHtml += '<h5>Window Customers:</h5>';
            if (window.customers && window.customers.length > 0) {
                statusHtml += '<ul>';
                window.customers.forEach(customer => {
                    statusHtml += `<li>${customer.contactPerson || customer.name} (${customer.phone}) - ${customer.notes || 'No notes'}</li>`;
                });
                statusHtml += '</ul>';
            } else {
                statusHtml += '<p>No customers in window.customers</p>';
            }
            
            // LocalStorage customers
            statusHtml += '<h5>LocalStorage Customers:</h5>';
            try {
                const localCustomers = localStorage.getItem('mci-customers');
                if (localCustomers) {
                    const customers = JSON.parse(localCustomers);
                    if (customers.length > 0) {
                        statusHtml += '<ul>';
                        customers.forEach(customer => {
                            statusHtml += `<li>${customer.contactPerson || customer.name} (${customer.phone}) - ${customer.notes || 'No notes'}</li>`;
                        });
                        statusHtml += '</ul>';
                    } else {
                        statusHtml += '<p>No customers in localStorage</p>';
                    }
                } else {
                    statusHtml += '<p>No customer data in localStorage</p>';
                }
            } catch (error) {
                statusHtml += `<p>Error reading localStorage: ${error.message}</p>`;
            }
            
            dataStatus.innerHTML = statusHtml;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initTestEnvironment, 1000); // Give scripts time to load
        });
    </script>
</body>
</html>