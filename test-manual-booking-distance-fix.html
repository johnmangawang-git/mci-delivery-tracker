<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Booking Distance Fix Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .log-container {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üß™ Manual Booking Distance Fix Test</h1>
        <p>Testing the fix for function name conflicts and type errors in manual booking distance calculations</p>

        <!-- Test Controls -->
        <div class="test-section">
            <h3>üõ†Ô∏è Test Controls</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-primary me-2 mb-2" onclick="testDistanceFromCoords()">üìè Test Distance From Coordinates</button>
                    <button class="btn btn-success me-2 mb-2" onclick="testGeocodeAddress()">üó∫Ô∏è Test Geocode Address</button>
                    <button class="btn btn-info me-2 mb-2" onclick="testRealDistance()">üéØ Test Real Distance</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-warning me-2 mb-2" onclick="testTypeHandling()">üîß Test Type Handling</button>
                    <button class="btn btn-secondary me-2 mb-2" onclick="simulateManualBooking()">üìã Simulate Manual Booking</button>
                    <button class="btn btn-danger mb-2" onclick="clearLog()">üóëÔ∏è Clear Log</button>
                </div>
            </div>
        </div>

        <!-- Log Container -->
        <div class="log-container" id="logContainer">
            <div>üöÄ Manual Booking Distance Fix Test initialized. Click buttons above to run tests.</div>
        </div>

        <!-- Test Results -->
        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Function Availability</h5>
                    <div id="functionResults" class="bg-light p-3" style="min-height: 200px;">
                        <small class="text-muted">Run tests to see function availability</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Distance Calculations</h5>
                    <div id="distanceResults" class="bg-light p-3" style="min-height: 200px;">
                        <small class="text-muted">Run distance tests to see results</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/booking.js"></script>
    <script>
        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                success: '#00ff88',
                error: '#ff4444',
                warning: '#ffaa00'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div>üöÄ Log cleared.</div>';
        }

        // Test distance calculation from coordinates
        function testDistanceFromCoords() {
            log('=== TESTING DISTANCE FROM COORDINATES ===');
            
            const functionResults = document.getElementById('functionResults');
            let resultsHtml = '<h6>Function Availability:</h6>';
            
            // Test calculateDistanceFromCoords function
            if (typeof window.calculateDistanceFromCoords === 'function') {
                log('‚úÖ calculateDistanceFromCoords function available', 'success');
                resultsHtml += '<div class="text-success">‚úÖ calculateDistanceFromCoords</div>';
                
                try {
                    // Test with Alabang to Makati coordinates
                    const alabangLat = 14.4378;
                    const alabangLng = 121.0199;
                    const makatiLat = 14.5547;
                    const makatiLng = 121.0244;
                    
                    const distance = window.calculateDistanceFromCoords(alabangLat, alabangLng, makatiLat, makatiLng);
                    log(`‚úÖ Alabang to Makati: ${distance.toFixed(2)} km`, 'success');
                    resultsHtml += `<small class="text-muted">Alabang ‚Üí Makati: ${distance.toFixed(2)} km</small><br>`;
                } catch (error) {
                    log(`‚ùå Error testing calculateDistanceFromCoords: ${error.message}`, 'error');
                    resultsHtml += '<small class="text-danger">‚ùå Error in calculation</small><br>';
                }
            } else {
                log('‚ùå calculateDistanceFromCoords function not available', 'error');
                resultsHtml += '<div class="text-danger">‚ùå calculateDistanceFromCoords</div>';
            }
            
            // Test calculateRealDistance function
            if (typeof window.calculateRealDistance === 'function') {
                log('‚úÖ calculateRealDistance function available', 'success');
                resultsHtml += '<div class="text-success">‚úÖ calculateRealDistance</div>';
            } else {
                log('‚ùå calculateRealDistance function not available', 'error');
                resultsHtml += '<div class="text-danger">‚ùå calculateRealDistance</div>';
            }
            
            functionResults.innerHTML = resultsHtml;
        }

        // Test geocode address function
        async function testGeocodeAddress() {
            log('=== TESTING GEOCODE ADDRESS ===');
            
            const testCases = [
                'Makati City',
                'SMEG Alabang warehouse',
                14.444208, // Number (should be handled gracefully)
                null, // Null (should be handled gracefully)
                '', // Empty string (should be handled gracefully)
                'BGC, Taguig'
            ];
            
            for (const testCase of testCases) {
                log(`Testing geocoding for: ${testCase} (type: ${typeof testCase})`);
                
                try {
                    if (typeof window.geocodeAddress === 'function') {
                        const result = await window.geocodeAddress(testCase);
                        log(`‚úÖ Result: (${result.lat}, ${result.lng})`, 'success');
                    } else {
                        log('‚ùå geocodeAddress function not available', 'error');
                        break;
                    }
                } catch (error) {
                    log(`‚ùå Error geocoding ${testCase}: ${error.message}`, 'error');
                }
            }
        }

        // Test real distance calculation
        async function testRealDistance() {
            log('=== TESTING REAL DISTANCE CALCULATION ===');
            
            const distanceResults = document.getElementById('distanceResults');
            let resultsHtml = '<h6>Distance Test Results:</h6>';
            
            const testRoutes = [
                { origin: 'SMEG Alabang warehouse', destination: 'Makati City' },
                { origin: 'SMEG Alabang warehouse', destination: 'Quezon City' },
                { origin: 'SMEG Alabang warehouse', destination: 'Las Pi√±as City' }
            ];
            
            for (const route of testRoutes) {
                log(`Testing distance: ${route.origin} ‚Üí ${route.destination}`);
                
                try {
                    if (typeof window.calculateRealDistance === 'function') {
                        const distance = await window.calculateRealDistance(route.origin, route.destination);
                        log(`‚úÖ ${route.origin} ‚Üí ${route.destination}: ${distance.toFixed(2)} km`, 'success');
                        resultsHtml += `<div class="mb-2">
                            <strong>${route.origin}</strong> ‚Üí <strong>${route.destination}</strong><br>
                            <small class="text-success">‚úÖ ${distance.toFixed(2)} km</small>
                        </div>`;
                    } else {
                        log('‚ùå calculateRealDistance function not available', 'error');
                        resultsHtml += '<div class="text-danger">‚ùå Function not available</div>';
                        break;
                    }
                } catch (error) {
                    log(`‚ùå Error calculating distance: ${error.message}`, 'error');
                    resultsHtml += `<div class="mb-2">
                        <strong>${route.origin}</strong> ‚Üí <strong>${route.destination}</strong><br>
                        <small class="text-danger">‚ùå Error: ${error.message}</small>
                    </div>`;
                }
            }
            
            distanceResults.innerHTML = resultsHtml;
        }

        // Test type handling
        function testTypeHandling() {
            log('=== TESTING TYPE HANDLING ===');
            
            // Test totalDistance.toFixed fix
            log('Testing totalDistance type handling...');
            
            const testValues = [
                25.5, // Number (should work)
                '25.5', // String (should be handled)
                null, // Null (should default to 0)
                undefined, // Undefined (should default to 0)
                NaN, // NaN (should default to 0)
                'invalid' // Invalid string (should default to 0)
            ];
            
            testValues.forEach(value => {
                const distance = typeof value === 'number' && !isNaN(value) ? value : 0;
                try {
                    const result = distance.toFixed(1);
                    log(`‚úÖ ${value} (${typeof value}) ‚Üí ${result} km`, 'success');
                } catch (error) {
                    log(`‚ùå ${value} (${typeof value}) ‚Üí Error: ${error.message}`, 'error');
                }
            });
        }

        // Simulate manual booking flow
        async function simulateManualBooking() {
            log('=== SIMULATING MANUAL BOOKING FLOW ===');
            
            log('1. User opens booking modal from calendar');
            log('2. User selects origin: SMEG Alabang warehouse');
            log('3. User pins destination on map: Makati City');
            
            try {
                // Simulate the coordinate-based calculation that was failing
                log('4. Simulating coordinate-based distance calculation...');
                
                if (typeof window.calculateDistanceFromCoords === 'function') {
                    const alabangLat = 14.4378;
                    const alabangLng = 121.0199;
                    const makatiLat = 14.5547;
                    const makatiLng = 121.0244;
                    
                    const distance = window.calculateDistanceFromCoords(alabangLat, alabangLng, makatiLat, makatiLng);
                    log(`‚úÖ Distance calculated: ${distance.toFixed(2)} km`, 'success');
                    
                    // Test the totalDistance.toFixed fix
                    const totalDistance = distance;
                    const formattedDistance = typeof totalDistance === 'number' ? totalDistance : 0;
                    const displayText = `${formattedDistance.toFixed(1)} km`;
                    
                    log(`‚úÖ Display text: ${displayText}`, 'success');
                    log('‚úÖ Manual booking simulation completed successfully!', 'success');
                } else {
                    log('‚ùå calculateDistanceFromCoords function not available', 'error');
                }
                
                // Test address-based calculation
                log('5. Testing address-based calculation...');
                if (typeof window.calculateRealDistance === 'function') {
                    const distance = await window.calculateRealDistance('SMEG Alabang warehouse', 'Makati City');
                    log(`‚úÖ Address-based distance: ${distance.toFixed(2)} km`, 'success');
                } else {
                    log('‚ùå calculateRealDistance function not available', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Simulation failed: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Manual Booking Distance Fix Test initialized');
            log('Available functions:');
            log(`- calculateDistanceFromCoords: ${typeof window.calculateDistanceFromCoords}`);
            log(`- calculateRealDistance: ${typeof window.calculateRealDistance}`);
            log(`- geocodeAddress: ${typeof window.geocodeAddress}`);
        });
    </script>
</body>
</html>