<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DR Upload Delivery Date Mapping Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        .correct { background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 5px 0; }
        .incorrect { background: #ffe8e8; padding: 10px; border-radius: 5px; margin: 5px 0; }
        input, button { margin: 5px; padding: 8px; }
        #results { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .step { margin: 10px 0; padding: 10px; border-left: 3px solid #007bff; }
    </style>
</head>
<body>
    <h1>üìã DR Upload Delivery Date Mapping Test</h1>
    <p><strong>TESTING:</strong> Ensures DR Upload uses user's delivery date input (NOT today's date)</p>
    
    <div class="test-section">
        <h3>üìÖ Date Comparison</h3>
        <div class="incorrect">
            <strong>‚ùå Today's Date (WRONG):</strong> <span id="todayDate">Loading...</span>
        </div>
        <div class="correct">
            <strong>‚úÖ User Input (CORRECT):</strong> <span id="userInputDate">Not set</span>
        </div>
    </div>
    
    <div class="test-section">
        <h3>üéØ DR Upload Simulation</h3>
        <div class="step">
            <strong>Step 1:</strong> Set Delivery Date
            <br>
            <label for="drDeliveryDate">Delivery Date:</label>
            <input type="date" id="drDeliveryDate" value="2025-01-31">
        </div>
        
        <div class="step">
            <strong>Step 2:</strong> Set Truck Details
            <br>
            <label for="drTruckType">Truck Type:</label>
            <input type="text" id="drTruckType" value="10-Wheeler" placeholder="Truck Type">
            <br>
            <label for="drTruckPlate">Truck Plate:</label>
            <input type="text" id="drTruckPlate" value="ABC-123" placeholder="Truck Plate">
        </div>
        
        <div class="step">
            <strong>Step 3:</strong> Test DR Upload Process
            <br>
            <button onclick="testDRUploadProcess()">Simulate DR Upload</button>
        </div>
    </div>
    
    <div class="test-section">
        <h3>üìä Test Results</h3>
        <div id="results">Click "Simulate DR Upload" to test the delivery date mapping...</div>
    </div>
    
    <div class="test-section">
        <h3>üéØ Expected Results</h3>
        <ul>
            <li><strong>‚úÖ CORRECT:</strong> booking.deliveryDate = "2025-01-31" (user input)</li>
            <li><strong>‚úÖ CORRECT:</strong> booking.created_date = "2025-01-31" (user input)</li>
            <li><strong>‚úÖ CORRECT:</strong> booking.bookedDate = "2025-01-31" (user input)</li>
            <li><strong>‚ùå WRONG:</strong> Any date field = "2024-10-29" (today's date)</li>
            <li><strong>üìÖ DISPLAY:</strong> "Jan 31, 2025, 2:30 PM" (user date + system time)</li>
        </ul>
    </div>

    <!-- Load the fix scripts -->
    <script src="public/assets/js/force-delivery-date-fix.js"></script>
    <script src="public/assets/js/dr-upload-created-date-fix.js"></script>
    <script src="public/assets/js/instant-time-display-fix.js"></script>
    <script src="public/assets/js/delivery-date-input-preservation-fix.js"></script>
    
    <script>
        // Mock pendingDRBookings for testing
        window.pendingDRBookings = [
            {
                drNumber: 'DR-TEST-001',
                origin: 'Test Origin',
                destination: 'Test Destination',
                customerName: 'Test Customer'
            },
            {
                drNumber: 'DR-TEST-002',
                origin: 'Test Origin 2',
                destination: 'Test Destination 2',
                customerName: 'Test Customer 2'
            }
        ];
        
        // Update date displays
        function updateDateDisplays() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            const todayDisplay = today.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            document.getElementById('todayDate').textContent = `${todayDisplay} (${todayString})`;
            
            const userInput = document.getElementById('drDeliveryDate').value;
            if (userInput) {
                const userDate = new Date(userInput);
                const userDisplay = userDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                document.getElementById('userInputDate').textContent = `${userDisplay} (${userInput})`;
            }
        }
        
        function testDRUploadProcess() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            console.log('üß™ Testing DR Upload Process...');
            
            // Get input values
            const drDeliveryDate = document.getElementById('drDeliveryDate').value;
            const drTruckType = document.getElementById('drTruckType').value;
            const drTruckPlate = document.getElementById('drTruckPlate').value;
            const todayDate = new Date().toISOString().split('T')[0];
            
            resultsDiv.innerHTML += `<div class="info"><strong>üéØ DR Upload Process Simulation</strong></div>`;
            resultsDiv.innerHTML += `User Delivery Date: ${drDeliveryDate}<br>`;
            resultsDiv.innerHTML += `Today's Date: ${todayDate}<br>`;
            resultsDiv.innerHTML += `Truck Type: ${drTruckType}<br>`;
            resultsDiv.innerHTML += `Truck Plate: ${drTruckPlate}<br><br>`;
            
            // Test 1: Input Validation
            resultsDiv.innerHTML += `<div class="info"><strong>Test 1: Input Validation</strong></div>`;
            
            if (!drDeliveryDate) {
                resultsDiv.innerHTML += `<div class="error">‚ùå FAIL: No delivery date selected</div><br>`;
                return;
            }
            
            if (!drTruckType || !drTruckPlate) {
                resultsDiv.innerHTML += `<div class="error">‚ùå FAIL: Truck details missing</div><br>`;
                return;
            }
            
            resultsDiv.innerHTML += `<div class="success">‚úÖ PASS: All required inputs provided</div><br>`;
            
            // Test 2: Simulate confirmDRUpload logic
            resultsDiv.innerHTML += `<div class="info"><strong>Test 2: DR Upload Logic Simulation</strong></div>`;
            
            // Simulate the fixed confirmDRUpload function
            const userDeliveryDate = drDeliveryDate;
            const processedBookings = [];
            
            for (let index = 0; index < window.pendingDRBookings.length; index++) {
                const booking = { ...window.pendingDRBookings[index] }; // Clone
                
                // Apply the fixed logic
                booking.truckType = drTruckType;
                booking.truckPlateNumber = drTruckPlate;
                booking.truck = `${drTruckType} (${drTruckPlate})`;
                
                // CRITICAL: Set delivery date from user input
                booking.deliveryDate = userDeliveryDate;
                booking.bookedDate = userDeliveryDate;
                booking.created_date = userDeliveryDate;
                
                processedBookings.push(booking);
                
                console.log(`üìÖ Processed ${booking.drNumber}:`, {
                    deliveryDate: booking.deliveryDate,
                    bookedDate: booking.bookedDate,
                    created_date: booking.created_date
                });
            }
            
            resultsDiv.innerHTML += `Processed ${processedBookings.length} bookings<br>`;
            
            // Test 3: Validate Date Mapping
            resultsDiv.innerHTML += `<div class="info"><strong>Test 3: Date Mapping Validation</strong></div>`;
            
            let allCorrect = true;
            processedBookings.forEach((booking, index) => {
                resultsDiv.innerHTML += `<strong>${booking.drNumber}:</strong><br>`;
                
                // Check deliveryDate
                if (booking.deliveryDate === drDeliveryDate) {
                    resultsDiv.innerHTML += `<div class="success">‚úÖ deliveryDate: ${booking.deliveryDate} (CORRECT)</div>`;
                } else {
                    resultsDiv.innerHTML += `<div class="error">‚ùå deliveryDate: ${booking.deliveryDate} (WRONG - should be ${drDeliveryDate})</div>`;
                    allCorrect = false;
                }
                
                // Check created_date
                if (booking.created_date === drDeliveryDate) {
                    resultsDiv.innerHTML += `<div class="success">‚úÖ created_date: ${booking.created_date} (CORRECT)</div>`;
                } else {
                    resultsDiv.innerHTML += `<div class="error">‚ùå created_date: ${booking.created_date} (WRONG - should be ${drDeliveryDate})</div>`;
                    allCorrect = false;
                }
                
                // Check bookedDate
                if (booking.bookedDate === drDeliveryDate) {
                    resultsDiv.innerHTML += `<div class="success">‚úÖ bookedDate: ${booking.bookedDate} (CORRECT)</div>`;
                } else {
                    resultsDiv.innerHTML += `<div class="error">‚ùå bookedDate: ${booking.bookedDate} (WRONG - should be ${drDeliveryDate})</div>`;
                    allCorrect = false;
                }
                
                resultsDiv.innerHTML += `<br>`;
            });
            
            // Test 4: Display Format Test
            resultsDiv.innerHTML += `<div class="info"><strong>Test 4: Active Deliveries Display Format</strong></div>`;
            
            const sampleBooking = processedBookings[0];
            const currentTime = new Date();
            const combinedDateTime = new Date(sampleBooking.created_date + 'T' + currentTime.toTimeString().split(' ')[0]);
            const expectedDisplay = combinedDateTime.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) + ', ' + combinedDateTime.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            resultsDiv.innerHTML += `Expected Display: <strong>${expectedDisplay}</strong><br>`;
            
            if (expectedDisplay.includes('Jan 31, 2025') && drDeliveryDate === '2025-01-31') {
                resultsDiv.innerHTML += `<div class="success">‚úÖ Display format correct (shows user's delivery date)</div><br>`;
            } else if (expectedDisplay.includes('Oct 29, 2024') && todayDate === '2024-10-29') {
                resultsDiv.innerHTML += `<div class="error">‚ùå Display format wrong (shows today's date instead of user input)</div><br>`;
                allCorrect = false;
            } else {
                resultsDiv.innerHTML += `<div class="success">‚úÖ Display format uses user's delivery date</div><br>`;
            }
            
            // Final Result
            resultsDiv.innerHTML += `<div class="info"><strong>üéØ Final Result</strong></div>`;
            if (allCorrect) {
                resultsDiv.innerHTML += `<div class="success">üéâ ALL TESTS PASSED! DR Upload will use user's delivery date correctly.</div>`;
            } else {
                resultsDiv.innerHTML += `<div class="error">‚ùå SOME TESTS FAILED! DR Upload may still use system date instead of user input.</div>`;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateDisplays();
            
            // Update displays when user changes input
            document.getElementById('drDeliveryDate').addEventListener('change', updateDateDisplays);
            
            console.log('üìã DR Upload Delivery Date Mapping Test Loaded');
            console.log('üéØ Testing that DR Upload uses user input, not system date');
            
            // Auto-run test after delay
            setTimeout(() => {
                testDRUploadProcess();
            }, 1000);
        });
    </script>
</body>
</html>