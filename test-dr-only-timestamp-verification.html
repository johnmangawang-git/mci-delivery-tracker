<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DR-Only Timestamp Verification Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="bi bi-clock text-primary"></i> DR-Only Timestamp Verification Test</h2>
        <p class="lead">Verify that Delivery History shows precise timestamp (date + time) when DR items are e-signed</p>
        
        <div class="alert alert-info">
            <strong>Enhancement:</strong> Delivery History "Date" column now includes precise timestamp with date and time.<br>
            <strong>Format:</strong> "Dec 21, 2024, 2:35:42 PM" (using local machine time)
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-stopwatch"></i> Timestamp Test</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Test Scenario:</strong> Sign DR-001 and verify timestamp</p>
                        <ul>
                            <li><strong>Before:</strong> Only date shown (e.g., "Dec 21, 2024")</li>
                            <li><strong>After:</strong> Date + time shown (e.g., "Dec 21, 2024, 2:35:42 PM")</li>
                        </ul>
                        
                        <div class="mb-3">
                            <strong>Current Time:</strong> <span id="currentTime" class="badge bg-info"></span>
                        </div>
                        
                        <button class="btn btn-primary" onclick="setupTimestampTest()">
                            <i class="bi bi-database-add"></i> Setup Test Data
                        </button>
                        <button class="btn btn-success" onclick="testTimestamp()">
                            <i class="bi bi-pen"></i> Sign & Test Timestamp
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-check-circle"></i> Expected Result</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>After e-signature:</strong></p>
                        <ul>
                            <li>‚úÖ Delivery History shows precise timestamp</li>
                            <li>‚úÖ Format: "Month Day, Year, Hour:Minute:Second AM/PM"</li>
                            <li>‚úÖ Uses local machine time</li>
                            <li>‚úÖ Timestamp matches signing time</li>
                        </ul>
                        <div id="timestampResult"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list"></i> Active Deliveries</h5>
                        <span class="badge bg-primary" id="activeTimestampCount">0</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>DR Number</th>
                                        <th>Customer</th>
                                        <th>Serial #</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="activeTimestampTable">
                                    <!-- Active deliveries will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-clock-history"></i> Delivery History with Timestamps</h5>
                        <span class="badge bg-success" id="historyTimestampCount">0</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-success">
                                <thead class="table-dark">
                                    <tr>
                                        <th>DR Number</th>
                                        <th>Completed Date & Time</th>
                                        <th>Customer</th>
                                        <th>Serial #</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTimestampTable">
                                    <!-- Completed deliveries with timestamps will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="bi bi-clock-fill"></i> Timestamp Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div id="timestampAnalysis">
                            <p class="text-muted">Run test to see timestamp analysis</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="bi bi-terminal"></i> Timestamp Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="timestampLog" class="bg-dark text-light p-3" style="font-family: monospace; height: 300px; overflow-y: auto;">
                            <!-- Timestamp log will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/enhanced-group-signature-dr-only.js"></script>
    
    <script>
        // Test data for timestamp verification
        let timestampTestDeliveries = [
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-001',
                customerName: 'Timestamp Test Customer A',
                itemNumber: 'ITM-001',
                mobileNumber: '09171111111',
                itemDescription: 'Test Item A',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Manila Office'
            },
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-002',
                customerName: 'Timestamp Test Customer B',
                itemNumber: 'ITM-002',
                mobileNumber: '09172222222',
                itemDescription: 'Test Item B',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Cebu Office'
            }
        ];
        
        let signatureTime = null;
        
        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // Update time every second
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // Capture console output for timestamp tracking
        const originalConsoleLog = console.log;
        const timestampLog = document.getElementById('timestampLog');
        
        function addToTimestampLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'lightblue',
                success: 'lightgreen',
                warning: 'orange',
                error: 'lightcoral'
            };
            const color = colors[type] || 'lightblue';
            timestampLog.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            timestampLog.scrollTop = timestampLog.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToTimestampLog(args.join(' '), 'info');
        };
        
        function setupTimestampTest() {
            addToTimestampLog('üïê Setting up timestamp verification test...', 'info');
            
            // Reset global arrays
            window.activeDeliveries = [...timestampTestDeliveries];
            window.deliveryHistory = [];
            
            addToTimestampLog(`‚úÖ Timestamp test data setup: ${timestampTestDeliveries.length} deliveries`, 'success');
            
            updateTimestampTables();
            showTimestampResult('Timestamp test data setup complete. Ready to test timestamp functionality.', 'info');
        }
        
        function updateTimestampTables() {
            const activeCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            const historyCount = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            // Update badges
            document.getElementById('activeTimestampCount').textContent = activeCount;
            document.getElementById('historyTimestampCount').textContent = historyCount;
            
            // Update active deliveries table
            const activeTable = document.getElementById('activeTimestampTable');
            if (activeCount === 0) {
                activeTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No active deliveries</td></tr>';
            } else {
                activeTable.innerHTML = window.activeDeliveries.map(d => 
                    `<tr>
                        <td><strong>${d.drNumber}</strong></td>
                        <td>${d.customerName}</td>
                        <td>${d.serialNumber}</td>
                        <td><span class="badge bg-warning">${d.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="signTimestampDelivery('${d.drNumber}')">
                                <i class="bi bi-pen"></i> Sign
                            </button>
                        </td>
                    </tr>`
                ).join('');
            }
            
            // Update history table with timestamp focus
            const historyTable = document.getElementById('historyTimestampTable');
            if (historyCount === 0) {
                historyTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No completed deliveries</td></tr>';
            } else {
                historyTable.innerHTML = window.deliveryHistory.map(d => 
                    `<tr>
                        <td><strong>${d.drNumber}</strong></td>
                        <td>
                            <div class="fw-bold text-success">${d.completedDateTime || d.completedDate || 'N/A'}</div>
                            <small class="text-muted">ISO: ${d.completedTimestamp || 'N/A'}</small>
                        </td>
                        <td>${d.customerName}</td>
                        <td>${d.serialNumber}</td>
                    </tr>`
                ).join('');
            }
        }
        
        function signTimestampDelivery(drNumber) {
            // Record the signing time
            signatureTime = new Date();
            const signingTimeString = signatureTime.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            
            addToTimestampLog(`üñäÔ∏è Signing delivery: ${drNumber} at ${signingTimeString}`, 'warning');
            
            if (typeof window.enhancedUpdateDeliveryStatusDROnly === 'function') {
                window.enhancedUpdateDeliveryStatusDROnly(drNumber, 'Completed');
                
                // Check results after a short delay
                setTimeout(() => {
                    updateTimestampTables();
                    verifyTimestamp();
                }, 500);
                
            } else {
                addToTimestampLog('‚ùå Enhanced DR-only function not available', 'error');
                showTimestampResult('Error: DR-Only function not loaded', 'danger');
            }
        }
        
        function testTimestamp() {
            addToTimestampLog('üïê Testing timestamp functionality for DR-001...', 'info');
            
            if (!window.activeDeliveries || window.activeDeliveries.length === 0) {
                addToTimestampLog('‚ùå No timestamp test data available. Please setup test data first.', 'error');
                showTimestampResult('Please setup timestamp test data first before testing.', 'danger');
                return;
            }
            
            signTimestampDelivery('DR-001');
        }
        
        function verifyTimestamp() {
            addToTimestampLog('üîç VERIFYING TIMESTAMP ACCURACY:', 'info');
            
            const historyCount = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            if (historyCount === 0) {
                addToTimestampLog('‚ùå No deliveries in history to verify timestamp', 'error');
                showTimestampResult('‚ùå No deliveries moved to history', 'danger');
                return;
            }
            
            let timestampResults = [];
            let allTimestampsValid = true;
            
            window.deliveryHistory.forEach((delivery, index) => {
                const drNumber = delivery.drNumber || delivery.dr_number;
                const completedDateTime = delivery.completedDateTime;
                const completedTimestamp = delivery.completedTimestamp;
                const completedDate = delivery.completedDate;
                
                // Check if timestamp exists and is recent
                const hasDateTime = !!completedDateTime;
                const hasTimestamp = !!completedTimestamp;
                const hasDate = !!completedDate;
                
                let timeDifference = null;
                if (signatureTime && completedTimestamp) {
                    const completedTime = new Date(completedTimestamp);
                    timeDifference = Math.abs(completedTime - signatureTime);
                }
                
                const isAccurate = timeDifference !== null && timeDifference < 5000; // Within 5 seconds
                
                timestampResults.push({
                    drNumber,
                    completedDateTime: completedDateTime || 'MISSING',
                    completedTimestamp: completedTimestamp || 'MISSING',
                    completedDate: completedDate || 'MISSING',
                    hasDateTime,
                    hasTimestamp,
                    hasDate,
                    timeDifference,
                    isAccurate
                });
                
                if (!hasDateTime || !hasTimestamp || !isAccurate) {
                    allTimestampsValid = false;
                }
                
                addToTimestampLog(`  Delivery ${index + 1} (${drNumber}):`, 'info');
                addToTimestampLog(`    DateTime: ${completedDateTime || 'MISSING'}`, hasDateTime ? 'success' : 'error');
                addToTimestampLog(`    Timestamp: ${completedTimestamp || 'MISSING'}`, hasTimestamp ? 'success' : 'error');
                addToTimestampLog(`    Accuracy: ${timeDifference !== null ? `${timeDifference}ms difference` : 'Cannot verify'}`, isAccurate ? 'success' : 'warning');
            });
            
            // Display timestamp analysis
            const analysisDiv = document.getElementById('timestampAnalysis');
            analysisDiv.innerHTML = `
                <h6>Timestamp Analysis Results:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>DR</th>
                                <th>Date & Time</th>
                                <th>ISO Timestamp</th>
                                <th>Accuracy</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${timestampResults.map(result => `
                                <tr class="${result.isAccurate ? 'table-success' : 'table-warning'}">
                                    <td>${result.drNumber}</td>
                                    <td>${result.completedDateTime}</td>
                                    <td><small>${result.completedTimestamp}</small></td>
                                    <td>${result.timeDifference !== null ? `${result.timeDifference}ms` : 'N/A'}</td>
                                    <td>
                                        <span class="badge ${result.isAccurate ? 'bg-success' : 'bg-warning'}">
                                            ${result.isAccurate ? '‚úÖ Accurate' : '‚ö†Ô∏è Check'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            if (allTimestampsValid) {
                addToTimestampLog('‚úÖ TIMESTAMP VERIFICATION SUCCESS: All timestamps accurate!', 'success');
                showTimestampResult('‚úÖ SUCCESS: Delivery History shows precise timestamps with date and time!', 'success');
            } else {
                addToTimestampLog('‚ö†Ô∏è TIMESTAMP VERIFICATION WARNING: Some timestamps may need attention', 'warning');
                showTimestampResult('‚ö†Ô∏è WARNING: Some timestamp issues detected - check analysis above', 'warning');
            }
        }
        
        function showTimestampResult(message, type) {
            const resultDiv = document.getElementById('timestampResult');
            resultDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addToTimestampLog('Timestamp Verification Test loaded', 'info');
            showTimestampResult('Timestamp test ready. Click "Setup Test Data" to begin.', 'info');
            updateTimestampTables();
        });
    </script>
</body>
</html>