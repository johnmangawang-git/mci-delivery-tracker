<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Priority Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Storage Priority Implementation Test</h1>
        <p>This page tests the new Supabase-primary with offline resilience approach.</p>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5>Storage Priority Configuration</h5>
            </div>
            <div class="card-body">
                <pre id="configOutput">Loading configuration...</pre>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5>Test Operations</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary me-2" onclick="testSaveDelivery()">Test Save Delivery</button>
                <button class="btn btn-secondary me-2" onclick="testGetConfig()">Get Config</button>
                <button class="btn btn-info" onclick="testStorageService()">Test Storage Service</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Test Results</h5>
            </div>
            <div class="card-body">
                <pre id="testOutput">Run a test to see results...</pre>
            </div>
        </div>
    </div>

    <script>
        // Wait for the page to load
        window.addEventListener('DOMContentLoaded', function() {
            // Display configuration
            displayConfig();
        });
        
        function displayConfig() {
            const configOutput = document.getElementById('configOutput');
            if (window.storagePriorityConfig) {
                configOutput.textContent = JSON.stringify(window.storagePriorityConfig, null, 2);
            } else {
                configOutput.textContent = 'Storage priority configuration not loaded';
            }
        }
        
        function testGetConfig() {
            const testOutput = document.getElementById('testOutput');
            try {
                const config = window.getStoragePriorityConfig();
                testOutput.textContent = 'Configuration retrieved successfully:\n' + JSON.stringify(config, null, 2);
            } catch (error) {
                testOutput.textContent = 'Error retrieving configuration: ' + error.message;
            }
        }
        
        function testStorageService() {
            const testOutput = document.getElementById('testOutput');
            try {
                const service = window.getStoragePriorityService();
                testOutput.textContent = 'Storage service retrieved successfully: ' + typeof service;
            } catch (error) {
                testOutput.textContent = 'Error retrieving storage service: ' + error.message;
            }
        }
        
        async function testSaveDelivery() {
            const testOutput = document.getElementById('testOutput');
            try {
                // Create a test delivery
                const testDelivery = {
                    dr_number: 'TEST-' + Date.now(),
                    customer_name: 'Test Customer',
                    vendor_number: 'VEND-001',
                    origin: 'Test Warehouse',
                    destination: 'Test Destination',
                    truck_type: 'L300',
                    truck_plate_number: 'TEST-123',
                    status: 'Active',
                    additional_costs: 0,
                    created_date: new Date().toISOString().split('T')[0],
                    created_by: 'Test',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                testOutput.textContent = 'Saving test delivery...\n' + JSON.stringify(testDelivery, null, 2);
                
                // Test with storage priority service
                if (window.storagePriorityService) {
                    const result = await window.storagePriorityService.executeWithPriority('upsert', 'deliveries', testDelivery);
                    testOutput.textContent += '\n\n✅ Delivery saved successfully:\n' + JSON.stringify(result, null, 2);
                } else {
                    testOutput.textContent += '\n\n⚠️ Storage priority service not available';
                }
            } catch (error) {
                testOutput.textContent = 'Error saving delivery: ' + error.message;
            }
        }
    </script>
</body>
</html>