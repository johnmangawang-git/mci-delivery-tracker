<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Save Issue Diagnostic - MCI Delivery System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .debug-log { background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .status-good { color: #28a745; }
        .status-bad { color: #dc3545; }
        .status-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-section">
            <h2><i class="bi bi-bug-fill text-danger"></i> Booking Save Issue Diagnostic</h2>
            <p class="text-muted">Investigating why completed bookings are not being saved to Active Deliveries</p>
            
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle"></i> Issue:</h5>
                <p><strong>Problem:</strong> Bookings created in "Delivery Booking" modal are not appearing in "Active Deliveries"</p>
                <p><strong>Expected:</strong> After clicking "Confirm Booking", the delivery should appear in Active Deliveries table</p>
            </div>
        </div>

        <div class="test-section">
            <h4>Data Flow Investigation</h4>
            <div class="row">
                <div class="col-md-6">
                    <h6>Global Variables Status:</h6>
                    <ul class="list-group" id="globalVarsStatus">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            window.activeDeliveries
                            <span id="windowActiveDeliveries" class="badge bg-secondary">Checking...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            localStorage mci-active-deliveries
                            <span id="localStorageActiveDeliveries" class="badge bg-secondary">Checking...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            loadActiveDeliveries function
                            <span id="loadActiveDeliveriesFunc" class="badge bg-secondary">Checking...</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            saveBooking function
                            <span id="saveBookingFunc" class="badge bg-secondary">Checking...</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Current Data State:</h6>
                    <div id="dataState" class="card">
                        <div class="card-body">
                            <p><strong>window.activeDeliveries:</strong> <span id="windowActiveCount">-</span> items</p>
                            <p><strong>localStorage:</strong> <span id="localStorageCount">-</span> items</p>
                            <p><strong>Data sync:</strong> <span id="dataSyncStatus">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h4>Booking Save Simulation</h4>
            <div class="row">
                <div class="col-md-8">
                    <h6>Test Booking Data:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">DR Number:</label>
                                <input type="text" id="testDrNumber" class="form-control" value="DR-TEST-001">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Customer Name:</label>
                                <input type="text" id="testCustomerName" class="form-control" value="Test Customer">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Origin:</label>
                                <input type="text" id="testOrigin" class="form-control" value="Manila">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Destination:</label>
                                <input type="text" id="testDestination" class="form-control" value="Quezon City">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Truck Type:</label>
                                <input type="text" id="testTruckType" class="form-control" value="10-Wheeler">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Plate Number:</label>
                                <input type="text" id="testPlateNumber" class="form-control" value="ABC-1234">
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="simulateBookingSave" class="btn btn-primary">
                            <i class="bi bi-save"></i> Simulate Booking Save
                        </button>
                        <button id="testLoadActiveDeliveries" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Test Load Active Deliveries
                        </button>
                        <button id="clearTestData" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Clear Test Data
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>Test Results:</h6>
                    <div id="testResults" class="alert alert-info">
                        <p><strong>Status:</strong> Ready to test</p>
                        <p><strong>Instructions:</strong> Click "Simulate Booking Save" to test</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h4>Active Deliveries Table Test</h4>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>DR Number</th>
                            <th>Customer</th>
                            <th>Origin</th>
                            <th>Destination</th>
                            <th>Status</th>
                            <th>Date Added</th>
                        </tr>
                    </thead>
                    <tbody id="testActiveDeliveriesTable">
                        <tr>
                            <td colspan="6" class="text-center text-muted">No test data yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="test-section">
            <h4>Debug Log</h4>
            <div id="debugLog" class="debug-log">
                <div>Debug log initialized...</div>
            </div>
            <button id="clearLog" class="btn btn-sm btn-outline-secondary mt-2">Clear Log</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Debug logging function
        function debugLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = type === 'error' ? 'status-bad' : type === 'success' ? 'status-good' : type === 'warning' ? 'status-warning' : '';
            log.innerHTML += `<div class="${typeClass}">[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Check global variables and functions
        function checkSystemStatus() {
            debugLog('Checking system status...');
            
            // Check window.activeDeliveries
            const windowActiveDeliveries = document.getElementById('windowActiveDeliveries');
            if (typeof window.activeDeliveries !== 'undefined') {
                windowActiveDeliveries.textContent = `Available (${window.activeDeliveries.length} items)`;
                windowActiveDeliveries.className = 'badge bg-success';
                debugLog(`✅ window.activeDeliveries available with ${window.activeDeliveries.length} items`, 'success');
            } else {
                windowActiveDeliveries.textContent = 'Not Available';
                windowActiveDeliveries.className = 'badge bg-danger';
                debugLog('❌ window.activeDeliveries not available', 'error');
            }

            // Check localStorage
            const localStorageActiveDeliveries = document.getElementById('localStorageActiveDeliveries');
            try {
                const saved = localStorage.getItem('mci-active-deliveries');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    localStorageActiveDeliveries.textContent = `Available (${parsed.length} items)`;
                    localStorageActiveDeliveries.className = 'badge bg-success';
                    debugLog(`✅ localStorage has ${parsed.length} active deliveries`, 'success');
                } else {
                    localStorageActiveDeliveries.textContent = 'Empty';
                    localStorageActiveDeliveries.className = 'badge bg-warning';
                    debugLog('⚠️ localStorage mci-active-deliveries is empty', 'warning');
                }
            } catch (error) {
                localStorageActiveDeliveries.textContent = 'Error';
                localStorageActiveDeliveries.className = 'badge bg-danger';
                debugLog(`❌ Error reading localStorage: ${error.message}`, 'error');
            }

            // Check loadActiveDeliveries function
            const loadActiveDeliveriesFunc = document.getElementById('loadActiveDeliveriesFunc');
            if (typeof window.loadActiveDeliveries === 'function') {
                loadActiveDeliveriesFunc.textContent = 'Available';
                loadActiveDeliveriesFunc.className = 'badge bg-success';
                debugLog('✅ loadActiveDeliveries function available', 'success');
            } else {
                loadActiveDeliveriesFunc.textContent = 'Not Available';
                loadActiveDeliveriesFunc.className = 'badge bg-danger';
                debugLog('❌ loadActiveDeliveries function not available', 'error');
            }

            // Check saveBooking function
            const saveBookingFunc = document.getElementById('saveBookingFunc');
            if (typeof window.saveBooking === 'function') {
                saveBookingFunc.textContent = 'Available';
                saveBookingFunc.className = 'badge bg-success';
                debugLog('✅ saveBooking function available', 'success');
            } else {
                saveBookingFunc.textContent = 'Not Available';
                saveBookingFunc.className = 'badge bg-danger';
                debugLog('❌ saveBooking function not available', 'error');
            }

            updateDataState();
        }

        // Update data state display
        function updateDataState() {
            const windowActiveCount = document.getElementById('windowActiveCount');
            const localStorageCount = document.getElementById('localStorageCount');
            const dataSyncStatus = document.getElementById('dataSyncStatus');

            // Window count
            if (typeof window.activeDeliveries !== 'undefined') {
                windowActiveCount.textContent = window.activeDeliveries.length;
            } else {
                windowActiveCount.textContent = 'N/A';
            }

            // localStorage count
            try {
                const saved = localStorage.getItem('mci-active-deliveries');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    localStorageCount.textContent = parsed.length;
                } else {
                    localStorageCount.textContent = '0';
                }
            } catch (error) {
                localStorageCount.textContent = 'Error';
            }

            // Sync status
            const windowCount = typeof window.activeDeliveries !== 'undefined' ? window.activeDeliveries.length : -1;
            const localCount = (() => {
                try {
                    const saved = localStorage.getItem('mci-active-deliveries');
                    return saved ? JSON.parse(saved).length : 0;
                } catch {
                    return -1;
                }
            })();

            if (windowCount === localCount && windowCount >= 0) {
                dataSyncStatus.textContent = '✅ Synced';
                dataSyncStatus.className = 'status-good';
            } else {
                dataSyncStatus.textContent = '❌ Out of sync';
                dataSyncStatus.className = 'status-bad';
            }
        }

        // Simulate booking save
        function simulateBookingSave() {
            debugLog('🧪 Simulating booking save...');
            
            // Initialize window.activeDeliveries if not exists
            if (typeof window.activeDeliveries === 'undefined') {
                window.activeDeliveries = [];
                debugLog('Initialized window.activeDeliveries array');
            }

            // Get test data
            const testBooking = {
                id: 'DEL-' + Date.now() + '-TEST',
                drNumber: document.getElementById('testDrNumber').value,
                customerName: document.getElementById('testCustomerName').value,
                origin: document.getElementById('testOrigin').value,
                destination: document.getElementById('testDestination').value,
                truckType: document.getElementById('testTruckType').value,
                truckPlateNumber: document.getElementById('testPlateNumber').value,
                status: 'On Schedule',
                deliveryDate: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString()
            };

            debugLog(`Creating test booking: ${testBooking.drNumber}`);

            // Add to window.activeDeliveries
            window.activeDeliveries.push(testBooking);
            debugLog(`✅ Added to window.activeDeliveries. Total: ${window.activeDeliveries.length}`, 'success');

            // Save to localStorage
            try {
                localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
                debugLog('✅ Saved to localStorage', 'success');
            } catch (error) {
                debugLog(`❌ Error saving to localStorage: ${error.message}`, 'error');
            }

            // Update displays
            updateDataState();
            updateTestTable();
            checkSystemStatus();

            // Test results
            document.getElementById('testResults').innerHTML = `
                <p><strong>Status:</strong> ✅ Booking saved successfully</p>
                <p><strong>DR Number:</strong> ${testBooking.drNumber}</p>
                <p><strong>Total Active:</strong> ${window.activeDeliveries.length}</p>
                <p><strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
            `;

            // Try to call loadActiveDeliveries if available
            if (typeof window.loadActiveDeliveries === 'function') {
                debugLog('🔄 Calling loadActiveDeliveries...');
                try {
                    window.loadActiveDeliveries();
                    debugLog('✅ loadActiveDeliveries called successfully', 'success');
                } catch (error) {
                    debugLog(`❌ Error calling loadActiveDeliveries: ${error.message}`, 'error');
                }
            } else {
                debugLog('⚠️ loadActiveDeliveries function not available', 'warning');
            }
        }

        // Update test table
        function updateTestTable() {
            const tbody = document.getElementById('testActiveDeliveriesTable');
            
            if (typeof window.activeDeliveries === 'undefined' || window.activeDeliveries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No active deliveries</td></tr>';
                return;
            }

            tbody.innerHTML = window.activeDeliveries.map(delivery => `
                <tr>
                    <td><strong>${delivery.drNumber}</strong></td>
                    <td>${delivery.customerName}</td>
                    <td>${delivery.origin}</td>
                    <td>${delivery.destination}</td>
                    <td><span class="badge bg-success">${delivery.status}</span></td>
                    <td>${new Date(delivery.timestamp).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // Clear test data
        function clearTestData() {
            debugLog('🧹 Clearing test data...');
            
            if (typeof window.activeDeliveries !== 'undefined') {
                window.activeDeliveries = [];
                debugLog('Cleared window.activeDeliveries');
            }

            try {
                localStorage.removeItem('mci-active-deliveries');
                debugLog('Cleared localStorage');
            } catch (error) {
                debugLog(`Error clearing localStorage: ${error.message}`, 'error');
            }

            updateDataState();
            updateTestTable();
            checkSystemStatus();

            document.getElementById('testResults').innerHTML = `
                <p><strong>Status:</strong> 🧹 Test data cleared</p>
                <p><strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
            `;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('🚀 Booking save diagnostic initialized');
            
            // Initial system check
            checkSystemStatus();
            updateTestTable();

            // Simulate booking save
            document.getElementById('simulateBookingSave').addEventListener('click', simulateBookingSave);

            // Test load active deliveries
            document.getElementById('testLoadActiveDeliveries').addEventListener('click', function() {
                debugLog('🧪 Testing loadActiveDeliveries function...');
                
                if (typeof window.loadActiveDeliveries === 'function') {
                    try {
                        window.loadActiveDeliveries();
                        debugLog('✅ loadActiveDeliveries executed successfully', 'success');
                    } catch (error) {
                        debugLog(`❌ Error executing loadActiveDeliveries: ${error.message}`, 'error');
                    }
                } else {
                    debugLog('❌ loadActiveDeliveries function not available', 'error');
                }
            });

            // Clear test data
            document.getElementById('clearTestData').addEventListener('click', clearTestData);

            // Clear log
            document.getElementById('clearLog').addEventListener('click', function() {
                document.getElementById('debugLog').innerHTML = '<div>Debug log cleared...</div>';
            });

            // Refresh status every 5 seconds
            setInterval(() => {
                updateDataState();
            }, 5000);
        });

        // Initialize window.activeDeliveries if not exists (for testing)
        if (typeof window.activeDeliveries === 'undefined') {
            window.activeDeliveries = [];
        }
    </script>
</body>
</html>