<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Schema Fix - Apply Additional Costs Schema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h3><i class="bi bi-exclamation-triangle"></i> Schema Fix Required</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h5>Analytics Dashboard Error Fix</h5>
                            <p>Your analytics dashboard is showing errors because the additional costs schema hasn't been applied to Supabase yet.</p>
                        </div>
                        
                        <h5>Current Errors:</h5>
                        <ul class="text-danger">
                            <li>404 error on cost_breakdown_analytics endpoint</li>
                            <li>Could not find table 'public.cost_breakdown_analytics'</li>
                            <li>Chart.js rendering errors</li>
                        </ul>
                        
                        <h5 class="mt-4">Quick Fix Options:</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6><i class="bi bi-database"></i> Option 1: Apply Schema (Recommended)</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>This will enable full functionality</strong></p>
                                        <ol>
                                            <li>Open <a href="https://supabase.com" target="_blank">Supabase Dashboard</a></li>
                                            <li>Go to SQL Editor</li>
                                            <li>Copy the schema below</li>
                                            <li>Paste and run it</li>
                                            <li>Refresh your app</li>
                                        </ol>
                                        <button class="btn btn-success" onclick="copySchema()">
                                            <i class="bi bi-clipboard"></i> Copy Schema SQL
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6><i class="bi bi-pause-circle"></i> Option 2: Continue with Fallback</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Dashboard works with localStorage</strong></p>
                                        <ul>
                                            <li>✅ No more errors</li>
                                            <li>✅ Charts work</li>
                                            <li>⚠️ Limited functionality</li>
                                            <li>⚠️ No real-time sync</li>
                                        </ul>
                                        <button class="btn btn-warning" onclick="continueWithFallback()">
                                            <i class="bi bi-arrow-right"></i> Continue with Current Setup
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Schema SQL to Copy:</h5>
                            <div class="card">
                                <div class="card-body">
                                    <pre id="schemaSQL" class="bg-light p-3" style="max-height: 300px; overflow-y: auto; font-size: 12px;">-- Additional Cost Breakdown Schema Extension
-- This extends the existing schema to properly store detailed cost breakdown data

-- Create additional_cost_items table to store detailed cost breakdown
CREATE TABLE IF NOT EXISTS public.additional_cost_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    delivery_id UUID REFERENCES public.deliveries(id) ON DELETE CASCADE,
    description TEXT NOT NULL,
    amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    category TEXT, -- Auto-categorized (Fuel Surcharge, Toll Fees, Helper, etc.)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    user_id UUID REFERENCES auth.users(id) DEFAULT auth.uid()
);

-- Add indexes for performance
CREATE INDEX IF NOT EXISTS idx_additional_cost_items_delivery_id ON public.additional_cost_items(delivery_id);
CREATE INDEX IF NOT EXISTS idx_additional_cost_items_category ON public.additional_cost_items(category);
CREATE INDEX IF NOT EXISTS idx_additional_cost_items_user_id ON public.additional_cost_items(user_id);

-- Add a JSONB column to deliveries table for storing cost items array (for backward compatibility)
ALTER TABLE public.deliveries 
ADD COLUMN IF NOT EXISTS additional_cost_items JSONB DEFAULT '[]';

-- Create index on the JSONB column
CREATE INDEX IF NOT EXISTS idx_deliveries_additional_cost_items ON public.deliveries USING GIN (additional_cost_items);

-- Row Level Security Policies for additional_cost_items table

-- Enable RLS
ALTER TABLE public.additional_cost_items ENABLE ROW LEVEL SECURITY;

-- Users can view their own cost items
CREATE POLICY "Users can view their own cost items" ON public.additional_cost_items
    FOR SELECT USING (auth.uid() = user_id);

-- Users can insert their own cost items
CREATE POLICY "Users can insert their own cost items" ON public.additional_cost_items
    FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Users can update their own cost items
CREATE POLICY "Users can update their own cost items" ON public.additional_cost_items
    FOR UPDATE USING (auth.uid() = user_id);

-- Users can delete their own cost items
CREATE POLICY "Users can delete their own cost items" ON public.additional_cost_items
    FOR DELETE USING (auth.uid() = user_id);

-- Create a function to automatically update the total additional_costs in deliveries table
CREATE OR REPLACE FUNCTION update_delivery_total_costs()
RETURNS TRIGGER AS $$
BEGIN
    -- Update the total additional_costs in the deliveries table
    UPDATE public.deliveries 
    SET additional_costs = (
        SELECT COALESCE(SUM(amount), 0) 
        FROM public.additional_cost_items 
        WHERE delivery_id = COALESCE(NEW.delivery_id, OLD.delivery_id)
    ),
    updated_at = NOW()
    WHERE id = COALESCE(NEW.delivery_id, OLD.delivery_id);
    
    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- Create triggers to automatically update total costs
CREATE TRIGGER trigger_update_delivery_costs_on_insert
    AFTER INSERT ON public.additional_cost_items
    FOR EACH ROW EXECUTE FUNCTION update_delivery_total_costs();

CREATE TRIGGER trigger_update_delivery_costs_on_update
    AFTER UPDATE ON public.additional_cost_items
    FOR EACH ROW EXECUTE FUNCTION update_delivery_total_costs();

CREATE TRIGGER trigger_update_delivery_costs_on_delete
    AFTER DELETE ON public.additional_cost_items
    FOR EACH ROW EXECUTE FUNCTION update_delivery_total_costs();

-- Create analytics view for cost breakdown
CREATE OR REPLACE VIEW public.cost_breakdown_analytics AS
SELECT 
    aci.category,
    COUNT(*) as item_count,
    SUM(aci.amount) as total_amount,
    AVG(aci.amount) as average_amount,
    DATE_TRUNC('month', aci.created_at) as month,
    DATE_TRUNC('week', aci.created_at) as week,
    DATE_TRUNC('day', aci.created_at) as day
FROM public.additional_cost_items aci
WHERE aci.user_id = auth.uid()
GROUP BY aci.category, DATE_TRUNC('month', aci.created_at), DATE_TRUNC('week', aci.created_at), DATE_TRUNC('day', aci.created_at);

-- Grant permissions for analytics view
GRANT SELECT ON public.cost_breakdown_analytics TO authenticated;</pre>
                                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="copySchema()">
                                        <i class="bi bi-clipboard"></i> Copy to Clipboard
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="alert alert-success">
                                <h6><i class="bi bi-check-circle"></i> After Applying Schema:</h6>
                                <ul class="mb-0">
                                    <li>✅ All analytics errors will be fixed</li>
                                    <li>✅ Real-time cost breakdown analytics</li>
                                    <li>✅ Automatic cost categorization</li>
                                    <li>✅ Cross-browser data consistency</li>
                                    <li>✅ Proper data backup and recovery</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copySchema() {
            const schemaText = document.getElementById('schemaSQL').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(schemaText).then(() => {
                    alert('✅ Schema SQL copied to clipboard!\n\nNow:\n1. Open Supabase Dashboard\n2. Go to SQL Editor\n3. Paste and run the SQL\n4. Refresh your app');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    fallbackCopy(schemaText);
                });
            } else {
                fallbackCopy(schemaText);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('✅ Schema SQL copied to clipboard!\n\nNow:\n1. Open Supabase Dashboard\n2. Go to SQL Editor\n3. Paste and run the SQL\n4. Refresh your app');
            } catch (err) {
                alert('❌ Copy failed. Please manually select and copy the SQL text above.');
            }
            
            document.body.removeChild(textArea);
        }
        
        function continueWithFallback() {
            alert('✅ Continuing with localStorage fallback.\n\nYour dashboard will work without errors, but with limited functionality.\n\nYou can apply the schema later for full features.');
            window.close();
        }
        
        // Show current status
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 Quick Schema Fix page loaded');
            console.log('📊 Current status: Analytics using localStorage fallback');
        });
    </script>
</body>
</html>