<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Signature to History Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîß Signature to History Fix Test</h1>
    
    <div class="test-section info">
        <h3>Test Environment</h3>
        <p>This page tests the comprehensive signature to history fix functionality.</p>
        <div id="environmentStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üß™ Test Controls</h3>
        <button onclick="testFieldNormalization()">Test Field Normalization</button>
        <button onclick="testStatusUpdate()">Test Status Update</button>
        <button onclick="testSignatureCompletion()">Test Signature Completion</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h3>üìä Test Data</h3>
        <button onclick="createTestData()">Create Test Data</button>
        <button onclick="showCurrentData()">Show Current Data</button>
        <button onclick="clearTestData()">Clear Test Data</button>
    </div>
    
    <div class="test-section">
        <h3>üìù Test Log</h3>
        <div id="testLog" class="log"></div>
    </div>

    <!-- Load required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/signature-to-history-comprehensive-fix.js"></script>
    
    <script>
        // Test logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<span style="color: ${colorMap[type] || '#333'}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        // Initialize test environment
        function initTestEnvironment() {
            log('üîß Initializing test environment...', 'info');
            
            // Initialize global arrays if they don't exist
            if (typeof window.activeDeliveries === 'undefined') {
                window.activeDeliveries = [];
                log('‚úÖ Initialized window.activeDeliveries array', 'success');
            }
            
            if (typeof window.deliveryHistory === 'undefined') {
                window.deliveryHistory = [];
                log('‚úÖ Initialized window.deliveryHistory array', 'success');
            }
            
            // Check if comprehensive fix is loaded
            if (typeof window.comprehensiveSignatureToHistoryFix !== 'undefined') {
                log('‚úÖ Comprehensive signature to history fix loaded', 'success');
                log(`   Version: ${window.comprehensiveSignatureToHistoryFix.version}`, 'info');
                log(`   Loaded at: ${window.comprehensiveSignatureToHistoryFix.timestamp}`, 'info');
            } else {
                log('‚ùå Comprehensive signature to history fix NOT loaded', 'error');
            }
            
            // Check if functions are available
            const requiredFunctions = [
                'comprehensiveUpdateDeliveryStatus',
                'comprehensiveSaveSignature',
                'normalizeDeliveryFields'
            ];
            
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    log(`‚úÖ Function ${funcName} available`, 'success');
                } else {
                    log(`‚ùå Function ${funcName} NOT available`, 'error');
                }
            });
            
            // Update environment status
            const statusElement = document.getElementById('environmentStatus');
            const fixLoaded = typeof window.comprehensiveSignatureToHistoryFix !== 'undefined';
            statusElement.innerHTML = `
                <strong>Fix Status:</strong> ${fixLoaded ? '‚úÖ Loaded' : '‚ùå Not Loaded'}<br>
                <strong>Active Deliveries:</strong> ${window.activeDeliveries ? window.activeDeliveries.length : 0}<br>
                <strong>Delivery History:</strong> ${window.deliveryHistory ? window.deliveryHistory.length : 0}
            `;
        }
        
        // Test field normalization
        function testFieldNormalization() {
            log('üß™ Testing field normalization...', 'info');
            
            if (typeof window.normalizeDeliveryFields !== 'function') {
                log('‚ùå normalizeDeliveryFields function not available', 'error');
                return;
            }
            
            const testDelivery = {
                id: 'test-123',
                drNumber: 'DR001',
                customerName: 'Test Customer',
                vendorNumber: 'V001',
                truckPlateNumber: 'ABC-123',
                truckType: 'L300',
                status: 'Active'
            };
            
            log(`üìù Input: ${JSON.stringify(testDelivery, null, 2)}`, 'info');
            
            const normalized = window.normalizeDeliveryFields(testDelivery);
            log(`üìù Output: ${JSON.stringify(normalized, null, 2)}`, 'info');
            
            // Check if both field formats exist
            const hasAllFields = normalized.drNumber && normalized.dr_number && 
                                normalized.customerName && normalized.customer_name &&
                                normalized.vendorNumber && normalized.vendor_number;
            
            if (hasAllFields) {
                log('‚úÖ Field normalization test PASSED', 'success');
            } else {
                log('‚ùå Field normalization test FAILED', 'error');
            }
        }
        
        // Test status update
        async function testStatusUpdate() {
            log('üß™ Testing status update...', 'info');
            
            if (typeof window.comprehensiveUpdateDeliveryStatus !== 'function') {
                log('‚ùå comprehensiveUpdateDeliveryStatus function not available', 'error');
                return;
            }
            
            // Create test delivery if none exists
            if (window.activeDeliveries.length === 0) {
                createTestData();
            }
            
            const testDrNumber = 'DR001';
            log(`üìù Updating DR ${testDrNumber} to Completed...`, 'info');
            
            try {
                const result = await window.comprehensiveUpdateDeliveryStatus(testDrNumber, 'Completed');
                
                if (result) {
                    log('‚úÖ Status update test PASSED', 'success');
                    log(`üìä Active deliveries: ${window.activeDeliveries.length}`, 'info');
                    log(`üìä Delivery history: ${window.deliveryHistory.length}`, 'info');
                } else {
                    log('‚ùå Status update test FAILED', 'error');
                }
            } catch (error) {
                log(`‚ùå Status update test ERROR: ${error.message}`, 'error');
            }
        }
        
        // Test signature completion
        async function testSignatureCompletion() {
            log('üß™ Testing signature completion...', 'info');
            
            if (typeof window.comprehensiveSaveSignature !== 'function') {
                log('‚ùå comprehensiveSaveSignature function not available', 'error');
                return;
            }
            
            const testSignatureInfo = {
                drNumber: 'DR002',
                customerName: 'Test Customer 2',
                customerContact: 'V002',
                truckPlate: 'XYZ-789',
                deliveryRoute: 'Warehouse A to Customer B',
                signatureData: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
            };
            
            log(`üìù Signature info: ${JSON.stringify(testSignatureInfo, null, 2)}`, 'info');
            
            try {
                const result = await window.comprehensiveSaveSignature(testSignatureInfo);
                
                if (result) {
                    log('‚úÖ Signature completion test PASSED', 'success');
                } else {
                    log('‚ùå Signature completion test FAILED', 'error');
                }
            } catch (error) {
                log(`‚ùå Signature completion test ERROR: ${error.message}`, 'error');
            }
        }
        
        // Create test data
        function createTestData() {
            log('üìä Creating test data...', 'info');
            
            const testDeliveries = [
                {
                    id: 'test-001',
                    drNumber: 'DR001',
                    dr_number: 'DR001',
                    customerName: 'Test Customer 1',
                    customer_name: 'Test Customer 1',
                    vendorNumber: 'V001',
                    vendor_number: 'V001',
                    truckPlateNumber: 'ABC-123',
                    truck_plate_number: 'ABC-123',
                    truckType: 'L300',
                    truck_type: 'L300',
                    origin: 'Warehouse A',
                    destination: 'Customer A',
                    status: 'Active',
                    createdDate: new Date().toLocaleDateString()
                },
                {
                    id: 'test-002',
                    drNumber: 'DR002',
                    dr_number: 'DR002',
                    customerName: 'Test Customer 2',
                    customer_name: 'Test Customer 2',
                    vendorNumber: 'V002',
                    vendor_number: 'V002',
                    truckPlateNumber: 'XYZ-789',
                    truck_plate_number: 'XYZ-789',
                    truckType: 'Canter',
                    truck_type: 'Canter',
                    origin: 'Warehouse B',
                    destination: 'Customer B',
                    status: 'Active',
                    createdDate: new Date().toLocaleDateString()
                }
            ];
            
            window.activeDeliveries = testDeliveries;
            window.deliveryHistory = [];
            
            log(`‚úÖ Created ${testDeliveries.length} test deliveries`, 'success');
        }
        
        // Show current data
        function showCurrentData() {
            log('üìä Current data state:', 'info');
            log(`Active Deliveries (${window.activeDeliveries.length}):`, 'info');
            window.activeDeliveries.forEach((delivery, index) => {
                log(`  ${index + 1}. DR: ${delivery.drNumber || delivery.dr_number} - Status: ${delivery.status}`, 'info');
            });
            
            log(`Delivery History (${window.deliveryHistory.length}):`, 'info');
            window.deliveryHistory.forEach((delivery, index) => {
                log(`  ${index + 1}. DR: ${delivery.drNumber || delivery.dr_number} - Status: ${delivery.status}`, 'info');
            });
            
            // Check E-POD records
            try {
                const epodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                log(`E-POD Records (${epodRecords.length}):`, 'info');
                epodRecords.forEach((record, index) => {
                    log(`  ${index + 1}. DR: ${record.dr_number} - Signed: ${record.signed_at}`, 'info');
                });
            } catch (error) {
                log(`‚ùå Error reading E-POD records: ${error.message}`, 'error');
            }
        }
        
        // Clear test data
        function clearTestData() {
            log('üóëÔ∏è Clearing test data...', 'info');
            
            window.activeDeliveries = [];
            window.deliveryHistory = [];
            localStorage.removeItem('ePodRecords');
            localStorage.removeItem('mci-active-deliveries');
            localStorage.removeItem('mci-delivery-history');
            
            log('‚úÖ Test data cleared', 'success');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initTestEnvironment, 500); // Give scripts time to load
        });
    </script>
</body>
</html>