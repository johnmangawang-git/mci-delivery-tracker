<!DOCTYPE html>
<html>
<head>
    <title>Test Booking ‚Üí Analytics Data Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .test-section { background: white; border: 1px solid #ddd; margin: 10px 0; padding: 20px; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .log { background: #f5f5f5; padding: 15px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; border-radius: 4px; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .data-display { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üìä Booking ‚Üí Analytics Data Flow Test</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="checkGlobalArrays()" class="btn-primary">Check Global Arrays</button>
        <button onclick="simulateBooking()" class="btn-success">Simulate Booking</button>
        <button onclick="testAnalyticsData()" class="btn-warning">Test Analytics Data</button>
        <button onclick="clearAllData()" class="btn-danger">Clear All Data</button>
        <button onclick="clearLog()" class="btn btn-secondary">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h2>Current Data State</h2>
        <div id="dataDisplay" class="data-display"></div>
        <button onclick="refreshDataDisplay()" class="btn btn-outline-primary">Refresh Data Display</button>
    </div>
    
    <div class="test-section">
        <h2>Debug Log</h2>
        <div id="debugLog" class="log"></div>
    </div>
    
    <script>
        let debugLog = document.getElementById('debugLog');
        let dataDisplay = document.getElementById('dataDisplay');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\\n`;
            debugLog.textContent += logEntry;
            console.log(message);
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        function clearLog() {
            debugLog.textContent = '';
        }
        
        function checkGlobalArrays() {
            log('=== CHECKING GLOBAL ARRAYS ===');
            
            // Check if arrays exist
            if (typeof window.activeDeliveries !== 'undefined') {
                log(`‚úÖ window.activeDeliveries exists with ${window.activeDeliveries.length} items`);
            } else {
                log('‚ùå window.activeDeliveries is undefined');
                window.activeDeliveries = [];
                log('‚úÖ Initialized window.activeDeliveries');
            }
            
            if (typeof window.deliveryHistory !== 'undefined') {
                log(`‚úÖ window.deliveryHistory exists with ${window.deliveryHistory.length} items`);
            } else {
                log('‚ùå window.deliveryHistory is undefined');
                window.deliveryHistory = [];
                log('‚úÖ Initialized window.deliveryHistory');
            }
            
            // Check localStorage
            const savedActive = localStorage.getItem('mci-active-deliveries');
            const savedHistory = localStorage.getItem('mci-delivery-history');
            
            if (savedActive) {
                const parsed = JSON.parse(savedActive);
                log(`‚úÖ localStorage has ${parsed.length} active deliveries`);
            } else {
                log('‚ö†Ô∏è No active deliveries in localStorage');
            }
            
            if (savedHistory) {
                const parsed = JSON.parse(savedHistory);
                log(`‚úÖ localStorage has ${parsed.length} delivery history`);
            } else {
                log('‚ö†Ô∏è No delivery history in localStorage');
            }
            
            refreshDataDisplay();
        }
        
        function simulateBooking() {
            log('=== SIMULATING BOOKING ===');
            
            // Ensure arrays exist
            if (typeof window.activeDeliveries === 'undefined') {
                window.activeDeliveries = [];
                log('Initialized window.activeDeliveries');
            }
            
            // Create a mock booking
            const mockBooking = {
                id: 'DEL-' + Date.now(),
                drNumbers: ['DR-' + Math.floor(Math.random() * 10000)],
                customerName: 'Test Customer ' + Math.floor(Math.random() * 100),
                customerNumber: '+63 999 ' + Math.floor(Math.random() * 1000000),
                origin: Math.random() > 0.5 ? 'SMEG Alabang warehouse' : 'SMEG Cebu warehouse',
                destinations: ['Test Destination City'],
                distance: (Math.random() * 50 + 5).toFixed(1) + ' km',
                deliveryDate: new Date().toISOString().split('T')[0],
                additionalCosts: Math.floor(Math.random() * 1000) + 100,
                additionalCostItems: [
                    {
                        description: Math.random() > 0.5 ? 'Gas money' : 'Helper fee',
                        amount: Math.floor(Math.random() * 500) + 100
                    }
                ],
                timestamp: new Date().toISOString(),
                status: 'active'
            };
            
            // Add to activeDeliveries
            window.activeDeliveries.push(mockBooking);
            log(`‚úÖ Added booking: ${mockBooking.id}`);
            log(`Total active deliveries: ${window.activeDeliveries.length}`);
            
            // Save to localStorage
            try {
                localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
                log('‚úÖ Saved to localStorage');
            } catch (error) {
                log(`‚ùå Error saving to localStorage: ${error.message}`);
            }
            
            // Update display
            refreshDataDisplay();
            
            log('‚úÖ Booking simulation completed');
        }
        
        function testAnalyticsData() {
            log('=== TESTING ANALYTICS DATA PROCESSING ===');
            
            const activeDeliveries = window.activeDeliveries || [];
            const deliveryHistory = window.deliveryHistory || [];
            const allDeliveries = [...activeDeliveries, ...deliveryHistory];
            
            log(`Analytics data source:`);
            log(`  - Active deliveries: ${activeDeliveries.length}`);
            log(`  - Delivery history: ${deliveryHistory.length}`);
            log(`  - Total deliveries: ${allDeliveries.length}`);
            
            if (allDeliveries.length === 0) {
                log('‚ö†Ô∏è No delivery data available for analytics');
                return;
            }
            
            // Test metrics calculation
            const totalBookings = allDeliveries.length;
            
            let totalDistance = 0;
            allDeliveries.forEach(delivery => {
                if (delivery.distance) {
                    const distanceMatch = delivery.distance.match(/(\d+\.?\d*)/);
                    if (distanceMatch) {
                        totalDistance += parseFloat(distanceMatch[1]) || 0;
                    }
                }
            });
            
            let totalAdditionalCost = 0;
            allDeliveries.forEach(delivery => {
                if (typeof delivery.additionalCosts === 'number') {
                    totalAdditionalCost += delivery.additionalCosts;
                }
            });
            
            log(`Analytics metrics:`);
            log(`  - Total bookings: ${totalBookings}`);
            log(`  - Total distance: ${totalDistance.toFixed(1)} km`);
            log(`  - Total additional costs: ‚Ç±${totalAdditionalCost.toLocaleString()}`);
            
            // Test daily data processing
            const today = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' });
            const todayBookings = allDeliveries.filter(d => {
                const deliveryDate = new Date(d.deliveryDate || d.timestamp);
                const deliveryDay = deliveryDate.toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' });
                return deliveryDay === today;
            });
            
            log(`Today's bookings (${today}): ${todayBookings.length}`);
            
            if (todayBookings.length > 0) {
                log('‚úÖ Analytics data processing successful');
            } else {
                log('‚ö†Ô∏è No bookings for today - analytics charts may appear empty');
            }
        }
        
        function refreshDataDisplay() {
            const activeCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            const historyCount = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            const savedActive = localStorage.getItem('mci-active-deliveries');
            const savedHistory = localStorage.getItem('mci-delivery-history');
            
            const savedActiveCount = savedActive ? JSON.parse(savedActive).length : 0;
            const savedHistoryCount = savedHistory ? JSON.parse(savedHistory).length : 0;
            
            dataDisplay.innerHTML = `
                <h4>Global Arrays:</h4>
                <p><strong>window.activeDeliveries:</strong> ${activeCount} items</p>
                <p><strong>window.deliveryHistory:</strong> ${historyCount} items</p>
                
                <h4>localStorage:</h4>
                <p><strong>mci-active-deliveries:</strong> ${savedActiveCount} items</p>
                <p><strong>mci-delivery-history:</strong> ${savedHistoryCount} items</p>
                
                <h4>Analytics Ready:</h4>
                <p><strong>Total data for analytics:</strong> ${activeCount + historyCount} items</p>
                <p><strong>Status:</strong> ${(activeCount + historyCount) > 0 ? '‚úÖ Ready' : '‚ö†Ô∏è No data'}</p>
            `;
        }
        
        function clearAllData() {
            log('=== CLEARING ALL DATA ===');
            
            window.activeDeliveries = [];
            window.deliveryHistory = [];
            
            localStorage.removeItem('mci-active-deliveries');
            localStorage.removeItem('mci-delivery-history');
            
            log('‚úÖ Cleared all global arrays and localStorage');
            refreshDataDisplay();
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            log('üìä Booking ‚Üí Analytics Data Flow Test Loaded');
            
            // Initialize arrays if they don't exist
            if (typeof window.activeDeliveries === 'undefined') {
                window.activeDeliveries = [];
            }
            if (typeof window.deliveryHistory === 'undefined') {
                window.deliveryHistory = [];
            }
            
            log('Ready to test booking ‚Üí analytics data flow');
            
            setTimeout(() => {
                checkGlobalArrays();
            }, 500);
        });
    </script>
</body>
</html>"