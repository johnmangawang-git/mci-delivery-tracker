<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPOD Troubleshooting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>EPOD Troubleshooting</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>Debug Information</h5>
            </div>
            <div class="card-body">
                <div id="debugInfo" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>Test Functions</h5>
            </div>
            <div class="card-body">
                <button id="checkAll" class="btn btn-primary me-2">1. Check All Systems</button>
                <button id="createTestRecord" class="btn btn-success me-2">2. Create Test Record</button>
                <button id="loadRecords" class="btn btn-info me-2">3. Load Records</button>
                <button id="clearRecords" class="btn btn-danger">4. Clear Records</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>EPOD Records</h5>
            </div>
            <div class="card-body">
                <div id="epodRecords"></div>
            </div>
        </div>
    </div>

    <script>
        // Debug function to log information
        function log(message, type = 'info') {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `text-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            debugInfo.appendChild(logEntry);
            console.log(`[${timestamp}] ${message}`);
            
            // Auto-scroll to bottom
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        // Check all systems
        function checkAll() {
            log('=== Checking All Systems ===', 'primary');
            
            // Check if required functions are available
            log('Checking function availability...', 'info');
            log('window.dataService available: ' + (typeof window.dataService !== 'undefined'), 'info');
            log('window.dataService.getEPodRecords available: ' + (typeof window.dataService?.getEPodRecords === 'function'), 'info');
            log('window.dataService.saveEPodRecord available: ' + (typeof window.dataService?.saveEPodRecord === 'function'), 'info');
            
            // Check localStorage
            try {
                const ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                log('localStorage EPOD records count: ' + ePodRecords.length, 'info');
                if (ePodRecords.length > 0) {
                    log('First record DR Number: ' + ePodRecords[0].drNumber, 'info');
                }
            } catch (error) {
                log('Error accessing localStorage: ' + error.message, 'danger');
            }
            
            // Check Supabase configuration
            log('Checking Supabase configuration...', 'info');
            if (typeof window.SUPABASE_URL !== 'undefined') {
                log('SUPABASE_URL: ' + (window.SUPABASE_URL ? 'Set' : 'Not set'), 'info');
            } else {
                log('SUPABASE_URL: Not defined', 'warning');
            }
            
            if (typeof window.SUPABASE_ANON_KEY !== 'undefined') {
                log('SUPABASE_ANON_KEY: ' + (window.SUPABASE_ANON_KEY ? 'Set' : 'Not set'), 'info');
            } else {
                log('SUPABASE_ANON_KEY: Not defined', 'warning');
            }
        }
        
        // Create test record
        async function createTestRecord() {
            log('=== Creating Test Record ===', 'primary');
            
            const testRecord = {
                drNumber: 'DR-TEST-' + Date.now(),
                customerName: 'Test Customer',
                customerContact: '09123456789',
                truckPlate: 'ABC123',
                origin: 'Test Origin',
                destination: 'Test Destination',
                signature: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                status: 'Completed',
                signedAt: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            
            log('Test record created: ' + testRecord.drNumber, 'info');
            
            // Try to save using dataService
            if (typeof window.dataService !== 'undefined' && typeof window.dataService.saveEPodRecord === 'function') {
                log('Saving via dataService...', 'info');
                try {
                    const result = await window.dataService.saveEPodRecord(testRecord);
                    log('Record saved via dataService: ' + result.drNumber, 'success');
                } catch (error) {
                    log('Error saving via dataService: ' + error.message, 'danger');
                }
            } else {
                log('dataService not available, saving to localStorage directly...', 'warning');
                try {
                    let ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                    ePodRecords.push(testRecord);
                    localStorage.setItem('ePodRecords', JSON.stringify(ePodRecords));
                    log('Record saved to localStorage. Total records: ' + ePodRecords.length, 'success');
                } catch (error) {
                    log('Error saving to localStorage: ' + error.message, 'danger');
                }
            }
        }
        
        // Load records
        async function loadRecords() {
            log('=== Loading Records ===', 'primary');
            
            // Try to load using dataService
            if (typeof window.dataService !== 'undefined' && typeof window.dataService.getEPodRecords === 'function') {
                log('Loading via dataService...', 'info');
                try {
                    const records = await window.dataService.getEPodRecords();
                    log('Records loaded via dataService: ' + records.length, 'success');
                    displayRecords(records);
                } catch (error) {
                    log('Error loading via dataService: ' + error.message, 'danger');
                    // Fallback to localStorage
                    fallbackToLocalStorage();
                }
            } else {
                log('dataService not available, loading from localStorage...', 'warning');
                fallbackToLocalStorage();
            }
        }
        
        // Fallback to localStorage
        function fallbackToLocalStorage() {
            try {
                const ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                log('Records loaded from localStorage: ' + ePodRecords.length, 'success');
                displayRecords(ePodRecords);
            } catch (error) {
                log('Error loading from localStorage: ' + error.message, 'danger');
                displayRecords([]);
            }
        }
        
        // Display records
        function displayRecords(records) {
            const container = document.getElementById('epodRecords');
            
            if (!records || records.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No EPOD records found</div>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>DR Number</th><th>Customer</th><th>Date</th><th>Source</th></tr></thead><tbody>';
            
            // Sort by date (newest first)
            const sortedRecords = [...records].sort((a, b) => 
                new Date(b.signedAt || b.timestamp) - new Date(a.signedAt || a.timestamp)
            );
            
            sortedRecords.forEach(record => {
                const date = new Date(record.signedAt || record.timestamp);
                const isTest = record.drNumber.includes('TEST');
                html += `<tr><td>${record.drNumber}</td><td>${record.customerName}</td><td>${date.toLocaleDateString()}</td><td><span class="badge ${isTest ? 'bg-warning' : 'bg-primary'}">${isTest ? 'Test' : 'Production'}</span></td></tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // Clear records
        function clearRecords() {
            log('=== Clearing Records ===', 'primary');
            try {
                localStorage.removeItem('ePodRecords');
                log('EPOD records cleared from localStorage', 'success');
                document.getElementById('epodRecords').innerHTML = '<div class="alert alert-success">Records cleared</div>';
            } catch (error) {
                log('Error clearing localStorage: ' + error.message, 'danger');
            }
        }
        
        // Set up event listeners
        document.addEventListener('DOMContentLoaded', function() {
            log('EPOD Troubleshooting Tool Loaded', 'success');
            
            document.getElementById('checkAll').addEventListener('click', checkAll);
            document.getElementById('createTestRecord').addEventListener('click', createTestRecord);
            document.getElementById('loadRecords').addEventListener('click', loadRecords);
            document.getElementById('clearRecords').addEventListener('click', clearRecords);
        });
    </script>
</body>
</html>