<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify EPOD Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Verify EPOD Fix</h1>
        <p class="lead">This page verifies that the EPOD fix is working correctly</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>File Verification</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">epod-fix.js Status:</label>
                            <div id="epodFixStatus" class="alert alert-secondary">Checking...</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Manifest.json Status:</label>
                            <div id="manifestStatus" class="alert alert-secondary">Checking...</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Favicon Status:</label>
                            <div id="faviconStatus" class="alert alert-secondary">Checking...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Function Verification</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">EPOD Functions:</label>
                            <div id="functionStatus" class="alert alert-secondary">Checking...</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data Service:</label>
                            <div id="dataServiceStatus" class="alert alert-secondary">Checking...</div>
                        </div>
                        <button id="testFunctions" class="btn btn-primary">Test EPOD Functions</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults" style="min-height: 200px; background-color: #f8f9fa; padding: 15px; border-radius: 4px;">
                            <p class="text-muted">Click "Test EPOD Functions" to run tests...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check file status
            checkFileStatus();
            
            // Check function status
            checkFunctionStatus();
            
            // Test button
            document.getElementById('testFunctions').addEventListener('click', testEPodFunctions);
        });
        
        function checkFileStatus() {
            // Check epod-fix.js
            fetch('assets/js/epod-fix.js')
                .then(response => {
                    if (response.ok && response.headers.get('content-type').includes('javascript')) {
                        document.getElementById('epodFixStatus').className = 'alert alert-success';
                        document.getElementById('epodFixStatus').textContent = 'Available and correct MIME type';
                    } else {
                        document.getElementById('epodFixStatus').className = 'alert alert-danger';
                        document.getElementById('epodFixStatus').textContent = 'Wrong MIME type or not found';
                    }
                })
                .catch(error => {
                    document.getElementById('epodFixStatus').className = 'alert alert-danger';
                    document.getElementById('epodFixStatus').textContent = 'Error: ' + error.message;
                });
            
            // Check manifest.json
            fetch('manifest.json')
                .then(response => {
                    if (response.ok && response.headers.get('content-type').includes('json')) {
                        document.getElementById('manifestStatus').className = 'alert alert-success';
                        document.getElementById('manifestStatus').textContent = 'Available and correct MIME type';
                    } else {
                        document.getElementById('manifestStatus').className = 'alert alert-danger';
                        document.getElementById('manifestStatus').textContent = 'Wrong MIME type or not found';
                    }
                })
                .catch(error => {
                    document.getElementById('manifestStatus').className = 'alert alert-danger';
                    document.getElementById('manifestStatus').textContent = 'Error: ' + error.message;
                });
            
            // Check favicon
            fetch('favicon.ico')
                .then(response => {
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        if (contentType.includes('image/') || contentType.includes('icon')) {
                            document.getElementById('faviconStatus').className = 'alert alert-success';
                            document.getElementById('faviconStatus').textContent = 'Available and correct MIME type (' + contentType + ')';
                        } else {
                            document.getElementById('faviconStatus').className = 'alert alert-warning';
                            document.getElementById('faviconStatus').textContent = 'Available but unexpected MIME type (' + contentType + ')';
                        }
                    } else {
                        document.getElementById('faviconStatus').className = 'alert alert-danger';
                        document.getElementById('faviconStatus').textContent = 'Not found';
                    }
                })
                .catch(error => {
                    document.getElementById('faviconStatus').className = 'alert alert-danger';
                    document.getElementById('faviconStatus').textContent = 'Error: ' + error.message;
                });
        }
        
        function checkFunctionStatus() {
            // Check if EPOD functions are available
            setTimeout(() => {
                const hasSaveFunction = typeof window.saveEPodRecordFixed === 'function';
                const hasLoadFunction = typeof window.getEPodRecordsFixed === 'function';
                
                if (hasSaveFunction && hasLoadFunction) {
                    document.getElementById('functionStatus').className = 'alert alert-success';
                    document.getElementById('functionStatus').textContent = 'All EPOD functions available';
                } else {
                    document.getElementById('functionStatus').className = 'alert alert-warning';
                    document.getElementById('functionStatus').textContent = `Functions missing - Save: ${hasSaveFunction}, Load: ${hasLoadFunction}`;
                }
                
                // Check dataService
                const hasDataService = typeof window.dataService !== 'undefined';
                if (hasDataService) {
                    document.getElementById('dataServiceStatus').className = 'alert alert-success';
                    document.getElementById('dataServiceStatus').textContent = 'dataService available';
                } else {
                    document.getElementById('dataServiceStatus').className = 'alert alert-warning';
                    document.getElementById('dataServiceStatus').textContent = 'dataService not available';
                }
            }, 1000);
        }
        
        async function testEPodFunctions() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<p>Testing EPOD functions...</p>';
            
            try {
                // Create a test record
                const testRecord = {
                    drNumber: 'DR-VERIFY-' + Date.now(),
                    customerName: 'Verify Test',
                    customerContact: '09123456789',
                    truckPlate: 'VT123',
                    origin: 'Verify Origin',
                    destination: 'Verify Destination',
                    signature: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                    status: 'Completed',
                    signedAt: new Date().toISOString(),
                    timestamp: new Date().toISOString()
                };
                
                results.innerHTML += '<p>Created test record: ' + testRecord.drNumber + '</p>';
                
                // Test save function
                if (typeof window.saveEPodRecordFixed === 'function') {
                    results.innerHTML += '<p>Using saveEPodRecordFixed function...</p>';
                    await window.saveEPodRecordFixed(testRecord);
                    results.innerHTML += '<p class="text-success">Record saved successfully!</p>';
                } else if (typeof window.dataService !== 'undefined' && typeof window.dataService.saveEPodRecord === 'function') {
                    results.innerHTML += '<p>Using dataService.saveEPodRecord function...</p>';
                    await window.dataService.saveEPodRecord(testRecord);
                    results.innerHTML += '<p class="text-success">Record saved successfully!</p>';
                } else {
                    results.innerHTML += '<p>Using localStorage fallback...</p>';
                    let records = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                    records.push(testRecord);
                    localStorage.setItem('ePodRecords', JSON.stringify(records));
                    results.innerHTML += '<p class="text-success">Record saved to localStorage!</p>';
                }
                
                // Test load function
                results.innerHTML += '<p>Loading records...</p>';
                let loadedRecords;
                if (typeof window.getEPodRecordsFixed === 'function') {
                    results.innerHTML += '<p>Using getEPodRecordsFixed function...</p>';
                    loadedRecords = await window.getEPodRecordsFixed();
                } else if (typeof window.dataService !== 'undefined' && typeof window.dataService.getEPodRecords === 'function') {
                    results.innerHTML += '<p>Using dataService.getEPodRecords function...</p>';
                    loadedRecords = await window.dataService.getEPodRecords();
                } else {
                    results.innerHTML += '<p>Using localStorage fallback...</p>';
                    loadedRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                }
                
                results.innerHTML += '<p class="text-success">Loaded ' + loadedRecords.length + ' records!</p>';
                if (loadedRecords.length > 0) {
                    results.innerHTML += '<p>Latest record DR Number: ' + loadedRecords[loadedRecords.length - 1].drNumber + '</p>';
                }
                
                results.innerHTML += '<p class="text-success fw-bold">All tests passed! EPOD fix is working correctly.</p>';
                
            } catch (error) {
                results.innerHTML += '<p class="text-danger">Error during testing: ' + error.message + '</p>';
                console.error('Test error:', error);
            }
        }
    </script>
</body>
</html>