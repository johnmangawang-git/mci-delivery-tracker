<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Booked Date Issue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Debug Booked Date Issue</h2>
        
        <div class="card">
            <div class="card-header">
                <h5>Current Active Deliveries Data</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="debugActiveDeliveries()">Debug Active Deliveries</button>
                <button class="btn btn-success" onclick="testDateFormats()">Test Date Formats</button>
                <button class="btn btn-warning" onclick="testTimestampCreation()">Test Timestamp Creation</button>
                <div id="debugOutput" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/local-system-time.js"></script>
    
    <script>
        function debugActiveDeliveries() {
            const output = document.getElementById('debugOutput');
            let html = '<h6>Active Deliveries Debug:</h6>';
            
            // Check localStorage
            const activeDeliveries = JSON.parse(localStorage.getItem('mci-active-deliveries') || '[]');
            html += `<p><strong>Total Active Deliveries:</strong> ${activeDeliveries.length}</p>`;
            
            if (activeDeliveries.length > 0) {
                html += '<div class="table-responsive"><table class="table table-sm">';
                html += '<thead><tr><th>DR Number</th><th>deliveryDate</th><th>bookedDate</th><th>created_at</th><th>timestamp</th><th>Formatted</th></tr></thead><tbody>';
                
                activeDeliveries.slice(0, 5).forEach((delivery, index) => {
                    const deliveryDate = delivery.deliveryDate || 'N/A';
                    const bookedDate = delivery.bookedDate || 'N/A';
                    const created_at = delivery.created_at || 'N/A';
                    const timestamp = delivery.timestamp || 'N/A';
                    
                    // Test formatting
                    let formatted = 'N/A';
                    if (window.formatActiveDeliveryDate) {
                        try {
                            formatted = window.formatActiveDeliveryDate(delivery);
                        } catch (e) {
                            formatted = 'Error: ' + e.message;
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${delivery.drNumber || delivery.dr_number || 'N/A'}</td>
                            <td><code>${deliveryDate}</code></td>
                            <td><code>${bookedDate}</code></td>
                            <td><code>${created_at}</code></td>
                            <td><code>${timestamp}</code></td>
                            <td><strong>${formatted}</strong></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            } else {
                html += '<p class="text-muted">No active deliveries found in localStorage</p>';
            }
            
            output.innerHTML = html;
        }
        
        function testDateFormats() {
            const output = document.getElementById('debugOutput');
            let html = '<h6>Date Format Tests:</h6>';
            
            const testDates = [
                '2024-11-06',                           // Date only (problematic)
                '2024-11-06T14:30:45.123Z',            // Full UTC timestamp
                '2024-11-06T14:30:45.123+08:00',       // Full timestamp with timezone
                new Date().toISOString(),               // Current time ISO
                window.getLocalSystemTimeISO ? window.getLocalSystemTimeISO() : 'N/A'  // Local system time
            ];
            
            html += '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Input</th><th>Parsed Date</th><th>Formatted Result</th><th>Issue?</th></tr></thead><tbody>';
            
            testDates.forEach(dateInput => {
                if (dateInput === 'N/A') return;
                
                try {
                    const parsedDate = new Date(dateInput);
                    const formatted = parsedDate.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    
                    const hasIssue = formatted.includes('08:00:00') ? 'YES' : 'NO';
                    const issueClass = hasIssue === 'YES' ? 'table-danger' : 'table-success';
                    
                    html += `
                        <tr class="${issueClass}">
                            <td><code>${dateInput}</code></td>
                            <td>${parsedDate.toString()}</td>
                            <td><strong>${formatted}</strong></td>
                            <td>${hasIssue}</td>
                        </tr>
                    `;
                } catch (e) {
                    html += `
                        <tr class="table-warning">
                            <td><code>${dateInput}</code></td>
                            <td colspan="3">Error: ${e.message}</td>
                        </tr>
                    `;
                }
            });
            
            html += '</tbody></table></div>';
            output.innerHTML = html;
        }
        
        function testTimestampCreation() {
            const output = document.getElementById('debugOutput');
            let html = '<h6>Timestamp Creation Tests:</h6>';
            
            // Test createBookingTimestamp if available
            if (window.createBookingTimestamp) {
                try {
                    const timestamp = window.createBookingTimestamp();
                    html += '<h6>createBookingTimestamp() result:</h6>';
                    html += '<pre>' + JSON.stringify(timestamp, null, 2) + '</pre>';
                    
                    // Test formatting each field
                    html += '<h6>Formatting test for each field:</h6>';
                    html += '<div class="table-responsive"><table class="table table-sm">';
                    html += '<thead><tr><th>Field</th><th>Value</th><th>Formatted</th></tr></thead><tbody>';
                    
                    ['deliveryDate', 'bookedDate', 'timestamp', 'created_at'].forEach(field => {
                        if (timestamp[field]) {
                            try {
                                const formatted = new Date(timestamp[field]).toLocaleString('en-US', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: false
                                });
                                
                                html += `
                                    <tr>
                                        <td><strong>${field}</strong></td>
                                        <td><code>${timestamp[field]}</code></td>
                                        <td>${formatted}</td>
                                    </tr>
                                `;
                            } catch (e) {
                                html += `
                                    <tr class="table-danger">
                                        <td><strong>${field}</strong></td>
                                        <td><code>${timestamp[field]}</code></td>
                                        <td>Error: ${e.message}</td>
                                    </tr>
                                `;
                            }
                        }
                    });
                    
                    html += '</tbody></table></div>';
                } catch (e) {
                    html += '<div class="alert alert-danger">Error calling createBookingTimestamp(): ' + e.message + '</div>';
                }
            } else {
                html += '<div class="alert alert-warning">createBookingTimestamp function not available</div>';
            }
            
            output.innerHTML = html;
        }
        
        // Load required scripts
        const scripts = [
            'assets/js/app.js',
            'assets/js/booking.js'
        ];
        
        let loadedScripts = 0;
        scripts.forEach(scriptSrc => {
            const script = document.createElement('script');
            script.src = scriptSrc;
            script.onload = () => {
                loadedScripts++;
                if (loadedScripts === scripts.length) {
                    console.log('All scripts loaded');
                }
            };
            script.onerror = () => {
                console.error('Failed to load:', scriptSrc);
                loadedScripts++;
            };
            document.head.appendChild(script);
        });
    </script>
</body>
</html>