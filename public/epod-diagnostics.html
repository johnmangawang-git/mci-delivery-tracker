<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPOD Diagnostics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>EPOD Diagnostics</h1>
        <p class="text-muted">Diagnostic tool to identify EPOD record creation issues</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5>System Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5>LocalStorage Content</h5>
                    </div>
                    <div class="card-body">
                        <div id="localStorageStatus"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5>Diagnostic Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button id="checkSystem" class="btn btn-primary">1. Check System Status</button>
                    <button id="testSave" class="btn btn-success">2. Test EPOD Save</button>
                    <button id="testLoad" class="btn btn-info">3. Test EPOD Load</button>
                    <button id="clearLocalStorage" class="btn btn-warning">4. Clear LocalStorage</button>
                    <button id="fullTest" class="btn btn-danger">5. Run Full Diagnostic</button>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5>Diagnostic Log</h5>
            </div>
            <div class="card-body">
                <div id="diagnosticLog" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em;"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5>EPOD Records Display</h5>
            </div>
            <div class="card-body">
                <div id="recordsDisplay"></div>
            </div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="assets/js/supabase.js"></script>
    <script src="assets/js/dataService.js"></script>
    <script src="assets/js/epod-fix.js"></script>
    <script src="assets/js/e-signature.js"></script>
    
    <script>
        // Diagnostic logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('diagnosticLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `text-${type} mb-1`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Update system status display
        function updateSystemStatus(status) {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = status;
        }
        
        // Update localStorage status display
        function updateLocalStorageStatus(status) {
            const statusDiv = document.getElementById('localStorageStatus');
            statusDiv.innerHTML = status;
        }
        
        // Check system status
        async function checkSystemStatus() {
            log('=== Checking System Status ===', 'primary');
            
            // Check if required scripts are loaded
            const checks = [
                { name: 'dataService', available: typeof window.dataService !== 'undefined' },
                { name: 'saveEPodRecord', available: typeof window.dataService?.saveEPodRecord === 'function' },
                { name: 'getEPodRecords', available: typeof window.dataService?.getEPodRecords === 'function' },
                { name: 'saveEPodRecordFixed', available: typeof window.saveEPodRecordFixed === 'function' },
                { name: 'getEPodRecordsFixed', available: typeof window.getEPodRecordsFixed === 'function' },
                { name: 'saveSingleSignature', available: typeof window.saveSingleSignature === 'function' }
            ];
            
            let statusHtml = '<ul class="list-group">';
            let allAvailable = true;
            
            checks.forEach(check => {
                const status = check.available ? 'Available' : 'NOT Available';
                const className = check.available ? 'list-group-item-success' : 'list-group-item-danger';
                statusHtml += `<li class="list-group-item ${className}">${check.name}: ${status}</li>`;
                if (!check.available) allAvailable = false;
            });
            
            statusHtml += '</ul>';
            updateSystemStatus(statusHtml);
            
            if (allAvailable) {
                log('✓ All required functions are available', 'success');
            } else {
                log('✗ Some required functions are missing', 'danger');
            }
            
            // Check dataService initialization
            if (window.dataService) {
                log(`dataService initialized: ${window.dataService.initialized || false}`, 'info');
                log(`dataService supabase: ${window.dataService.supabase !== null}`, 'info');
            }
            
            // Check Supabase configuration
            log(`SUPABASE_URL configured: ${!!window.SUPABASE_URL && window.SUPABASE_URL !== 'YOUR_SUPABASE_URL'}`, 'info');
            log(`SUPABASE_ANON_KEY configured: ${!!window.SUPABASE_ANON_KEY && window.SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY'}`, 'info');
        }
        
        // Check localStorage content
        function checkLocalStorage() {
            log('=== Checking LocalStorage ===', 'primary');
            
            try {
                const ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                const statusHtml = `
                    <div class="alert alert-info">
                        <h6>LocalStorage EPOD Records</h6>
                        <p>Total records: ${ePodRecords.length}</p>
                        ${ePodRecords.length > 0 ? `
                            <p>First record DR: ${ePodRecords[0].drNumber}</p>
                            <p>First record date: ${new Date(ePodRecords[0].signedAt).toLocaleString()}</p>
                        ` : ''}
                    </div>
                `;
                updateLocalStorageStatus(statusHtml);
                log(`Found ${ePodRecords.length} EPOD records in localStorage`, 'info');
                
                return ePodRecords;
            } catch (error) {
                const statusHtml = `<div class="alert alert-danger">Error reading localStorage: ${error.message}</div>`;
                updateLocalStorageStatus(statusHtml);
                log(`Error reading localStorage: ${error.message}`, 'danger');
                return [];
            }
        }
        
        // Test EPOD save
        async function testEPODSave() {
            log('=== Testing EPOD Save ===', 'primary');
            
            // Create test record
            const testRecord = {
                drNumber: 'DR-DIAG-' + Date.now(),
                customerName: 'Diagnostic Test Customer',
                customerContact: '09123456789',
                truckPlate: 'DIAG123',
                origin: 'Diagnostic Origin',
                destination: 'Diagnostic Destination',
                signature: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                status: 'Completed',
                signedAt: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            
            log(`Creating test record: ${testRecord.drNumber}`, 'info');
            
            // Try different save methods
            const methods = [
                { name: 'saveEPodRecordFixed', func: window.saveEPodRecordFixed },
                { name: 'dataService.saveEPodRecord', func: window.dataService?.saveEPodRecord },
                { name: 'Direct localStorage', func: null }
            ];
            
            let saved = false;
            
            for (const method of methods) {
                if (method.func) {
                    try {
                        log(`Trying to save via ${method.name}...`, 'info');
                        const result = await method.func(testRecord);
                        log(`✓ Saved via ${method.name}: ${result.drNumber}`, 'success');
                        saved = true;
                        break;
                    } catch (error) {
                        log(`✗ Error with ${method.name}: ${error.message}`, 'danger');
                    }
                } else {
                    // Direct localStorage save
                    try {
                        log('Trying direct localStorage save...', 'info');
                        let ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                        ePodRecords.push(testRecord);
                        localStorage.setItem('ePodRecords', JSON.stringify(ePodRecords));
                        log('✓ Saved directly to localStorage', 'success');
                        saved = true;
                        break;
                    } catch (error) {
                        log(`✗ Error with direct localStorage save: ${error.message}`, 'danger');
                    }
                }
            }
            
            if (!saved) {
                log('✗ Failed to save using any method', 'danger');
            }
            
            // Check localStorage after save
            setTimeout(checkLocalStorage, 500);
        }
        
        // Test EPOD load
        async function testEPODLoad() {
            log('=== Testing EPOD Load ===', 'primary');
            
            // Try different load methods
            const methods = [
                { name: 'getEPodRecordsFixed', func: window.getEPodRecordsFixed },
                { name: 'dataService.getEPodRecords', func: window.dataService?.getEPodRecords },
                { name: 'Direct localStorage', func: null }
            ];
            
            let records = null;
            
            for (const method of methods) {
                if (method.func) {
                    try {
                        log(`Trying to load via ${method.name}...`, 'info');
                        records = await method.func();
                        log(`✓ Loaded ${records.length} records via ${method.name}`, 'success');
                        break;
                    } catch (error) {
                        log(`✗ Error with ${method.name}: ${error.message}`, 'danger');
                    }
                } else {
                    // Direct localStorage load
                    try {
                        log('Trying direct localStorage load...', 'info');
                        records = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                        log(`✓ Loaded ${records.length} records from localStorage`, 'success');
                        break;
                    } catch (error) {
                        log(`✗ Error with direct localStorage load: ${error.message}`, 'danger');
                    }
                }
            }
            
            if (records) {
                displayRecords(records);
            } else {
                log('✗ Failed to load records using any method', 'danger');
                displayRecords([]);
            }
        }
        
        // Clear localStorage
        function clearLocalStorage() {
            log('=== Clearing LocalStorage ===', 'primary');
            
            try {
                localStorage.removeItem('ePodRecords');
                log('✓ Cleared EPOD records from localStorage', 'success');
                updateLocalStorageStatus('<div class="alert alert-success">LocalStorage cleared</div>');
                document.getElementById('recordsDisplay').innerHTML = '<div class="alert alert-info">No records to display</div>';
            } catch (error) {
                log(`✗ Error clearing localStorage: ${error.message}`, 'danger');
            }
        }
        
        // Display records
        function displayRecords(records) {
            const container = document.getElementById('recordsDisplay');
            
            if (!records || records.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No EPOD records found</div>';
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>DR Number</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Sort by date (newest first)
            const sortedRecords = [...records].sort((a, b) => 
                new Date(b.signedAt || b.timestamp) - new Date(a.signedAt || a.timestamp)
            );
            
            sortedRecords.forEach(record => {
                const date = new Date(record.signedAt || record.timestamp);
                const isTest = record.drNumber.includes('DIAG') || record.drNumber.includes('TEST');
                html += `
                    <tr>
                        <td>${record.drNumber}</td>
                        <td>${record.customerName}</td>
                        <td>${date.toLocaleDateString()}</td>
                        <td><span class="badge ${isTest ? 'bg-warning' : 'bg-primary'}">${isTest ? 'Test' : 'Production'}</span></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Run full diagnostic
        async function runFullDiagnostic() {
            log('=== Running Full Diagnostic ===', 'primary');
            
            await checkSystemStatus();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testEPODSave();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testEPODLoad();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkLocalStorage();
            
            log('=== Full Diagnostic Complete ===', 'primary');
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            log('EPOD Diagnostics Tool Loaded', 'success');
            
            // Set up event listeners
            document.getElementById('checkSystem').addEventListener('click', checkSystemStatus);
            document.getElementById('testSave').addEventListener('click', testEPODSave);
            document.getElementById('testLoad').addEventListener('click', testEPODLoad);
            document.getElementById('clearLocalStorage').addEventListener('click', clearLocalStorage);
            document.getElementById('fullTest').addEventListener('click', runFullDiagnostic);
            
            // Initial checks
            setTimeout(() => {
                checkSystemStatus();
                checkLocalStorage();
            }, 1000);
        });
    </script>
</body>
</html>