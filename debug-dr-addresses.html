<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug DR Addresses</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h2><i class="bi bi-bug"></i> Debug DR Addresses</h2>
        <p>Let's debug why all DR addresses are getting 25.0 km (fallback distance).</p>
        
        <div class="card">
            <div class="card-header">
                <h5>Test Your DR Addresses</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Paste a few destination addresses from your Excel file:</label>
                    <textarea class="form-control" id="testAddresses" rows="5" 
                        placeholder="Example:
UNIT 1003A RITZ TOWER AYALA AVE CITY OF MAKATI METRO MANILA
123 Main Street, Quezon City
BGC, Taguig City"></textarea>
                </div>
                <button class="btn btn-primary" onclick="debugAddresses()">
                    <i class="bi bi-search"></i> Debug These Addresses
                </button>
                <div id="debugResults" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Pin on Map Database Check</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="showAvailableLocations()">
                    <i class="bi bi-list"></i> Show Available Locations in Database
                </button>
                <div id="locationsList" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Console Output</h5>
            </div>
            <div class="card-body">
                <div id="consoleOutput" class="bg-dark text-light p-3" style="font-family: monospace; height: 400px; overflow-y: auto;">
                    <!-- Console output will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const consoleOutput = document.getElementById('consoleOutput');
        
        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            let color = 'text-light';
            if (type === 'error') color = 'text-danger';
            else if (type === 'warn') color = 'text-warning';
            else if (type === 'success') color = 'text-success';
            
            consoleOutput.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };
        
        async function debugAddresses() {
            const addresses = document.getElementById('testAddresses').value.split('\n').filter(addr => addr.trim());
            const resultDiv = document.getElementById('debugResults');
            
            if (addresses.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please paste some addresses</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="alert alert-info">Debugging addresses...</div>';
            
            try {
                console.log('=== DEBUGGING DR ADDRESSES ===');
                
                let html = '<div class="table-responsive"><table class="table table-striped">';
                html += '<thead><tr><th>Original Address</th><th>Parsed</th><th>Search Results</th><th>Distance</th></tr></thead><tbody>';
                
                for (const address of addresses) {
                    try {
                        console.log(`\n--- Debugging: ${address} ---`);
                        
                        // Test address parsing
                        const parsed = parseAddressForGeocoding ? parseAddressForGeocoding(address) : 'Function not available';
                        console.log(`Parsed: ${parsed}`);
                        
                        // Test search
                        const searchResults = searchAddress ? await searchAddress(parsed) : [];
                        console.log(`Search results:`, searchResults);
                        
                        // Test distance calculation
                        const booking = {
                            drNumber: 'TEST',
                            originWarehouse: 'SMEG Alabang warehouse',
                            destinationArea: address
                        };
                        
                        const distance = calculateDistanceUsingPinOnMapForDR ? 
                            await calculateDistanceUsingPinOnMapForDR(booking) : 'Function not available';
                        
                        console.log(`Distance: ${distance}`);
                        
                        // Show results
                        const searchResultsText = searchResults.length > 0 ? 
                            `${searchResults.length} results: ${searchResults[0].display_name}` : 
                            'No results found';
                        
                        const distanceColor = distance === 25.0 ? 'text-danger' : 'text-success';
                        
                        html += `
                            <tr>
                                <td><small>${address}</small></td>
                                <td><code>${parsed}</code></td>
                                <td><small>${searchResultsText}</small></td>
                                <td><span class="${distanceColor}">${distance} km</span></td>
                            </tr>
                        `;
                        
                    } catch (error) {
                        console.error(`Error debugging ${address}:`, error);
                        html += `
                            <tr>
                                <td><small>${address}</small></td>
                                <td colspan="3"><span class="text-danger">Error: ${error.message}</span></td>
                            </tr>
                        `;
                    }
                }
                
                html += '</tbody></table></div>';
                
                html += '<div class="alert alert-warning">';
                html += '<h6>üîç Analysis:</h6>';
                html += '<ul>';
                html += '<li><strong>25.0 km</strong> = Fallback distance (geocoding failed)</li>';
                html += '<li><strong>Other values</strong> = Real calculated distance (geocoding worked)</li>';
                html += '<li><strong>No results found</strong> = Address not in Pin on Map database</li>';
                html += '</ul>';
                html += '</div>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Debug failed:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå Debug failed: ${error.message}</div>`;
            }
        }
        
        function showAvailableLocations() {
            const resultDiv = document.getElementById('locationsList');
            
            // Show what locations are available in the Pin on Map database
            const locations = [
                'Manila', 'Makati City', 'Quezon City', 'Pasig City', 'Taguig City',
                'Muntinlupa City', 'Paranaque City', 'Las Pinas City', 'Marikina City',
                'Mandaluyong City', 'San Juan City', 'Pasay City', 'Caloocan City',
                'BGC', 'Ortigas Center', 'Alabang', 'Cebu City', 'Davao City', 'Baguio City'
            ];
            
            let html = '<div class="alert alert-info">';
            html += '<h6>üìç Available Locations in Pin on Map Database:</h6>';
            html += '<div class="row">';
            
            locations.forEach(location => {
                html += `<div class="col-md-4"><span class="badge bg-success me-1">${location}</span></div>`;
            });
            
            html += '</div>';
            html += '<hr>';
            html += '<p><strong>Note:</strong> Your DR addresses need to contain or match these location names for geocoding to work.</p>';
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }
        
        // Load booking.js
        const script = document.createElement('script');
        script.src = 'public/assets/js/booking.js';
        script.onload = function() {
            console.log('‚úÖ booking.js loaded');
            addToConsole('‚úÖ Debug tools ready', 'success');
        };
        script.onerror = function() {
            console.error('‚ùå Failed to load booking.js');
            addToConsole('‚ùå Failed to load booking.js', 'error');
        };
        document.head.appendChild(script);
    </script>
</body>
</html>