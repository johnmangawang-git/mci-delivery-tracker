<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive EPOD Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Comprehensive EPOD Test</h1>
        <p class="lead">This page helps diagnose and test EPOD functionality</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">dataService Status:</label>
                            <div id="dataServiceStatus" class="alert alert-secondary">Checking...</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">EPOD Functions:</label>
                            <div id="epodFunctionsStatus" class="alert alert-secondary">Checking...</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">LocalStorage Status:</label>
                            <div id="localStorageStatus" class="alert alert-secondary">Checking...</div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Test Controls</h5>
                    </div>
                    <div class="card-body">
                        <button id="initTest" class="btn btn-primary mb-2">Initialize Test</button>
                        <button id="saveTestRecord" class="btn btn-success mb-2">Save Test EPOD Record</button>
                        <button id="loadTestRecords" class="btn btn-info mb-2">Load EPOD Records</button>
                        <button id="clearTestRecords" class="btn btn-danger mb-2">Clear EPOD Records</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Test Record:</label>
                            <textarea id="testRecord" class="form-control" rows="6" readonly></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Operation Log:</label>
                            <div id="operationLog" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Debug Console</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugConsole" style="max-height: 300px; overflow-y: auto; background-color: #000; color: #00ff00; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em;"></div>
                        <button id="clearConsole" class="btn btn-sm btn-secondary mt-2">Clear Console</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load the same scripts as the main app -->
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/epod-fix.js"></script>
    
    <script>
        // Debug console logging
        function debugLog(message) {
            const consoleElement = document.getElementById('debugConsole');
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}`;
            
            consoleElement.textContent += logEntry + '\n';
            consoleElement.scrollTop = consoleElement.scrollHeight;
            
            console.log(message);
        }
        
        function logOperation(message) {
            const logElement = document.getElementById('operationLog');
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}`;
            
            logElement.textContent += logEntry + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            debugLog(message);
        }
        
        // Test record
        const testRecord = {
            drNumber: 'DR-TEST-' + Date.now(),
            customerName: 'Test Customer',
            customerContact: '09123456789',
            truckPlate: 'TEST123',
            origin: 'Test Origin',
            destination: 'Test Destination',
            signature: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
            status: 'Completed',
            signedAt: new Date().toISOString(),
            timestamp: new Date().toISOString()
        };
        
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('Comprehensive EPOD Test page loaded');
            
            // Display test record
            document.getElementById('testRecord').value = JSON.stringify(testRecord, null, 2);
            
            // Initialize status checks
            checkSystemStatus();
            
            // Button event handlers
            document.getElementById('initTest').addEventListener('click', async function() {
                logOperation('Initializing test...');
                await initializeTest();
            });
            
            document.getElementById('saveTestRecord').addEventListener('click', async function() {
                logOperation('Saving test EPOD record...');
                await saveTestRecord();
            });
            
            document.getElementById('loadTestRecords').addEventListener('click', async function() {
                logOperation('Loading EPOD records...');
                await loadTestRecords();
            });
            
            document.getElementById('clearTestRecords').addEventListener('click', function() {
                logOperation('Clearing EPOD records...');
                clearTestRecords();
            });
            
            document.getElementById('clearConsole').addEventListener('click', function() {
                document.getElementById('debugConsole').textContent = '';
            });
        });
        
        async function checkSystemStatus() {
            logOperation('Checking system status...');
            
            // Check dataService
            const dataServiceStatus = document.getElementById('dataServiceStatus');
            if (typeof window.dataService !== 'undefined') {
                dataServiceStatus.className = 'alert alert-success';
                dataServiceStatus.textContent = 'Available';
                logOperation('dataService: Available');
            } else {
                dataServiceStatus.className = 'alert alert-warning';
                dataServiceStatus.textContent = 'Not available';
                logOperation('dataService: Not available');
            }
            
            // Check EPOD functions
            const epodFunctionsStatus = document.getElementById('epodFunctionsStatus');
            const hasSaveFunction = typeof window.saveEPodRecordFixed === 'function';
            const hasLoadFunction = typeof window.getEPodRecordsFixed === 'function';
            
            if (hasSaveFunction && hasLoadFunction) {
                epodFunctionsStatus.className = 'alert alert-success';
                epodFunctionsStatus.textContent = 'All functions available';
                logOperation('EPOD functions: All available');
            } else {
                epodFunctionsStatus.className = 'alert alert-warning';
                epodFunctionsStatus.textContent = `Save: ${hasSaveFunction ? 'Available' : 'Missing'}, Load: ${hasLoadFunction ? 'Available' : 'Missing'}`;
                logOperation(`EPOD functions: Save: ${hasSaveFunction ? 'Available' : 'Missing'}, Load: ${hasLoadFunction ? 'Available' : 'Missing'}`);
            }
            
            // Check localStorage
            const localStorageStatus = document.getElementById('localStorageStatus');
            try {
                const testKey = 'epod_test_' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                localStorageStatus.className = 'alert alert-success';
                localStorageStatus.textContent = 'Accessible';
                logOperation('LocalStorage: Accessible');
            } catch (error) {
                localStorageStatus.className = 'alert alert-danger';
                localStorageStatus.textContent = 'Not accessible: ' + error.message;
                logOperation('LocalStorage: Not accessible - ' + error.message);
            }
        }
        
        async function initializeTest() {
            logOperation('Initializing test environment...');
            
            try {
                if (typeof window.dataService !== 'undefined') {
                    logOperation('Initializing dataService...');
                    await window.dataService.init();
                    logOperation('dataService initialized successfully');
                } else {
                    logOperation('dataService not available, using localStorage only');
                }
            } catch (error) {
                logOperation('Error initializing dataService: ' + error.message);
            }
        }
        
        async function saveTestRecord() {
            logOperation('Creating test EPOD record...');
            
            // Create a fresh test record each time
            const freshRecord = {
                drNumber: 'DR-TEST-' + Date.now(),
                customerName: 'Test Customer',
                customerContact: '09123456789',
                truckPlate: 'TEST123',
                origin: 'Test Origin',
                destination: 'Test Destination',
                signature: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                status: 'Completed',
                signedAt: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            
            document.getElementById('testRecord').value = JSON.stringify(freshRecord, null, 2);
            
            try {
                logOperation('Attempting to save EPOD record...');
                
                if (typeof window.saveEPodRecordFixed === 'function') {
                    logOperation('Using saveEPodRecordFixed function');
                    const result = await window.saveEPodRecordFixed(freshRecord);
                    logOperation('EPOD record saved successfully: ' + JSON.stringify(result, null, 2));
                } else if (typeof window.dataService !== 'undefined' && typeof window.dataService.saveEPodRecord === 'function') {
                    logOperation('Using dataService.saveEPodRecord function');
                    const result = await window.dataService.saveEPodRecord(freshRecord);
                    logOperation('EPOD record saved successfully: ' + JSON.stringify(result, null, 2));
                } else {
                    logOperation('Using localStorage fallback');
                    let ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                    ePodRecords.push(freshRecord);
                    localStorage.setItem('ePodRecords', JSON.stringify(ePodRecords));
                    logOperation('EPOD record saved to localStorage. Total records: ' + ePodRecords.length);
                }
            } catch (error) {
                logOperation('Error saving EPOD record: ' + error.message);
                console.error('Save error:', error);
            }
        }
        
        async function loadTestRecords() {
            logOperation('Loading EPOD records...');
            
            try {
                let records;
                
                if (typeof window.getEPodRecordsFixed === 'function') {
                    logOperation('Using getEPodRecordsFixed function');
                    records = await window.getEPodRecordsFixed();
                } else if (typeof window.dataService !== 'undefined' && typeof window.dataService.getEPodRecords === 'function') {
                    logOperation('Using dataService.getEPodRecords function');
                    records = await window.dataService.getEPodRecords();
                } else {
                    logOperation('Using localStorage fallback');
                    records = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                }
                
                logOperation('Loaded ' + records.length + ' EPOD records');
                if (records.length > 0) {
                    logOperation('First record: ' + JSON.stringify(records[0], null, 2));
                }
            } catch (error) {
                logOperation('Error loading EPOD records: ' + error.message);
                console.error('Load error:', error);
            }
        }
        
        function clearTestRecords() {
            try {
                localStorage.removeItem('ePodRecords');
                logOperation('EPOD records cleared from localStorage');
            } catch (error) {
                logOperation('Error clearing EPOD records: ' + error.message);
            }
        }
    </script>
</body>
</html>