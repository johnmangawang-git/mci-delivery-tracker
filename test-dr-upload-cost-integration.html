<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test DR Upload Cost Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .chart-container { width: 400px; height: 400px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ DR Upload Cost Integration Test</h1>
        
        <div class="alert alert-info">
            <h5>Test Purpose</h5>
            <p>This page tests that additional costs from DR upload modal are properly saved and displayed in analytics.</p>
        </div>

        <div class="test-section">
            <h3>üéØ Simulate DR Upload with Costs</h3>
            <p>This simulates the DR upload modal with additional cost items:</p>
            
            <!-- Simulate DR Modal Cost Inputs -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Cost Description 1</label>
                    <input type="text" class="form-control dr-cost-description" value="Fuel Surcharge" placeholder="e.g., Fuel Surcharge">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Amount 1</label>
                    <div class="input-group">
                        <span class="input-group-text">‚Ç±</span>
                        <input type="number" class="form-control dr-cost-amount" value="150.00" placeholder="0.00">
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Cost Description 2</label>
                    <input type="text" class="form-control dr-cost-description" value="Toll Fee" placeholder="e.g., Toll Fee">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Amount 2</label>
                    <div class="input-group">
                        <span class="input-group-text">‚Ç±</span>
                        <input type="number" class="form-control dr-cost-amount" value="75.50" placeholder="0.00">
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Cost Description 3</label>
                    <input type="text" class="form-control dr-cost-description" value="Helper Fee" placeholder="e.g., Helper Fee">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Amount 3</label>
                    <div class="input-group">
                        <span class="input-group-text">‚Ç±</span>
                        <input type="number" class="form-control dr-cost-amount" value="100.00" placeholder="0.00">
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <button onclick="testCostCollection()" class="btn btn-primary">Test Cost Collection</button>
                <button onclick="testAnalyticsIntegration()" class="btn btn-success">Test Analytics Integration</button>
                <button onclick="clearLog()" class="btn btn-secondary">Clear Log</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä Cost Breakdown Chart Test</h3>
            <div class="chart-container">
                <canvas id="testCostChart"></canvas>
            </div>
            <button onclick="updateChart()" class="btn btn-info">Update Chart</button>
        </div>

        <div class="test-section">
            <h3>üìã Test Log</h3>
            <div id="testLog" class="log">Ready to test DR upload cost integration...\n</div>
        </div>
    </div>

    <!-- Include the enhanced scripts -->
    <script src="public/assets/js/booking-excel-fix.js"></script>
    <script src="public/assets/js/analytics.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `${timestamp} ${icon} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').textContent = 'Log cleared...\n';
        }
        
        function testCostCollection() {
            log('üß™ Testing cost collection from DR modal inputs...', 'info');
            
            try {
                const costDescriptions = document.querySelectorAll('.dr-cost-description');
                const costAmounts = document.querySelectorAll('.dr-cost-amount');
                
                log(`Found ${costDescriptions.length} description fields and ${costAmounts.length} amount fields`, 'info');
                
                const costItems = [];
                let totalCost = 0;
                
                for (let i = 0; i < Math.min(costDescriptions.length, costAmounts.length); i++) {
                    const description = costDescriptions[i].value?.trim();
                    const amount = parseFloat(costAmounts[i].value) || 0;
                    
                    if (description && amount > 0) {
                        const category = window.categorizeCostDescription ? window.categorizeCostDescription(description) : 'Other';
                        costItems.push({
                            description: description,
                            amount: amount,
                            category: category
                        });
                        totalCost += amount;
                        log(`Collected: ${description} = ‚Ç±${amount} (Category: ${category})`, 'success');
                    }
                }
                
                log(`Total cost items: ${costItems.length}, Total amount: ‚Ç±${totalCost}`, 'success');
                
                // Store for analytics test
                window.testCostItems = costItems;
                window.testTotalCost = totalCost;
                
                return { costItems, totalCost };
                
            } catch (error) {
                log(`Error collecting costs: ${error.message}`, 'error');
                return { costItems: [], totalCost: 0 };
            }
        }
        
        function testAnalyticsIntegration() {
            log('üß™ Testing analytics integration...', 'info');
            
            try {
                // First collect costs
                const { costItems, totalCost } = testCostCollection();
                
                if (costItems.length === 0) {
                    log('No cost items to test with', 'warning');
                    return;
                }
                
                // Create a mock delivery with cost items
                const mockDelivery = {
                    id: 'TEST-DEL-001',
                    dr_number: 'DR-TEST-001',
                    customer_name: 'Test Customer',
                    additional_costs: totalCost,
                    additional_cost_items: costItems
                };
                
                log(`Created mock delivery: ${mockDelivery.dr_number}`, 'info');
                log(`Additional costs: ‚Ç±${mockDelivery.additional_costs}`, 'info');
                log(`Cost items: ${JSON.stringify(mockDelivery.additional_cost_items, null, 2)}`, 'info');
                
                // Add to active deliveries for testing
                window.activeDeliveries = window.activeDeliveries || [];
                window.activeDeliveries.push(mockDelivery);
                
                log('Added mock delivery to activeDeliveries for analytics testing', 'success');
                
                // Test cost breakdown data function
                if (typeof window.getCostBreakdownData === 'function') {
                    log('Testing getCostBreakdownData function...', 'info');
                    
                    window.getCostBreakdownData('month').then(result => {
                        if (result) {
                            log(`Analytics result: ${result.labels.length} categories found`, 'success');
                            log(`Categories: ${result.labels.join(', ')}`, 'info');
                            log(`Values: ${result.values.join(', ')}`, 'info');
                            
                            // Store for chart update
                            window.testChartData = result;
                        } else {
                            log('No cost breakdown data returned', 'warning');
                        }
                    }).catch(error => {
                        log(`Error getting cost breakdown data: ${error.message}`, 'error');
                    });
                } else {
                    log('getCostBreakdownData function not available', 'error');
                }
                
            } catch (error) {
                log(`Error in analytics integration test: ${error.message}`, 'error');
            }
        }
        
        function updateChart() {
            log('üß™ Updating cost breakdown chart...', 'info');
            
            try {
                const canvas = document.getElementById('testCostChart');
                
                // Destroy existing chart
                if (window.testChart) {
                    window.testChart.destroy();
                }
                
                // Use test data or create sample data
                const chartData = window.testChartData || {
                    labels: ['Fuel Surcharge', 'Toll Fee', 'Helper Fee'],
                    values: [150, 75.50, 100],
                    colors: ['#FF6384', '#36A2EB', '#FFCE56']
                };
                
                window.testChart = new Chart(canvas, {
                    type: 'pie',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.values,
                            backgroundColor: chartData.colors || ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                log('Chart updated successfully', 'success');
                
            } catch (error) {
                log(`Error updating chart: ${error.message}`, 'error');
            }
        }
        
        // Initialize test
        window.addEventListener('load', () => {
            log('üîß DR Upload Cost Integration Test initialized', 'info');
            log('Click "Test Cost Collection" to start testing', 'info');
            
            // Check if required functions are available
            setTimeout(() => {
                log(`categorizeCostDescription available: ${typeof window.categorizeCostDescription === 'function'}`, 'info');
                log(`getCostBreakdownData available: ${typeof window.getCostBreakdownData === 'function'}`, 'info');
            }, 1000);
        });
    </script>
</body>
</html>