<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time System Integration Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        .live-clock {
            font-size: 2em;
            color: #28a745;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">üïê Real-Time System Integration Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìÖ Delivery Date Selection</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="drDeliveryDate" class="form-label">Select Delivery Date:</label>
                            <input type="date" class="form-control" id="drDeliveryDate">
                        </div>
                        <button class="btn btn-primary" onclick="testTimestamp()">Test Timestamp Creation</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üïê Live System Time</h5>
                    </div>
                    <div class="card-body">
                        <div class="live-clock" id="liveClock">Loading...</div>
                        <p class="text-muted text-center">This shows your laptop's current time</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üß™ Test Results</h5>
                    </div>
                    <div class="card-body" id="testResults">
                        <p class="text-muted">Select a delivery date and click "Test Timestamp Creation" to see results.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Continuous Testing</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="startContinuousTest()">Start Continuous Test</button>
                        <button class="btn btn-danger" onclick="stopContinuousTest()">Stop Test</button>
                        <div id="continuousResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="public/assets/js/local-system-time.js"></script>
    <script src="public/assets/js/real-time-system-integration.js"></script>
    <script src="public/assets/js/delivery-date-enhancement.js"></script>
    
    <script>
        let continuousTestInterval;
        
        // Initialize delivery date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('drDeliveryDate').value = today;
            document.getElementById('drDeliveryDate').min = today;
            
            // Start live clock
            updateLiveClock();
            setInterval(updateLiveClock, 1000);
        });
        
        function updateLiveClock() {
            const now = new Date();
            const timeString = now.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('liveClock').textContent = timeString;
        }
        
        function testTimestamp() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            const selectedDate = document.getElementById('drDeliveryDate').value;
            const currentTime = new Date();
            
            addTestResult('Selected Delivery Date', 'info', selectedDate);
            addTestResult('Current System Time', 'info', currentTime.toLocaleTimeString());
            
            // Test the real-time integration functions
            if (typeof window.createRealTimeTimestamp === 'function') {
                const timestamp = window.createRealTimeTimestamp();
                addTestResult('Real-Time Timestamp', 'success', timestamp.toLocaleString());
            } else {
                addTestResult('Real-Time Timestamp', 'error', 'Function not available');
            }
            
            if (typeof window.formatRealTimeDisplay === 'function') {
                const display = window.formatRealTimeDisplay(true);
                addTestResult('Formatted Display', 'success', display);
            } else {
                addTestResult('Formatted Display', 'error', 'Function not available');
            }
            
            if (typeof window.createDeliveryTimestamp === 'function') {
                const deliveryTimestamp = window.createDeliveryTimestamp();
                addTestResult('Delivery Timestamp', 'success', JSON.stringify(deliveryTimestamp, null, 2));
            } else {
                addTestResult('Delivery Timestamp', 'error', 'Function not available');
            }
            
            if (typeof window.createBookingTimestamp === 'function') {
                const bookingTimestamp = window.createBookingTimestamp();
                addTestResult('Booking Timestamp', 'success', JSON.stringify(bookingTimestamp, null, 2));
            } else {
                addTestResult('Booking Timestamp', 'error', 'Function not available');
            }
            
            // Test that time is NOT fixed at 8:00 AM
            const testTime = new Date();
            const isFixed8AM = testTime.getHours() !== 8 && display.includes('08:00');
            if (isFixed8AM) {
                addTestResult('Fixed 8:00 AM Check', 'error', 'Time appears to be fixed at 8:00 AM - this is the bug!');
            } else {
                addTestResult('Fixed 8:00 AM Check', 'success', 'Time is using real system time - bug fixed!');
            }
        }
        
        function addTestResult(title, type, content) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `
                <strong>${title}:</strong><br>
                <div class="time-display">${content}</div>
            `;
            resultsDiv.appendChild(resultDiv);
        }
        
        function startContinuousTest() {
            const resultsDiv = document.getElementById('continuousResults');
            resultsDiv.innerHTML = '<p class="text-info">Running continuous test... Watch the time update in real-time!</p>';
            
            continuousTestInterval = setInterval(() => {
                if (typeof window.formatRealTimeDisplay === 'function') {
                    const currentDisplay = window.formatRealTimeDisplay(true);
                    const selectedDate = document.getElementById('drDeliveryDate').value;
                    
                    resultsDiv.innerHTML = `
                        <div class="test-result success">
                            <strong>Selected Date:</strong> ${selectedDate}<br>
                            <strong>Current Combined Timestamp:</strong><br>
                            <div class="time-display">${currentDisplay}</div>
                            <small class="text-muted">Updates every second to show real system time</small>
                        </div>
                    `;
                }
            }, 1000);
        }
        
        function stopContinuousTest() {
            if (continuousTestInterval) {
                clearInterval(continuousTestInterval);
                continuousTestInterval = null;
                document.getElementById('continuousResults').innerHTML = '<p class="text-muted">Continuous test stopped.</p>';
            }
        }
        
        // Test on page load
        setTimeout(() => {
            console.log('üß™ Running initial test...');
            testTimestamp();
        }, 1000);
    </script>
</body>
</html>