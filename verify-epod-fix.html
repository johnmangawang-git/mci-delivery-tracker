<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify EPOD Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-entry {
            font-family: monospace;
            font-size: 0.9em;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-3">Verify EPOD Fix</h1>
                
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Test Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2">
                            <button id="runFullTest" class="btn btn-primary">Run Full Test</button>
                            <button id="checkFunctions" class="btn btn-secondary">Check Functions</button>
                            <button id="testSave" class="btn btn-success">Test Save</button>
                            <button id="testLoad" class="btn btn-info">Test Load</button>
                            <button id="clearAll" class="btn btn-danger">Clear All</button>
                            <button id="clearLog" class="btn btn-outline-secondary">Clear Log</button>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Test Log</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="testLog" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; padding: 10px;"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">EPOD Records</h5>
                    </div>
                    <div class="card-body">
                        <div id="epodRecords" class="table-responsive">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Click "Test Load" to load EPOD records</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load the required scripts in the correct order -->
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/epod-fix.js"></script>
    <script src="public/assets/js/e-signature.js"></script>
    
    <script>
        // Test record template
        const testRecordTemplate = {
            drNumber: '',
            customerName: 'Test Customer',
            customerContact: '09123456789',
            truckPlate: 'ABC123',
            origin: 'Test Origin',
            destination: 'Test Destination',
            signature: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
            status: 'Completed',
            signedAt: '',
            timestamp: ''
        };
        
        // Log function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Clear log
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            log('Log cleared', 'info');
        }
        
        // Check function availability
        function checkFunctions() {
            log('=== Checking Function Availability ===', 'info');
            
            const functions = [
                { name: 'window.dataService', available: typeof window.dataService !== 'undefined' },
                { name: 'window.dataService.saveEPodRecord', available: typeof window.dataService?.saveEPodRecord === 'function' },
                { name: 'window.dataService.getEPodRecords', available: typeof window.dataService?.getEPodRecords === 'function' },
                { name: 'window.saveEPodRecordFixed', available: typeof window.saveEPodRecordFixed === 'function' },
                { name: 'window.getEPodRecordsFixed', available: typeof window.getEPodRecordsFixed === 'function' },
                { name: 'window.saveSingleSignature', available: typeof window.saveSingleSignature === 'function' },
                { name: 'window.saveMultipleSignatures', available: typeof window.saveMultipleSignatures === 'function' }
            ];
            
            functions.forEach(func => {
                if (func.available) {
                    log(`✓ ${func.name} is available`, 'success');
                } else {
                    log(`✗ ${func.name} is NOT available`, 'error');
                }
            });
            
            // Check localStorage
            try {
                const ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                log(`✓ localStorage accessible, ${ePodRecords.length} records found`, 'success');
            } catch (error) {
                log(`✗ localStorage error: ${error.message}`, 'error');
            }
        }
        
        // Test save functionality
        async function testSave() {
            log('=== Testing Save Functionality ===', 'info');
            
            // Create test record
            const timestamp = new Date().toISOString();
            const testRecord = {
                ...testRecordTemplate,
                drNumber: 'DR-TEST-' + Date.now(),
                signedAt: timestamp,
                timestamp: timestamp
            };
            
            log(`Created test record: ${testRecord.drNumber}`, 'info');
            
            // Test different save methods
            const methods = [
                { name: 'saveEPodRecordFixed', func: window.saveEPodRecordFixed },
                { name: 'dataService.saveEPodRecord', func: window.dataService?.saveEPodRecord },
                { name: 'saveSingleSignature', func: window.saveSingleSignature }
            ];
            
            let saved = false;
            
            for (const method of methods) {
                if (typeof method.func === 'function') {
                    try {
                        log(`Trying to save via ${method.name}...`, 'info');
                        
                        if (method.name === 'saveSingleSignature') {
                            // Special handling for saveSingleSignature
                            method.func({
                                drNumber: testRecord.drNumber,
                                customerName: testRecord.customerName,
                                customerContact: testRecord.customerContact,
                                truckPlate: testRecord.truckPlate,
                                deliveryRoute: `${testRecord.origin} to ${testRecord.destination}`,
                                signatureData: testRecord.signature
                            });
                            log(`✓ Called ${method.name}`, 'success');
                        } else {
                            const result = await method.func(testRecord);
                            log(`✓ Saved via ${method.name}: ${result.drNumber}`, 'success');
                        }
                        
                        saved = true;
                        break; // Stop after first successful save
                    } catch (error) {
                        log(`✗ Error with ${method.name}: ${error.message}`, 'error');
                    }
                } else {
                    log(`✗ ${method.name} not available`, 'warning');
                }
            }
            
            if (!saved) {
                log('✗ Failed to save using any method', 'error');
            } else {
                log('✓ Record saved successfully using at least one method', 'success');
            }
        }
        
        // Test load functionality
        async function testLoad() {
            log('=== Testing Load Functionality ===', 'info');
            
            const methods = [
                { name: 'getEPodRecordsFixed', func: window.getEPodRecordsFixed },
                { name: 'dataService.getEPodRecords', func: window.dataService?.getEPodRecords }
            ];
            
            let records = null;
            
            for (const method of methods) {
                if (typeof method.func === 'function') {
                    try {
                        log(`Trying to load via ${method.name}...`, 'info');
                        records = await method.func();
                        log(`✓ Loaded ${records.length} records via ${method.name}`, 'success');
                        break;
                    } catch (error) {
                        log(`✗ Error with ${method.name}: ${error.message}`, 'error');
                    }
                } else {
                    log(`✗ ${method.name} not available`, 'warning');
                }
            }
            
            if (!records) {
                // Fallback to localStorage
                try {
                    records = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                    log(`✓ Loaded ${records.length} records from localStorage (fallback)`, 'success');
                } catch (error) {
                    log(`✗ Error loading from localStorage: ${error.message}`, 'error');
                    records = [];
                }
            }
            
            displayRecords(records);
        }
        
        // Display records
        function displayRecords(records) {
            const container = document.getElementById('epodRecords');
            
            if (!records || records.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
                        <p class="mt-3">No EPOD records found</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>DR Number</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Sort by date (newest first)
            const sortedRecords = [...records].sort((a, b) => 
                new Date(b.signedAt || b.timestamp) - new Date(a.signedAt || a.timestamp)
            );
            
            sortedRecords.forEach(record => {
                const date = new Date(record.signedAt || record.timestamp);
                const isTest = record.drNumber.includes('TEST');
                html += `
                    <tr class="${isTest ? 'table-warning' : ''}">
                        <td>${record.drNumber}</td>
                        <td>${record.customerName}</td>
                        <td>${date.toLocaleDateString()}</td>
                        <td><span class="badge ${isTest ? 'bg-warning' : 'bg-primary'}">${isTest ? 'Test' : 'Live'}</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Clear all EPOD records
        function clearAll() {
            log('=== Clearing All EPOD Records ===', 'info');
            
            try {
                localStorage.removeItem('ePodRecords');
                log('✓ Cleared EPOD records from localStorage', 'success');
                document.getElementById('epodRecords').innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                        <p class="mt-3">All EPOD records cleared</p>
                    </div>
                `;
            } catch (error) {
                log(`✗ Error clearing localStorage: ${error.message}`, 'error');
            }
        }
        
        // Run full test
        async function runFullTest() {
            log('=== Running Full EPOD Test ===', 'info');
            
            // Step 1: Check functions
            checkFunctions();
            
            // Step 2: Test save
            await testSave();
            
            // Step 3: Test load
            await testLoad();
            
            log('=== Full Test Completed ===', 'info');
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            log('EPOD Verification Tool Loaded', 'success');
            
            // Set up event listeners
            document.getElementById('runFullTest').addEventListener('click', runFullTest);
            document.getElementById('checkFunctions').addEventListener('click', checkFunctions);
            document.getElementById('testSave').addEventListener('click', testSave);
            document.getElementById('testLoad').addEventListener('click', testLoad);
            document.getElementById('clearAll').addEventListener('click', clearAll);
            document.getElementById('clearLog').addEventListener('click', clearLog);
            
            // Initial load
            setTimeout(testLoad, 1000);
        });
    </script>
</body>
</html>