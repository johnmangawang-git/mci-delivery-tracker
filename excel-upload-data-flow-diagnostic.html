<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Upload Data Flow Diagnostic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .diagnostic-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .log-container {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .data-flow-step {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .step-number {
            background: #2196f3;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üîç Excel Upload Data Flow Diagnostic</h1>
        <p>Comprehensive diagnostic tool to trace where Excel upload data goes after confirmation</p>

        <!-- Quick Status Check -->
        <div class="diagnostic-section">
            <h3>üìä Quick Status Check</h3>
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="activeDeliveriesCount">0</h5>
                            <p class="card-text">Active Deliveries</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="localStorageCount">0</h5>
                            <p class="card-text">localStorage Items</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="drUploadCount">0</h5>
                            <p class="card-text">DR Upload Entries</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="functionsAvailable">0</h5>
                            <p class="card-text">Functions Available</p>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="updateQuickStatus()">üîÑ Refresh Status</button>
        </div>

        <!-- Data Flow Visualization -->
        <div class="diagnostic-section">
            <h3>üîÑ Excel Upload Data Flow</h3>
            <div class="data-flow-step">
                <span class="step-number">1</span>
                <strong>Excel File Upload</strong><br>
                <small>User selects Excel file ‚Üí processDRFileInModal() ‚Üí readExcelFile() ‚Üí mapDRDataWithModalContext()</small>
            </div>
            <div class="data-flow-step">
                <span class="step-number">2</span>
                <strong>Data Preview</strong><br>
                <small>showDRPreviewInModal() ‚Üí window.pendingDRBookings = mappedBookings</small>
            </div>
            <div class="data-flow-step">
                <span class="step-number">3</span>
                <strong>User Confirmation</strong><br>
                <small>User clicks "Confirm & Create Bookings" ‚Üí confirmDRBookings event listener</small>
            </div>
            <div class="data-flow-step">
                <span class="step-number">4</span>
                <strong>Bulk Processing</strong><br>
                <small>processBulkBookings(validBookings) ‚Üí calculateDistanceForBooking() ‚Üí createBookingFromDR()</small>
            </div>
            <div class="data-flow-step">
                <span class="step-number">5</span>
                <strong>Data Storage</strong><br>
                <small>window.activeDeliveries.push(bookingData) ‚Üí localStorage.setItem('mci-active-deliveries') ‚Üí localStorage.setItem('activeDeliveries')</small>
            </div>
            <div class="data-flow-step">
                <span class="step-number">6</span>
                <strong>UI Update</strong><br>
                <small>closeBookingModal() ‚Üí refreshActiveDeliveries() ‚Üí loadActiveDeliveries() ‚Üí switchToActiveDeliveriesView()</small>
            </div>
        </div>

        <!-- Diagnostic Controls -->
        <div class="diagnostic-section">
            <h3>üõ†Ô∏è Diagnostic Tools</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-info me-2 mb-2" onclick="traceDataFlow()">üîç Trace Complete Data Flow</button>
                    <button class="btn btn-success me-2 mb-2" onclick="simulateExcelUpload()">üìä Simulate Excel Upload</button>
                    <button class="btn btn-warning me-2 mb-2" onclick="checkDataIntegrity()">‚úÖ Check Data Integrity</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-secondary me-2 mb-2" onclick="inspectLocalStorage()">üíæ Inspect localStorage</button>
                    <button class="btn btn-primary me-2 mb-2" onclick="testActiveDeliveriesDisplay()">üìã Test Active Deliveries Display</button>
                    <button class="btn btn-danger mb-2" onclick="clearLog()">üóëÔ∏è Clear Log</button>
                </div>
            </div>
        </div>

        <!-- Log Container -->
        <div class="log-container" id="logContainer">
            <div>üöÄ Excel Upload Data Flow Diagnostic initialized. Click buttons above to run diagnostics.</div>
        </div>

        <!-- Current Data Display -->
        <div class="diagnostic-section">
            <h3>üìã Current Data State</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>window.activeDeliveries</h5>
                    <pre id="activeDeliveriesData" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">Loading...</pre>
                </div>
                <div class="col-md-6">
                    <h5>localStorage Data</h5>
                    <pre id="localStorageData" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">Loading...</pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize global arrays if they don't exist
        if (!window.activeDeliveries) {
            window.activeDeliveries = [];
        }

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                success: '#00ff88',
                error: '#ff4444',
                warning: '#ffaa00'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div>üöÄ Log cleared.</div>';
        }

        // Update quick status
        function updateQuickStatus() {
            // Count active deliveries
            const activeCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            document.getElementById('activeDeliveriesCount').textContent = activeCount;

            // Count localStorage items
            const mciData = localStorage.getItem('mci-active-deliveries');
            const altData = localStorage.getItem('activeDeliveries');
            const mciCount = mciData ? JSON.parse(mciData).length : 0;
            const altCount = altData ? JSON.parse(altData).length : 0;
            document.getElementById('localStorageCount').textContent = `${mciCount}/${altCount}`;

            // Count DR upload entries
            const drEntries = window.activeDeliveries ? 
                window.activeDeliveries.filter(d => d.source === 'DR_UPLOAD').length : 0;
            document.getElementById('drUploadCount').textContent = drEntries;

            // Count available functions
            const functions = [
                'processBulkBookings',
                'createBookingFromDR',
                'processDRFileInModal',
                'closeBookingModal',
                'refreshActiveDeliveries'
            ];
            const availableCount = functions.filter(fn => typeof window[fn] === 'function').length;
            document.getElementById('functionsAvailable').textContent = `${availableCount}/${functions.length}`;

            // Update data displays
            updateDataDisplays();
        }

        // Update data displays
        function updateDataDisplays() {
            // Display activeDeliveries
            const activeDeliveriesData = document.getElementById('activeDeliveriesData');
            if (window.activeDeliveries && window.activeDeliveries.length > 0) {
                activeDeliveriesData.textContent = JSON.stringify(window.activeDeliveries, null, 2);
            } else {
                activeDeliveriesData.textContent = 'No active deliveries found';
            }

            // Display localStorage data
            const localStorageData = document.getElementById('localStorageData');
            const mciData = localStorage.getItem('mci-active-deliveries');
            const altData = localStorage.getItem('activeDeliveries');
            
            let storageInfo = '';
            if (mciData) {
                storageInfo += `mci-active-deliveries (${JSON.parse(mciData).length} items):\n`;
                storageInfo += JSON.stringify(JSON.parse(mciData), null, 2);
            }
            if (altData) {
                storageInfo += `\n\nactiveDeliveries (${JSON.parse(altData).length} items):\n`;
                storageInfo += JSON.stringify(JSON.parse(altData), null, 2);
            }
            if (!mciData && !altData) {
                storageInfo = 'No localStorage data found';
            }
            
            localStorageData.textContent = storageInfo;
        }

        // Trace complete data flow
        function traceDataFlow() {
            log('=== TRACING EXCEL UPLOAD DATA FLOW ===');
            
            // Step 1: Check if Excel processing functions exist
            log('Step 1: Checking Excel processing functions...');
            const excelFunctions = [
                'processDRFileInModal',
                'readExcelFile',
                'mapDRDataWithModalContext',
                'showDRPreviewInModal'
            ];
            
            excelFunctions.forEach(fn => {
                if (typeof window[fn] === 'function') {
                    log(`‚úÖ ${fn} function available`, 'success');
                } else {
                    log(`‚ùå ${fn} function missing`, 'error');
                }
            });

            // Step 2: Check bulk processing functions
            log('Step 2: Checking bulk processing functions...');
            const bulkFunctions = [
                'processBulkBookings',
                'createBookingFromDR',
                'calculateDistanceForBooking',
                'generateBookingId'
            ];
            
            bulkFunctions.forEach(fn => {
                if (typeof window[fn] === 'function') {
                    log(`‚úÖ ${fn} function available`, 'success');
                } else {
                    log(`‚ùå ${fn} function missing`, 'error');
                }
            });

            // Step 3: Check data storage
            log('Step 3: Checking data storage...');
            log(`Global activeDeliveries array: ${window.activeDeliveries ? window.activeDeliveries.length : 0} items`);
            
            const mciData = localStorage.getItem('mci-active-deliveries');
            const altData = localStorage.getItem('activeDeliveries');
            log(`localStorage 'mci-active-deliveries': ${mciData ? JSON.parse(mciData).length : 0} items`);
            log(`localStorage 'activeDeliveries': ${altData ? JSON.parse(altData).length : 0} items`);

            // Step 4: Check UI update functions
            log('Step 4: Checking UI update functions...');
            const uiFunctions = [
                'closeBookingModal',
                'refreshActiveDeliveries',
                'loadActiveDeliveries',
                'switchToActiveDeliveriesView'
            ];
            
            uiFunctions.forEach(fn => {
                if (typeof window[fn] === 'function') {
                    log(`‚úÖ ${fn} function available`, 'success');
                } else {
                    log(`‚ùå ${fn} function missing`, 'error');
                }
            });

            log('‚úÖ Data flow trace completed');
        }

        // Simulate Excel upload
        function simulateExcelUpload() {
            log('=== SIMULATING EXCEL UPLOAD ===');
            
            // Create mock Excel data
            const mockExcelData = [
                {
                    drNumber: 'DR-SIM-001',
                    customerName: 'Simulated Customer 1',
                    customerNumber: '09123456789',
                    destinationArea: 'Makati City, Metro Manila',
                    originWarehouse: 'SMEG Alabang warehouse',
                    deliveryDate: new Date().toISOString().split('T')[0],
                    distance: 12.5
                },
                {
                    drNumber: 'DR-SIM-002',
                    customerName: 'Simulated Customer 2',
                    customerNumber: '09987654321',
                    destinationArea: 'Quezon City, Metro Manila',
                    originWarehouse: 'SMEG Alabang warehouse',
                    deliveryDate: new Date().toISOString().split('T')[0],
                    distance: 18.3
                }
            ];

            log(`Created ${mockExcelData.length} mock Excel entries`);

            // Simulate the bulk processing
            if (typeof window.processBulkBookings === 'function') {
                log('Processing mock bookings using processBulkBookings...');
                window.processBulkBookings(mockExcelData).then(results => {
                    log(`‚úÖ Bulk processing completed: ${results.successful} successful, ${results.failed} failed`, 'success');
                    updateQuickStatus();
                }).catch(error => {
                    log(`‚ùå Bulk processing failed: ${error.message}`, 'error');
                });
            } else {
                log('‚ùå processBulkBookings function not available, simulating manually...', 'warning');
                
                // Manual simulation
                mockExcelData.forEach(booking => {
                    const bookingData = {
                        id: 'SIM_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        drNumber: booking.drNumber,
                        customerName: booking.customerName,
                        customerNumber: booking.customerNumber,
                        origin: booking.originWarehouse,
                        destination: booking.destinationArea,
                        deliveryDate: booking.deliveryDate,
                        distance: booking.distance,
                        status: 'Pending',
                        timestamp: new Date().toISOString(),
                        source: 'DR_UPLOAD'
                    };

                    window.activeDeliveries.push(bookingData);
                    log(`Added simulated booking: ${booking.drNumber}`);
                });

                // Save to localStorage
                localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
                localStorage.setItem('activeDeliveries', JSON.stringify(window.activeDeliveries));
                
                log('‚úÖ Manual simulation completed', 'success');
                updateQuickStatus();
            }
        }

        // Check data integrity
        function checkDataIntegrity() {
            log('=== CHECKING DATA INTEGRITY ===');
            
            // Check if global array matches localStorage
            const globalCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            const mciData = localStorage.getItem('mci-active-deliveries');
            const altData = localStorage.getItem('activeDeliveries');
            const mciCount = mciData ? JSON.parse(mciData).length : 0;
            const altCount = altData ? JSON.parse(altData).length : 0;

            log(`Global array: ${globalCount} items`);
            log(`localStorage 'mci-active-deliveries': ${mciCount} items`);
            log(`localStorage 'activeDeliveries': ${altCount} items`);

            if (globalCount === mciCount && mciCount === altCount) {
                log('‚úÖ Data integrity check passed - all sources match', 'success');
            } else {
                log('‚ö†Ô∏è Data integrity issue - counts do not match', 'warning');
                
                if (globalCount !== mciCount) {
                    log(`‚ùå Global array (${globalCount}) != mci-active-deliveries (${mciCount})`, 'error');
                }
                if (mciCount !== altCount) {
                    log(`‚ùå mci-active-deliveries (${mciCount}) != activeDeliveries (${altCount})`, 'error');
                }
            }

            // Check for DR_UPLOAD entries
            if (window.activeDeliveries) {
                const drEntries = window.activeDeliveries.filter(d => d.source === 'DR_UPLOAD');
                log(`Found ${drEntries.length} DR_UPLOAD entries in global array`);
                
                if (drEntries.length > 0) {
                    log('‚úÖ DR upload entries found in data', 'success');
                    drEntries.forEach(entry => {
                        log(`  - ${entry.drNumber}: ${entry.customerName} ‚Üí ${entry.destination}`);
                    });
                } else {
                    log('‚ö†Ô∏è No DR upload entries found', 'warning');
                }
            }
        }

        // Inspect localStorage
        function inspectLocalStorage() {
            log('=== INSPECTING LOCALSTORAGE ===');
            
            const keys = ['mci-active-deliveries', 'activeDeliveries', 'mci-delivery-history', 'mci-customers'];
            
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        log(`‚úÖ ${key}: ${Array.isArray(parsed) ? parsed.length : 'object'} items`, 'success');
                        
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            const drUploads = parsed.filter(item => item.source === 'DR_UPLOAD');
                            if (drUploads.length > 0) {
                                log(`  ‚îî‚îÄ ${drUploads.length} DR_UPLOAD entries found`);
                            }
                        }
                    } catch (error) {
                        log(`‚ùå ${key}: Invalid JSON data`, 'error');
                    }
                } else {
                    log(`‚ö†Ô∏è ${key}: No data found`, 'warning');
                }
            });
        }

        // Test active deliveries display
        function testActiveDeliveriesDisplay() {
            log('=== TESTING ACTIVE DELIVERIES DISPLAY ===');
            
            // Check if loadActiveDeliveries function exists
            if (typeof window.loadActiveDeliveries === 'function') {
                log('‚úÖ loadActiveDeliveries function exists', 'success');
                
                try {
                    window.loadActiveDeliveries();
                    log('‚úÖ loadActiveDeliveries executed successfully', 'success');
                } catch (error) {
                    log(`‚ùå Error executing loadActiveDeliveries: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå loadActiveDeliveries function not found', 'error');
                log('This means the Active Deliveries view may not update after Excel upload');
            }

            // Check if the Active Deliveries table exists
            const tableBody = document.getElementById('activeDeliveriesTableBody');
            if (tableBody) {
                log('‚úÖ Active Deliveries table found in DOM', 'success');
                log(`Current table rows: ${tableBody.children.length}`);
            } else {
                log('‚ùå Active Deliveries table not found in DOM', 'error');
                log('This means we are not on the main application page');
            }

            // Check view switching function
            if (typeof window.switchToActiveDeliveriesView === 'function') {
                log('‚úÖ switchToActiveDeliveriesView function exists', 'success');
            } else {
                log('‚ùå switchToActiveDeliveriesView function not found', 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Excel Upload Data Flow Diagnostic initialized');
            updateQuickStatus();
        });

        // Auto-refresh status every 5 seconds
        setInterval(updateQuickStatus, 5000);
    </script>
</body>
</html>