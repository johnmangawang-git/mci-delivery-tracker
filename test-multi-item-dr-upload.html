<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Item DR Upload Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .critical { background-color: #f5c6cb; border: 2px solid #dc3545; color: #721c24; font-weight: bold; }
        .code-display {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">üîß Multi-Item DR Upload Test</h1>
        
        <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> Issue Identified</h5>
            <p><strong>Problem:</strong> Only the last record from Excel upload appears in Active Deliveries</p>
            <p><strong>Expected:</strong> All 4 items should appear in Active Deliveries</p>
            <p><strong>Observed:</strong> Preview shows 4 items, but only 1 appears in Active Deliveries</p>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üîç Diagnostic Tools</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="diagnoseActiveDeliveries()">
                            üîç Check Active Deliveries State
                        </button>
                        <br>
                        <button class="btn btn-info mb-2" onclick="checkLocalStorage()">
                            üíæ Check localStorage Data
                        </button>
                        <br>
                        <button class="btn btn-warning mb-2" onclick="testUploadFunctions()">
                            üß™ Test Upload Functions
                        </button>
                        <br>
                        <button class="btn btn-success" onclick="simulateMultiItemUpload()">
                            üìù Simulate Multi-Item Upload
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Current State</h5>
                    </div>
                    <div class="card-body" id="currentState">
                        <p class="text-muted">Click diagnostic tools to see current state...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üß™ Test Results</h5>
                    </div>
                    <div class="card-body" id="testResults">
                        <p class="text-muted">Run diagnostic tools to see results.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã Sample Multi-Item Data</h5>
                    </div>
                    <div class="card-body">
                        <div class="code-display" id="sampleData">
                            Loading sample data...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/multi-item-dr-upload-fix.js"></script>
    
    <script>
        // Sample multi-item data (similar to what would come from Excel)
        const sampleMultiItemData = [
            {
                drNumber: 'DR-TEST-001',
                customerName: 'Customer A',
                vendorNumber: 'V001',
                origin: 'Warehouse A',
                destination: 'Location A',
                truckType: 'Truck',
                truckPlateNumber: 'ABC-001',
                itemNumber: 'ITEM-001',
                mobileNumber: '09123456789',
                itemDescription: 'Test Item A',
                serialNumber: 'SN-001',
                additionalCosts: 100.00,
                deliveryDate: '2025-01-27',
                bookedDate: '2025-01-27'
            },
            {
                drNumber: 'DR-TEST-002',
                customerName: 'Customer B',
                vendorNumber: 'V002',
                origin: 'Warehouse B',
                destination: 'Location B',
                truckType: 'Van',
                truckPlateNumber: 'XYZ-002',
                itemNumber: 'ITEM-002',
                mobileNumber: '09987654321',
                itemDescription: 'Test Item B',
                serialNumber: 'SN-002',
                additionalCosts: 150.00,
                deliveryDate: '2025-01-27',
                bookedDate: '2025-01-27'
            },
            {
                drNumber: 'DR-TEST-003',
                customerName: 'Customer C',
                vendorNumber: 'V003',
                origin: 'Warehouse C',
                destination: 'Location C',
                truckType: 'Truck',
                truckPlateNumber: 'DEF-003',
                itemNumber: 'ITEM-003',
                mobileNumber: '09111222333',
                itemDescription: 'Test Item C',
                serialNumber: 'SN-003',
                additionalCosts: 200.00,
                deliveryDate: '2025-01-27',
                bookedDate: '2025-01-27'
            },
            {
                drNumber: 'DR-TEST-004',
                customerName: 'Customer D',
                vendorNumber: 'V004',
                origin: 'Warehouse D',
                destination: 'Location D',
                truckType: 'Van',
                truckPlateNumber: 'GHI-004',
                itemNumber: 'ITEM-004',
                mobileNumber: '09444555666',
                itemDescription: 'Test Item D',
                serialNumber: 'SN-004',
                additionalCosts: 250.00,
                deliveryDate: '2025-01-27',
                bookedDate: '2025-01-27'
            }
        ];
        
        function updateCurrentState() {
            const stateDiv = document.getElementById('currentState');
            const activeCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            
            let storageCount = 0;
            try {
                const stored = localStorage.getItem('mci-active-deliveries');
                if (stored) {
                    storageCount = JSON.parse(stored).length;
                }
            } catch (error) {
                // Ignore
            }
            
            stateDiv.innerHTML = `
                <p><strong>Active Deliveries Array:</strong> ${activeCount} items</p>
                <p><strong>localStorage Count:</strong> ${storageCount} items</p>
                <p><strong>Fix Loaded:</strong> ${typeof window.multiItemDRUploadFix !== 'undefined' ? '‚úÖ Yes' : '‚ùå No'}</p>
                <p><strong>Enhanced Functions:</strong> ${typeof window.enhancedCreateBookingFromDR === 'function' ? '‚úÖ Available' : '‚ùå Not Available'}</p>
            `;
        }
        
        function diagnoseActiveDeliveries() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            addTestResult('Active Deliveries Diagnosis', 'info', 'Checking current state...');
            
            if (typeof window.diagnoseActiveDeliveries === 'function') {
                addTestResult('Diagnostic Function', 'success', 'diagnoseActiveDeliveries function available');
                
                // Capture console output
                const originalLog = console.log;
                const logs = [];
                console.log = function(...args) {
                    logs.push(args.join(' '));
                    originalLog.apply(console, args);
                };
                
                // Run diagnosis
                window.diagnoseActiveDeliveries();
                
                // Restore console.log
                console.log = originalLog;
                
                // Show captured logs
                logs.forEach(log => {
                    addTestResult('Diagnostic Output', 'info', log);
                });
                
            } else {
                addTestResult('Diagnostic Function', 'error', 'diagnoseActiveDeliveries function not available');
            }
            
            updateCurrentState();
        }
        
        function checkLocalStorage() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            addTestResult('localStorage Check', 'info', 'Checking localStorage data...');
            
            try {
                const keys = ['mci-active-deliveries', 'activeDeliveries', 'mci-delivery-history'];
                
                keys.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            addTestResult(`localStorage: ${key}`, 'success', 
                                `${parsed.length} items found`);
                            
                            if (parsed.length > 0) {
                                const sample = parsed[0];
                                addTestResult(`Sample from ${key}`, 'info', 
                                    `DR: ${sample.drNumber || sample.dr_number}, Customer: ${sample.customerName || sample.customer_name}`);
                            }
                        } catch (parseError) {
                            addTestResult(`localStorage: ${key}`, 'error', 
                                `Parse error: ${parseError.message}`);
                        }
                    } else {
                        addTestResult(`localStorage: ${key}`, 'warning', 'No data found');
                    }
                });
                
            } catch (error) {
                addTestResult('localStorage Error', 'error', error.message);
            }
            
            updateCurrentState();
        }
        
        function testUploadFunctions() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            addTestResult('Upload Functions Test', 'info', 'Testing upload function availability...');
            
            const functions = [
                'createBookingFromDR',
                'enhancedCreateBookingFromDR',
                'processInlineBookings',
                'enhancedProcessInlineBookings'
            ];
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    addTestResult(`Function: ${funcName}`, 'success', 'Available');
                } else {
                    addTestResult(`Function: ${funcName}`, 'error', 'Not available');
                }
            });
            
            updateCurrentState();
        }
        
        function simulateMultiItemUpload() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            addTestResult('Multi-Item Upload Simulation', 'info', 'Starting simulation with 4 test items...');
            
            // Initialize activeDeliveries if needed
            if (!window.activeDeliveries) {
                window.activeDeliveries = [];
                addTestResult('Initialization', 'info', 'Initialized activeDeliveries array');
            }
            
            const initialCount = window.activeDeliveries.length;
            addTestResult('Initial Count', 'info', `Starting with ${initialCount} items`);
            
            if (typeof window.enhancedProcessInlineBookings === 'function') {
                addTestResult('Enhanced Function', 'success', 'Using enhancedProcessInlineBookings');
                
                window.enhancedProcessInlineBookings(sampleMultiItemData)
                    .then(results => {
                        const finalCount = window.activeDeliveries.length;
                        const addedCount = finalCount - initialCount;
                        
                        if (addedCount === 4) {
                            addTestResult('Simulation Result', 'success', 
                                `‚úÖ SUCCESS: Added ${addedCount} items (Expected: 4)`);
                        } else {
                            addTestResult('Simulation Result', 'error', 
                                `‚ùå FAILED: Added ${addedCount} items (Expected: 4)`);
                        }
                        
                        addTestResult('Final Count', 'info', `Final activeDeliveries count: ${finalCount}`);
                        
                        // Show added items
                        if (results && results.length > 0) {
                            results.forEach((item, index) => {
                                addTestResult(`Added Item ${index + 1}`, 'success', 
                                    `${item.drNumber} - ${item.customerName}`);
                            });
                        }
                        
                        updateCurrentState();
                    })
                    .catch(error => {
                        addTestResult('Simulation Error', 'error', error.message);
                        updateCurrentState();
                    });
                    
            } else if (typeof window.createBookingFromDR === 'function') {
                addTestResult('Fallback Function', 'warning', 'Using original createBookingFromDR');
                
                // Process items sequentially
                processItemsSequentially(sampleMultiItemData, 0, initialCount);
                
            } else {
                addTestResult('No Functions', 'error', 'No upload functions available');
            }
        }
        
        function processItemsSequentially(items, index, initialCount) {
            if (index >= items.length) {
                const finalCount = window.activeDeliveries.length;
                const addedCount = finalCount - initialCount;
                
                if (addedCount === 4) {
                    addTestResult('Sequential Result', 'success', 
                        `‚úÖ SUCCESS: Added ${addedCount} items (Expected: 4)`);
                } else {
                    addTestResult('Sequential Result', 'error', 
                        `‚ùå FAILED: Added ${addedCount} items (Expected: 4)`);
                }
                
                updateCurrentState();
                return;
            }
            
            const item = items[index];
            addTestResult(`Processing Item ${index + 1}`, 'info', `${item.drNumber} - ${item.customerName}`);
            
            window.createBookingFromDR(item)
                .then(() => {
                    addTestResult(`Item ${index + 1} Complete`, 'success', `${item.drNumber} processed`);
                    setTimeout(() => {
                        processItemsSequentially(items, index + 1, initialCount);
                    }, 200);
                })
                .catch(error => {
                    addTestResult(`Item ${index + 1} Error`, 'error', error.message);
                    setTimeout(() => {
                        processItemsSequentially(items, index + 1, initialCount);
                    }, 200);
                });
        }
        
        function addTestResult(title, type, content) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `
                <strong>${title}:</strong><br>
                <div>${content}</div>
            `;
            resultsDiv.appendChild(resultDiv);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Display sample data
            document.getElementById('sampleData').textContent = JSON.stringify(sampleMultiItemData, null, 2);
            
            // Update current state
            updateCurrentState();
            
            // Run initial diagnosis after scripts load
            setTimeout(() => {
                console.log('üß™ Running initial multi-item upload diagnosis...');
                
                const hasEnhanced = typeof window.enhancedCreateBookingFromDR === 'function';
                const hasOriginal = typeof window.createBookingFromDR === 'function';
                const hasMultiItemFix = typeof window.multiItemDRUploadFix !== 'undefined';
                
                console.log('Enhanced function available:', hasEnhanced);
                console.log('Original function available:', hasOriginal);
                console.log('Multi-item fix loaded:', hasMultiItemFix);
                
                if (hasEnhanced && hasMultiItemFix) {
                    addTestResult('Initial Check', 'success', 'Multi-item DR upload fix is loaded and ready');
                } else {
                    addTestResult('Initial Check', 'warning', 'Some functions may still be loading. Try running tests manually.');
                }
                
                updateCurrentState();
            }, 2000);
        });
    </script>
</body>
</html>