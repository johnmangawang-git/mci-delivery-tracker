<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Active Deliveries Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Debug Active Deliveries Sync Issue</h2>
        
        <div class="alert alert-info">
            <strong>Issue:</strong> Dashboard shows 3 Active Deliveries but table shows no records.
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Data Sources Check</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="checkDataSources()">Check All Data Sources</button>
                        <div id="dataSourcesResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Status Filter Check</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-secondary" onclick="checkStatusFilters()">Check Status Filters</button>
                        <div id="statusFilterResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Function Availability Check</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="checkFunctions()">Check Functions</button>
                        <div id="functionsResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Raw Data Inspector</h5>
                    </div>
                    <div class="card-body">
                        <textarea id="rawDataOutput" class="form-control" rows="15" readonly placeholder="Raw data will appear here..."></textarea>
                        <button class="btn btn-warning mt-2" onclick="forceLoadActiveDeliveries()">Force Load Active Deliveries</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function checkDataSources() {
            const resultsDiv = document.getElementById('dataSourcesResults');
            
            let html = '<h6>Data Sources Analysis:</h6>';
            
            // Check window.activeDeliveries
            const windowData = window.activeDeliveries || [];
            html += `<div class="alert alert-info">
                <strong>window.activeDeliveries:</strong> ${windowData.length} items<br>
                <small>Status: ${windowData.length > 0 ? 'Has Data' : 'Empty'}</small>
            </div>`;
            
            // Check localStorage sources
            const localStorageKeys = ['mci-active-deliveries', 'activeDeliveries'];
            localStorageKeys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    if (data) {
                        const parsed = JSON.parse(data);
                        const count = Array.isArray(parsed) ? parsed.length : 'Not Array';
                        html += `<div class="alert alert-success">
                            <strong>${key}:</strong> ${count} items<br>
                            <small>First item: ${Array.isArray(parsed) && parsed.length > 0 ? parsed[0].drNumber || parsed[0].dr_number || 'No DR#' : 'N/A'}</small>
                        </div>`;
                    } else {
                        html += `<div class="alert alert-warning"><strong>${key}:</strong> Not found</div>`;
                    }
                } catch (error) {
                    html += `<div class="alert alert-danger"><strong>${key}:</strong> Error - ${error.message}</div>`;
                }
            });
            
            resultsDiv.innerHTML = html;
            
            // Update raw data
            document.getElementById('rawDataOutput').value = JSON.stringify({
                windowActiveDeliveries: windowData,
                localStorage: {
                    'mci-active-deliveries': localStorage.getItem('mci-active-deliveries'),
                    'activeDeliveries': localStorage.getItem('activeDeliveries')
                }
            }, null, 2);
        }
        
        function checkStatusFilters() {
            const resultsDiv = document.getElementById('statusFilterResults');
            
            let html = '<h6>Status Filter Analysis:</h6>';
            
            // Check if there are any status filters applied
            const statusFilter = document.querySelector('#statusFilter');
            const searchInput = document.querySelector('#searchInput');
            
            html += `<div class="alert alert-info">
                <strong>Status Filter Element:</strong> ${statusFilter ? 'Found' : 'Not Found'}<br>
                <strong>Current Filter Value:</strong> ${statusFilter ? statusFilter.value : 'N/A'}<br>
                <strong>Search Input:</strong> ${searchInput ? searchInput.value || 'Empty' : 'Not Found'}
            </div>`;
            
            // Check global filter variables
            html += `<div class="alert alert-secondary">
                <strong>Global Variables:</strong><br>
                <small>
                    currentSearchTerm: ${window.currentSearchTerm || 'undefined'}<br>
                    currentStatusFilter: ${window.currentStatusFilter || 'undefined'}
                </small>
            </div>`;
            
            // Check if data is being filtered out
            if (window.activeDeliveries && window.activeDeliveries.length > 0) {
                const activeStatuses = ['Active', 'In Transit', 'On Schedule', 'Delayed', 'Pending'];
                const filteredData = window.activeDeliveries.filter(delivery => 
                    activeStatuses.includes(delivery.status)
                );
                
                html += `<div class="alert alert-warning">
                    <strong>Filter Test:</strong><br>
                    Total Deliveries: ${window.activeDeliveries.length}<br>
                    After Status Filter: ${filteredData.length}<br>
                    <small>Statuses found: ${[...new Set(window.activeDeliveries.map(d => d.status))].join(', ')}</small>
                </div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function checkFunctions() {
            const resultsDiv = document.getElementById('functionsResults');
            
            const functions = [
                'loadActiveDeliveries',
                'displayActiveDeliveries', 
                'updateDashboardMetrics',
                'updateBookingViewDashboard'
            ];
            
            let html = '<h6>Function Availability:</h6>';
            
            functions.forEach(funcName => {
                const exists = typeof window[funcName] === 'function';
                html += `<div class="alert ${exists ? 'alert-success' : 'alert-danger'}">
                    <strong>${funcName}:</strong> ${exists ? 'Available' : 'Missing'}
                </div>`;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function forceLoadActiveDeliveries() {
            console.log('ðŸ”„ Force loading active deliveries...');
            
            // Try to call loadActiveDeliveries if it exists
            if (typeof window.loadActiveDeliveries === 'function') {
                window.loadActiveDeliveries();
                console.log('âœ… Called loadActiveDeliveries()');
            }
            
            // Try to call displayActiveDeliveries if it exists
            if (typeof window.displayActiveDeliveries === 'function') {
                window.displayActiveDeliveries();
                console.log('âœ… Called displayActiveDeliveries()');
            }
            
            // Force refresh the table
            setTimeout(() => {
                checkDataSources();
                alert('Force load attempted. Check console for details.');
            }, 1000);
        }
        
        // Auto-run checks when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkDataSources();
                checkStatusFilters();
                checkFunctions();
            }, 1000);
        });
    </script>
</body>
</html>