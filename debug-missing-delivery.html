<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Missing Delivery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üîç Debug: Missing Delivery Investigation</h2>
        
        <div class="alert alert-danger">
            <strong>Issue:</strong> Delivery disappears from Active Deliveries but doesn't appear in Delivery History after signing.
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Data Investigation</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary me-2" onclick="addTestDelivery()">Add Test Delivery</button>
                        <button class="btn btn-warning me-2" onclick="investigateSignatureProcess()">Investigate Signature Process</button>
                        <button class="btn btn-info me-2" onclick="checkAllStorageLocations()">Check All Storage Locations</button>
                        <button class="btn btn-secondary" onclick="clearAllData()">Clear All Data</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6>Current State</h6>
                        </div>
                        <div class="card-body">
                            <div id="currentState" style="font-family: monospace; font-size: 12px;">
                                Loading...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6>Investigation Log</h6>
                        </div>
                        <div class="card-body">
                            <div id="investigationLog" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; background-color: #f8f9fa; padding: 10px;">
                                Investigation log will appear here...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/signature-completion-fix.js"></script>
    <script>
        // Initialize arrays
        if (typeof window.activeDeliveries === 'undefined') {
            window.activeDeliveries = [];
        }
        if (typeof window.deliveryHistory === 'undefined') {
            window.deliveryHistory = [];
        }

        // Load existing data
        try {
            const savedActive = localStorage.getItem('mci-active-deliveries');
            const savedHistory = localStorage.getItem('mci-delivery-history');
            
            if (savedActive) {
                window.activeDeliveries = JSON.parse(savedActive);
            }
            if (savedHistory) {
                window.deliveryHistory = JSON.parse(savedHistory);
            }
        } catch (error) {
            console.error('Error loading data:', error);
        }

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('investigationLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'blue';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Override functions to trace the process
        const originalEnhancedUpdateDeliveryStatus = window.enhancedUpdateDeliveryStatus;
        window.enhancedUpdateDeliveryStatus = function(drNumber, newStatus) {
            log(`üîÑ TRACE: enhancedUpdateDeliveryStatus called for ${drNumber} -> ${newStatus}`, 'info');
            log(`üìä BEFORE: Active=${window.activeDeliveries.length}, History=${window.deliveryHistory.length}`, 'info');
            
            const result = originalEnhancedUpdateDeliveryStatus(drNumber, newStatus);
            
            log(`üìä AFTER: Active=${window.activeDeliveries.length}, History=${window.deliveryHistory.length}`, 'info');
            log(`‚úÖ Result: ${result}`, result ? 'success' : 'error');
            
            updateCurrentState();
            return result;
        };

        // Override localStorage setItem to trace saves
        const originalSetItem = localStorage.setItem;
        localStorage.setItem = function(key, value) {
            if (key.includes('delivery') || key.includes('active') || key.includes('history')) {
                log(`üíæ TRACE: localStorage.setItem('${key}', ${value.length} chars)`, 'info');
                if (key === 'mci-delivery-history') {
                    try {
                        const parsed = JSON.parse(value);
                        log(`üì¶ History being saved: ${parsed.length} items`, 'info');
                        parsed.forEach((item, index) => {
                            log(`  ${index + 1}. ${item.drNumber} - ${item.status}`, 'info');
                        });
                    } catch (e) {
                        log(`‚ùå Error parsing history data: ${e.message}`, 'error');
                    }
                }
            }
            return originalSetItem.call(this, key, value);
        };

        function addTestDelivery() {
            const testDelivery = {
                id: 'test-' + Date.now(),
                drNumber: 'DR-TRACE-' + Date.now(),
                customerName: 'Trace Test Customer',
                vendorNumber: 'VN-TRACE-001',
                truckPlateNumber: 'TRACE-123',
                origin: 'Manila',
                destination: 'Quezon City',
                status: 'Active',
                createdDate: new Date().toLocaleDateString()
            };
            
            window.activeDeliveries.push(testDelivery);
            localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
            
            log(`‚úÖ Added test delivery: ${testDelivery.drNumber}`, 'success');
            updateCurrentState();
        }

        function investigateSignatureProcess() {
            if (window.activeDeliveries.length === 0) {
                log('‚ö†Ô∏è No active deliveries to investigate. Add a test delivery first.', 'warning');
                return;
            }
            
            const delivery = window.activeDeliveries[0];
            log(`üîç INVESTIGATION: Starting signature process for ${delivery.drNumber}`, 'info');
            
            // Step 1: Check initial state
            log(`üìä INITIAL STATE:`, 'info');
            log(`  Active Deliveries: ${window.activeDeliveries.length}`, 'info');
            log(`  Delivery History: ${window.deliveryHistory.length}`, 'info');
            log(`  Target Delivery: ${delivery.drNumber}`, 'info');
            
            // Step 2: Create E-POD record
            log(`üìù STEP 1: Creating E-POD record...`, 'info');
            const ePodRecord = {
                drNumber: delivery.drNumber,
                customerName: delivery.customerName,
                customerContact: delivery.vendorNumber,
                truckPlate: delivery.truckPlateNumber,
                origin: delivery.origin,
                destination: delivery.destination,
                signature: 'data:image/png;base64,test',
                status: 'Completed',
                signedAt: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            
            try {
                let ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                ePodRecords.push(ePodRecord);
                localStorage.setItem('ePodRecords', JSON.stringify(ePodRecords));
                log(`‚úÖ E-POD record saved. Total: ${ePodRecords.length}`, 'success');
            } catch (error) {
                log(`‚ùå Error saving E-POD: ${error.message}`, 'error');
            }
            
            // Step 3: Call enhanced signature save
            log(`üöÄ STEP 2: Calling enhanced signature save...`, 'info');
            
            if (typeof window.enhancedSaveSignature === 'function') {
                const signatureInfo = {
                    drNumber: delivery.drNumber,
                    customerName: delivery.customerName,
                    customerContact: delivery.vendorNumber,
                    truckPlate: delivery.truckPlateNumber,
                    origin: delivery.origin,
                    destination: delivery.destination,
                    signatureData: ePodRecord.signature
                };
                
                const success = window.enhancedSaveSignature(signatureInfo);
                log(`üìä Enhanced save result: ${success}`, success ? 'success' : 'error');
            } else {
                log(`‚ùå Enhanced signature save function not available`, 'error');
            }
            
            // Step 4: Check final state
            setTimeout(() => {
                log(`üìä FINAL STATE:`, 'info');
                log(`  Active Deliveries: ${window.activeDeliveries.length}`, 'info');
                log(`  Delivery History: ${window.deliveryHistory.length}`, 'info');
                
                const stillInActive = window.activeDeliveries.find(d => d.drNumber === delivery.drNumber);
                const nowInHistory = window.deliveryHistory.find(d => d.drNumber === delivery.drNumber);
                
                log(`üîç DELIVERY LOCATION:`, 'info');
                log(`  Still in Active: ${stillInActive ? 'YES' : 'NO'}`, stillInActive ? 'warning' : 'info');
                log(`  Now in History: ${nowInHistory ? 'YES' : 'NO'}`, nowInHistory ? 'success' : 'error');
                
                if (!stillInActive && !nowInHistory) {
                    log(`‚ùå CRITICAL: Delivery has DISAPPEARED!`, 'error');
                    checkAllStorageLocations();
                }
                
                updateCurrentState();
            }, 1000);
        }

        function checkAllStorageLocations() {
            log(`üîç CHECKING ALL STORAGE LOCATIONS:`, 'info');
            
            // Check window globals
            log(`üìä WINDOW GLOBALS:`, 'info');
            log(`  window.activeDeliveries: ${window.activeDeliveries ? window.activeDeliveries.length : 'undefined'} items`, 'info');
            log(`  window.deliveryHistory: ${window.deliveryHistory ? window.deliveryHistory.length : 'undefined'} items`, 'info');
            
            // Check localStorage
            log(`üíæ LOCALSTORAGE:`, 'info');
            const storageKeys = [
                'mci-active-deliveries',
                'mci-delivery-history',
                'ePodRecords',
                'activeDeliveries', // Check for alternative keys
                'deliveryHistory',
                'deliveries'
            ];
            
            storageKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        log(`  ${key}: ${Array.isArray(parsed) ? parsed.length : 'not array'} items`, 'info');
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            parsed.forEach((item, index) => {
                                if (item.drNumber) {
                                    log(`    ${index + 1}. ${item.drNumber} - ${item.status || 'no status'}`, 'info');
                                }
                            });
                        }
                    } catch (e) {
                        log(`  ${key}: ${value.length} chars (not JSON)`, 'info');
                    }
                } else {
                    log(`  ${key}: null`, 'info');
                }
            });
            
            // Check for any other delivery-related keys
            log(`üîç ALL LOCALSTORAGE KEYS:`, 'info');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.toLowerCase().includes('delivery') || key.toLowerCase().includes('dr-'))) {
                    log(`  Found: ${key}`, 'info');
                }
            }
        }

        function clearAllData() {
            window.activeDeliveries = [];
            window.deliveryHistory = [];
            
            // Clear all possible localStorage keys
            const keysToRemove = [
                'mci-active-deliveries',
                'mci-delivery-history',
                'ePodRecords',
                'activeDeliveries',
                'deliveryHistory',
                'deliveries'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });
            
            log('üóëÔ∏è All data cleared', 'info');
            updateCurrentState();
        }

        function updateCurrentState() {
            const stateDiv = document.getElementById('currentState');
            let html = '';
            
            html += `<strong>Window Arrays:</strong><br>`;
            html += `Active Deliveries: ${window.activeDeliveries.length}<br>`;
            html += `Delivery History: ${window.deliveryHistory.length}<br><br>`;
            
            html += `<strong>Active Deliveries:</strong><br>`;
            if (window.activeDeliveries.length === 0) {
                html += `<em>None</em><br>`;
            } else {
                window.activeDeliveries.forEach((d, i) => {
                    html += `${i + 1}. ${d.drNumber} - ${d.status}<br>`;
                });
            }
            
            html += `<br><strong>Delivery History:</strong><br>`;
            if (window.deliveryHistory.length === 0) {
                html += `<em>None</em><br>`;
            } else {
                window.deliveryHistory.forEach((d, i) => {
                    html += `${i + 1}. ${d.drNumber} - ${d.status}<br>`;
                });
            }
            
            // Check E-POD records
            try {
                const epodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                html += `<br><strong>E-POD Records:</strong><br>`;
                if (epodRecords.length === 0) {
                    html += `<em>None</em><br>`;
                } else {
                    epodRecords.forEach((r, i) => {
                        html += `${i + 1}. ${r.drNumber} - Signed<br>`;
                    });
                }
            } catch (error) {
                html += `<br><strong>E-POD Records:</strong> Error loading<br>`;
            }
            
            stateDiv.innerHTML = html;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Debug investigation page loaded', 'info');
            updateCurrentState();
            checkAllStorageLocations();
        });
    </script>
</body>
</html>