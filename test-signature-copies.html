<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Signature Copies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Test Signature Copies</h1>
        <p class="lead">This page tests the signature copy functionality for Delivery History and EPOD Records</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Controls</h5>
                    </div>
                    <div class="card-body">
                        <button id="simulateSignature" class="btn btn-primary mb-2">Simulate E-Signature Process</button>
                        <button id="viewAllData" class="btn btn-secondary mb-2">View All Data</button>
                        <button id="clearAllData" class="btn btn-danger mb-2">Clear All Data</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="status" class="alert alert-secondary">
                            Ready to test signature copies
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Active Deliveries</h5>
                    </div>
                    <div class="card-body">
                        <pre id="activeDeliveriesDisplay" class="bg-light p-2" style="max-height: 200px; overflow-y: auto; font-size: 0.8em;">
No data
                        </pre>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Delivery History</h5>
                    </div>
                    <div class="card-body">
                        <pre id="deliveryHistoryDisplay" class="bg-light p-2" style="max-height: 200px; overflow-y: auto; font-size: 0.8em;">
No data
                        </pre>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>EPOD Records</h5>
                    </div>
                    <div class="card-body">
                        <pre id="epodRecordsDisplay" class="bg-light p-2" style="max-height: 200px; overflow-y: auto; font-size: 0.8em;">
No data
                        </pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update status display
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.className = `alert alert-${type}`;
            statusElement.textContent = message;
        }
        
        // Update all data displays
        function updateAllDataDisplays() {
            try {
                // Update Active Deliveries display
                const activeDeliveries = JSON.parse(localStorage.getItem('mci-activeDeliveries') || '[]');
                document.getElementById('activeDeliveriesDisplay').textContent = JSON.stringify(activeDeliveries, null, 2);
                
                // Update Delivery History display
                const deliveryHistory = JSON.parse(localStorage.getItem('mci-deliveryHistory') || '[]');
                document.getElementById('deliveryHistoryDisplay').textContent = JSON.stringify(deliveryHistory, null, 2);
                
                // Update EPOD Records display
                const ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                document.getElementById('epodRecordsDisplay').textContent = JSON.stringify(ePodRecords, null, 2);
            } catch (error) {
                updateStatus('Error updating data displays: ' + error.message, 'danger');
            }
        }
        
        // Simulate E-Signature process
        function simulateSignature() {
            updateStatus('Simulating E-Signature process...', 'info');
            
            // Simple signature data (1x1 transparent PNG)
            const signatureData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
            
            // Create a test active delivery
            const testDelivery = {
                id: 'DEL-' + Date.now(),
                drNumber: 'DR-TEST-' + Date.now(),
                customerName: 'Test Customer',
                customerNumber: '09123456789',
                origin: 'Test Origin',
                destination: 'Test Destination',
                distance: '10.5 km',
                truck: 'Test Truck',
                status: 'In Transit',
                bookedDate: new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                })
            };
            
            try {
                // Add to active deliveries
                let activeDeliveries = JSON.parse(localStorage.getItem('mci-activeDeliveries') || '[]');
                activeDeliveries.push(testDelivery);
                localStorage.setItem('mci-activeDeliveries', JSON.stringify(activeDeliveries));
                
                // Create E-POD record
                const ePodRecord = {
                    drNumber: testDelivery.drNumber,
                    customerName: testDelivery.customerName,
                    customerContact: testDelivery.customerNumber,
                    truckPlate: testDelivery.truck,
                    origin: testDelivery.origin,
                    destination: testDelivery.destination,
                    signature: signatureData,
                    status: 'Completed',
                    signedAt: new Date().toISOString(),
                    timestamp: new Date().toISOString()
                };
                
                // Save to EPOD records
                let ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                ePodRecords.push(ePodRecord);
                localStorage.setItem('ePodRecords', JSON.stringify(ePodRecords));
                
                // Create a clean copy for delivery history (without signature)
                const deliveryHistoryCopy = { ...testDelivery };
                deliveryHistoryCopy.status = 'Completed';
                deliveryHistoryCopy.completedDate = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Add to delivery history
                let deliveryHistory = JSON.parse(localStorage.getItem('mci-deliveryHistory') || '[]');
                deliveryHistory.unshift(deliveryHistoryCopy);
                localStorage.setItem('mci-deliveryHistory', JSON.stringify(deliveryHistory));
                
                // Remove from active deliveries
                const deliveryIndex = activeDeliveries.findIndex(d => d.drNumber === testDelivery.drNumber);
                if (deliveryIndex !== -1) {
                    activeDeliveries.splice(deliveryIndex, 1);
                    localStorage.setItem('mci-activeDeliveries', JSON.stringify(activeDeliveries));
                }
                
                updateStatus(`E-Signature process simulated successfully for ${testDelivery.drNumber}`, 'success');
                updateAllDataDisplays();
            } catch (error) {
                updateStatus('Error simulating E-Signature process: ' + error.message, 'danger');
            }
        }
        
        // View all data
        function viewAllData() {
            updateStatus('Viewing all data...', 'info');
            updateAllDataDisplays();
            updateStatus('All data displayed', 'success');
        }
        
        // Clear all data
        function clearAllData() {
            updateStatus('Clearing all data...', 'info');
            
            try {
                localStorage.removeItem('mci-activeDeliveries');
                localStorage.removeItem('mci-deliveryHistory');
                localStorage.removeItem('ePodRecords');
                
                updateStatus('All data cleared successfully', 'success');
                updateAllDataDisplays();
            } catch (error) {
                updateStatus('Error clearing data: ' + error.message, 'danger');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('simulateSignature').addEventListener('click', simulateSignature);
            document.getElementById('viewAllData').addEventListener('click', viewAllData);
            document.getElementById('clearAllData').addEventListener('click', clearAllData);
            
            // Initial display update
            updateAllDataDisplays();
        });
    </script>
</body>
</html>