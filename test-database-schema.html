<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Schema Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Database Schema Test</h2>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Schema Check Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="schemaResults">
                            <p>Testing database connection...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Additional Cost Items</h5>
                    </div>
                    <div class="card-body">
                        <button id="testCostItems" class="btn btn-primary">Test Cost Items Table</button>
                        <div id="costItemsResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ntyvrezyhrmflswxefbk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50eXZyZXp5aHJtZmxzd3hlZmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjUzNTgsImV4cCI6MjA3MDY0MTM1OH0.JX0YP42_40lKQ1ghUmIA_Lu0YVZB_Ytl0EdQinU0Nm4';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function checkDatabaseSchema() {
            const resultsDiv = document.getElementById('schemaResults');
            resultsDiv.innerHTML = '<p>Checking database schema...</p>';

            try {
                // Test connection
                const { data: connectionTest, error: connectionError } = await supabase
                    .from('deliveries')
                    .select('count', { count: 'exact', head: true });

                if (connectionError) {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Connection Error: ${connectionError.message}</div>`;
                    return;
                }

                // Check if additional_cost_items table exists
                const { data: costItemsTest, error: costItemsError } = await supabase
                    .from('additional_cost_items')
                    .select('count', { count: 'exact', head: true });

                let results = '<div class="alert alert-success">✅ Database connection successful</div>';
                results += `<p><strong>Deliveries table:</strong> ${connectionTest ? 'Exists' : 'Missing'}</p>`;
                
                if (costItemsError) {
                    results += `<div class="alert alert-warning">⚠️ additional_cost_items table: ${costItemsError.message}</div>`;
                } else {
                    results += '<div class="alert alert-success">✅ additional_cost_items table exists</div>';
                }

                // Check deliveries table structure
                const { data: deliveriesData, error: deliveriesError } = await supabase
                    .from('deliveries')
                    .select('*')
                    .limit(1);

                if (deliveriesData && deliveriesData.length > 0) {
                    const columns = Object.keys(deliveriesData[0]);
                    results += '<h6>Deliveries Table Columns:</h6>';
                    results += '<ul>';
                    columns.forEach(col => {
                        results += `<li>${col}</li>`;
                    });
                    results += '</ul>';
                }

                resultsDiv.innerHTML = results;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function testCostItemsTable() {
            const resultsDiv = document.getElementById('costItemsResults');
            resultsDiv.innerHTML = '<p>Testing cost items table...</p>';

            try {
                // Try to insert a test cost item
                const { data: deliveries, error: deliveriesError } = await supabase
                    .from('deliveries')
                    .select('id')
                    .limit(1);

                if (deliveriesError || !deliveries || deliveries.length === 0) {
                    resultsDiv.innerHTML = '<div class="alert alert-warning">No deliveries found to test with</div>';
                    return;
                }

                const deliveryId = deliveries[0].id;

                // Try to insert a test cost item
                const { data: insertData, error: insertError } = await supabase
                    .from('additional_cost_items')
                    .insert({
                        delivery_id: deliveryId,
                        description: 'Test Cost Item',
                        amount: 50.00,
                        category: 'Test'
                    })
                    .select();

                if (insertError) {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Insert Error: ${insertError.message}</div>`;
                    return;
                }

                // Clean up test data
                if (insertData && insertData.length > 0) {
                    await supabase
                        .from('additional_cost_items')
                        .delete()
                        .eq('id', insertData[0].id);
                }

                resultsDiv.innerHTML = '<div class="alert alert-success">✅ Cost items table is working correctly!</div>';

            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkDatabaseSchema();
            
            document.getElementById('testCostItems').addEventListener('click', testCostItemsTable);
        });
    </script>
</body>
</html>