<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Modal Coordinates Fix Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .log-container {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .map-pin-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .map-pin-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
        .coordinates-display {
            font-family: monospace;
            font-size: 0.9em;
            color: #6c757d;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üß™ Booking Modal Coordinates Fix Test</h1>
        <p>Testing origin coordinates display and Pin on Map functionality</p>

        <!-- Test Controls -->
        <div class="test-section">
            <h3>Test Controls</h3>
            <button class="btn btn-primary me-2" onclick="testOriginCoordinates()">Test Origin Coordinates</button>
            <button class="btn btn-success me-2" onclick="testPinOnMapButtons()">Test Pin on Map</button>
            <button class="btn btn-info me-2" onclick="openBookingModal()">Open Booking Modal</button>
            <button class="btn btn-warning" onclick="clearLog()">Clear Log</button>
        </div>

        <!-- Log Container -->
        <div class="log-container" id="logContainer">
            <div>üöÄ Test initialized. Click buttons above to run tests.</div>
        </div>

        <!-- Mock Booking Modal -->
        <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üìÖ New Delivery Booking</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Origin Section -->
                        <div class="form-section mb-4">
                            <h5><i class="bi bi-geo-alt-fill"></i> Origin Details</h5>
                            <div class="mb-3">
                                <label class="form-label">Origin Warehouse</label>
                                <div class="input-group">
                                    <select class="form-select" id="originSelect">
                                        <option value="" selected>Select warehouse</option>
                                        <option value="alabang">SMEG Alabang warehouse</option>
                                        <option value="cebu">SMEG Cebu warehouse</option>
                                    </select>
                                    <button type="button" class="btn map-pin-btn" id="pinOrigin">
                                        <i class="bi bi-geo-alt"></i> Pin on Map
                                    </button>
                                </div>
                                <div class="form-text">
                                    Select from warehouse list or pin location on map
                                    <div id="originCoordinatesDisplay" class="coordinates-display mt-2" style="min-height: 30px;">
                                        <small class="text-muted">Coordinates will appear here</small>
                                    </div>
                                </div>

                                <!-- Custom Origin Container -->
                                <div id="customOriginContainer" class="d-none mt-3">
                                    <label class="form-label">Custom Origin Location</label>
                                    <input type="text" class="form-control" id="customOrigin" placeholder="Selected location will appear here" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Destination Section -->
                        <div class="form-section mb-4">
                            <h5><i class="bi bi-map"></i> Destination Areas</h5>
                            <div class="mb-3">
                                <label class="form-label">Destination Areas</label>
                                <div id="destinationAreasContainer">
                                    <div class="destination-area-item">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control destination-area-input" 
                                                   placeholder="Click to select location on map" required readonly style="cursor: pointer;">
                                            <button type="button" class="btn map-pin-btn pin-on-map-btn" data-area-index="0">
                                                <i class="bi bi-geo-alt"></i> Pin on Map
                                            </button>
                                            <button type="button" class="btn btn-outline-danger remove-area">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-secondary mt-2" id="addAreaBtn">
                                    <i class="bi bi-plus-circle me-2"></i>Add Area
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary">Confirm Booking</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                success: '#00ff88',
                error: '#ff4444',
                warning: '#ffaa00'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div>üöÄ Log cleared.</div>';
        }

        // Default warehouse coordinates
        const defaultWarehouses = {
            'alabang': { lat: 14.4378, lng: 121.0199, name: 'SMEG Alabang warehouse' },
            'cebu': { lat: 10.3157, lng: 123.8854, name: 'SMEG Cebu warehouse' }
        };

        // Global variables for map functionality
        let currentMapInstance = null;
        let selectedMarker = null;
        let selectedCoordinates = { lat: null, lng: null };

        // Test origin coordinates display
        function testOriginCoordinates() {
            log('=== TESTING ORIGIN COORDINATES DISPLAY ===');
            
            const originSelect = document.getElementById('originSelect');
            const originCoordinatesDisplay = document.getElementById('originCoordinatesDisplay');
            
            if (!originSelect || !originCoordinatesDisplay) {
                log('‚ùå Origin elements not found', 'error');
                return;
            }

            // Test Alabang selection
            log('Testing Alabang warehouse selection...');
            originSelect.value = 'alabang';
            
            // Trigger change event
            const changeEvent = new Event('change', { bubbles: true });
            originSelect.dispatchEvent(changeEvent);
            
            // Check if coordinates are displayed
            setTimeout(() => {
                const displayText = originCoordinatesDisplay.textContent;
                log(`Alabang coordinates display: "${displayText}"`);
                
                if (displayText.includes('14.4378') && displayText.includes('121.0199')) {
                    log('‚úÖ Alabang coordinates displayed correctly', 'success');
                } else {
                    log('‚ùå Alabang coordinates not displayed correctly', 'error');
                }
                
                // Test Cebu selection
                log('Testing Cebu warehouse selection...');
                originSelect.value = 'cebu';
                originSelect.dispatchEvent(changeEvent);
                
                setTimeout(() => {
                    const cebuDisplayText = originCoordinatesDisplay.textContent;
                    log(`Cebu coordinates display: "${cebuDisplayText}"`);
                    
                    if (cebuDisplayText.includes('10.3157') && cebuDisplayText.includes('123.8854')) {
                        log('‚úÖ Cebu coordinates displayed correctly', 'success');
                    } else {
                        log('‚ùå Cebu coordinates not displayed correctly', 'error');
                    }
                }, 100);
            }, 100);
        }

        // Test Pin on Map buttons
        function testPinOnMapButtons() {
            log('=== TESTING PIN ON MAP BUTTONS ===');
            
            const pinOriginBtn = document.getElementById('pinOrigin');
            const pinDestinationBtn = document.querySelector('.pin-on-map-btn');
            
            if (pinOriginBtn) {
                log('‚úÖ Origin pin button found');
                log('Testing origin pin button click...');
                
                // Test click
                pinOriginBtn.click();
                
                // Check if map modal appears
                setTimeout(() => {
                    const mapModal = document.getElementById('mapModal');
                    if (mapModal && mapModal.classList.contains('show')) {
                        log('‚úÖ Map modal opened for origin', 'success');
                    } else {
                        log('‚ùå Map modal did not open for origin', 'error');
                    }
                }, 500);
            } else {
                log('‚ùå Origin pin button not found', 'error');
            }
            
            if (pinDestinationBtn) {
                log('‚úÖ Destination pin button found');
                
                setTimeout(() => {
                    log('Testing destination pin button click...');
                    pinDestinationBtn.click();
                    
                    setTimeout(() => {
                        const mapModal = document.getElementById('mapModal');
                        if (mapModal && mapModal.classList.contains('show')) {
                            log('‚úÖ Map modal opened for destination', 'success');
                        } else {
                            log('‚ùå Map modal did not open for destination', 'error');
                        }
                    }, 500);
                }, 1000);
            } else {
                log('‚ùå Destination pin button not found', 'error');
            }
        }

        // Open booking modal
        function openBookingModal() {
            log('üóÇÔ∏è Opening booking modal...');
            const bookingModal = document.getElementById('bookingModal');
            if (bookingModal) {
                const modal = new bootstrap.Modal(bookingModal);
                modal.show();
                log('‚úÖ Booking modal opened', 'success');
                
                // Initialize functionality after modal is shown
                setTimeout(() => {
                    initializeBookingModal();
                }, 300);
            } else {
                log('‚ùå Booking modal not found', 'error');
            }
        }

        // Initialize booking modal functionality
        function initializeBookingModal() {
            log('üîß Initializing booking modal functionality...');
            
            // Set up origin select change listener
            const originSelect = document.getElementById('originSelect');
            if (originSelect) {
                // Remove existing listeners
                const newOriginSelect = originSelect.cloneNode(true);
                originSelect.parentNode.replaceChild(newOriginSelect, originSelect);
                
                newOriginSelect.addEventListener('change', function() {
                    log(`Origin warehouse changed to: ${this.value}`);
                    
                    const originCoordinatesDisplay = document.getElementById('originCoordinatesDisplay');
                    const customOriginContainer = document.getElementById('customOriginContainer');
                    
                    if (this.value === '') {
                        // Custom location selected
                        if (customOriginContainer) {
                            customOriginContainer.classList.remove('d-none');
                        }
                        if (originCoordinatesDisplay) {
                            originCoordinatesDisplay.innerHTML = '<small class="text-muted">Select location on map</small>';
                        }
                        log('Custom origin location mode activated');
                    } else {
                        // Warehouse selected
                        if (customOriginContainer) {
                            customOriginContainer.classList.add('d-none');
                        }
                        
                        const warehouse = defaultWarehouses[this.value];
                        if (warehouse && originCoordinatesDisplay) {
                            const coordText = `üìç ${warehouse.name}<br><span style="font-family: monospace;">(${warehouse.lat.toFixed(6)}, ${warehouse.lng.toFixed(6)})</span>`;
                            originCoordinatesDisplay.innerHTML = coordText;
                            log(`‚úÖ Displayed coordinates for ${warehouse.name}: (${warehouse.lat}, ${warehouse.lng})`, 'success');
                        } else {
                            if (originCoordinatesDisplay) {
                                originCoordinatesDisplay.innerHTML = '<small class="text-muted text-danger">Coordinates not found</small>';
                            }
                            log(`‚ùå No coordinates found for warehouse: ${this.value}`, 'error');
                        }
                    }
                });
                
                log('‚úÖ Origin select listener attached');
            }
            
            // Set up Pin on Map buttons
            const pinOriginBtn = document.getElementById('pinOrigin');
            if (pinOriginBtn) {
                const newPinOriginBtn = pinOriginBtn.cloneNode(true);
                pinOriginBtn.parentNode.replaceChild(newPinOriginBtn, pinOriginBtn);
                
                newPinOriginBtn.addEventListener('click', function() {
                    log('üó∫Ô∏è Origin Pin on Map button clicked');
                    showMapPinDialog('origin', 0);
                });
                
                log('‚úÖ Origin pin button listener attached');
            }
            
            // Set up destination pin buttons
            document.querySelectorAll('.pin-on-map-btn').forEach((btn, index) => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function() {
                    const areaIndex = parseInt(this.dataset.areaIndex) || index;
                    log(`üó∫Ô∏è Destination Pin on Map button clicked for area ${areaIndex}`);
                    showMapPinDialog('destination', areaIndex);
                });
            });
            
            log('‚úÖ Destination pin button listeners attached');
            
            // Set up destination input click handlers
            document.querySelectorAll('.destination-area-input').forEach((input, index) => {
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                newInput.addEventListener('click', function() {
                    log(`üó∫Ô∏è Destination input ${index} clicked`);
                    showMapPinDialog('destination', index);
                });
                
                newInput.addEventListener('focus', function() {
                    log(`üó∫Ô∏è Destination input ${index} focused`);
                    showMapPinDialog('destination', index);
                });
            });
            
            log('‚úÖ Destination input listeners attached');
            log('üéâ Booking modal initialization complete');
        }

        // Show map pin dialog
        function showMapPinDialog(type, index = 0) {
            log(`üó∫Ô∏è showMapPinDialog called: type=${type}, index=${index}`, 'success');
            
            // Create or get map modal
            let mapModal = document.getElementById('mapModal');
            if (!mapModal) {
                log('Creating new map modal...');
                mapModal = document.createElement('div');
                mapModal.id = 'mapModal';
                mapModal.className = 'modal fade';
                mapModal.tabIndex = -1;
                mapModal.setAttribute('aria-hidden', 'true');
                mapModal.innerHTML = `
                    <div class="modal-dialog modal-xl modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    <span id="mapModalTitle">Select Location on Map</span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Search Location</label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                <input type="text" class="form-control" id="mapSearchInput" placeholder="Search for a place...">
                                                <button class="btn btn-outline-secondary" type="button" id="mapSearchBtn">
                                                    <i class="bi bi-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Selected Coordinates</label>
                                            <div class="coordinates-display p-2 bg-light rounded">
                                                <div><small class="text-muted">Latitude:</small> <span id="selectedLat" class="fw-bold">--</span></div>
                                                <div><small class="text-muted">Longitude:</small> <span id="selectedLng" class="fw-bold">--</span></div>
                                            </div>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary" id="confirmLocationBtn" disabled>
                                                <i class="bi bi-check-circle me-2"></i>Confirm Location
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="mapContainer" style="height: 400px; border-radius: 8px; border: 1px solid #ddd;">
                                            <div class="d-flex justify-content-center align-items-center h-100">
                                                <div class="text-center">
                                                    <div class="spinner-border text-primary"></div>
                                                    <p class="mt-2">Loading map...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(mapModal);
                log('‚úÖ Map modal created');
            }

            // Set modal title
            const modalTitle = document.getElementById('mapModalTitle');
            if (modalTitle) {
                modalTitle.textContent = type === 'origin' ? 'Select Origin Location' : `Select Destination Location #${index + 1}`;
            }

            // Show the modal
            const modal = new bootstrap.Modal(mapModal);
            modal.show();
            log('‚úÖ Map modal shown');

            // Initialize map after modal is shown
            mapModal.addEventListener('shown.bs.modal', function() {
                log('Map modal shown event fired, initializing map...');
                initializeMapModal(type, index);
            }, { once: true });
        }

        // Initialize map modal
        function initializeMapModal(type, index) {
            log(`üó∫Ô∏è Initializing map for ${type}, index: ${index}`);
            
            const mapContainer = document.getElementById('mapContainer');
            if (!mapContainer) {
                log('‚ùå Map container not found', 'error');
                return;
            }

            // Clear loading indicator
            mapContainer.innerHTML = '';

            try {
                // Initialize Leaflet map
                currentMapInstance = L.map('mapContainer').setView([14.6091, 121.0223], 10);
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(currentMapInstance);

                log('‚úÖ Map initialized successfully', 'success');

                // Add click event
                currentMapInstance.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    
                    log(`üìç Map clicked at: (${lat.toFixed(6)}, ${lng.toFixed(6)})`);
                    
                    // Update coordinates display
                    document.getElementById('selectedLat').textContent = lat.toFixed(6);
                    document.getElementById('selectedLng').textContent = lng.toFixed(6);
                    
                    // Remove existing marker
                    if (selectedMarker) {
                        currentMapInstance.removeLayer(selectedMarker);
                    }
                    
                    // Add new marker
                    selectedMarker = L.marker([lat, lng]).addTo(currentMapInstance);
                    selectedCoordinates = { lat, lng };
                    
                    // Enable confirm button
                    document.getElementById('confirmLocationBtn').disabled = false;
                    
                    log('‚úÖ Location selected and marker placed', 'success');
                });

                // Set up confirm button
                const confirmBtn = document.getElementById('confirmLocationBtn');
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', function() {
                        log(`‚úÖ Location confirmed for ${type} #${index}: (${selectedCoordinates.lat}, ${selectedCoordinates.lng})`, 'success');
                        
                        // Close modal
                        const mapModal = document.getElementById('mapModal');
                        const modal = bootstrap.Modal.getInstance(mapModal);
                        if (modal) {
                            modal.hide();
                        }
                        
                        // Update the appropriate field
                        if (type === 'origin') {
                            const customOriginContainer = document.getElementById('customOriginContainer');
                            const customOriginInput = document.getElementById('customOrigin');
                            const originSelect = document.getElementById('originSelect');
                            const originCoordinatesDisplay = document.getElementById('originCoordinatesDisplay');
                            
                            if (customOriginContainer) customOriginContainer.classList.remove('d-none');
                            if (originSelect) originSelect.value = '';
                            if (customOriginInput) customOriginInput.value = `Custom Location (${selectedCoordinates.lat.toFixed(6)}, ${selectedCoordinates.lng.toFixed(6)})`;
                            if (originCoordinatesDisplay) {
                                originCoordinatesDisplay.innerHTML = `üìç Custom Location<br><span style="font-family: monospace;">(${selectedCoordinates.lat.toFixed(6)}, ${selectedCoordinates.lng.toFixed(6)})</span>`;
                            }
                        } else {
                            // Update destination input
                            const destinationInputs = document.querySelectorAll('.destination-area-input');
                            if (destinationInputs[index]) {
                                destinationInputs[index].value = `Selected Location (${selectedCoordinates.lat.toFixed(6)}, ${selectedCoordinates.lng.toFixed(6)})`;
                            }
                        }
                    });
                }

            } catch (error) {
                log(`‚ùå Error initializing map: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Page loaded, ready for testing');
        });
    </script>
</body>
</html>