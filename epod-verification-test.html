<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPOD Verification Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h1>EPOD Verification Test</h1>
        <p class="lead">This page tests the complete EPOD workflow to ensure signed DR items are saved and displayed correctly.</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Controls</h5>
                    </div>
                    <div class="card-body">
                        <button id="createTestDelivery" class="btn btn-primary mb-2">1. Create Test Delivery</button>
                        <button id="simulateSignature" class="btn btn-success mb-2">2. Simulate E-Signature</button>
                        <button id="checkLocalStorage" class="btn btn-info mb-2">3. Check LocalStorage</button>
                        <button id="clearAllRecords" class="btn btn-danger mb-2">4. Clear All Records</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="testStatus" class="alert alert-secondary">
                            Ready to run tests
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>LocalStorage EPOD Records</h5>
            </div>
            <div class="card-body">
                <pre id="epodRecords" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">
No records yet
                </pre>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>EPOD View Preview</h5>
            </div>
            <div class="card-body">
                <div id="epodViewPreview" class="row">
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
                        <p class="mt-3">No signed deliveries found</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test delivery data
        const testDelivery = {
            id: Date.now(),
            drNumber: 'DR-TEST-' + Date.now(),
            customerName: 'Test Customer',
            customerContact: '09123456789',
            origin: 'Test Origin',
            destination: 'Test Destination',
            distance: '50 km',
            truck: 'TEST123',
            status: 'In Transit',
            bookedDate: new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            })
        };
        
        // Simple signature data (1x1 transparent PNG)
        const signatureData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
        
        // Update test status display
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('testStatus');
            statusElement.className = `alert alert-${type}`;
            statusElement.textContent = message;
        }
        
        // Update localStorage records display
        function updateLocalStorageDisplay() {
            try {
                const ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                document.getElementById('epodRecords').textContent = JSON.stringify(ePodRecords, null, 2);
                
                // Update EPOD view preview
                updateEPodViewPreview(ePodRecords);
            } catch (error) {
                document.getElementById('epodRecords').textContent = 'Error reading localStorage: ' + error.message;
            }
        }
        
        // Update EPOD view preview
        function updateEPodViewPreview(records) {
            const container = document.getElementById('epodViewPreview');
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
                        <p class="mt-3">No signed deliveries found</p>
                    </div>
                `;
                return;
            }
            
            // Sort by signed date (newest first)
            const sortedRecords = [...records].sort((a, b) => new Date(b.signedAt) - new Date(a.signedAt));
            
            // Clear container
            container.innerHTML = '';
            
            // Add cards for each signed delivery
            sortedRecords.forEach((record, index) => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 mb-4';
                card.innerHTML = `
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${record.drNumber}</h6>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <small class="text-muted">Customer</small>
                                <p class="mb-1">${record.customerName}</p>
                                <small class="text-muted">Contact</small>
                                <p class="mb-1">${record.customerContact}</p>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Route</small>
                                <p class="mb-1">${record.origin} to ${record.destination}</p>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Truck</small>
                                <p class="mb-1">${record.truckPlate}</p>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Signed Date</small>
                                <p class="mb-1">${new Date(record.signedAt).toLocaleDateString()}</p>
                            </div>
                            <div class="text-center">
                                <img src="${record.signature}" alt="Signature" class="img-fluid border" style="max-height: 100px; object-fit: contain;">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Create test delivery
        function createTestDelivery() {
            updateStatus('Creating test delivery...', 'info');
            
            // Save to localStorage (simulating booking)
            let deliveries = JSON.parse(localStorage.getItem('mci-activeDeliveries') || '[]');
            deliveries.push(testDelivery);
            localStorage.setItem('mci-activeDeliveries', JSON.stringify(deliveries));
            
            updateStatus(`Test delivery created: ${testDelivery.drNumber}`, 'success');
            console.log('Test delivery created:', testDelivery);
        }
        
        // Simulate E-Signature process
        function simulateSignature() {
            updateStatus('Simulating E-Signature process...', 'info');
            
            // Create EPOD record (simulating what happens in saveSingleSignature)
            const ePodRecord = {
                drNumber: testDelivery.drNumber,
                customerName: testDelivery.customerName,
                customerContact: testDelivery.customerContact,
                truckPlate: testDelivery.truck,
                origin: testDelivery.origin,
                destination: testDelivery.destination,
                signature: signatureData,
                status: 'Completed',
                signedAt: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage (simulating the save process)
            try {
                let ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                
                // Check if record already exists
                const existingIndex = ePodRecords.findIndex(r => r.drNumber === ePodRecord.drNumber);
                if (existingIndex >= 0) {
                    ePodRecords[existingIndex] = ePodRecord;
                } else {
                    ePodRecords.push(ePodRecord);
                }
                
                localStorage.setItem('ePodRecords', JSON.stringify(ePodRecords));
                
                updateStatus(`E-Signature simulated and EPOD record saved: ${ePodRecord.drNumber}`, 'success');
                console.log('EPOD record saved:', ePodRecord);
                
                // Update display
                updateLocalStorageDisplay();
            } catch (error) {
                updateStatus('Error saving EPOD record: ' + error.message, 'danger');
                console.error('Error saving EPOD record:', error);
            }
        }
        
        // Check localStorage
        function checkLocalStorage() {
            updateStatus('Checking LocalStorage...', 'info');
            
            try {
                // Check active deliveries
                const deliveries = JSON.parse(localStorage.getItem('mci-activeDeliveries') || '[]');
                
                // Check EPOD records
                const ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                
                updateStatus(`LocalStorage check complete: ${deliveries.length} active deliveries, ${ePodRecords.length} EPOD records`, 'success');
                console.log('LocalStorage contents:', { deliveries, ePodRecords });
                
                // Update display
                updateLocalStorageDisplay();
            } catch (error) {
                updateStatus('Error checking LocalStorage: ' + error.message, 'danger');
                console.error('Error checking LocalStorage:', error);
            }
        }
        
        // Clear all records
        function clearAllRecords() {
            updateStatus('Clearing all records...', 'info');
            
            try {
                localStorage.removeItem('mci-activeDeliveries');
                localStorage.removeItem('ePodRecords');
                
                updateStatus('All records cleared from LocalStorage', 'success');
                console.log('All records cleared');
                
                // Update display
                updateLocalStorageDisplay();
            } catch (error) {
                updateStatus('Error clearing records: ' + error.message, 'danger');
                console.error('Error clearing records:', error);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('createTestDelivery').addEventListener('click', createTestDelivery);
            document.getElementById('simulateSignature').addEventListener('click', simulateSignature);
            document.getElementById('checkLocalStorage').addEventListener('click', checkLocalStorage);
            document.getElementById('clearAllRecords').addEventListener('click', clearAllRecords);
            
            // Initial display update
            updateLocalStorageDisplay();
        });
    </script>
</body>
</html>