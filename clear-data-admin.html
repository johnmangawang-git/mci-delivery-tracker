<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCI Data Admin - Clear All Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .danger-zone {
            border: 2px solid #dc3545;
            border-radius: 8px;
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h1 class="text-center mb-4">üóëÔ∏è MCI Data Admin</h1>
                
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Warning:</strong> This page allows you to permanently delete delivery data. Use with caution!
                </div>
                
                <div class="danger-zone p-4 mb-4">
                    <h3 class="text-danger">üö® Danger Zone</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-warning">
                                    <h5>Clear Local Storage Only</h5>
                                </div>
                                <div class="card-body">
                                    <p>Clears data from browser storage only. Supabase data remains intact.</p>
                                    <button id="clearLocalStorage" class="btn btn-warning">Clear Local Storage</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-danger text-white">
                                    <h5>Clear ALL Data</h5>
                                </div>
                                <div class="card-body">
                                    <p>Permanently deletes ALL delivery data from both local storage AND Supabase database.</p>
                                    <button id="clearAllData" class="btn btn-danger">Clear ALL Data</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <h5>Clear Active Deliveries Only</h5>
                                </div>
                                <div class="card-body">
                                    <p>Clears only active deliveries, keeps delivery history.</p>
                                    <button id="clearActiveOnly" class="btn btn-info">Clear Active Only</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-secondary text-white">
                                    <h5>View Current Data</h5>
                                </div>
                                <div class="card-body">
                                    <p>Check what data currently exists before clearing.</p>
                                    <button id="viewData" class="btn btn-secondary">View Data</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Operation Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="operationLog" style="background: #f8f9fa; padding: 15px; font-family: monospace; height: 300px; overflow-y: auto; border: 1px solid #dee2e6;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>

    <script>
        // Setup logging
        const operationLog = document.getElementById('operationLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : type === 'warning' ? 'text-warning' : 'text-info';
            operationLog.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            operationLog.scrollTop = operationLog.scrollHeight;
            console.log(message);
        }

        // Clear local storage only
        document.getElementById('clearLocalStorage').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear local storage data?')) {
                try {
                    localStorage.removeItem('mci-active-deliveries');
                    localStorage.removeItem('mci-delivery-history');
                    
                    // Clear global arrays if they exist
                    if (window.activeDeliveries) window.activeDeliveries = [];
                    if (window.deliveryHistory) window.deliveryHistory = [];
                    
                    log('‚úÖ Local storage cleared successfully', 'success');
                    alert('Local storage cleared successfully!');
                } catch (error) {
                    log('‚ùå Error clearing local storage: ' + error.message, 'error');
                }
            }
        });

        // Clear active deliveries only
        document.getElementById('clearActiveOnly').addEventListener('click', async function() {
            if (confirm('Are you sure you want to clear ONLY active deliveries? (History will be preserved)')) {
                try {
                    // Clear local storage active deliveries
                    localStorage.removeItem('mci-active-deliveries');
                    if (window.activeDeliveries) window.activeDeliveries = [];
                    
                    // Clear from Supabase
                    if (window.supabaseClient) {
                        const client = window.supabaseClient();
                        const { error } = await client
                            .from('deliveries')
                            .delete()
                            .neq('status', 'Completed'); // Delete all except completed
                        
                        if (error) throw error;
                        log('‚úÖ Active deliveries cleared from Supabase', 'success');
                    }
                    
                    log('‚úÖ Active deliveries cleared successfully', 'success');
                    alert('Active deliveries cleared successfully!');
                } catch (error) {
                    log('‚ùå Error clearing active deliveries: ' + error.message, 'error');
                }
            }
        });

        // Clear ALL data
        document.getElementById('clearAllData').addEventListener('click', async function() {
            const confirmation = prompt('This will permanently delete ALL delivery data. Type "DELETE ALL" to confirm:');
            if (confirmation === 'DELETE ALL') {
                try {
                    // Clear local storage
                    localStorage.removeItem('mci-active-deliveries');
                    localStorage.removeItem('mci-delivery-history');
                    
                    // Clear global arrays
                    if (window.activeDeliveries) window.activeDeliveries = [];
                    if (window.deliveryHistory) window.deliveryHistory = [];
                    
                    // Clear from Supabase
                    if (window.supabaseClient) {
                        const client = window.supabaseClient();
                        const { error } = await client
                            .from('deliveries')
                            .delete()
                            .gte('id', 0); // Delete all records
                        
                        if (error) throw error;
                        log('‚úÖ All data cleared from Supabase database', 'success');
                    }
                    
                    log('‚úÖ ALL DATA CLEARED SUCCESSFULLY', 'success');
                    alert('All data has been permanently deleted!');
                } catch (error) {
                    log('‚ùå Error clearing all data: ' + error.message, 'error');
                }
            } else {
                log('‚ùå Operation cancelled - incorrect confirmation', 'warning');
            }
        });

        // View current data
        document.getElementById('viewData').addEventListener('click', async function() {
            try {
                log('üìä Checking current data...', 'info');
                
                // Check local storage
                const localActive = JSON.parse(localStorage.getItem('mci-active-deliveries') || '[]');
                const localHistory = JSON.parse(localStorage.getItem('mci-delivery-history') || '[]');
                
                log(`üì± Local Storage: ${localActive.length} active, ${localHistory.length} history`, 'info');
                
                // Check Supabase
                if (window.supabaseClient) {
                    const client = window.supabaseClient();
                    const { data: allDeliveries, error } = await client
                        .from('deliveries')
                        .select('*');
                    
                    if (error) throw error;
                    
                    const supabaseActive = allDeliveries.filter(d => d.status !== 'Completed');
                    const supabaseHistory = allDeliveries.filter(d => d.status === 'Completed');
                    
                    log(`üóÑÔ∏è Supabase: ${supabaseActive.length} active, ${supabaseHistory.length} history`, 'info');
                    log(`üìã Total records in database: ${allDeliveries.length}`, 'info');
                } else {
                    log('‚ö†Ô∏è Supabase client not available', 'warning');
                }
                
            } catch (error) {
                log('‚ùå Error viewing data: ' + error.message, 'error');
            }
        });

        log('üöÄ Data Admin tool loaded successfully', 'success');
        log('‚ö†Ô∏è Use these tools carefully - data deletion is permanent!', 'warning');
    </script>
</body>
</html>