<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Customer Cross-Browser Functionality</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .highlight { background-color: #fff3cd; }
        .customer-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .customer-form input, .customer-form select { padding: 5px; }
        .full-width { grid-column: 1 / -1; }
    </style>
</head>
<body>
    <h1>üë• Customer Cross-Browser Test</h1>
    
    <div class="test-section info">
        <h3>Test Purpose</h3>
        <p>This page tests customer data consistency across different browsers and verifies Supabase integration.</p>
        <div id="browserInfo"></div>
        <div id="fixStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üß™ Test Controls</h3>
        <button onclick="testFieldNormalization()">Test Field Normalization</button>
        <button onclick="testCustomerSave()">Test Customer Save</button>
        <button onclick="testAutoCreateCustomer()">Test Auto-Create Customer</button>
        <button onclick="testCrossBrowserSync()">Test Cross-Browser Sync</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h3>üë§ Create Test Customer</h3>
        <div class="customer-form">
            <input type="text" id="testCustomerName" placeholder="Customer Name" value="Test Customer">
            <input type="text" id="testCustomerPhone" placeholder="Phone Number" value="+63 917 123 4567">
            <input type="email" id="testCustomerEmail" placeholder="Email" value="test@example.com">
            <input type="text" id="testCustomerAddress" placeholder="Address" value="123 Test Street, Test City">
            <select id="testAccountType">
                <option value="Individual">Individual</option>
                <option value="Corporate">Corporate</option>
            </select>
            <select id="testStatus">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
            <input type="text" id="testNotes" placeholder="Notes" value="Test customer for cross-browser testing" class="full-width">
            <button onclick="createTestCustomer()" class="full-width">Create Test Customer</button>
        </div>
    </div>
    
    <div class="test-section">
        <h3>üìä Current Customer Data</h3>
        <button onclick="showCurrentCustomers()">Show Current Customers</button>
        <button onclick="clearCustomerData()">Clear Customer Data</button>
        <div id="customerDataDisplay"></div>
    </div>
    
    <div class="test-section">
        <h3>üìù Test Log</h3>
        <div id="testLog" class="log"></div>
    </div>

    <!-- Load required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/customer-field-mapping-fix.js"></script>
    
    <script>
        // Test logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<span style="color: ${colorMap[type] || '#333'}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        // Initialize test environment
        function initTestEnvironment() {
            log('üîß Initializing customer cross-browser test environment...', 'info');
            
            // Display browser information
            const browserInfo = document.getElementById('browserInfo');
            browserInfo.innerHTML = `
                <strong>Browser:</strong> ${navigator.userAgent}<br>
                <strong>Local Storage Available:</strong> ${typeof(Storage) !== "undefined" ? '‚úÖ Yes' : '‚ùå No'}<br>
                <strong>Current Time:</strong> ${new Date().toLocaleString()}
            `;
            
            // Check if customer field mapping fix is loaded
            const fixStatus = document.getElementById('fixStatus');
            if (typeof window.customerFieldMappingFix !== 'undefined') {
                fixStatus.innerHTML = `
                    <div class="success" style="margin-top: 10px; padding: 10px; border-radius: 5px;">
                        <strong>‚úÖ Customer Field Mapping Fix Loaded</strong><br>
                        Version: ${window.customerFieldMappingFix.version}<br>
                        Loaded at: ${window.customerFieldMappingFix.timestamp}
                    </div>
                `;
                log('‚úÖ Customer field mapping fix loaded', 'success');
            } else {
                fixStatus.innerHTML = `
                    <div class="error" style="margin-top: 10px; padding: 10px; border-radius: 5px;">
                        <strong>‚ùå Customer Field Mapping Fix NOT Loaded</strong><br>
                        Cross-browser functionality may not work properly.
                    </div>
                `;
                log('‚ùå Customer field mapping fix NOT loaded', 'error');
            }
            
            // Initialize global arrays
            if (typeof window.customers === 'undefined') {
                window.customers = [];
                log('‚úÖ Initialized window.customers array', 'success');
            }
            
            // Check if functions are available
            const requiredFunctions = [
                'normalizeCustomerFields',
                'enhancedLoadCustomers',
                'enhancedSaveCustomer',
                'enhancedAutoCreateCustomer'
            ];
            
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    log(`‚úÖ Function ${funcName} available`, 'success');
                } else {
                    log(`‚ùå Function ${funcName} NOT available`, 'error');
                }
            });
            
            // Check Supabase connection
            if (typeof window.supabaseClient === 'function') {
                const client = window.supabaseClient();
                if (client) {
                    log('‚úÖ Supabase client available', 'success');
                } else {
                    log('‚ö†Ô∏è Supabase client not initialized', 'warning');
                }
            } else {
                log('‚ùå Supabase client function not available', 'error');
            }
            
            // Check dataService
            if (typeof window.dataService !== 'undefined') {
                log('‚úÖ DataService available', 'success');
                if (typeof window.dataService.getCustomers === 'function') {
                    log('‚úÖ DataService.getCustomers available', 'success');
                }
                if (typeof window.dataService.saveCustomer === 'function') {
                    log('‚úÖ DataService.saveCustomer available', 'success');
                }
            } else {
                log('‚ùå DataService not available', 'error');
            }
        }
        
        // Test field normalization
        function testFieldNormalization() {
            log('üß™ Testing customer field normalization...', 'info');
            
            if (typeof window.normalizeCustomerFields !== 'function') {
                log('‚ùå normalizeCustomerFields function not available', 'error');
                return;
            }
            
            // Test customers with different field name formats
            const testCustomers = [
                {
                    id: 'test-1',
                    contactPerson: 'John Doe',
                    phone: '+63 917 123 4567',
                    accountType: 'Individual'
                },
                {
                    id: 'test-2',
                    name: 'Jane Smith',
                    phone: '+63 918 765 4321',
                    account_type: 'Corporate'
                },
                {
                    id: 'test-3',
                    contact_person: 'Bob Johnson',
                    vendor_number: '+63 919 555 1234',
                    bookings_count: 5
                }
            ];
            
            const results = [];
            
            testCustomers.forEach((customer, index) => {
                log(`üìù Testing customer ${index + 1}: ${JSON.stringify(customer)}`, 'info');
                
                const normalized = window.normalizeCustomerFields(customer);
                
                const result = {
                    id: normalized.id,
                    hasContactPerson: !!(normalized.contactPerson && normalized.contactPerson !== ''),
                    hasName: !!(normalized.name && normalized.name !== ''),
                    hasPhone: !!(normalized.phone && normalized.phone !== ''),
                    hasAccountType: !!(normalized.accountType && normalized.accountType !== ''),
                    hasBookingsCount: typeof normalized.bookingsCount === 'number',
                    allFieldsNormalized: true
                };
                
                result.allFieldsNormalized = result.hasContactPerson && result.hasName && 
                                           result.hasPhone && result.hasAccountType && 
                                           result.hasBookingsCount;
                
                results.push(result);
                
                log(`üìù Result: ${JSON.stringify(result)}`, result.allFieldsNormalized ? 'success' : 'warning');
            });
            
            const passedTests = results.filter(r => r.allFieldsNormalized).length;
            log(`‚úÖ Field normalization test completed: ${passedTests}/${results.length} passed`, 
                passedTests === results.length ? 'success' : 'warning');
        }
        
        // Test customer save
        async function testCustomerSave() {
            log('üß™ Testing customer save functionality...', 'info');
            
            if (typeof window.enhancedSaveCustomer !== 'function') {
                log('‚ùå enhancedSaveCustomer function not available', 'error');
                return;
            }
            
            const testCustomer = {
                id: 'TEST-SAVE-001',
                contactPerson: 'Save Test Customer',
                phone: '+63 917 999 8888',
                email: 'savetest@example.com',
                address: '123 Save Test Street',
                accountType: 'Individual',
                status: 'active',
                notes: 'Test customer for save functionality',
                bookingsCount: 0
            };
            
            try {
                log('üíæ Attempting to save test customer...', 'info');
                const savedCustomer = await window.enhancedSaveCustomer(testCustomer);
                
                if (savedCustomer) {
                    log('‚úÖ Customer save test PASSED', 'success');
                    log(`üìù Saved customer: ${savedCustomer.contactPerson || savedCustomer.name}`, 'info');
                    
                    // Verify it's in the global array
                    const foundInArray = window.customers.find(c => c.id === testCustomer.id);
                    if (foundInArray) {
                        log('‚úÖ Customer found in global array', 'success');
                    } else {
                        log('‚ö†Ô∏è Customer not found in global array', 'warning');
                    }
                    
                    // Verify it's in localStorage
                    try {
                        const localStorageData = localStorage.getItem('mci-customers');
                        if (localStorageData) {
                            const customers = JSON.parse(localStorageData);
                            const foundInStorage = customers.find(c => c.id === testCustomer.id);
                            if (foundInStorage) {
                                log('‚úÖ Customer found in localStorage', 'success');
                            } else {
                                log('‚ö†Ô∏è Customer not found in localStorage', 'warning');
                            }
                        }
                    } catch (error) {
                        log('‚ùå Error checking localStorage', 'error');
                    }
                    
                } else {
                    log('‚ùå Customer save test FAILED - no return value', 'error');
                }
            } catch (error) {
                log(`‚ùå Customer save test ERROR: ${error.message}`, 'error');
            }
        }
        
        // Test auto-create customer
        async function testAutoCreateCustomer() {
            log('üß™ Testing auto-create customer functionality...', 'info');
            
            if (typeof window.enhancedAutoCreateCustomer !== 'function') {
                log('‚ùå enhancedAutoCreateCustomer function not available', 'error');
                return;
            }
            
            const customerName = 'Auto Created Customer';
            const vendorNumber = '+63 917 777 6666';
            const destination = '456 Auto Create Avenue';
            
            try {
                log('üîÑ Attempting to auto-create customer...', 'info');
                const createdCustomer = await window.enhancedAutoCreateCustomer(customerName, vendorNumber, destination);
                
                if (createdCustomer) {
                    log('‚úÖ Auto-create customer test PASSED', 'success');
                    log(`üìù Created customer: ${createdCustomer.contactPerson || createdCustomer.name}`, 'info');
                    log(`üìä Bookings count: ${createdCustomer.bookingsCount}`, 'info');
                    
                    // Test creating the same customer again (should update, not duplicate)
                    log('üîÑ Testing duplicate prevention...', 'info');
                    const duplicateTest = await window.enhancedAutoCreateCustomer(customerName, vendorNumber, destination);
                    
                    if (duplicateTest && duplicateTest.bookingsCount > createdCustomer.bookingsCount) {
                        log('‚úÖ Duplicate prevention test PASSED - booking count increased', 'success');
                    } else {
                        log('‚ö†Ô∏è Duplicate prevention test unclear', 'warning');
                    }
                    
                } else {
                    log('‚ùå Auto-create customer test FAILED - no return value', 'error');
                }
            } catch (error) {
                log(`‚ùå Auto-create customer test ERROR: ${error.message}`, 'error');
            }
        }
        
        // Test cross-browser sync
        async function testCrossBrowserSync() {
            log('üß™ Testing cross-browser sync functionality...', 'info');
            
            // Create a unique customer for this browser session
            const browserIdentifier = navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                                    navigator.userAgent.includes('Firefox') ? 'Firefox' : 
                                    navigator.userAgent.includes('Safari') ? 'Safari' : 'Unknown';
            
            const syncTestCustomer = {
                id: `SYNC-TEST-${Date.now()}`,
                contactPerson: `${browserIdentifier} Sync Test Customer`,
                phone: `+63 917 ${Math.floor(Math.random() * 1000).toString().padStart(3, '0')} ${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`,
                email: `synctest-${browserIdentifier.toLowerCase()}@example.com`,
                address: `${browserIdentifier} Browser Test Address`,
                accountType: 'Individual',
                status: 'active',
                notes: `Created in ${browserIdentifier} for cross-browser sync testing at ${new Date().toLocaleString()}`,
                bookingsCount: 1
            };
            
            try {
                log(`üíæ Creating sync test customer in ${browserIdentifier}...`, 'info');
                
                if (typeof window.enhancedSaveCustomer === 'function') {
                    const savedCustomer = await window.enhancedSaveCustomer(syncTestCustomer);
                    
                    if (savedCustomer) {
                        log('‚úÖ Sync test customer created successfully', 'success');
                        log(`üìù Customer ID: ${savedCustomer.id}`, 'info');
                        log(`üìù Customer Name: ${savedCustomer.contactPerson || savedCustomer.name}`, 'info');
                        
                        // Instructions for cross-browser testing
                        log('üìã CROSS-BROWSER TEST INSTRUCTIONS:', 'info');
                        log('1. Note the customer ID above', 'info');
                        log('2. Open this page in a different browser', 'info');
                        log('3. Click "Show Current Customers" in the other browser', 'info');
                        log('4. Look for the customer with the ID noted above', 'info');
                        log('5. If found, cross-browser sync is working!', 'info');
                        
                        // Also save instructions to localStorage for reference
                        const instructions = {
                            testCustomerId: savedCustomer.id,
                            testCustomerName: savedCustomer.contactPerson || savedCustomer.name,
                            createdIn: browserIdentifier,
                            createdAt: new Date().toISOString(),
                            instructions: 'Look for this customer in other browsers to verify cross-browser sync'
                        };
                        
                        localStorage.setItem('cross-browser-test-instructions', JSON.stringify(instructions));
                        log('üíæ Test instructions saved to localStorage', 'info');
                        
                    } else {
                        log('‚ùå Failed to create sync test customer', 'error');
                    }
                } else {
                    log('‚ùå enhancedSaveCustomer function not available', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Cross-browser sync test ERROR: ${error.message}`, 'error');
            }
        }
        
        // Create test customer from form
        async function createTestCustomer() {
            log('üë§ Creating test customer from form...', 'info');
            
            const customerData = {
                id: `FORM-TEST-${Date.now()}`,
                contactPerson: document.getElementById('testCustomerName').value,
                phone: document.getElementById('testCustomerPhone').value,
                email: document.getElementById('testCustomerEmail').value,
                address: document.getElementById('testCustomerAddress').value,
                accountType: document.getElementById('testAccountType').value,
                status: document.getElementById('testStatus').value,
                notes: document.getElementById('testNotes').value,
                bookingsCount: 0
            };
            
            if (!customerData.contactPerson || !customerData.phone || !customerData.address) {
                log('‚ùå Please fill in required fields (Name, Phone, Address)', 'error');
                return;
            }
            
            try {
                if (typeof window.enhancedSaveCustomer === 'function') {
                    const savedCustomer = await window.enhancedSaveCustomer(customerData);
                    
                    if (savedCustomer) {
                        log('‚úÖ Test customer created successfully from form', 'success');
                        log(`üìù Customer: ${savedCustomer.contactPerson || savedCustomer.name}`, 'info');
                        
                        // Clear form
                        document.getElementById('testCustomerName').value = 'Test Customer';
                        document.getElementById('testCustomerPhone').value = '+63 917 123 4567';
                        document.getElementById('testCustomerEmail').value = 'test@example.com';
                        document.getElementById('testCustomerAddress').value = '123 Test Street, Test City';
                        document.getElementById('testNotes').value = 'Test customer for cross-browser testing';
                        
                    } else {
                        log('‚ùå Failed to create test customer from form', 'error');
                    }
                } else {
                    log('‚ùå enhancedSaveCustomer function not available', 'error');
                }
            } catch (error) {
                log(`‚ùå Error creating test customer: ${error.message}`, 'error');
            }
        }
        
        // Show current customers
        async function showCurrentCustomers() {
            log('üìä Loading and displaying current customers...', 'info');
            
            try {
                // Load customers using enhanced function
                if (typeof window.enhancedLoadCustomers === 'function') {
                    await window.enhancedLoadCustomers();
                }
                
                const customers = window.customers || [];
                log(`üìä Found ${customers.length} customers`, 'info');
                
                const displayDiv = document.getElementById('customerDataDisplay');
                
                if (customers.length === 0) {
                    displayDiv.innerHTML = `
                        <div class="warning" style="padding: 10px; border-radius: 5px; margin-top: 10px;">
                            <strong>No customers found</strong><br>
                            Try creating a test customer or check if data exists in other browsers.
                        </div>
                    `;
                    return;
                }
                
                // Check for cross-browser test instructions
                let instructionsHtml = '';
                try {
                    const instructions = localStorage.getItem('cross-browser-test-instructions');
                    if (instructions) {
                        const parsed = JSON.parse(instructions);
                        instructionsHtml = `
                            <div class="info" style="padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                <strong>Cross-Browser Test Instructions:</strong><br>
                                Look for customer: <strong>${parsed.testCustomerName}</strong><br>
                                ID: <strong>${parsed.testCustomerId}</strong><br>
                                Created in: <strong>${parsed.createdIn}</strong><br>
                                Created at: <strong>${new Date(parsed.createdAt).toLocaleString()}</strong>
                            </div>
                        `;
                    }
                } catch (error) {
                    // Ignore errors reading instructions
                }
                
                // Generate customer table
                let tableHtml = `
                    ${instructionsHtml}
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Account Type</th>
                                <th>Status</th>
                                <th>Bookings</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                customers.forEach(customer => {
                    const normalized = window.normalizeCustomerFields ? 
                        window.normalizeCustomerFields(customer) : customer;
                    
                    // Highlight cross-browser test customers
                    const isTestCustomer = normalized.id.includes('SYNC-TEST') || 
                                          normalized.notes.includes('cross-browser') ||
                                          normalized.notes.includes('sync testing');
                    
                    tableHtml += `
                        <tr ${isTestCustomer ? 'class="highlight"' : ''}>
                            <td>${normalized.id}</td>
                            <td>${normalized.contactPerson || normalized.name}</td>
                            <td>${normalized.phone}</td>
                            <td>${normalized.email || 'N/A'}</td>
                            <td>${normalized.accountType || normalized.account_type}</td>
                            <td>${normalized.status}</td>
                            <td>${normalized.bookingsCount || normalized.bookings_count || 0}</td>
                            <td>${normalized.notes || 'N/A'}</td>
                        </tr>
                    `;
                    
                    log(`üìù Customer: ${normalized.contactPerson || normalized.name} (${normalized.id})`, 'info');
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                `;
                
                displayDiv.innerHTML = tableHtml;
                
            } catch (error) {
                log(`‚ùå Error showing current customers: ${error.message}`, 'error');
            }
        }
        
        // Clear customer data
        function clearCustomerData() {
            if (confirm('Are you sure you want to clear all customer data? This will remove data from localStorage only.')) {
                localStorage.removeItem('mci-customers');
                localStorage.removeItem('cross-browser-test-instructions');
                window.customers = [];
                
                document.getElementById('customerDataDisplay').innerHTML = '';
                
                log('üóëÔ∏è Customer data cleared from localStorage', 'info');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initTestEnvironment, 500); // Give scripts time to load
        });
    </script>
</body>
</html>