<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final Delivery History Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üß™ Test: Final Delivery History Fix</h2>
        
        <div class="alert alert-success">
            <strong>‚úÖ COMPREHENSIVE FIX APPLIED:</strong>
            <ul class="mb-0 mt-2">
                <li>Enhanced signature completion process</li>
                <li>Forced localStorage saving</li>
                <li>Prevented database interference</li>
                <li>Direct delivery history refresh</li>
            </ul>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Active Deliveries <span id="activeCount" class="badge bg-light text-dark">0</span></h5>
                    </div>
                    <div class="card-body" style="height: 200px; overflow-y: auto;">
                        <div id="activeList">No active deliveries</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>Delivery History <span id="historyCount" class="badge bg-light text-dark">0</span></h5>
                    </div>
                    <div class="card-body" style="height: 200px; overflow-y: auto;">
                        <div id="historyList">No delivery history</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Test Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-primary mb-2 w-100" onclick="addTestDelivery()">
                                üì¶ Add Test Delivery
                            </button>
                            <button class="btn btn-success mb-2 w-100" onclick="completeSignatureProcess()">
                                üñäÔ∏è Complete Signature Process
                            </button>
                            <button class="btn btn-info mb-2 w-100" onclick="verifyDeliveryHistory()">
                                üîç Verify Delivery History
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-warning mb-2 w-100" onclick="checkDataIntegrity()">
                                üìä Check Data Integrity
                            </button>
                            <button class="btn btn-secondary mb-2 w-100" onclick="forceRefreshHistory()">
                                üîÑ Force Refresh History
                            </button>
                            <button class="btn btn-danger mb-2 w-100" onclick="clearAllData()">
                                üóëÔ∏è Clear All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Test Log</h5>
                </div>
                <div class="card-body">
                    <div id="testLog" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; background-color: #f8f9fa; padding: 10px; border: 1px solid #ddd;">
                        Test log will appear here...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/signature-completion-fix.js"></script>
    <script src="public/assets/js/delivery-history-fix.js"></script>
    <script>
        // Initialize arrays
        if (typeof window.activeDeliveries === 'undefined') {
            window.activeDeliveries = [];
        }
        if (typeof window.deliveryHistory === 'undefined') {
            window.deliveryHistory = [];
        }

        // Load existing data
        try {
            const savedActive = localStorage.getItem('mci-active-deliveries');
            const savedHistory = localStorage.getItem('mci-delivery-history');
            
            if (savedActive) {
                window.activeDeliveries = JSON.parse(savedActive);
            }
            if (savedHistory) {
                window.deliveryHistory = JSON.parse(savedHistory);
            }
        } catch (error) {
            console.error('Error loading data:', error);
        }

        // Logging
        const testLog = document.getElementById('testLog');
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': 'black',
                'success': 'green',
                'error': 'red',
                'warning': 'orange',
                'debug': 'blue'
            };
            const color = colors[type] || 'black';
            testLog.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            testLog.scrollTop = testLog.scrollHeight;
            console.log(message);
        }

        function addTestDelivery() {
            const testDelivery = {
                id: 'final-test-' + Date.now(),
                drNumber: 'DR-FINAL-' + Date.now(),
                customerName: 'Final Test Customer',
                vendorNumber: 'VN-FINAL-001',
                truckPlateNumber: 'FINAL-123',
                origin: 'Manila',
                destination: 'Quezon City',
                status: 'Active',
                createdDate: new Date().toLocaleDateString()
            };
            
            window.activeDeliveries.push(testDelivery);
            localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
            
            log(`‚úÖ Added test delivery: ${testDelivery.drNumber}`, 'success');
            updateDisplay();
        }

        function completeSignatureProcess() {
            if (window.activeDeliveries.length === 0) {
                log('‚ö†Ô∏è No active deliveries to complete. Add a test delivery first.', 'warning');
                return;
            }
            
            const delivery = window.activeDeliveries[0];
            log(`üñäÔ∏è Starting signature completion for: ${delivery.drNumber}`, 'info');
            
            // Step 1: Create E-POD record
            log('üìù Step 1: Creating E-POD record...', 'debug');
            const ePodRecord = {
                drNumber: delivery.drNumber,
                customerName: delivery.customerName,
                customerContact: delivery.vendorNumber,
                truckPlate: delivery.truckPlateNumber,
                origin: delivery.origin,
                destination: delivery.destination,
                signature: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                status: 'Completed',
                signedAt: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            
            try {
                let ePodRecords = JSON.parse(localStorage.getItem('ePodRecords') || '[]');
                ePodRecords.push(ePodRecord);
                localStorage.setItem('ePodRecords', JSON.stringify(ePodRecords));
                log(`‚úÖ E-POD record saved. Total: ${ePodRecords.length}`, 'success');
            } catch (error) {
                log(`‚ùå Error saving E-POD: ${error.message}`, 'error');
                return;
            }
            
            // Step 2: Use enhanced signature completion
            log('üöÄ Step 2: Using enhanced signature completion...', 'debug');
            
            if (typeof window.enhancedSignatureComplete === 'function') {
                log('‚úÖ Enhanced signature completion function available', 'success');
                
                const success = window.enhancedSignatureComplete(delivery.drNumber);
                
                if (success) {
                    log('üéâ Enhanced signature completion successful!', 'success');
                } else {
                    log('‚ùå Enhanced signature completion failed', 'error');
                }
            } else {
                log('‚ö†Ô∏è Enhanced signature completion not available, using fallback', 'warning');
                
                if (typeof window.updateDeliveryStatus === 'function') {
                    const success = window.updateDeliveryStatus(delivery.drNumber, 'Completed');
                    log(`Fallback result: ${success}`, success ? 'success' : 'error');
                } else {
                    log('‚ùå No update function available', 'error');
                }
            }
            
            // Step 3: Verify results
            setTimeout(() => {
                log('üîç Step 3: Verifying results...', 'debug');
                verifyDeliveryHistory();
                updateDisplay();
            }, 1000);
        }

        function verifyDeliveryHistory() {
            log('üîç Verifying delivery history...', 'info');
            
            // Check memory
            log(`üìä Memory: Active=${window.activeDeliveries.length}, History=${window.deliveryHistory.length}`, 'debug');
            
            // Check localStorage
            try {
                const savedActive = localStorage.getItem('mci-active-deliveries');
                const savedHistory = localStorage.getItem('mci-delivery-history');
                const savedEPod = localStorage.getItem('ePodRecords');
                
                const activeCount = savedActive ? JSON.parse(savedActive).length : 0;
                const historyCount = savedHistory ? JSON.parse(savedHistory).length : 0;
                const epodCount = savedEPod ? JSON.parse(savedEPod).length : 0;
                
                log(`üíæ Storage: Active=${activeCount}, History=${historyCount}, E-POD=${epodCount}`, 'debug');
                
                if (historyCount > 0) {
                    const historyData = JSON.parse(savedHistory);
                    log('üì¶ Delivery History Items:', 'info');
                    historyData.forEach((item, index) => {
                        log(`  ${index + 1}. ${item.drNumber} - ${item.status} (${item.completedDate})`, 'info');
                    });
                    log('‚úÖ Delivery history verification successful!', 'success');
                } else {
                    log('‚ùå No items found in delivery history', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error verifying data: ${error.message}`, 'error');
            }
        }

        function checkDataIntegrity() {
            log('üìä Checking data integrity...', 'info');
            
            // Check function availability
            const functions = [
                'enhancedSignatureComplete',
                'updateDeliveryStatus',
                'loadDeliveryHistory',
                'forceRefreshDeliveryHistory'
            ];
            
            functions.forEach(func => {
                const available = typeof window[func] === 'function';
                log(`${func}: ${available ? '‚úÖ Available' : '‚ùå Missing'}`, available ? 'success' : 'error');
            });
            
            verifyDeliveryHistory();
        }

        function forceRefreshHistory() {
            log('üîÑ Force refreshing delivery history...', 'info');
            
            if (typeof window.forceRefreshDeliveryHistory === 'function') {
                window.forceRefreshDeliveryHistory();
                log('‚úÖ Force refresh completed', 'success');
            } else {
                log('‚ùå Force refresh function not available', 'error');
            }
            
            updateDisplay();
        }

        function clearAllData() {
            window.activeDeliveries = [];
            window.deliveryHistory = [];
            localStorage.removeItem('mci-active-deliveries');
            localStorage.removeItem('mci-delivery-history');
            localStorage.removeItem('ePodRecords');
            
            log('üóëÔ∏è All data cleared', 'info');
            updateDisplay();
        }

        function updateDisplay() {
            // Update active deliveries
            document.getElementById('activeCount').textContent = window.activeDeliveries.length;
            const activeList = document.getElementById('activeList');
            if (window.activeDeliveries.length === 0) {
                activeList.innerHTML = '<div class="text-muted">No active deliveries</div>';
            } else {
                activeList.innerHTML = window.activeDeliveries.map(d => 
                    `<div class="mb-1 p-2 border rounded">
                        <strong>${d.drNumber}</strong><br>
                        <small>${d.customerName} - ${d.status}</small>
                    </div>`
                ).join('');
            }
            
            // Update delivery history
            document.getElementById('historyCount').textContent = window.deliveryHistory.length;
            const historyList = document.getElementById('historyList');
            if (window.deliveryHistory.length === 0) {
                historyList.innerHTML = '<div class="text-muted">No delivery history</div>';
            } else {
                historyList.innerHTML = window.deliveryHistory.map(d => 
                    `<div class="mb-1 p-2 border rounded bg-light">
                        <strong>${d.drNumber}</strong><br>
                        <small>${d.customerName} - ${d.status}</small><br>
                        <small class="text-success">‚úÖ Completed: ${d.completedDate}</small>
                    </div>`
                ).join('');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Final Delivery History Fix Test loaded', 'success');
            log('üìã Test Instructions:', 'info');
            log('1. Click "Add Test Delivery" to create a test DR', 'info');
            log('2. Click "Complete Signature Process" to simulate signing', 'info');
            log('3. Verify the DR appears in Delivery History', 'info');
            log('4. Check data integrity to ensure everything is working', 'info');
            
            updateDisplay();
            checkDataIntegrity();
        });
    </script>
</body>
</html>