<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Booking Diagnostic - MCI Delivery System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f8f9fa; font-size: 13px; }
        .diagnostic-container { max-width: 1600px; margin: 0 auto; }
        .diagnostic-section { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .live-log { background: #000; color: #00ff00; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 11px; max-height: 400px; overflow-y: auto; }
        .status-good { color: #28a745; font-weight: bold; }
        .status-bad { color: #dc3545; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
        .monitor-panel { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; }
        .function-trace { background: #e3f2fd; padding: 8px; border-left: 4px solid #2196f3; margin: 5px 0; font-family: monospace; font-size: 11px; }
        .error-trace { background: #ffebee; padding: 8px; border-left: 4px solid #f44336; margin: 5px 0; font-family: monospace; font-size: 11px; }
        .success-trace { background: #e8f5e8; padding: 8px; border-left: 4px solid #4caf50; margin: 5px 0; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <div class="diagnostic-section">
            <h2><i class="bi bi-activity text-danger"></i> Live Booking Diagnostic Monitor</h2>
            <p class="text-muted">Real-time monitoring of booking creation process to identify blocking issues</p>
            
            <div class="alert alert-info">
                <h6><i class="bi bi-info-circle"></i> Instructions:</h6>
                <ol class="mb-0">
                    <li><strong>Keep this page open</strong> while testing bookings</li>
                    <li><strong>Go to your main app</strong> and try to create a booking</li>
                    <li><strong>Watch the monitors below</strong> - they'll show exactly what happens</li>
                    <li><strong>Check for any red errors</strong> or blocked function calls</li>
                </ol>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="diagnostic-section">
                    <h5>üîç Function Call Monitor</h5>
                    <div id="functionCallMonitor" class="monitor-panel">
                        <div>Monitoring function calls...</div>
                        <div>Waiting for booking activity...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="diagnostic-section">
                    <h5>üìä Data State Monitor</h5>
                    <div id="dataStateMonitor" class="monitor-panel">
                        <div>window.activeDeliveries: <span id="activeDeliveriesCount">-</span></div>
                        <div>localStorage items: <span id="localStorageCount">-</span></div>
                        <div>Last update: <span id="lastUpdate">-</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="diagnostic-section">
                    <h6>üéØ Critical Functions</h6>
                    <div id="criticalFunctions" class="monitor-panel">
                        <div>saveBooking: <span id="saveBookingStatus">-</span></div>
                        <div>loadActiveDeliveries: <span id="loadActiveDeliveriesStatus">-</span></div>
                        <div>populateActiveDeliveriesTable: <span id="populateTableStatus">-</span></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="diagnostic-section">
                    <h6>üîó Event Listeners</h6>
                    <div id="eventListeners" class="monitor-panel">
                        <div>Confirm button: <span id="confirmButtonStatus">-</span></div>
                        <div>Form submission: <span id="formSubmissionStatus">-</span></div>
                        <div>Modal events: <span id="modalEventsStatus">-</span></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="diagnostic-section">
                    <h6>‚ö†Ô∏è Error Detection</h6>
                    <div id="errorDetection" class="monitor-panel">
                        <div>JavaScript errors: <span id="jsErrorCount">0</span></div>
                        <div>Console warnings: <span id="consoleWarningCount">0</span></div>
                        <div>Network errors: <span id="networkErrorCount">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="diagnostic-section">
            <h5>üìù Live Execution Log</h5>
            <div id="liveLog" class="live-log">
                <div>[SYSTEM] Live diagnostic monitor initialized</div>
                <div>[SYSTEM] Monitoring all booking-related function calls...</div>
            </div>
            <div class="mt-2">
                <button id="clearLog" class="btn btn-sm btn-outline-secondary">Clear Log</button>
                <button id="testBookingFlow" class="btn btn-sm btn-primary">Test Booking Flow</button>
                <button id="inspectCurrentState" class="btn btn-sm btn-info">Inspect Current State</button>
            </div>
        </div>

        <div class="diagnostic-section">
            <h5>üß™ Manual Test Controls</h5>
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <h6>Quick Booking Test</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" id="quickDrNumber" class="form-control form-control-sm mb-2" placeholder="DR Number" value="DR-LIVE-TEST">
                                    <input type="text" id="quickCustomer" class="form-control form-control-sm mb-2" placeholder="Customer" value="Live Test Customer">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" id="quickOrigin" class="form-control form-control-sm mb-2" placeholder="Origin" value="Manila">
                                    <input type="text" id="quickDestination" class="form-control form-control-sm mb-2" placeholder="Destination" value="Quezon City">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" id="quickTruck" class="form-control form-control-sm mb-2" placeholder="Truck Type" value="10-Wheeler">
                                    <input type="text" id="quickPlate" class="form-control form-control-sm mb-2" placeholder="Plate Number" value="TEST-123">
                                </div>
                            </div>
                            <button id="createTestBooking" class="btn btn-primary btn-sm">Create Test Booking</button>
                            <button id="callSaveBooking" class="btn btn-outline-primary btn-sm">Call saveBooking() Directly</button>
                            <button id="callLoadActiveDeliveries" class="btn btn-outline-secondary btn-sm">Call loadActiveDeliveries()</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h6>Current Data</h6>
                            <div id="currentDataDisplay" class="monitor-panel" style="max-height: 150px; overflow-y: auto;">
                                Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let functionCallCount = 0;
        let errorCount = 0;
        let warningCount = 0;

        // Live logging function
        function liveLog(message, type = 'info') {
            const log = document.getElementById('liveLog');
            const timestamp = new Date().toLocaleTimeString();
            const typePrefix = type === 'error' ? '[ERROR]' : type === 'success' ? '[SUCCESS]' : type === 'warning' ? '[WARNING]' : '[INFO]';
            const color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : type === 'warning' ? '#ffff44' : '#00ff00';
            
            log.innerHTML += `<div style="color: ${color}">[${timestamp}] ${typePrefix} ${message}</div>`;
            log.scrollTop = log.scrollHeight;
            console.log(`[${timestamp}] ${typePrefix} ${message}`);
        }

        // Monitor function calls by intercepting them
        function setupFunctionMonitoring() {
            liveLog('Setting up function call monitoring...');

            // Monitor saveBooking
            if (typeof window.saveBooking === 'function') {
                const originalSaveBooking = window.saveBooking;
                window.saveBooking = function(...args) {
                    liveLog('üéØ saveBooking() called with args: ' + JSON.stringify(args), 'success');
                    updateFunctionCallMonitor('saveBooking called');
                    
                    try {
                        const result = originalSaveBooking.apply(this, args);
                        liveLog('‚úÖ saveBooking() completed successfully', 'success');
                        return result;
                    } catch (error) {
                        liveLog('‚ùå saveBooking() threw error: ' + error.message, 'error');
                        throw error;
                    }
                };
                document.getElementById('saveBookingStatus').innerHTML = '<span class="status-good">‚úÖ Monitored</span>';
            } else {
                document.getElementById('saveBookingStatus').innerHTML = '<span class="status-bad">‚ùå Not Found</span>';
                liveLog('‚ùå saveBooking function not found', 'error');
            }

            // Monitor loadActiveDeliveries
            if (typeof window.loadActiveDeliveries === 'function') {
                const originalLoadActiveDeliveries = window.loadActiveDeliveries;
                window.loadActiveDeliveries = function(...args) {
                    liveLog('üîÑ loadActiveDeliveries() called', 'success');
                    updateFunctionCallMonitor('loadActiveDeliveries called');
                    
                    try {
                        const result = originalLoadActiveDeliveries.apply(this, args);
                        liveLog('‚úÖ loadActiveDeliveries() completed', 'success');
                        return result;
                    } catch (error) {
                        liveLog('‚ùå loadActiveDeliveries() threw error: ' + error.message, 'error');
                        throw error;
                    }
                };
                document.getElementById('loadActiveDeliveriesStatus').innerHTML = '<span class="status-good">‚úÖ Monitored</span>';
            } else {
                document.getElementById('loadActiveDeliveriesStatus').innerHTML = '<span class="status-bad">‚ùå Not Found</span>';
                liveLog('‚ùå loadActiveDeliveries function not found', 'error');
            }

            // Monitor populateActiveDeliveriesTable
            if (typeof window.populateActiveDeliveriesTable === 'function') {
                const originalPopulateTable = window.populateActiveDeliveriesTable;
                window.populateActiveDeliveriesTable = function(...args) {
                    liveLog('üìä populateActiveDeliveriesTable() called', 'success');
                    updateFunctionCallMonitor('populateActiveDeliveriesTable called');
                    
                    try {
                        const result = originalPopulateTable.apply(this, args);
                        liveLog('‚úÖ populateActiveDeliveriesTable() completed', 'success');
                        return result;
                    } catch (error) {
                        liveLog('‚ùå populateActiveDeliveriesTable() threw error: ' + error.message, 'error');
                        throw error;
                    }
                };
                document.getElementById('populateTableStatus').innerHTML = '<span class="status-good">‚úÖ Monitored</span>';
            } else {
                document.getElementById('populateTableStatus').innerHTML = '<span class="status-bad">‚ùå Not Found</span>';
                liveLog('‚ùå populateActiveDeliveriesTable function not found', 'error');
            }
        }

        // Update function call monitor
        function updateFunctionCallMonitor(message) {
            functionCallCount++;
            const monitor = document.getElementById('functionCallMonitor');
            monitor.innerHTML += `<div class="function-trace">[${functionCallCount}] ${message} at ${new Date().toLocaleTimeString()}</div>`;
            monitor.scrollTop = monitor.scrollHeight;
        }

        // Monitor data state changes
        function updateDataStateMonitor() {
            const activeCount = typeof window.activeDeliveries !== 'undefined' ? window.activeDeliveries.length : 'undefined';
            const localStorageCount = localStorage.length;
            
            document.getElementById('activeDeliveriesCount').textContent = activeCount;
            document.getElementById('localStorageCount').textContent = localStorageCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            // Update current data display
            const currentDataDisplay = document.getElementById('currentDataDisplay');
            let dataInfo = '';
            
            if (typeof window.activeDeliveries !== 'undefined') {
                dataInfo += `window.activeDeliveries: ${window.activeDeliveries.length} items\n`;
                if (window.activeDeliveries.length > 0) {
                    dataInfo += `Latest: ${window.activeDeliveries[window.activeDeliveries.length - 1].drNumber}\n`;
                }
            } else {
                dataInfo += 'window.activeDeliveries: undefined\n';
            }

            try {
                const saved = localStorage.getItem('mci-active-deliveries');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    dataInfo += `localStorage: ${parsed.length} items\n`;
                } else {
                    dataInfo += 'localStorage: empty\n';
                }
            } catch (error) {
                dataInfo += `localStorage: error (${error.message})\n`;
            }

            currentDataDisplay.textContent = dataInfo;
        }

        // Monitor console errors
        function setupErrorMonitoring() {
            const originalError = console.error;
            console.error = function(...args) {
                errorCount++;
                document.getElementById('jsErrorCount').textContent = errorCount;
                liveLog('üö® Console Error: ' + args.join(' '), 'error');
                originalError.apply(console, args);
            };

            const originalWarn = console.warn;
            console.warn = function(...args) {
                warningCount++;
                document.getElementById('consoleWarningCount').textContent = warningCount;
                liveLog('‚ö†Ô∏è Console Warning: ' + args.join(' '), 'warning');
                originalWarn.apply(console, args);
            };

            // Monitor unhandled errors
            window.addEventListener('error', function(event) {
                errorCount++;
                document.getElementById('jsErrorCount').textContent = errorCount;
                liveLog('üö® Unhandled Error: ' + event.error.message + ' at ' + event.filename + ':' + event.lineno, 'error');
            });

            // Monitor unhandled promise rejections
            window.addEventListener('unhandledrejection', function(event) {
                errorCount++;
                document.getElementById('jsErrorCount').textContent = errorCount;
                liveLog('üö® Unhandled Promise Rejection: ' + event.reason, 'error');
            });
        }

        // Create test booking
        function createTestBooking() {
            liveLog('üß™ Creating test booking...', 'success');
            
            if (typeof window.activeDeliveries === 'undefined') {
                window.activeDeliveries = [];
                liveLog('üîß Initialized window.activeDeliveries', 'warning');
            }

            const testBooking = {
                id: 'DEL-' + Date.now() + '-LIVE',
                drNumber: document.getElementById('quickDrNumber').value,
                customerName: document.getElementById('quickCustomer').value,
                vendorNumber: 'VN-LIVE-TEST',
                origin: document.getElementById('quickOrigin').value,
                destination: document.getElementById('quickDestination').value,
                truckType: document.getElementById('quickTruck').value,
                truckPlateNumber: document.getElementById('quickPlate').value,
                status: 'On Schedule',
                deliveryDate: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString(),
                source: 'LIVE_DIAGNOSTIC'
            };

            const beforeCount = window.activeDeliveries.length;
            window.activeDeliveries.push(testBooking);
            const afterCount = window.activeDeliveries.length;

            liveLog(`üìä Added booking: ${beforeCount} ‚Üí ${afterCount}`, 'success');

            // Save to localStorage
            try {
                localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
                liveLog('üíæ Saved to localStorage successfully', 'success');
            } catch (error) {
                liveLog('‚ùå Failed to save to localStorage: ' + error.message, 'error');
            }

            // Try to call loadActiveDeliveries
            if (typeof window.loadActiveDeliveries === 'function') {
                liveLog('üîÑ Calling loadActiveDeliveries...', 'success');
                try {
                    window.loadActiveDeliveries();
                    liveLog('‚úÖ loadActiveDeliveries called successfully', 'success');
                } catch (error) {
                    liveLog('‚ùå loadActiveDeliveries failed: ' + error.message, 'error');
                }
            } else {
                liveLog('‚ùå loadActiveDeliveries function not available', 'error');
            }

            updateDataStateMonitor();
        }

        // Inspect current state
        function inspectCurrentState() {
            liveLog('üîç Inspecting current system state...', 'success');
            
            // Check global variables
            liveLog('Global variables:', 'info');
            liveLog(`- window.activeDeliveries: ${typeof window.activeDeliveries !== 'undefined' ? window.activeDeliveries.length + ' items' : 'undefined'}`, 'info');
            liveLog(`- window.deliveryHistory: ${typeof window.deliveryHistory !== 'undefined' ? window.deliveryHistory.length + ' items' : 'undefined'}`, 'info');
            
            // Check functions
            liveLog('Functions:', 'info');
            liveLog(`- saveBooking: ${typeof window.saveBooking === 'function' ? 'available' : 'missing'}`, 'info');
            liveLog(`- loadActiveDeliveries: ${typeof window.loadActiveDeliveries === 'function' ? 'available' : 'missing'}`, 'info');
            liveLog(`- populateActiveDeliveriesTable: ${typeof window.populateActiveDeliveriesTable === 'function' ? 'available' : 'missing'}`, 'info');
            
            // Check DOM elements
            liveLog('DOM elements:', 'info');
            const confirmBtn = document.getElementById('confirmBookingBtn');
            liveLog(`- confirmBookingBtn: ${confirmBtn ? 'found' : 'not found'}`, 'info');
            const tableBody = document.getElementById('activeDeliveriesTableBody');
            liveLog(`- activeDeliveriesTableBody: ${tableBody ? 'found' : 'not found'}`, 'info');
            
            // Check localStorage
            liveLog('localStorage:', 'info');
            try {
                const saved = localStorage.getItem('mci-active-deliveries');
                liveLog(`- mci-active-deliveries: ${saved ? JSON.parse(saved).length + ' items' : 'empty'}`, 'info');
            } catch (error) {
                liveLog(`- mci-active-deliveries: error (${error.message})`, 'error');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            liveLog('üöÄ Live diagnostic monitor started', 'success');
            
            // Initialize monitoring
            setupFunctionMonitoring();
            setupErrorMonitoring();
            updateDataStateMonitor();
            
            // Set up periodic monitoring
            setInterval(updateDataStateMonitor, 2000);
            
            // Event listeners for controls
            document.getElementById('clearLog').addEventListener('click', function() {
                document.getElementById('liveLog').innerHTML = '<div>[SYSTEM] Log cleared</div>';
            });
            
            document.getElementById('testBookingFlow').addEventListener('click', function() {
                liveLog('üß™ Testing complete booking flow...', 'success');
                inspectCurrentState();
            });
            
            document.getElementById('inspectCurrentState').addEventListener('click', inspectCurrentState);
            document.getElementById('createTestBooking').addEventListener('click', createTestBooking);
            
            document.getElementById('callSaveBooking').addEventListener('click', function() {
                if (typeof window.saveBooking === 'function') {
                    liveLog('üéØ Calling saveBooking() directly...', 'success');
                    try {
                        window.saveBooking();
                        liveLog('‚úÖ saveBooking() called successfully', 'success');
                    } catch (error) {
                        liveLog('‚ùå saveBooking() failed: ' + error.message, 'error');
                    }
                } else {
                    liveLog('‚ùå saveBooking function not available', 'error');
                }
            });
            
            document.getElementById('callLoadActiveDeliveries').addEventListener('click', function() {
                if (typeof window.loadActiveDeliveries === 'function') {
                    liveLog('üîÑ Calling loadActiveDeliveries() directly...', 'success');
                    try {
                        window.loadActiveDeliveries();
                        liveLog('‚úÖ loadActiveDeliveries() called successfully', 'success');
                    } catch (error) {
                        liveLog('‚ùå loadActiveDeliveries() failed: ' + error.message, 'error');
                    }
                } else {
                    liveLog('‚ùå loadActiveDeliveries function not available', 'error');
                }
            });
            
            liveLog('‚úÖ All monitoring systems active', 'success');
            liveLog('üìã Ready to monitor booking creation attempts', 'info');
        });

        // Initialize global arrays if needed
        if (typeof window.activeDeliveries === 'undefined') {
            window.activeDeliveries = [];
            liveLog('üîß Initialized window.activeDeliveries for monitoring', 'warning');
        }
    </script>
</body>
</html>