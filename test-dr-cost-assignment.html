<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test DR Cost Assignment - Option C</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Test DR Cost Assignment - Option C Implementation</h2>
        <p class="text-muted">This page tests the new cost assignment logic where only the first DR gets costs.</p>
        
        <div class="alert alert-info">
            <h5>Test Scenario:</h5>
            <p>When uploading multiple DR records with total costs of â‚±1,500:</p>
            <ul>
                <li><strong>First DR (DR001):</strong> Gets â‚±1,500 (all costs)</li>
                <li><strong>Other DRs (DR002, DR003):</strong> Get â‚±0 (zero costs)</li>
                <li><strong>Analytics Total:</strong> â‚±1,500 (correct, not inflated)</li>
            </ul>
        </div>
        
        <!-- Mock DR Upload Results -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="bi bi-upload"></i> Mock DR Upload Results</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>DR Number</th>
                                <th>Customer Name</th>
                                <th>Additional Costs</th>
                                <th>Cost Breakdown</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="mockDRResults">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="simulateDRUpload()">
                        <i class="bi bi-play"></i> Simulate DR Upload
                    </button>
                    <button class="btn btn-success" onclick="calculateAnalytics()">
                        <i class="bi bi-calculator"></i> Calculate Analytics
                    </button>
                </div>
                
                <div id="analyticsResult" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <h6>Analytics Result:</h6>
                        <p id="analyticsText"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Mock data for testing
        let mockDRData = [];
        
        function simulateDRUpload() {
            console.log('ðŸ§ª Simulating DR Upload with Option C logic...');
            
            // Mock input data
            const pendingDRBookings = [
                { drNumber: 'DR001', customerName: 'Customer A' },
                { drNumber: 'DR002', customerName: 'Customer B' },
                { drNumber: 'DR003', customerName: 'Customer C' }
            ];
            
            // Mock cost data from modal
            const totalAdditionalCost = 1500;
            const additionalCosts = [
                { description: 'Fuel Surcharge', amount: 800 },
                { description: 'Helper Fee', amount: 500 },
                { description: 'Toll Fee', amount: 200 }
            ];
            
            // Apply Option C logic: costs only to first DR
            mockDRData = [];
            for (let index = 0; index < pendingDRBookings.length; index++) {
                const booking = pendingDRBookings[index];
                
                if (index === 0) {
                    // First DR gets all the costs
                    booking.additionalCosts = totalAdditionalCost;
                    booking.additionalCostBreakdown = [...additionalCosts];
                    console.log(`ðŸ’° Applied costs to first DR (${booking.drNumber}): â‚±${totalAdditionalCost}`);
                } else {
                    // Other DRs get zero costs
                    booking.additionalCosts = 0;
                    booking.additionalCostBreakdown = [];
                    console.log(`ðŸ’° Zero costs applied to DR (${booking.drNumber})`);
                }
                
                mockDRData.push(booking);
            }
            
            // Display results
            displayResults();
        }
        
        function displayResults() {
            const tbody = document.getElementById('mockDRResults');
            tbody.innerHTML = mockDRData.map(dr => {
                const costBreakdown = dr.additionalCostBreakdown.length > 0 
                    ? dr.additionalCostBreakdown.map(item => `${item.description}: â‚±${item.amount}`).join('<br>')
                    : 'No costs';
                    
                const statusClass = dr.additionalCosts > 0 ? 'bg-success' : 'bg-secondary';
                const statusText = dr.additionalCosts > 0 ? 'Has Costs' : 'Zero Costs';
                
                return `
                    <tr>
                        <td><strong>${dr.drNumber}</strong></td>
                        <td>${dr.customerName}</td>
                        <td><strong>â‚±${dr.additionalCosts.toLocaleString()}</strong></td>
                        <td><small>${costBreakdown}</small></td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        function calculateAnalytics() {
            if (mockDRData.length === 0) {
                alert('Please simulate DR upload first');
                return;
            }
            
            // Calculate analytics (same logic as additional-costs-analysis-fix.js)
            const totalBookings = mockDRData.length;
            const totalAdditionalCost = mockDRData.reduce((sum, dr) => sum + (dr.additionalCosts || 0), 0);
            const avgCostPerBooking = totalBookings > 0 ? totalAdditionalCost / totalBookings : 0;
            
            // Show results
            const analyticsResult = document.getElementById('analyticsResult');
            const analyticsText = document.getElementById('analyticsText');
            
            analyticsText.innerHTML = `
                <strong>Total Bookings:</strong> ${totalBookings}<br>
                <strong>Total Additional Costs:</strong> â‚±${totalAdditionalCost.toLocaleString()}<br>
                <strong>Average Cost per Booking:</strong> â‚±${avgCostPerBooking.toFixed(2)}<br>
                <br>
                <span class="text-success">âœ… Correct! Total cost is â‚±${totalAdditionalCost.toLocaleString()} (not inflated)</span>
            `;
            
            analyticsResult.style.display = 'block';
            
            console.log('ðŸ“Š Analytics calculated:', {
                totalBookings,
                totalAdditionalCost,
                avgCostPerBooking
            });
        }
    </script>
</body>
</html>