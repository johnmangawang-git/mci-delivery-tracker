<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer 400 Error Fix Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Customer 400 Error Fix Test</h1>
                
                <div class="alert alert-info">
                    <h5>Testing Customer Supabase Schema Fix</h5>
                    <p>This page tests the fix for the 400 error when loading customers from Supabase.</p>
                    <p><strong>Issue:</strong> Field mismatch between JavaScript (contactPerson) and Supabase schema (name)</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Controls</h5>
                            </div>
                            <div class="card-body">
                                <button id="testFetchCustomers" class="btn btn-primary mb-2">Test Fetch Customers</button>
                                <button id="testSaveCustomer" class="btn btn-success mb-2">Test Save Customer</button>
                                <button id="clearConsole" class="btn btn-secondary mb-2">Clear Console</button>
                                <button id="loadCustomersUI" class="btn btn-info mb-2">Load Customers UI</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Results</h5>
                            </div>
                            <div class="card-body">
                                <div id="testResults" class="small">
                                    <p class="text-muted">Click test buttons to see results...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Customers Display</h5>
                            </div>
                            <div class="card-body">
                                <div id="customersContainer" class="row">
                                    <div class="col-12 text-center py-3">
                                        <p class="text-muted">No customers loaded yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Configuration -->
    <script>
        // Supabase configuration
        window.SUPABASE_URL = 'https://ntyvrezyhrmflswxefbk.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50eXZyZXp5aHJtZmxzd3hlZmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA3MjU1NzQsImV4cCI6MjA0NjMwMTU3NH0.Ej5zJhOJGKJhq8Ej5zJhOJGKJhq8Ej5zJhOJGKJhq8E';
    </script>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Core Scripts -->
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/customers.js"></script>
    
    <!-- Fix Scripts -->
    <script src="public/assets/js/customer-field-mapping-fix.js"></script>
    <script src="public/assets/js/customer-supabase-schema-fix.js"></script>
    <script src="public/assets/js/customer-400-error-diagnostic.js"></script>
    
    <script>
        let testResults = [];
        
        function addTestResult(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push({ timestamp, message, type });
            updateTestResultsDisplay();
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateTestResultsDisplay() {
            const container = document.getElementById('testResults');
            container.innerHTML = testResults.map(result => {
                const badgeClass = {
                    'success': 'bg-success',
                    'error': 'bg-danger',
                    'warning': 'bg-warning',
                    'info': 'bg-info'
                }[result.type] || 'bg-secondary';
                
                return `
                    <div class="mb-1">
                        <span class="badge ${badgeClass}">${result.timestamp}</span>
                        <span class="ms-2">${result.message}</span>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        // Test fetch customers
        document.getElementById('testFetchCustomers').addEventListener('click', async function() {
            addTestResult('Testing customer fetch...', 'info');
            
            try {
                const customers = await window.dataService.getCustomers();
                addTestResult(`✅ Fetch successful: ${customers.length} customers loaded`, 'success');
                
                if (customers.length > 0) {
                    addTestResult(`First customer: ${JSON.stringify(customers[0], null, 2)}`, 'info');
                }
            } catch (error) {
                addTestResult(`❌ Fetch failed: ${error.message}`, 'error');
                console.error('Customer fetch error:', error);
            }
        });
        
        // Test save customer
        document.getElementById('testSaveCustomer').addEventListener('click', async function() {
            addTestResult('Testing customer save...', 'info');
            
            const testCustomer = {
                id: 'TEST-' + Date.now(),
                contactPerson: 'Test Customer ' + Date.now(),
                phone: '+63 999 ' + Math.floor(Math.random() * 1000000),
                email: 'test' + Date.now() + '@example.com',
                address: 'Test Address ' + Date.now(),
                vendorNumber: '+63 999 ' + Math.floor(Math.random() * 1000000),
                accountType: 'Individual',
                status: 'active',
                notes: 'Test customer for schema fix',
                bookingsCount: 0,
                lastDelivery: '',
                createdAt: new Date().toISOString()
            };
            
            try {
                const savedCustomer = await window.dataService.saveCustomer(testCustomer);
                addTestResult(`✅ Save successful: ${savedCustomer.contactPerson || savedCustomer.name}`, 'success');
                addTestResult(`Saved customer: ${JSON.stringify(savedCustomer, null, 2)}`, 'info');
            } catch (error) {
                addTestResult(`❌ Save failed: ${error.message}`, 'error');
                console.error('Customer save error:', error);
            }
        });
        
        // Clear console
        document.getElementById('clearConsole').addEventListener('click', function() {
            testResults = [];
            updateTestResultsDisplay();
            console.clear();
            addTestResult('Console cleared', 'info');
        });
        
        // Load customers UI
        document.getElementById('loadCustomersUI').addEventListener('click', async function() {
            addTestResult('Loading customers UI...', 'info');
            
            try {
                if (typeof window.loadCustomers === 'function') {
                    await window.loadCustomers();
                    addTestResult('✅ Customers UI loaded successfully', 'success');
                } else {
                    addTestResult('❌ loadCustomers function not available', 'error');
                }
            } catch (error) {
                addTestResult(`❌ UI load failed: ${error.message}`, 'error');
                console.error('UI load error:', error);
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('Customer 400 Error Fix Test initialized', 'success');
            addTestResult('Ready to test customer operations', 'info');
            
            // Auto-test after a short delay
            setTimeout(() => {
                addTestResult('Running automatic tests...', 'info');
                document.getElementById('testFetchCustomers').click();
            }, 2000);
        });
    </script>
</body>
</html>