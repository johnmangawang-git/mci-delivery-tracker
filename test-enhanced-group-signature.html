<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Group Signature Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Enhanced Group Signature Test</h2>
        <p>This test verifies that signing one delivery completes all deliveries with the same DR Number + Customer Name + Mobile Number.</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Scenario</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Test Data:</strong> 6 deliveries with mixed groupings</p>
                        <ul>
                            <li><strong>Group 1:</strong> DR-001, Customer A, Mobile 09171111111 (3 items)</li>
                            <li><strong>Group 2:</strong> DR-001, Customer B, Mobile 09172222222 (2 items)</li>
                            <li><strong>Individual:</strong> DR-002, Customer C, Mobile 09173333333 (1 item)</li>
                        </ul>
                        <button class="btn btn-primary" onclick="setupTestData()">Setup Test Data</button>
                        <button class="btn btn-success ms-2" onclick="testGroupSignature()">Test Group Signature</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Expected Result</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>When signing Group 1 (DR-001, Customer A):</strong></p>
                        <ul>
                            <li>‚úÖ All 3 items with same DR + Customer + Mobile should complete</li>
                            <li>‚ùå Group 2 items should remain active (different customer)</li>
                            <li>‚ùå Individual item should remain active (different DR)</li>
                        </ul>
                        <div id="testResult" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Active Deliveries (Test Data)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>DR Number</th>
                                        <th>Customer Name</th>
                                        <th>Mobile Number</th>
                                        <th>Serial Number</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="testDeliveriesTable">
                                    <!-- Test deliveries will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="testLog" class="bg-dark text-light p-3" style="font-family: monospace; height: 300px; overflow-y: auto;">
                            <!-- Test log will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/enhanced-group-signature.js"></script>
    
    <script>
        // Test data with mixed groupings
        let testDeliveries = [
            // Group 1: Same DR + Customer + Mobile (should complete together)
            {
                drNumber: 'DR-001',
                customerName: 'SMEG Customer A',
                mobileNumber: '09171111111',
                serialNumber: 'SN-001',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Manila Office'
            },
            {
                drNumber: 'DR-001',
                customerName: 'SMEG Customer A',
                mobileNumber: '09171111111',
                serialNumber: 'SN-002',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Manila Office'
            },
            {
                drNumber: 'DR-001',
                customerName: 'SMEG Customer A',
                mobileNumber: '09171111111',
                serialNumber: 'SN-003',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Manila Office'
            },
            // Group 2: Same DR but different Customer + Mobile (should NOT complete with Group 1)
            {
                drNumber: 'DR-001',
                customerName: 'SMEG Customer B',
                mobileNumber: '09172222222',
                serialNumber: 'SN-004',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Cebu Office'
            },
            {
                drNumber: 'DR-001',
                customerName: 'SMEG Customer B',
                mobileNumber: '09172222222',
                serialNumber: 'SN-005',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Cebu Office'
            },
            // Individual: Different DR (should NOT complete with others)
            {
                drNumber: 'DR-002',
                customerName: 'SMEG Customer C',
                mobileNumber: '09173333333',
                serialNumber: 'SN-006',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Davao Office'
            }
        ];
        
        // Capture console output
        const originalConsoleLog = console.log;
        const testLog = document.getElementById('testLog');
        
        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'lightblue';
            testLog.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            testLog.scrollTop = testLog.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToLog(args.join(' '), 'info');
        };
        
        function setupTestData() {
            addToLog('üß™ Setting up test data...', 'info');
            
            // Set up global activeDeliveries array
            window.activeDeliveries = [...testDeliveries];
            window.deliveryHistory = [];
            
            // Populate test table
            populateTestTable();
            
            addToLog(`‚úÖ Test data setup complete: ${testDeliveries.length} deliveries`, 'success');
            showResult('Test data setup complete. Ready to test group signature functionality.', 'success');
        }
        
        function populateTestTable() {
            const tableBody = document.getElementById('testDeliveriesTable');
            tableBody.innerHTML = '';
            
            window.activeDeliveries.forEach((delivery, index) => {
                const row = document.createElement('tr');
                const statusClass = delivery.status === 'Completed' ? 'table-success' : '';
                row.className = statusClass;
                
                row.innerHTML = `
                    <td><strong>${delivery.drNumber}</strong></td>
                    <td>${delivery.customerName}</td>
                    <td>${delivery.mobileNumber}</td>
                    <td><span class="badge bg-info">${delivery.serialNumber}</span></td>
                    <td><span class="badge ${delivery.status === 'Completed' ? 'bg-success' : 'bg-warning'}">${delivery.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="signDelivery('${delivery.drNumber}')"
                                ${delivery.status === 'Completed' ? 'disabled' : ''}>
                            <i class="bi bi-pen"></i> Sign
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function signDelivery(drNumber) {
            addToLog(`üñäÔ∏è Signing delivery: ${drNumber}`, 'info');
            
            if (typeof window.enhancedUpdateDeliveryStatus === 'function') {
                window.enhancedUpdateDeliveryStatus(drNumber, 'Completed');
                
                // Update table display
                setTimeout(() => {
                    populateTestTable();
                    analyzeResults();
                }, 100);
                
            } else {
                addToLog('‚ùå Enhanced group signature function not available', 'error');
            }
        }
        
        function testGroupSignature() {
            addToLog('üß™ Testing group signature functionality...', 'info');
            
            if (!window.activeDeliveries || window.activeDeliveries.length === 0) {
                addToLog('‚ùå No test data available. Please setup test data first.', 'error');
                showResult('Please setup test data first before testing.', 'danger');
                return;
            }
            
            // Test signing Group 1 (DR-001, Customer A)
            addToLog('üéØ Testing: Sign DR-001 for Customer A (should complete 3 items)', 'info');
            signDelivery('DR-001');
        }
        
        function analyzeResults() {
            const activeCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            const historyCount = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            addToLog('üìä ANALYSIS RESULTS:', 'info');
            addToLog(`  Active deliveries remaining: ${activeCount}`, 'info');
            addToLog(`  Completed deliveries: ${historyCount}`, 'info');
            
            // Expected: 3 completed (Group 1), 3 remaining (Group 2 + Individual)
            if (historyCount === 3 && activeCount === 3) {
                addToLog('‚úÖ TEST PASSED: Correct grouping behavior', 'success');
                showResult('‚úÖ TEST PASSED: Group signature works correctly! 3 items completed, 3 remain active.', 'success');
            } else {
                addToLog(`‚ùå TEST FAILED: Expected 3 completed, 3 active. Got ${historyCount} completed, ${activeCount} active`, 'error');
                showResult(`‚ùå TEST FAILED: Expected 3 completed, 3 active. Got ${historyCount} completed, ${activeCount} active.`, 'danger');
            }
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addToLog('Enhanced Group Signature Test loaded', 'info');
            showResult('Test environment ready. Click "Setup Test Data" to begin.', 'info');
        });
    </script>
</body>
</html>