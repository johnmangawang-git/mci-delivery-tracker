<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Data Analysis Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Cost Data Analysis Test</h1>
                
                <div class="alert alert-info">
                    <h5>Testing Cost Data Connection</h5>
                    <p>This page analyzes your delivery data to find cost information and ensure it connects to analytics.</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Test Controls</h5>
                            </div>
                            <div class="card-body">
                                <button id="analyzeCostData" class="btn btn-primary mb-2">Analyze Cost Data</button>
                                <button id="testSupabaseData" class="btn btn-success mb-2">Test Supabase Data</button>
                                <button id="testLocalStorageData" class="btn btn-warning mb-2">Test localStorage Data</button>
                                <button id="forceAnalyticsUpdate" class="btn btn-info mb-2">Force Analytics Update</button>
                                <button id="clearConsole" class="btn btn-secondary mb-2">Clear Console</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Cost Summary</h5>
                            </div>
                            <div class="card-body">
                                <div id="costSummary">
                                    <p class="text-muted">Click "Analyze Cost Data" to see summary</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Detailed Analysis Results</h5>
                            </div>
                            <div class="card-body">
                                <div id="analysisResults" class="small" style="max-height: 400px; overflow-y: auto;">
                                    <p class="text-muted">Analysis results will appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Sample Deliveries with Costs</h5>
                            </div>
                            <div class="card-body">
                                <div id="sampleDeliveries">
                                    <p class="text-muted">Sample deliveries will appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Configuration -->
    <script>
        window.SUPABASE_URL = 'https://ntyvrezyhrmflswxefbk.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50eXZyZXp5aHJtZmxzd3hlZmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA3MjU1NzQsImV4cCI6MjA0NjMwMTU3NH0.Ej5zJhOJGKJhq8Ej5zJhOJGKJhq8Ej5zJhOJGKJhq8E';
    </script>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Core Scripts -->
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    
    <!-- Fix Scripts -->
    <script src="public/assets/js/analytics-cost-data-fix.js"></script>
    
    <script>
        let analysisResults = [];
        
        function addResult(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            analysisResults.push({ timestamp, message, type });
            updateResultsDisplay();
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateResultsDisplay() {
            const container = document.getElementById('analysisResults');
            container.innerHTML = analysisResults.map(result => {
                const badgeClass = {
                    'success': 'bg-success',
                    'error': 'bg-danger',
                    'warning': 'bg-warning',
                    'info': 'bg-info'
                }[result.type] || 'bg-secondary';
                
                return `
                    <div class="mb-1">
                        <span class="badge ${badgeClass}">${result.timestamp}</span>
                        <span class="ms-2">${result.message}</span>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        function updateCostSummary(costData) {
            const container = document.getElementById('costSummary');
            
            if (!costData || costData.totalCosts === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <h6>No Cost Data Found</h6>
                        <p class="mb-0">No additional costs found in deliveries. This explains why analytics shows â‚±0.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="alert alert-success">
                    <h6>Cost Data Found!</h6>
                    <p><strong>Total Additional Costs:</strong> â‚±${costData.totalCosts.toLocaleString()}</p>
                    <p><strong>Deliveries with Costs:</strong> ${costData.deliveries.filter(d => 
                        (d.additionalCosts && d.additionalCosts > 0) || 
                        (d.additional_costs && d.additional_costs > 0) ||
                        (d.additionalCostItems && d.additionalCostItems.length > 0)
                    ).length}</p>
                </div>
                <div class="row">
                    ${Object.entries(costData.costBreakdown).map(([category, amount]) => 
                        amount > 0 ? `
                            <div class="col-6 mb-2">
                                <strong>${category}:</strong> â‚±${amount.toLocaleString()}
                            </div>
                        ` : ''
                    ).join('')}
                </div>
            `;
        }
        
        function displaySampleDeliveries(deliveries) {
            const container = document.getElementById('sampleDeliveries');
            
            const deliveriesWithCosts = deliveries.filter(d => 
                (d.additionalCosts && d.additionalCosts > 0) || 
                (d.additional_costs && d.additional_costs > 0) ||
                (d.additionalCostItems && d.additionalCostItems.length > 0)
            ).slice(0, 5);
            
            if (deliveriesWithCosts.length === 0) {
                container.innerHTML = '<p class="text-muted">No deliveries with cost data found</p>';
                return;
            }
            
            container.innerHTML = deliveriesWithCosts.map(delivery => {
                const drNumber = delivery.dr_number || delivery.drNumber || delivery.id;
                const costs = delivery.additionalCosts || delivery.additional_costs || 0;
                const costItems = delivery.additionalCostItems || [];
                
                return `
                    <div class="border rounded p-3 mb-2">
                        <h6>${drNumber}</h6>
                        <p><strong>Customer:</strong> ${delivery.customer_name || delivery.customerName || 'N/A'}</p>
                        <p><strong>Total Additional Costs:</strong> â‚±${costs.toLocaleString()}</p>
                        ${costItems.length > 0 ? `
                            <p><strong>Cost Items:</strong></p>
                            <ul class="small">
                                ${costItems.map(item => `<li>${item.description}: â‚±${item.amount}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Analyze cost data
        document.getElementById('analyzeCostData').addEventListener('click', async function() {
            addResult('Starting comprehensive cost data analysis...', 'info');
            
            try {
                if (!window.getComprehensiveCostData) {
                    throw new Error('Cost data analysis function not available');
                }
                
                const costData = await window.getComprehensiveCostData();
                
                addResult(`âœ… Analysis complete: Found â‚±${costData.totalCosts.toLocaleString()} in additional costs`, 'success');
                addResult(`ðŸ“Š Processed ${costData.deliveries.length} deliveries`, 'info');
                
                // Update displays
                updateCostSummary(costData);
                displaySampleDeliveries(costData.deliveries);
                
                // Show breakdown
                Object.entries(costData.costBreakdown).forEach(([category, amount]) => {
                    if (amount > 0) {
                        addResult(`ðŸ’° ${category}: â‚±${amount.toLocaleString()}`, 'success');
                    }
                });
                
                if (costData.totalCosts === 0) {
                    addResult('âš ï¸ No cost data found - this explains why analytics shows â‚±0', 'warning');
                    addResult('ðŸ’¡ Check if deliveries have cost fields: additionalCosts, additional_costs, or additionalCostItems', 'info');
                }
                
            } catch (error) {
                addResult(`âŒ Analysis failed: ${error.message}`, 'error');
                console.error('Cost analysis error:', error);
            }
        });
        
        // Test Supabase data
        document.getElementById('testSupabaseData').addEventListener('click', async function() {
            addResult('Testing Supabase data connection...', 'info');
            
            try {
                if (!window.dataService) {
                    throw new Error('DataService not available');
                }
                
                const deliveries = await window.dataService.getDeliveries();
                addResult(`âœ… Loaded ${deliveries.length} deliveries from Supabase`, 'success');
                
                const withCosts = deliveries.filter(d => 
                    (d.additionalCosts && d.additionalCosts > 0) || 
                    (d.additional_costs && d.additional_costs > 0) ||
                    (d.additionalCostItems && d.additionalCostItems.length > 0)
                );
                
                addResult(`ðŸ’° ${withCosts.length} deliveries have cost data`, withCosts.length > 0 ? 'success' : 'warning');
                
            } catch (error) {
                addResult(`âŒ Supabase test failed: ${error.message}`, 'error');
            }
        });
        
        // Test localStorage data
        document.getElementById('testLocalStorageData').addEventListener('click', function() {
            addResult('Testing localStorage data...', 'info');
            
            try {
                const activeDeliveries = JSON.parse(localStorage.getItem('mci-active-deliveries') || '[]');
                const deliveryHistory = JSON.parse(localStorage.getItem('mci-delivery-history') || '[]');
                const allDeliveries = [...activeDeliveries, ...deliveryHistory];
                
                addResult(`ðŸ“Š Found ${allDeliveries.length} deliveries in localStorage`, 'info');
                
                const withCosts = allDeliveries.filter(d => 
                    (d.additionalCosts && d.additionalCosts > 0) || 
                    (d.additional_costs && d.additional_costs > 0) ||
                    (d.additionalCostItems && d.additionalCostItems.length > 0)
                );
                
                addResult(`ðŸ’° ${withCosts.length} localStorage deliveries have cost data`, withCosts.length > 0 ? 'success' : 'warning');
                
            } catch (error) {
                addResult(`âŒ localStorage test failed: ${error.message}`, 'error');
            }
        });
        
        // Force analytics update
        document.getElementById('forceAnalyticsUpdate').addEventListener('click', function() {
            addResult('Forcing analytics update...', 'info');
            
            try {
                if (typeof window.updateCostBreakdownChart === 'function') {
                    window.updateCostBreakdownChart('month');
                    addResult('âœ… Cost breakdown chart update triggered', 'success');
                }
                
                if (typeof window.updateDashboardMetrics === 'function') {
                    window.updateDashboardMetrics();
                    addResult('âœ… Dashboard metrics update triggered', 'success');
                }
                
                addResult('ðŸ”„ Check your main analytics dashboard for updates', 'info');
                
            } catch (error) {
                addResult(`âŒ Analytics update failed: ${error.message}`, 'error');
            }
        });
        
        // Clear console
        document.getElementById('clearConsole').addEventListener('click', function() {
            analysisResults = [];
            updateResultsDisplay();
            console.clear();
            addResult('Console cleared', 'info');
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addResult('Cost Data Analysis Test initialized', 'success');
            addResult('Ready to analyze cost data connection', 'info');
            
            // Auto-run analysis after a delay
            setTimeout(() => {
                document.getElementById('analyzeCostData').click();
            }, 2000);
        });
    </script>
</body>
</html>