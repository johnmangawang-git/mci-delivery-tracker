<!DOCTYPE html>
<html>
<head>
    <title>Test Origin & Destination Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .coordinate-display { background: #e9ecef; padding: 8px; border-radius: 4px; font-family: monospace; }
        .map-pin-btn { background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 4px; }
        .map-pin-btn:hover { background: #5a2d91; }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Origin & Destination Fix Test</h1>
    
    <div class="section">
        <h2>Origin Selection Test</h2>
        <div class="mb-3">
            <label class="form-label">Origin Warehouse</label>
            <div class="input-group">
                <select class="form-select" id="originSelect">
                    <option value="" selected>Select warehouse</option>
                    <option value="alabang">SMEG Alabang warehouse</option>
                    <option value="cebu">SMEG Cebu warehouse</option>
                </select>
                <button type="button" class="btn map-pin-btn" id="pinOrigin">
                    <i class="bi bi-geo-alt"></i> Pin on Map
                </button>
            </div>
            <div class="form-text">
                Select from warehouse list or pin location on map
                <span id="originCoordinatesDisplay" class="text-muted ms-2 coordinate-display"></span>
            </div>
        </div>
        
        <div id="customOriginContainer" class="d-none mt-3">
            <label class="form-label">Custom Origin Location</label>
            <input type="text" class="form-control" id="customOrigin" placeholder="Selected location will appear here" readonly>
            <div class="form-text">Location selected from map</div>
        </div>
    </div>
    
    <div class="section">
        <h2>Destination Selection Test</h2>
        <div id="destinationAreasContainer">
            <div class="destination-area-item">
                <div class="input-group mb-2">
                    <input type="text" class="form-control destination-area-input" placeholder="Click to select location on map" required readonly style="cursor: pointer;">
                    <button type="button" class="btn map-pin-btn pin-on-map-btn" data-area-index="0">
                        <i class="bi bi-geo-alt"></i> Pin on Map
                    </button>
                    <button type="button" class="btn btn-outline-danger remove-area">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-outline-secondary mt-2" id="addAreaBtn">
            <i class="bi bi-plus-circle me-2"></i>Add Area
        </button>
        <div class="form-text">
            Click on the input field or Pin on Map button to select precise locations
            <div id="destinationCoordinatesDisplay" class="mt-2"></div>
        </div>
    </div>
    
    <div class="section">
        <h2>Distance Calculation Test</h2>
        <div class="mb-4">
            <label class="form-label">Calculated Distance</label>
            <div class="distance-box" id="calculatedDistance">
                <span id="distanceValue">-- km</span>
                <div class="distance-loading d-none">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Calculating...</span>
                    </div>
                    <span class="ms-2">Calculating distance...</span>
                </div>
            </div>
        </div>
        <button onclick="testDistanceCalculation()" class="btn btn-primary">Test Distance Calculation</button>
    </div>
    
    <div class="section">
        <h2>Debug Log</h2>
        <div id="debugLog" class="log"></div>
        <button onclick="clearLog()" class="btn btn-secondary">Clear Log</button>
        <button onclick="runAllTests()" class="btn btn-success">Run All Tests</button>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let debugLog = document.getElementById('debugLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\\n`;
            debugLog.textContent += logEntry;
            console.log(message);
            
            if (type === 'error') {
                debugLog.className = 'log error';
            } else if (type === 'success') {
                debugLog.className = 'log success';
            } else {
                debugLog.className = 'log';
            }
        }
        
        function clearLog() {
            debugLog.textContent = '';
            debugLog.className = 'log';
        }
        
        // Default warehouse coordinates
        const defaultWarehouses = {
            'alabang': { lat: 14.4378, lng: 121.0199, name: 'SMEG Alabang warehouse' },
            'cebu': { lat: 10.3157, lng: 123.8854, name: 'SMEG Cebu warehouse' }
        };
        
        // Test origin selection
        function testOriginSelection() {
            log('=== TESTING ORIGIN SELECTION ===');
            
            const originSelect = document.getElementById('originSelect');
            const originCoordinatesDisplay = document.getElementById('originCoordinatesDisplay');
            
            if (!originSelect || !originCoordinatesDisplay) {
                log('Origin elements not found', 'error');
                return;
            }
            
            // Test warehouse selection
            originSelect.value = 'alabang';
            const warehouse = defaultWarehouses['alabang'];
            if (warehouse) {
                originCoordinatesDisplay.textContent = `(${warehouse.lat.toFixed(6)}, ${warehouse.lng.toFixed(6)})`;
                log(`‚úÖ Alabang warehouse coordinates: ${warehouse.lat}, ${warehouse.lng}`, 'success');
            }
            
            // Test Cebu warehouse
            setTimeout(() => {
                originSelect.value = 'cebu';
                const cebuWarehouse = defaultWarehouses['cebu'];
                if (cebuWarehouse) {
                    originCoordinatesDisplay.textContent = `(${cebuWarehouse.lat.toFixed(6)}, ${cebuWarehouse.lng.toFixed(6)})`;
                    log(`‚úÖ Cebu warehouse coordinates: ${cebuWarehouse.lat}, ${cebuWarehouse.lng}`, 'success');
                }
            }, 1000);
        }
        
        // Test destination input
        function testDestinationInput() {
            log('=== TESTING DESTINATION INPUT ===');
            
            const destinationInput = document.querySelector('.destination-area-input');
            if (!destinationInput) {
                log('Destination input not found', 'error');
                return;
            }
            
            // Simulate location selection
            const testLocation = 'Makati City, Metro Manila, Philippines';
            const testLat = 14.5547;
            const testLng = 121.0244;
            
            destinationInput.value = testLocation;
            destinationInput.setAttribute('data-lat', testLat);
            destinationInput.setAttribute('data-lng', testLng);
            
            log(`‚úÖ Destination set: ${testLocation}`, 'success');
            log(`‚úÖ Coordinates: ${testLat}, ${testLng}`, 'success');
            
            // Update coordinates display
            const destinationCoordinatesDisplay = document.getElementById('destinationCoordinatesDisplay');
            if (destinationCoordinatesDisplay) {
                destinationCoordinatesDisplay.innerHTML = `
                    <div class="coordinate-display">
                        <strong>Destination 1:</strong> ${testLocation}<br>
                        <small>Coordinates: ${testLat.toFixed(6)}, ${testLng.toFixed(6)}</small>
                    </div>
                `;
            }
        }
        
        // Test distance calculation
        function testDistanceCalculation() {
            log('=== TESTING DISTANCE CALCULATION ===');
            
            // Get origin coordinates
            const originSelect = document.getElementById('originSelect');
            const originValue = originSelect.value;
            
            if (!originValue) {
                log('Please select an origin warehouse first', 'error');
                return;
            }
            
            const originWarehouse = defaultWarehouses[originValue];
            const destinationInput = document.querySelector('.destination-area-input');
            
            if (!destinationInput.value) {
                log('Please set a destination first', 'error');
                return;
            }
            
            const destLat = parseFloat(destinationInput.getAttribute('data-lat'));
            const destLng = parseFloat(destinationInput.getAttribute('data-lng'));
            
            if (!destLat || !destLng) {
                log('Destination coordinates not found', 'error');
                return;
            }
            
            // Calculate distance using Haversine formula
            const distance = calculateHaversineDistance(
                originWarehouse.lat, originWarehouse.lng,
                destLat, destLng
            );
            
            const distanceValue = document.getElementById('distanceValue');
            if (distanceValue) {
                distanceValue.textContent = `${distance.toFixed(1)} km`;
                log(`‚úÖ Distance calculated: ${distance.toFixed(1)} km`, 'success');
            }
        }
        
        // Haversine distance calculation
        function calculateHaversineDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Test pin on map buttons
        function testPinOnMapButtons() {
            log('=== TESTING PIN ON MAP BUTTONS ===');
            
            const pinOriginBtn = document.getElementById('pinOrigin');
            const pinDestinationBtn = document.querySelector('.pin-on-map-btn');
            
            if (pinOriginBtn) {
                log('‚úÖ Origin pin button found');
                pinOriginBtn.addEventListener('click', function() {
                    log('Origin pin button clicked - would open map modal');
                });
            } else {
                log('‚ùå Origin pin button not found', 'error');
            }
            
            if (pinDestinationBtn) {
                log('‚úÖ Destination pin button found');
                pinDestinationBtn.addEventListener('click', function() {
                    log('Destination pin button clicked - would open map modal');
                });
            } else {
                log('‚ùå Destination pin button not found', 'error');
            }
        }
        
        // Run all tests
        function runAllTests() {
            clearLog();
            log('üß™ Starting comprehensive origin/destination tests...');
            
            testOriginSelection();
            setTimeout(() => testDestinationInput(), 2000);
            setTimeout(() => testPinOnMapButtons(), 3000);
            setTimeout(() => {
                log('=== ALL TESTS COMPLETED ===', 'success');
                log('‚úÖ Origin warehouse selection working');
                log('‚úÖ Destination input working');
                log('‚úÖ Coordinate display working');
                log('‚úÖ Pin on Map buttons detected');
                log('Ready for distance calculation test');
            }, 4000);
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            log('Origin & Destination Fix Test Page Loaded');
            
            // Set up origin select event listener
            const originSelect = document.getElementById('originSelect');
            if (originSelect) {
                originSelect.addEventListener('change', function() {
                    const originCoordinatesDisplay = document.getElementById('originCoordinatesDisplay');
                    const customOriginContainer = document.getElementById('customOriginContainer');
                    
                    if (this.value === '') {
                        customOriginContainer.classList.remove('d-none');
                        if (originCoordinatesDisplay) {
                            originCoordinatesDisplay.textContent = '';
                        }
                    } else {
                        customOriginContainer.classList.add('d-none');
                        const warehouse = defaultWarehouses[this.value];
                        if (warehouse && originCoordinatesDisplay) {
                            originCoordinatesDisplay.textContent = `(${warehouse.lat.toFixed(6)}, ${warehouse.lng.toFixed(6)})`;
                        }
                    }
                });
            }
            
            // Auto-run tests after 1 second
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>"