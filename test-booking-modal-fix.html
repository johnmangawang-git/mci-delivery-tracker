<!DOCTYPE html>
<html>
<head>
    <title>Test Booking Modal Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .coordinate-display { background: #e9ecef; padding: 8px; border-radius: 4px; font-family: monospace; }
        .map-pin-btn { background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 4px; }
        .map-pin-btn:hover { background: #5a2d91; }
        .test-button { margin: 5px; }
    </style>
</head>
<body>
    <h1>🧪 Booking Modal Fix Test Suite</h1>
    
    <div class="section">
        <h2>Test Controls</h2>
        <button onclick="testOriginCoordinates()" class="btn btn-primary test-button">Test Origin Coordinates</button>
        <button onclick="testDestinationClick()" class="btn btn-success test-button">Test Destination Click</button>
        <button onclick="simulateBookingFlow()" class="btn btn-warning test-button">Simulate Full Booking Flow</button>
        <button onclick="clearLog()" class="btn btn-secondary test-button">Clear Log</button>
    </div>
    
    <!-- Simulated Booking Modal Elements -->
    <div class="section">
        <h2>Simulated Booking Modal</h2>
        
        <!-- Origin Section -->
        <div class="mb-4">
            <h5><i class="bi bi-geo-alt-fill"></i> Origin Details</h5>
            <div class="input-group">
                <select class="form-select" id="originSelect">
                    <option value="" selected>Select warehouse</option>
                    <option value="alabang">SMEG Alabang warehouse</option>
                    <option value="cebu">SMEG Cebu warehouse</option>
                </select>
                <button type="button" class="btn map-pin-btn" id="pinOrigin">
                    <i class="bi bi-geo-alt"></i> Pin on Map
                </button>
            </div>
            <div class="form-text">
                Select from warehouse list or pin location on map
                <span id="originCoordinatesDisplay" class="text-muted ms-2 coordinate-display"></span>
            </div>
        </div>
        
        <!-- Destination Section -->
        <div class="mb-4">
            <h5><i class="bi bi-map"></i> Destination Areas</h5>
            <div id="destinationAreasContainer">
                <div class="destination-area-item">
                    <div class="input-group mb-2">
                        <input type="text" class="form-control destination-area-input" 
                               placeholder="Click to select location on map" required readonly style="cursor: pointer;">
                        <button type="button" class="btn map-pin-btn pin-on-map-btn" data-area-index="0">
                            <i class="bi bi-geo-alt"></i> Pin on Map
                        </button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-outline-secondary mt-2" id="addAreaBtn">
                <i class="bi bi-plus-circle me-2"></i>Add Area
            </button>
        </div>
    </div>
    
    <div class="section">
        <h2>Debug Log</h2>
        <div id="debugLog" class="log"></div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let debugLog = document.getElementById('debugLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\\n`;
            debugLog.textContent += logEntry;
            console.log(message);
            
            if (type === 'error') {
                debugLog.className = 'log error';
            } else if (type === 'success') {
                debugLog.className = 'log success';
            } else {
                debugLog.className = 'log';
            }
            
            // Auto-scroll to bottom
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        function clearLog() {
            debugLog.textContent = '';
            debugLog.className = 'log';
        }
        
        // Mock warehouse manager
        window.warehouseManager = {
            warehouseLocations: [
                {
                    id: 'alabang',
                    name: 'SMEG Alabang warehouse',
                    coordinates: { lat: 14.4378, lng: 121.0199 }
                },
                {
                    id: 'cebu', 
                    name: 'SMEG Cebu warehouse',
                    coordinates: { lat: 10.3157, lng: 123.8854 }
                }
            ]
        };
        
        // Mock showMapPinDialog function
        function showMapPinDialog(type, index) {
            log(`🗺️ showMapPinDialog called: type=${type}, index=${index}`, 'success');
            
            // Simulate map dialog opening
            setTimeout(() => {
                if (type === 'destination') {
                    const input = document.querySelectorAll('.destination-area-input')[index];
                    if (input) {
                        input.value = 'Makati City, Metro Manila, Philippines';
                        input.setAttribute('data-lat', '14.5547');
                        input.setAttribute('data-lng', '121.0244');
                        log(`✅ Destination ${index} set to: Makati City`, 'success');
                    }
                } else if (type === 'origin') {
                    const customOrigin = document.getElementById('customOrigin');
                    if (customOrigin) {
                        customOrigin.value = 'Custom Location, Philippines';
                        log('✅ Custom origin location set', 'success');
                    }
                }
            }, 1000);
        }
        
        // Test origin coordinates display
        function testOriginCoordinates() {
            log('=== TESTING ORIGIN COORDINATES ===');
            
            const originSelect = document.getElementById('originSelect');
            const originCoordinatesDisplay = document.getElementById('originCoordinatesDisplay');
            
            if (!originSelect || !originCoordinatesDisplay) {
                log('❌ Origin elements not found', 'error');
                return;
            }
            
            // Test Alabang selection
            log('Testing Alabang warehouse selection...');
            originSelect.value = 'alabang';
            originSelect.dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                // Test Cebu selection
                log('Testing Cebu warehouse selection...');
                originSelect.value = 'cebu';
                originSelect.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    log('✅ Origin coordinates test completed', 'success');
                }, 1000);
            }, 1000);
        }
        
        // Test destination click functionality
        function testDestinationClick() {
            log('=== TESTING DESTINATION CLICK ===');
            
            const destinationInput = document.querySelector('.destination-area-input');
            if (!destinationInput) {
                log('❌ Destination input not found', 'error');
                return;
            }
            
            log('Testing destination input focus...');
            destinationInput.focus();
            
            setTimeout(() => {
                log('Testing destination input click...');
                destinationInput.click();
                
                setTimeout(() => {
                    log('✅ Destination click test completed', 'success');
                }, 1000);
            }, 1000);
        }
        
        // Simulate full booking flow
        function simulateBookingFlow() {
            log('=== SIMULATING FULL BOOKING FLOW ===');
            
            // Step 1: Select origin
            log('Step 1: Selecting origin warehouse...');
            const originSelect = document.getElementById('originSelect');
            originSelect.value = 'alabang';
            originSelect.dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                // Step 2: Click destination
                log('Step 2: Clicking destination input...');
                const destinationInput = document.querySelector('.destination-area-input');
                destinationInput.focus();
                
                setTimeout(() => {
                    // Step 3: Add another destination
                    log('Step 3: Adding another destination area...');
                    const addAreaBtn = document.getElementById('addAreaBtn');
                    if (addAreaBtn) {
                        addAreaBtn.click();
                        
                        setTimeout(() => {
                            log('✅ Full booking flow simulation completed', 'success');
                            log('📊 Summary:');
                            log('  - Origin coordinates should display');
                            log('  - Destination inputs should open map on click');
                            log('  - Additional areas can be added');
                        }, 1000);
                    }
                }, 2000);
            }, 1000);
        }
        
        // Initialize the booking modal functionality
        function initBookingModal() {
            log('=== INITIALIZING BOOKING MODAL ===');
            
            // Origin selection event listener
            const originSelect = document.getElementById('originSelect');
            if (originSelect) {
                originSelect.addEventListener('change', function() {
                    const originCoordinatesDisplay = document.getElementById('originCoordinatesDisplay');
                    
                    if (this.value && originCoordinatesDisplay) {
                        const warehouse = window.warehouseManager.warehouseLocations.find(w => w.id === this.value);
                        if (warehouse) {
                            const coordText = `(${warehouse.coordinates.lat.toFixed(6)}, ${warehouse.coordinates.lng.toFixed(6)})`;
                            originCoordinatesDisplay.textContent = coordText;
                            log(`✅ Origin coordinates displayed: ${coordText}`, 'success');
                        }
                    } else if (originCoordinatesDisplay) {
                        originCoordinatesDisplay.textContent = '';
                    }
                });
                log('✅ Origin select event listener attached');
            }
            
            // Destination input event listeners
            document.querySelectorAll('.destination-area-input').forEach((input, index) => {
                input.addEventListener('focus', function() {
                    log(`🗺️ Destination input ${index} focused - opening map dialog`);
                    showMapPinDialog('destination', index);
                });
                
                input.addEventListener('click', function() {
                    log(`🗺️ Destination input ${index} clicked - opening map dialog`);
                    showMapPinDialog('destination', index);
                });
                
                log(`✅ Destination input ${index} event listeners attached`);
            });
            
            // Pin on Map button event listeners
            document.querySelectorAll('.pin-on-map-btn').forEach((btn, index) => {
                btn.addEventListener('click', function() {
                    const areaIndex = parseInt(this.dataset.areaIndex) || index;
                    log(`🗺️ Pin on Map button clicked for area ${areaIndex}`);
                    showMapPinDialog('destination', areaIndex);
                });
                log(`✅ Pin on Map button ${index} event listener attached`);
            });
            
            // Add Area button
            const addAreaBtn = document.getElementById('addAreaBtn');
            if (addAreaBtn) {
                addAreaBtn.addEventListener('click', function() {
                    log('➕ Add Area button clicked');
                    // Simulate adding a new area
                    const container = document.getElementById('destinationAreasContainer');
                    const newIndex = container.children.length;
                    
                    const newArea = document.createElement('div');
                    newArea.className = 'destination-area-item';
                    newArea.innerHTML = `
                        <div class="input-group mb-2">
                            <input type="text" class="form-control destination-area-input" 
                                   placeholder="Click to select location on map" required readonly style="cursor: pointer;">
                            <button type="button" class="btn map-pin-btn pin-on-map-btn" data-area-index="${newIndex}">
                                <i class="bi bi-geo-alt"></i> Pin on Map
                            </button>
                        </div>
                    `;
                    container.appendChild(newArea);
                    
                    // Attach event listeners to new elements
                    const newInput = newArea.querySelector('.destination-area-input');
                    const newBtn = newArea.querySelector('.pin-on-map-btn');
                    
                    newInput.addEventListener('focus', () => {
                        log(`🗺️ New destination input ${newIndex} focused`);
                        showMapPinDialog('destination', newIndex);
                    });
                    
                    newInput.addEventListener('click', () => {
                        log(`🗺️ New destination input ${newIndex} clicked`);
                        showMapPinDialog('destination', newIndex);
                    });
                    
                    newBtn.addEventListener('click', () => {
                        log(`🗺️ New Pin on Map button ${newIndex} clicked`);
                        showMapPinDialog('destination', newIndex);
                    });
                    
                    log(`✅ New destination area ${newIndex} added with event listeners`);
                });
                log('✅ Add Area button event listener attached');
            }
            
            log('✅ Booking modal initialization completed');
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            log('🧪 Booking Modal Fix Test Suite Loaded');
            log('Initializing booking modal functionality...');
            
            initBookingModal();
            
            setTimeout(() => {
                log('🚀 Ready for testing!');
                log('Click the test buttons above to verify functionality');
            }, 500);
        });
    </script>
</body>
</html>"