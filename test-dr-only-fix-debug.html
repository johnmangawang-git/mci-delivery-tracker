<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DR-Only Group Signature - Debug Fix Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="bi bi-bug text-danger"></i> DR-Only Group Signature - Debug Fix</h2>
        <p class="lead">Testing the fix for: All DRs marked complete but only 1 moves to history</p>
        
        <div class="alert alert-info">
            <strong>Issue:</strong> All identical DRs are tagged as completed, but only 1 DR moves to Delivery History (rest disappear).<br>
            <strong>Fix:</strong> Batch removal from active deliveries + prevent duplicate history entries
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="bi bi-exclamation-triangle"></i> Debug Test</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Test Scenario:</strong> 3 identical DR-001 deliveries</p>
                        <ul>
                            <li>DR-001, Serial: SN-001</li>
                            <li>DR-001, Serial: SN-002</li>
                            <li>DR-001, Serial: SN-003</li>
                        </ul>
                        
                        <button class="btn btn-primary" onclick="setupDebugData()">
                            <i class="bi bi-database-add"></i> Setup Debug Data
                        </button>
                        <button class="btn btn-danger" onclick="testDRSignature()">
                            <i class="bi bi-pen"></i> Sign DR-001 (Test Fix)
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-check-circle"></i> Expected Result</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>After signing DR-001:</strong></p>
                        <ul>
                            <li>‚úÖ Active Deliveries: 0 (all removed)</li>
                            <li>‚úÖ Delivery History: 3 (all 3 DRs moved)</li>
                            <li>‚úÖ No deliveries disappear</li>
                        </ul>
                        <div id="debugResult"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list"></i> Active Deliveries</h5>
                        <span class="badge bg-primary" id="activeCountBadge">0</span>
                    </div>
                    <div class="card-body">
                        <div id="activeDeliveriesList">
                            <p class="text-muted">No active deliveries</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-clock-history"></i> Delivery History</h5>
                        <span class="badge bg-success" id="historyCountBadge">0</span>
                    </div>
                    <div class="card-body">
                        <div id="deliveryHistoryList">
                            <p class="text-muted">No completed deliveries</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="bi bi-terminal"></i> Debug Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugLog" class="bg-dark text-light p-3" style="font-family: monospace; height: 400px; overflow-y: auto;">
                            <!-- Debug log will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/enhanced-group-signature-dr-only.js"></script>
    
    <script>
        // Debug test data: 3 identical DR-001 deliveries
        let debugDeliveries = [
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-001',
                customerName: 'Debug Customer A',
                mobileNumber: '09171111111',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Manila Office'
            },
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-002',
                customerName: 'Debug Customer B',
                mobileNumber: '09172222222',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Cebu Office'
            },
            {
                drNumber: 'DR-001',
                serialNumber: 'SN-003',
                customerName: 'Debug Customer C',
                mobileNumber: '09173333333',
                status: 'Active',
                origin: 'SMEG Alabang',
                destination: 'Davao Office'
            }
        ];
        
        // Capture console output for debugging
        const originalConsoleLog = console.log;
        const debugLog = document.getElementById('debugLog');
        
        function addToDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'lightblue',
                success: 'lightgreen',
                warning: 'orange',
                error: 'lightcoral'
            };
            const color = colors[type] || 'lightblue';
            debugLog.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToDebugLog(args.join(' '), 'info');
        };
        
        function setupDebugData() {
            addToDebugLog('üêõ Setting up debug data for DR-Only fix test...', 'info');
            
            // Reset global arrays
            window.activeDeliveries = [...debugDeliveries];
            window.deliveryHistory = [];
            
            addToDebugLog(`‚úÖ Debug data setup: ${debugDeliveries.length} active deliveries`, 'success');
            
            updateDebugDisplay();
            showDebugResult('Debug data setup complete. Ready to test DR-Only fix.', 'info');
        }
        
        function updateDebugDisplay() {
            const activeCount = window.activeDeliveries ? window.activeDeliveries.length : 0;
            const historyCount = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            // Update badges
            document.getElementById('activeCountBadge').textContent = activeCount;
            document.getElementById('historyCountBadge').textContent = historyCount;
            
            // Update active deliveries list
            const activeList = document.getElementById('activeDeliveriesList');
            if (activeCount === 0) {
                activeList.innerHTML = '<p class="text-muted">No active deliveries</p>';
            } else {
                activeList.innerHTML = window.activeDeliveries.map(d => 
                    `<div class="border p-2 mb-2">
                        <strong>${d.drNumber}</strong> - Serial: ${d.serialNumber}<br>
                        <small>Customer: ${d.customerName}</small>
                    </div>`
                ).join('');
            }
            
            // Update history list
            const historyList = document.getElementById('deliveryHistoryList');
            if (historyCount === 0) {
                historyList.innerHTML = '<p class="text-muted">No completed deliveries</p>';
            } else {
                historyList.innerHTML = window.deliveryHistory.map(d => 
                    `<div class="border border-success p-2 mb-2">
                        <strong>${d.drNumber}</strong> - Serial: ${d.serialNumber}<br>
                        <small>Customer: ${d.customerName}</small><br>
                        <small class="text-success">Method: ${d.completionMethod || 'Manual'}</small>
                    </div>`
                ).join('');
            }
        }
        
        function testDRSignature() {
            addToDebugLog('üêõ Testing DR-001 signature with fix...', 'warning');
            
            if (!window.activeDeliveries || window.activeDeliveries.length === 0) {
                addToDebugLog('‚ùå No debug data available. Please setup debug data first.', 'error');
                showDebugResult('Please setup debug data first before testing.', 'danger');
                return;
            }
            
            const beforeActive = window.activeDeliveries.length;
            const beforeHistory = window.deliveryHistory ? window.deliveryHistory.length : 0;
            
            addToDebugLog(`üìä BEFORE: Active=${beforeActive}, History=${beforeHistory}`, 'info');
            
            // Test the enhanced DR-only signature
            if (typeof window.enhancedUpdateDeliveryStatusDROnly === 'function') {
                window.enhancedUpdateDeliveryStatusDROnly('DR-001', 'Completed');
                
                // Check results after a short delay
                setTimeout(() => {
                    const afterActive = window.activeDeliveries.length;
                    const afterHistory = window.deliveryHistory ? window.deliveryHistory.length : 0;
                    
                    addToDebugLog(`üìä AFTER: Active=${afterActive}, History=${afterHistory}`, 'info');
                    
                    updateDebugDisplay();
                    analyzeDebugResults(beforeActive, beforeHistory, afterActive, afterHistory);
                }, 500);
                
            } else {
                addToDebugLog('‚ùå Enhanced DR-only function not available', 'error');
                showDebugResult('Error: DR-Only function not loaded', 'danger');
            }
        }
        
        function analyzeDebugResults(beforeActive, beforeHistory, afterActive, afterHistory) {
            addToDebugLog('üîç ANALYZING DEBUG RESULTS:', 'info');
            
            const activeChange = beforeActive - afterActive;
            const historyChange = afterHistory - beforeHistory;
            
            addToDebugLog(`  Active deliveries removed: ${activeChange}`, 'info');
            addToDebugLog(`  History deliveries added: ${historyChange}`, 'info');
            
            // Expected: 3 removed from active, 3 added to history
            if (activeChange === 3 && historyChange === 3 && afterActive === 0) {
                addToDebugLog('‚úÖ FIX SUCCESSFUL: All 3 deliveries moved correctly!', 'success');
                showDebugResult('‚úÖ FIX SUCCESSFUL: All 3 DR-001 deliveries moved to history correctly!', 'success');
            } else if (activeChange === 3 && historyChange < 3) {
                addToDebugLog(`‚ùå PARTIAL FIX: ${activeChange} removed but only ${historyChange} in history`, 'error');
                showDebugResult(`‚ùå PARTIAL FIX: ${activeChange} removed but only ${historyChange} in history`, 'warning');
            } else {
                addToDebugLog(`‚ùå FIX FAILED: Unexpected results - Active: ${activeChange}, History: ${historyChange}`, 'error');
                showDebugResult(`‚ùå FIX FAILED: Unexpected results`, 'danger');
            }
        }
        
        function showDebugResult(message, type) {
            const resultDiv = document.getElementById('debugResult');
            resultDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addToDebugLog('DR-Only Group Signature Debug Test loaded', 'info');
            showDebugResult('Debug test ready. Click "Setup Debug Data" to begin.', 'info');
            updateDebugDisplay();
        });
    </script>
</body>
</html>