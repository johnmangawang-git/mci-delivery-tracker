<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Upload Debug Console</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            padding: 20px; 
            background-color: #1e1e1e; 
            color: #d4d4d4; 
        }
        .console { 
            background-color: #2d2d30; 
            border: 1px solid #3e3e42; 
            border-radius: 5px; 
            padding: 15px; 
            height: 80vh; 
            overflow-y: auto; 
            font-size: 12px; 
            line-height: 1.4;
        }
        .log-entry { 
            margin: 2px 0; 
            padding: 2px 5px; 
            border-radius: 3px;
        }
        .step { color: #4fc3f7; }
        .data { color: #81c784; }
        .error { color: #f48fb1; background-color: rgba(244, 143, 177, 0.1); }
        .success { color: #a5d6a7; background-color: rgba(165, 214, 167, 0.1); }
        .warning { color: #ffb74d; background-color: rgba(255, 183, 77, 0.1); }
        .controls { 
            margin-bottom: 20px; 
            padding: 10px; 
            background-color: #2d2d30; 
            border-radius: 5px; 
        }
        button { 
            background-color: #0e639c; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            margin: 5px; 
            border-radius: 3px; 
            cursor: pointer; 
        }
        button:hover { background-color: #1177bb; }
        .status { 
            display: inline-block; 
            padding: 4px 8px; 
            border-radius: 3px; 
            margin-left: 10px; 
        }
        .status.active { background-color: #4caf50; color: white; }
        .status.inactive { background-color: #757575; color: white; }
        .header { 
            color: #569cd6; 
            font-size: 18px; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        .instructions {
            background-color: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            color: #d4d4d4;
        }
    </style>
</head>
<body>
    <div class="header">📊 Excel Upload Debug Console</div>
    
    <div class="instructions">
        <strong>Instructions:</strong>
        <ol>
            <li>Keep this console open while testing Excel uploads</li>
            <li>Go to your main app and upload an Excel file</li>
            <li>Watch this console for real-time debug information</li>
            <li>Look for customer creation steps and any errors</li>
        </ol>
    </div>
    
    <div class="controls">
        <button onclick="clearConsole()">Clear Console</button>
        <button onclick="checkStatus()">Check Status</button>
        <button onclick="forceCheck()">Force Check Data</button>
        <button onclick="exportLogs()">Export Logs</button>
        <span class="status" id="monitoringStatus">Initializing...</span>
    </div>
    
    <div class="console" id="debugConsole">
        <div class="log-entry step">🔧 Excel Upload Debug Console Starting...</div>
        <div class="log-entry data">Waiting for Excel upload activity...</div>
    </div>

    <script>
        let logCount = 0;
        let monitoring = false;
        
        function addLog(message, type = 'step') {
            const console = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            console.appendChild(logEntry);
            console.scrollTop = console.scrollHeight;
            logCount++;
        }
        
        function clearConsole() {
            document.getElementById('debugConsole').innerHTML = '';
            logCount = 0;
            addLog('Console cleared', 'step');
        }
        
        function checkStatus() {
            addLog('🔍 Checking system status...', 'step');
            
            // Check if main app functions are available
            const functions = [
                'startExcelDebugMonitoring',
                'getExcelDebugReport',
                'autoCreateCustomer',
                'enhancedAutoCreateCustomer',
                'supabaseOnlyLoadCustomers'
            ];
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    addLog(`✅ ${funcName}: Available`, 'success');
                } else {
                    addLog(`❌ ${funcName}: Not Available`, 'error');
                }
            });
            
            // Check global variables
            const vars = ['pendingDRBookings', 'activeDeliveries', 'customers'];
            vars.forEach(varName => {
                if (window[varName]) {
                    if (Array.isArray(window[varName])) {
                        addLog(`📊 ${varName}: ${window[varName].length} items`, 'data');
                    } else {
                        addLog(`📊 ${varName}: ${typeof window[varName]}`, 'data');
                    }
                } else {
                    addLog(`📊 ${varName}: Not found`, 'warning');
                }
            });
        }
        
        function forceCheck() {
            addLog('🔄 Force checking for processed data...', 'step');
            
            if (typeof window.checkForProcessedData === 'function') {
                window.checkForProcessedData();
                addLog('✅ Force check completed', 'success');
            } else {
                addLog('❌ checkForProcessedData function not available', 'error');
            }
            
            if (typeof window.checkForCustomerCreation === 'function') {
                window.checkForCustomerCreation();
                addLog('✅ Customer creation check completed', 'success');
            } else {
                addLog('❌ checkForCustomerCreation function not available', 'error');
            }
        }
        
        function exportLogs() {
            const logs = document.querySelectorAll('.log-entry');
            let logText = 'Excel Upload Debug Logs\n';
            logText += '========================\n\n';
            
            logs.forEach(log => {
                logText += log.textContent + '\n';
            });
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `excel-debug-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('📄 Logs exported to file', 'success');
        }
        
        function updateStatus(active) {
            const statusEl = document.getElementById('monitoringStatus');
            if (active) {
                statusEl.textContent = 'Monitoring Active';
                statusEl.className = 'status active';
                monitoring = true;
            } else {
                statusEl.textContent = 'Monitoring Inactive';
                statusEl.className = 'status inactive';
                monitoring = false;
            }
        }
        
        // Monitor for debug steps from the main app
        function monitorDebugSteps() {
            if (window.excelDebugSteps && Array.isArray(window.excelDebugSteps)) {
                const currentLength = window.excelDebugSteps.length;
                const lastLength = window.lastDebugStepsLength || 0;
                
                if (currentLength > lastLength) {
                    // New debug steps added
                    for (let i = lastLength; i < currentLength; i++) {
                        const step = window.excelDebugSteps[i];
                        let type = 'step';
                        
                        if (step.step.includes('ERROR') || step.step.includes('FAILED')) {
                            type = 'error';
                        } else if (step.step.includes('SUCCESS') || step.step.includes('CREATED')) {
                            type = 'success';
                        } else if (step.step.includes('FOUND') || step.step.includes('DATA')) {
                            type = 'data';
                        } else if (step.step.includes('WARNING') || step.step.includes('NO_')) {
                            type = 'warning';
                        }
                        
                        let message = `${step.step}`;
                        if (step.data) {
                            message += `: ${typeof step.data === 'object' ? JSON.stringify(step.data) : step.data}`;
                        }
                        
                        addLog(message, type);
                    }
                    
                    window.lastDebugStepsLength = currentLength;
                    updateStatus(true);
                }
            }
        }
        
        // Start monitoring
        function startMonitoring() {
            addLog('🔧 Starting debug monitoring...', 'step');
            updateStatus(true);
            
            // Check for debug steps every 500ms
            setInterval(monitorDebugSteps, 500);
            
            // Check status every 5 seconds
            setInterval(() => {
                if (monitoring) {
                    // Check if we're still getting updates
                    const lastUpdate = window.lastDebugStepsLength || 0;
                    const currentUpdate = window.excelDebugSteps ? window.excelDebugSteps.length : 0;
                    
                    if (currentUpdate === lastUpdate && logCount > 10) {
                        // No new updates, but don't spam the console
                    }
                }
            }, 5000);
        }
        
        // Initialize
        setTimeout(() => {
            addLog('✅ Debug console initialized', 'success');
            addLog('📋 Upload an Excel file in your main app to see debug information', 'data');
            startMonitoring();
        }, 1000);
    </script>
</body>
</html>