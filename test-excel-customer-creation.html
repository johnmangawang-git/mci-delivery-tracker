<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Excel Customer Creation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .customer-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .customer-form input { padding: 5px; }
        .full-width { grid-column: 1 / -1; }
    </style>
</head>
<body>
    <h1>üìä Excel Customer Creation Test</h1>
    
    <div class="test-section info">
        <h3>Test Purpose</h3>
        <p>This page tests that customers are properly created and saved to Supabase when uploading Excel files.</p>
        <div id="systemStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üîç System Check</h3>
        <button onclick="checkSystemStatus()">Check System Status</button>
        <button onclick="testAutoCreateFunction()">Test Auto-Create Function</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h3>üß™ Simulate Excel Customer Creation</h3>
        <p>This simulates what happens when you upload an Excel file with customer data:</p>
        <div class="customer-form">
            <input type="text" id="testCustomerName" placeholder="Customer Name" value="Excel Test Customer">
            <input type="text" id="testVendorNumber" placeholder="Vendor Number" value="+63 917 888 9999">
            <input type="text" id="testDestination" placeholder="Destination" value="Excel Test Destination" class="full-width">
            <button onclick="simulateExcelCustomerCreation()" class="full-width">Simulate Excel Customer Creation</button>
        </div>
        <div id="simulationResults"></div>
    </div>
    
    <div class="test-section">
        <h3>üìä Current Customers</h3>
        <button onclick="loadAndShowCustomers()">Load & Show Customers</button>
        <button onclick="clearAllCustomers()">Clear All Customers</button>
        <div id="customersList"></div>
    </div>
    
    <div class="test-section">
        <h3>üìù Test Log</h3>
        <div id="testLog" class="log"></div>
    </div>

    <!-- Load required scripts in correct order -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="public/assets/js/supabase.js"></script>
    <script src="public/assets/js/dataService.js"></script>
    <script src="public/assets/js/customer-field-mapping-fix.js"></script>
    <script src="public/assets/js/booking-customer-integration-fix.js"></script>
    <script src="public/assets/js/supabase-only-customer-fix.js"></script>
    
    <script>
        // Test logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<span style="color: ${colorMap[type] || '#333'}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        // Check system status
        function checkSystemStatus() {
            log('üîç Checking system status for Excel customer creation...', 'info');
            
            const systemStatus = document.getElementById('systemStatus');
            let statusHtml = '<h4>System Status:</h4><ul>';
            
            // Check required functions
            const requiredFunctions = [
                { name: 'autoCreateCustomer', desc: 'Main function called by Excel upload' },
                { name: 'enhancedAutoCreateCustomer', desc: 'Enhanced version with Supabase integration' },
                { name: 'supabaseOnlyLoadCustomers', desc: 'Supabase-only customer loading' },
                { name: 'dataService.saveCustomer', desc: 'Supabase customer saving', check: () => window.dataService && typeof window.dataService.saveCustomer === 'function' },
                { name: 'dataService.getCustomers', desc: 'Supabase customer loading', check: () => window.dataService && typeof window.dataService.getCustomers === 'function' }
            ];
            
            requiredFunctions.forEach(func => {
                let available;
                if (func.check) {
                    available = func.check();
                } else {
                    available = typeof window[func.name] === 'function';
                }
                
                const status = available ? '‚úÖ' : '‚ùå';
                const color = available ? 'green' : 'red';
                statusHtml += `<li style="color: ${color}">${status} ${func.name}: ${func.desc}</li>`;
                log(`${func.name}: ${available ? 'Available' : 'Not Available'}`, available ? 'success' : 'error');
            });
            
            statusHtml += '</ul>';
            
            // Check fixes loaded
            statusHtml += '<h5>Fixes Loaded:</h5><ul>';
            const fixes = [
                { name: 'customerFieldMappingFix', desc: 'Field normalization' },
                { name: 'bookingCustomerIntegrationFix', desc: 'Booking integration' },
                { name: 'supabaseOnlyCustomerFix', desc: 'Supabase-only data' }
            ];
            
            fixes.forEach(fix => {
                const available = typeof window[fix.name] !== 'undefined';
                const status = available ? '‚úÖ' : '‚ùå';
                const color = available ? 'green' : 'red';
                statusHtml += `<li style="color: ${color}">${status} ${fix.name}: ${fix.desc}</li>`;
                log(`${fix.name}: ${available ? 'Loaded' : 'Not Loaded'}`, available ? 'success' : 'error');
            });
            
            statusHtml += '</ul>';
            systemStatus.innerHTML = statusHtml;
        }
        
        // Test the auto-create function directly
        async function testAutoCreateFunction() {
            log('üß™ Testing autoCreateCustomer function directly...', 'info');
            
            const testData = {
                customerName: 'Direct Test Customer',
                vendorNumber: '+63 917 777 8888',
                destination: 'Direct Test Destination'
            };
            
            try {
                if (typeof window.autoCreateCustomer === 'function') {
                    log('üîÑ Calling autoCreateCustomer function...', 'info');
                    log(`üìù Input: ${JSON.stringify(testData)}`, 'info');
                    
                    const result = await window.autoCreateCustomer(
                        testData.customerName,
                        testData.vendorNumber,
                        testData.destination
                    );
                    
                    if (result) {
                        log('‚úÖ autoCreateCustomer test PASSED', 'success');
                        log(`üìù Result: ${JSON.stringify({
                            id: result.id,
                            name: result.contactPerson || result.name,
                            phone: result.phone,
                            address: result.address
                        })}`, 'success');
                        
                        // Check if it was saved to Supabase
                        setTimeout(async () => {
                            try {
                                if (window.dataService && window.dataService.getCustomers) {
                                    const customers = await window.dataService.getCustomers();
                                    const found = customers.find(c => c.phone === testData.vendorNumber);
                                    if (found) {
                                        log('‚úÖ Customer found in Supabase database', 'success');
                                    } else {
                                        log('‚ö†Ô∏è Customer NOT found in Supabase database', 'warning');
                                    }
                                }
                            } catch (error) {
                                log(`‚ùå Error checking Supabase: ${error.message}`, 'error');
                            }
                        }, 2000);
                        
                    } else {
                        log('‚ùå autoCreateCustomer test FAILED - no result returned', 'error');
                    }
                } else {
                    log('‚ùå autoCreateCustomer function not available', 'error');
                }
            } catch (error) {
                log(`‚ùå autoCreateCustomer test ERROR: ${error.message}`, 'error');
            }
        }
        
        // Simulate Excel customer creation
        async function simulateExcelCustomerCreation() {
            log('üìä Simulating Excel customer creation process...', 'info');
            
            const customerName = document.getElementById('testCustomerName').value;
            const vendorNumber = document.getElementById('testVendorNumber').value;
            const destination = document.getElementById('testDestination').value;
            
            if (!customerName || !vendorNumber || !destination) {
                log('‚ùå Please fill in all fields', 'error');
                return;
            }
            
            const simulationResults = document.getElementById('simulationResults');
            simulationResults.innerHTML = '<p>üîÑ Creating customer...</p>';
            
            try {
                log('üìù Simulating Excel upload with customer data...', 'info');
                log(`Customer: ${customerName}, Phone: ${vendorNumber}, Destination: ${destination}`, 'info');
                
                // This is what happens when Excel is uploaded
                if (typeof window.autoCreateCustomer === 'function') {
                    const customer = await window.autoCreateCustomer(customerName, vendorNumber, destination);
                    
                    if (customer) {
                        simulationResults.innerHTML = `
                            <div class="success" style="padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <h5>‚úÖ Customer Created Successfully!</h5>
                                <p><strong>ID:</strong> ${customer.id}</p>
                                <p><strong>Name:</strong> ${customer.contactPerson || customer.name}</p>
                                <p><strong>Phone:</strong> ${customer.phone}</p>
                                <p><strong>Address:</strong> ${customer.address}</p>
                                <p><strong>Notes:</strong> ${customer.notes}</p>
                            </div>
                        `;
                        
                        log('‚úÖ Excel customer creation simulation SUCCESSFUL', 'success');
                        
                        // Verify it's in Supabase
                        setTimeout(async () => {
                            try {
                                await loadAndShowCustomers();
                            } catch (error) {
                                log('Error refreshing customer list', 'error');
                            }
                        }, 1000);
                        
                    } else {
                        simulationResults.innerHTML = `
                            <div class="error" style="padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <h5>‚ùå Customer Creation Failed</h5>
                                <p>No customer object returned</p>
                            </div>
                        `;
                        log('‚ùå Excel customer creation simulation FAILED', 'error');
                    }
                } else {
                    simulationResults.innerHTML = `
                        <div class="error" style="padding: 10px; border-radius: 5px; margin-top: 10px;">
                            <h5>‚ùå Function Not Available</h5>
                            <p>autoCreateCustomer function not found</p>
                        </div>
                    `;
                    log('‚ùå autoCreateCustomer function not available', 'error');
                }
                
            } catch (error) {
                simulationResults.innerHTML = `
                    <div class="error" style="padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <h5>‚ùå Error Creating Customer</h5>
                        <p>${error.message}</p>
                    </div>
                `;
                log(`‚ùå Error in Excel customer creation: ${error.message}`, 'error');
            }
        }
        
        // Load and show current customers
        async function loadAndShowCustomers() {
            log('üìä Loading and showing current customers...', 'info');
            
            const customersList = document.getElementById('customersList');
            customersList.innerHTML = '<p>üîÑ Loading customers...</p>';
            
            try {
                // Load customers using Supabase-only function
                if (typeof window.supabaseOnlyLoadCustomers === 'function') {
                    const customers = await window.supabaseOnlyLoadCustomers();
                    
                    if (customers && customers.length > 0) {
                        let customersHtml = '<h4>Current Customers:</h4><table><tr><th>ID</th><th>Name</th><th>Phone</th><th>Address</th><th>Notes</th></tr>';
                        
                        customers.forEach(customer => {
                            customersHtml += `
                                <tr>
                                    <td>${customer.id}</td>
                                    <td>${customer.contactPerson || customer.name}</td>
                                    <td>${customer.phone}</td>
                                    <td>${customer.address}</td>
                                    <td>${customer.notes || 'N/A'}</td>
                                </tr>
                            `;
                        });
                        
                        customersHtml += '</table>';
                        customersList.innerHTML = customersHtml;
                        
                        log(`‚úÖ Loaded ${customers.length} customers from Supabase`, 'success');
                    } else {
                        customersList.innerHTML = '<p>No customers found in database.</p>';
                        log('üìä No customers found in Supabase', 'info');
                    }
                } else {
                    customersList.innerHTML = '<p>‚ùå Customer loading function not available</p>';
                    log('‚ùå supabaseOnlyLoadCustomers function not available', 'error');
                }
            } catch (error) {
                customersList.innerHTML = `<p>‚ùå Error loading customers: ${error.message}</p>`;
                log(`‚ùå Error loading customers: ${error.message}`, 'error');
            }
        }
        
        // Clear all customers
        async function clearAllCustomers() {
            if (!confirm('Are you sure you want to clear ALL customers from the database?')) {
                return;
            }
            
            log('üóëÔ∏è Clearing all customers...', 'info');
            
            try {
                if (typeof window.clearAllCustomerData === 'function') {
                    await window.clearAllCustomerData();
                    log('‚úÖ All customers cleared', 'success');
                    
                    // Refresh the display
                    setTimeout(loadAndShowCustomers, 1000);
                } else {
                    log('‚ùå clearAllCustomerData function not available', 'error');
                }
            } catch (error) {
                log(`‚ùå Error clearing customers: ${error.message}`, 'error');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                log('üîß Excel Customer Creation Test initialized', 'info');
                checkSystemStatus();
                setTimeout(loadAndShowCustomers, 2000);
            }, 1000);
        });
    </script>
</body>
</html>