<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Manual Booking Freeze</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .log-container {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-height: 500px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .step { color: #007bff; }
        .real-time-monitor {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 10px;
            z-index: 9999;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üêõ Debug Manual Booking Freeze</h1>
        <p>Comprehensive debugging tool to trace the manual booking freeze issue</p>

        <!-- Real-time Monitor -->
        <div id="realTimeMonitor" class="real-time-monitor">
            <div><strong>Real-time Monitor</strong></div>
            <div id="monitorContent">Monitoring...</div>
        </div>

        <!-- Debug Controls -->
        <div class="debug-section">
            <h3>üõ†Ô∏è Debug Controls</h3>
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-primary me-2 mb-2" onclick="startRealTimeMonitoring()">üìä Start Real-time Monitoring</button>
                    <button class="btn btn-success me-2 mb-2" onclick="simulateManualBooking()">üìã Simulate Manual Booking</button>
                    <button class="btn btn-info me-2 mb-2" onclick="traceBookingFlow()">üîç Trace Booking Flow</button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning me-2 mb-2" onclick="checkActiveDeliveries()">üì¶ Check Active Deliveries</button>
                    <button class="btn btn-secondary me-2 mb-2" onclick="emergencyCleanup()">üö® Emergency Cleanup</button>
                    <button class="btn btn-dark me-2 mb-2" onclick="testSidebarAfterBooking()">üß™ Test Sidebar</button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-danger mb-2" onclick="clearLog()">üóëÔ∏è Clear Log</button>
                </div>
            </div>
        </div>

        <!-- Log Container -->
        <div class="log-container" id="logContainer">
            <div>üöÄ Manual booking freeze debugger initialized.</div>
        </div>

        <!-- Mock Booking Form -->
        <div class="debug-section">
            <h3>üìã Mock Manual Booking Form</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">DR Number</label>
                        <input type="text" class="form-control" id="mockDrNumber" value="DR-MANUAL-001">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="mockCustomerName" value="Test Customer">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Number</label>
                        <input type="text" class="form-control" id="mockCustomerNumber" value="09123456789">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Origin</label>
                        <select class="form-control" id="mockOrigin">
                            <option value="SMEG Alabang warehouse">SMEG Alabang warehouse</option>
                            <option value="SMEG Cebu warehouse">SMEG Cebu warehouse</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Destination</label>
                        <input type="text" class="form-control" id="mockDestination" value="Makati City">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Delivery Date</label>
                        <input type="date" class="form-control" id="mockDeliveryDate" value="2024-12-21">
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="executeManualBooking()">üìã Execute Manual Booking</button>
        </div>

        <!-- State Display -->
        <div class="debug-section">
            <h3>üìä Current State</h3>
            <div class="row">
                <div class="col-md-4">
                    <h5>Active Deliveries</h5>
                    <div id="activeDeliveriesState" class="bg-light p-3" style="min-height: 150px;">
                        <small class="text-muted">Click "Check Active Deliveries" to see current state</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>Modal State</h5>
                    <div id="modalState" class="bg-light p-3" style="min-height: 150px;">
                        <small class="text-muted">Modal state will be shown here</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>Interaction State</h5>
                    <div id="interactionState" class="bg-light p-3" style="min-height: 150px;">
                        <small class="text-muted">Interaction state will be shown here</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mock Sidebar -->
        <div class="debug-section">
            <h3>üß™ Test Sidebar (Click after booking)</h3>
            <div class="list-group">
                <a href="#" class="list-group-item list-group-item-action test-nav-link" data-view="booking">
                    <i class="bi bi-calendar-plus"></i> Booking
                </a>
                <a href="#" class="list-group-item list-group-item-action test-nav-link" data-view="active-deliveries">
                    <i class="bi bi-truck"></i> Active Deliveries
                </a>
                <a href="#" class="list-group-item list-group-item-action test-nav-link" data-view="analytics">
                    <i class="bi bi-graph-up"></i> Analytics
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="public/assets/js/booking.js"></script>
    <script src="public/assets/js/main.js"></script>
    <script>
        let monitoringInterval;
        let bookingStep = 0;

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                success: '#00ff88',
                error: '#ff4444',
                warning: '#ffaa00',
                step: '#007bff'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div>üöÄ Log cleared.</div>';
        }

        // Start real-time monitoring
        function startRealTimeMonitoring() {
            log('=== STARTING REAL-TIME MONITORING ===', 'step');
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            monitoringInterval = setInterval(() => {
                updateRealTimeMonitor();
            }, 1000);
            
            log('‚úÖ Real-time monitoring started', 'success');
        }

        // Update real-time monitor
        function updateRealTimeMonitor() {
            const monitorContent = document.getElementById('monitorContent');
            
            const backdrops = document.querySelectorAll('.modal-backdrop').length;
            const modalOpen = document.body.classList.contains('modal-open');
            const activeDeliveries = window.activeDeliveries ? window.activeDeliveries.length : 0;
            const bodyOverflow = document.body.style.overflow || 'default';
            const pointerEvents = document.body.style.pointerEvents || 'default';
            
            monitorContent.innerHTML = `
                <div>Backdrops: ${backdrops}</div>
                <div>Modal-open: ${modalOpen}</div>
                <div>Active Deliveries: ${activeDeliveries}</div>
                <div>Body overflow: ${bodyOverflow}</div>
                <div>Pointer events: ${pointerEvents}</div>
                <div>Step: ${bookingStep}</div>
            `;
        }

        // Simulate manual booking
        function simulateManualBooking() {
            log('=== SIMULATING MANUAL BOOKING ===', 'step');
            
            // Initialize global arrays if needed
            if (!window.activeDeliveries) {
                window.activeDeliveries = [];
                log('Initialized window.activeDeliveries', 'info');
            }
            
            log(`Initial active deliveries count: ${window.activeDeliveries.length}`, 'info');
            
            // Create mock booking data
            const mockBooking = {
                id: 'DEL-' + Date.now() + '-DR-MANUAL-001',
                drNumber: 'DR-MANUAL-001',
                customerName: 'Test Customer',
                customerNumber: '09123456789',
                origin: 'SMEG Alabang warehouse',
                destination: 'Makati City',
                distance: '12.5 km',
                truckType: 'Closed Van',
                truckPlateNumber: 'ABC-123',
                status: 'On Schedule',
                deliveryDate: '2024-12-21',
                timestamp: new Date().toISOString(),
                source: 'MANUAL'
            };
            
            log('Created mock booking data', 'info');
            
            // Add to active deliveries
            window.activeDeliveries.push(mockBooking);
            log(`‚úÖ Added to active deliveries. New count: ${window.activeDeliveries.length}`, 'success');
            
            // Save to localStorage
            try {
                localStorage.setItem('mci-active-deliveries', JSON.stringify(window.activeDeliveries));
                log('‚úÖ Saved to localStorage', 'success');
            } catch (error) {
                log(`‚ùå Error saving to localStorage: ${error.message}`, 'error');
            }
            
            // Test loadActiveDeliveries function
            if (typeof window.loadActiveDeliveries === 'function') {
                window.loadActiveDeliveries();
                log('‚úÖ Called loadActiveDeliveries', 'success');
            } else {
                log('‚ùå loadActiveDeliveries function not available', 'error');
            }
        }

        // Execute manual booking using actual functions
        async function executeManualBooking() {
            log('=== EXECUTING MANUAL BOOKING ===', 'step');
            bookingStep = 1;
            
            try {
                // Step 1: Check function availability
                log('Step 1: Checking function availability...', 'step');
                bookingStep = 1;
                
                if (typeof window.saveBookingAndCloseModal === 'function') {
                    log('‚úÖ saveBookingAndCloseModal available', 'success');
                } else {
                    log('‚ùå saveBookingAndCloseModal not available', 'error');
                    return;
                }
                
                // Step 2: Prepare mock form data
                log('Step 2: Preparing form data...', 'step');
                bookingStep = 2;
                
                // Create mock form elements if they don't exist
                createMockFormElements();
                
                // Step 3: Execute booking
                log('Step 3: Executing saveBookingAndCloseModal...', 'step');
                bookingStep = 3;
                
                await window.saveBookingAndCloseModal();
                
                log('‚úÖ saveBookingAndCloseModal completed', 'success');
                bookingStep = 4;
                
                // Step 4: Check results
                setTimeout(() => {
                    log('Step 4: Checking results...', 'step');
                    bookingStep = 5;
                    checkActiveDeliveries();
                    checkModalState();
                    checkInteractionState();
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Error executing manual booking: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
            }
        }

        // Create mock form elements
        function createMockFormElements() {
            // Create mock elements if they don't exist
            const mockElements = [
                { id: 'drNumber', type: 'input', value: document.getElementById('mockDrNumber').value },
                { id: 'customerName', type: 'input', value: document.getElementById('mockCustomerName').value },
                { id: 'customerNumber', type: 'input', value: document.getElementById('mockCustomerNumber').value },
                { id: 'originSelect', type: 'select', value: 'alabang' },
                { id: 'deliveryDate', type: 'input', value: document.getElementById('mockDeliveryDate').value },
                { id: 'truckType', type: 'input', value: 'Closed Van' },
                { id: 'truckPlateNumber', type: 'input', value: 'ABC-123' }
            ];
            
            mockElements.forEach(elem => {
                let element = document.getElementById(elem.id);
                if (!element) {
                    element = document.createElement('input');
                    element.id = elem.id;
                    element.style.display = 'none';
                    document.body.appendChild(element);
                }
                element.value = elem.value;
            });
            
            // Create mock destination area
            let destContainer = document.getElementById('destinationAreasContainer');
            if (!destContainer) {
                destContainer = document.createElement('div');
                destContainer.id = 'destinationAreasContainer';
                destContainer.style.display = 'none';
                document.body.appendChild(destContainer);
            }
            
            let destInput = destContainer.querySelector('.destination-area-input');
            if (!destInput) {
                destInput = document.createElement('input');
                destInput.className = 'destination-area-input';
                destInput.value = document.getElementById('mockDestination').value;
                destContainer.appendChild(destInput);
            }
            
            log('‚úÖ Mock form elements created', 'success');
        }

        // Check active deliveries
        function checkActiveDeliveries() {
            log('=== CHECKING ACTIVE DELIVERIES ===', 'step');
            
            const activeDeliveriesState = document.getElementById('activeDeliveriesState');
            let stateHtml = '<h6>Active Deliveries State:</h6>';
            
            const count = window.activeDeliveries ? window.activeDeliveries.length : 0;
            log(`Active deliveries count: ${count}`, 'info');
            stateHtml += `<div>Count: ${count}</div>`;
            
            if (window.activeDeliveries && window.activeDeliveries.length > 0) {
                const latest = window.activeDeliveries[window.activeDeliveries.length - 1];
                log(`Latest booking: ${latest.drNumber} - ${latest.customerName}`, 'info');
                stateHtml += `<div class="small">Latest: ${latest.drNumber}</div>`;
                stateHtml += `<div class="small">Customer: ${latest.customerName}</div>`;
                stateHtml += `<div class="small">Source: ${latest.source || 'N/A'}</div>`;
            }
            
            // Check localStorage
            const stored = localStorage.getItem('mci-active-deliveries');
            const storedCount = stored ? JSON.parse(stored).length : 0;
            log(`localStorage count: ${storedCount}`, 'info');
            stateHtml += `<div>localStorage: ${storedCount}</div>`;
            
            activeDeliveriesState.innerHTML = stateHtml;
        }

        // Check modal state
        function checkModalState() {
            const modalState = document.getElementById('modalState');
            let stateHtml = '<h6>Modal State:</h6>';
            
            const backdrops = document.querySelectorAll('.modal-backdrop').length;
            const modalOpen = document.body.classList.contains('modal-open');
            const modals = document.querySelectorAll('.modal.show').length;
            
            stateHtml += `<div>Backdrops: ${backdrops}</div>`;
            stateHtml += `<div>Modal-open class: ${modalOpen}</div>`;
            stateHtml += `<div>Visible modals: ${modals}</div>`;
            
            if (backdrops > 0) {
                stateHtml += '<div class="text-danger">‚ö†Ô∏è Backdrops present</div>';
            }
            if (modalOpen) {
                stateHtml += '<div class="text-danger">‚ö†Ô∏è Modal-open class present</div>';
            }
            
            modalState.innerHTML = stateHtml;
        }

        // Check interaction state
        function checkInteractionState() {
            const interactionState = document.getElementById('interactionState');
            let stateHtml = '<h6>Interaction State:</h6>';
            
            const bodyPointerEvents = document.body.style.pointerEvents || 'auto';
            const bodyOverflow = document.body.style.overflow || 'visible';
            
            stateHtml += `<div>Body pointer-events: ${bodyPointerEvents}</div>`;
            stateHtml += `<div>Body overflow: ${bodyOverflow}</div>`;
            
            // Test sidebar links
            const testLinks = document.querySelectorAll('.test-nav-link');
            let clickableCount = 0;
            testLinks.forEach(link => {
                const rect = link.getBoundingClientRect();
                if (rect.width > 0 && rect.height > 0 && link.style.pointerEvents !== 'none') {
                    clickableCount++;
                }
            });
            
            stateHtml += `<div>Clickable sidebar links: ${clickableCount}/${testLinks.length}</div>`;
            
            if (clickableCount === testLinks.length) {
                stateHtml += '<div class="text-success">‚úÖ All links clickable</div>';
            } else {
                stateHtml += '<div class="text-danger">‚ùå Some links not clickable</div>';
            }
            
            interactionState.innerHTML = stateHtml;
        }

        // Emergency cleanup
        function emergencyCleanup() {
            log('=== EMERGENCY CLEANUP ===', 'step');
            
            if (typeof window.forceCleanupModal === 'function') {
                window.forceCleanupModal();
                log('‚úÖ Called forceCleanupModal', 'success');
            }
            
            if (typeof window.ensureInteractionsEnabled === 'function') {
                window.ensureInteractionsEnabled();
                log('‚úÖ Called ensureInteractionsEnabled', 'success');
            }
            
            // Manual cleanup
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.pointerEvents = '';
            
            log('‚úÖ Manual cleanup completed', 'success');
            
            setTimeout(() => {
                checkModalState();
                checkInteractionState();
            }, 100);
        }

        // Test sidebar after booking
        function testSidebarAfterBooking() {
            log('=== TESTING SIDEBAR AFTER BOOKING ===', 'step');
            
            const testLinks = document.querySelectorAll('.test-nav-link');
            testLinks.forEach((link, index) => {
                const view = link.getAttribute('data-view');
                
                try {
                    // Simulate click
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    
                    const result = link.dispatchEvent(clickEvent);
                    log(`Link ${index + 1} (${view}): Click dispatched: ${result}`, result ? 'success' : 'error');
                } catch (error) {
                    log(`Link ${index + 1} (${view}): Error: ${error.message}`, 'error');
                }
            });
        }

        // Trace booking flow
        function traceBookingFlow() {
            log('=== TRACING BOOKING FLOW ===', 'step');
            
            const functions = [
                'saveBookingAndCloseModal',
                'saveBooking',
                'closeBookingModal',
                'cleanupModalArtifacts',
                'forceCleanupModal',
                'ensureInteractionsEnabled',
                'refreshActiveDeliveries',
                'loadActiveDeliveries'
            ];
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    log(`‚úÖ ${funcName} available`, 'success');
                } else {
                    log(`‚ùå ${funcName} not available`, 'error');
                }
            });
        }

        // Set up test sidebar links
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Manual booking freeze debugger initialized');
            
            // Set up test sidebar links
            document.querySelectorAll('.test-nav-link').forEach((link, index) => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const view = this.getAttribute('data-view');
                    log(`‚úÖ Test sidebar link clicked: ${view}`, 'success');
                    
                    // Update active state
                    document.querySelectorAll('.test-nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Start monitoring
            startRealTimeMonitoring();
        });
    </script>
</body>
</html>